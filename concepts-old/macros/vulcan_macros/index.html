<!DOCTYPE html>
<html class="no-js" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Complete documentation for Vulcan - complete stack for building data products" name="description"/>
<meta content="DataOS Vulcan Team" name="author"/>
<link href="https://tmdc-io.github.io/vulcan-docs/concepts-old/macros/vulcan_macros/" rel="canonical"/>
<link href="../../../assets/images/vulcan.svg" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.0" name="generator"/>
<title>Built In - DataOS Vulcan</title>
<link href="../../../assets/stylesheets/main.618322db.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ab4e12ef.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
<link href="../../../assets/stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
<body data-md-color-accent="blue-grey" data-md-color-primary="blue-grey" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#built-in">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="DataOS Vulcan" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="DataOS Vulcan">
<img alt="logo" src="../../../assets/images/vulcan-white.svg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DataOS Vulcan
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Built In
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="blue-grey" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="blue-grey" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue-grey" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue-grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
</a>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/tmdc-io/vulcan-book" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tmdc-io/vulcan-book
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DataOS Vulcan" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="DataOS Vulcan">
<img alt="logo" src="../../../assets/images/vulcan-white.svg"/>
</a>
    DataOS Vulcan
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/tmdc-io/vulcan-book" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    tmdc-io/vulcan-book
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    About
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Configurations
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Configurations
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/overview/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Options
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
            
  
    Options
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/options/model_defaults/">
<span class="md-ellipsis">
    
  
    Model defaults
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/options/variables/">
<span class="md-ellipsis">
    
  
    Variables
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/options/execution_hooks/">
<span class="md-ellipsis">
    
  
    Execution Hooks
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/options/notifications/">
<span class="md-ellipsis">
    
  
    Notifications
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/options/linter/">
<span class="md-ellipsis">
    
  
    Linter
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Engines
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Engines
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/engines/postgres/postgres/">
<span class="md-ellipsis">
    
  
    Postgres
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../configurations/engines/snowflake/snowflake/">
<span class="md-ellipsis">
    
  
    Snowflake
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../ci-cd/index.md">
<span class="md-ellipsis">
    
  
    CI/CD
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Components
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Components
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Model
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_1">
<span class="md-nav__icon md-icon"></span>
            
  
    Model
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/overview/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/properties/">
<span class="md-ellipsis">
    
  
    Properties
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_1_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_1_3" id="__nav_3_1_3_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Types
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_1_3_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_1_3">
<span class="md-nav__icon md-icon"></span>
            
  
    Types
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/types/sql_models/">
<span class="md-ellipsis">
    
  
    SQL models
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/types/python_models/">
<span class="md-ellipsis">
    
  
    Python models
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/types/external_models/">
<span class="md-ellipsis">
    
  
    External models
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/types/managed_models/">
<span class="md-ellipsis">
    
  
    Managed models
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/model_kinds/">
<span class="md-ellipsis">
    
  
    Kinds
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/model/statements/">
<span class="md-ellipsis">
    
  
    Statements
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/tests/tests/">
<span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/audits/audits/">
<span class="md-ellipsis">
    
  
    Auditing
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/checks/checks/">
<span class="md-ellipsis">
    
  
    Checks
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Semantics
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            
  
    Semantics
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/semantics/overview/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/semantics/models/">
<span class="md-ellipsis">
    
  
    Semantic Models
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/semantics/business_metrics/">
<span class="md-ellipsis">
    
  
    Business Metrics
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Advance Features
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            
  
    Advance Features
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6_1" id="__nav_3_6_1_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Macros
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_6_1">
<span class="md-nav__icon md-icon"></span>
            
  
    Macros
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/advanced-features/macros/overview/">
<span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/advanced-features/macros/variables/">
<span class="md-ellipsis">
    
  
    Variables
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/advanced-features/macros/built_in/">
<span class="md-ellipsis">
    
  
    Built In
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/advanced-features/macros/jinja/">
<span class="md-ellipsis">
    
  
    Jinja
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/advanced-features/signals/">
<span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../components/advanced-features/custom_materializations/">
<span class="md-ellipsis">
    
  
    Custom materializations
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/get-started/docker/">
<span class="md-ellipsis">
    
  
    Get Started
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/plan/">
<span class="md-ellipsis">
    
  
    Plan
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/run_and_scheduling/">
<span class="md-ellipsis">
    
  
    Run and Scheduling
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/models/">
<span class="md-ellipsis">
    
  
    Models
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/incremental_by_time/">
<span class="md-ellipsis">
    
  
    Incremental by Time
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/data_quality/">
<span class="md-ellipsis">
    
  
    Data Quality
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/model_selection/">
<span class="md-ellipsis">
    
  
    Model Selection
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../guides/transpiling_semantics/">
<span class="md-ellipsis">
    
  
    Transpiling Semantics
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cli-command/cli/">
<span class="md-ellipsis">
    
  
    CLI Commands
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cookbook/">
<span class="md-ellipsis">
    
  
    Cookbook
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../faq/">
<span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="On this page" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      On this page
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#macro-systems-two-approaches">
<span class="md-ellipsis">
      
        Macro systems: two approaches
      
    </span>
</a>
<nav aria-label="Macro systems: two approaches" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#vulcan-macro-approach">
<span class="md-ellipsis">
      
        Vulcan macro approach
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#embedding-variables-in-strings">
<span class="md-ellipsis">
      
        Embedding variables in strings
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#user-defined-variables">
<span class="md-ellipsis">
      
        User-defined variables
      
    </span>
</a>
<nav aria-label="User-defined variables" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#global-variables">
<span class="md-ellipsis">
      
        Global variables
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gateway-variables">
<span class="md-ellipsis">
      
        Gateway variables
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#blueprint-variables">
<span class="md-ellipsis">
      
        Blueprint variables
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#local-variables">
<span class="md-ellipsis">
      
        Local variables
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#macro-functions">
<span class="md-ellipsis">
      
        Macro functions
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#macro-operators">
<span class="md-ellipsis">
      
        Macro operators
      
    </span>
</a>
<nav aria-label="Macro operators" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#each">
<span class="md-ellipsis">
      
        @EACH
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#if">
<span class="md-ellipsis">
      
        @IF
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#eval">
<span class="md-ellipsis">
      
        @EVAL
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#filter">
<span class="md-ellipsis">
      
        @FILTER
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#reduce">
<span class="md-ellipsis">
      
        @REDUCE
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#star">
<span class="md-ellipsis">
      
        @STAR
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#generate_surrogate_key">
<span class="md-ellipsis">
      
        @GENERATE_SURROGATE_KEY
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#safe_add">
<span class="md-ellipsis">
      
        @SAFE_ADD
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#safe_sub">
<span class="md-ellipsis">
      
        @SAFE_SUB
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#safe_div">
<span class="md-ellipsis">
      
        @SAFE_DIV
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#union">
<span class="md-ellipsis">
      
        @UNION
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#haversine_distance">
<span class="md-ellipsis">
      
        @HAVERSINE_DISTANCE
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pivot">
<span class="md-ellipsis">
      
        @PIVOT
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#deduplicate">
<span class="md-ellipsis">
      
        @DEDUPLICATE
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#date_spine">
<span class="md-ellipsis">
      
        @DATE_SPINE
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#resolve_template">
<span class="md-ellipsis">
      
        @RESOLVE_TEMPLATE
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#and">
<span class="md-ellipsis">
      
        @AND
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#or">
<span class="md-ellipsis">
      
        @OR
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sql-clause-operators">
<span class="md-ellipsis">
      
        SQL clause operators
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sql-clause-operator-examples">
<span class="md-ellipsis">
      
        SQL clause operator examples
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#user-defined-macro-functions">
<span class="md-ellipsis">
      
        User-defined macro functions
      
    </span>
</a>
<nav aria-label="User-defined macro functions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#python-macro-functions">
<span class="md-ellipsis">
      
        Python macro functions
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#typed-macros">
<span class="md-ellipsis">
      
        Typed Macros
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mixing-macro-systems">
<span class="md-ellipsis">
      
        Mixing macro systems
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="built-in">Built In<a class="headerlink" href="#built-in" title="Link to this section">¶</a></h1>
<h2 id="macro-systems-two-approaches">Macro systems: two approaches<a class="headerlink" href="#macro-systems-two-approaches" title="Link to this section">¶</a></h2>
<p>Vulcan macros behave differently than those of templating systems like <a href="https://jinja.palletsprojects.com/en/3.1.x/">Jinja</a>.</p>
<p>Macro systems are based on string substitution. The macro system scans code files, identifies special characters that signify macro content, and replaces the macro elements with other text.</p>
<p>In a general sense, that is the entire functionality of templating systems. They have tools that provide control flow logic (if-then) and other functionality, but <em>that functionality is solely to support substituting in the correct strings</em>.</p>
<p>Templating systems are intentionally agnostic to the programming language being templated, and most of them work for everything from blog posts to HTML to SQL.</p>
<p>In contrast, Vulcan macros are designed specifically for generating SQL code. They have <em>semantic understanding</em> of the SQL code being created by analyzing it with the Python <a href="https://github.com/tobymao/sqlglot">sqlglot</a> library, and they allow use of Python code so users can tidily implement sophisticated macro logic.</p>
<h3 id="vulcan-macro-approach">Vulcan macro approach<a class="headerlink" href="#vulcan-macro-approach" title="Link to this section">¶</a></h3>
<p>This section describes how Vulcan macros work under the hood. Feel free to skip over this section and return if and when it is useful. This information is <strong>not</strong> required to use Vulcan macros, but it will be useful for debugging any macros exhibiting puzzling behavior.</p>
<p>The critical distinction between the Vulcan macro approach and templating systems is the role string substitution plays. In templating systems, string substitution is the entire and only point.</p>
<p>In Vulcan, string substitution is just one step toward modifying the semantic representation of the SQL query. <em>Vulcan macros work by building and modifying the semantic representation of the SQL query.</em></p>
<p>After processing all the non-SQL text, it uses the substituted values to modify the semantic representation of the query to its final state.</p>
<p>It uses the following five step approach to accomplish this:</p>
<ol>
<li>
<p>Parse the text with the appropriate sqlglot SQL dialect (e.g., Postgres, BigQuery, etc.). During the parsing, it detects the special macro symbol <code>@</code> to differentiate non-SQL from SQL text. The parser builds a semantic representation of the SQL code's structure, capturing non-SQL text as "placeholder" values to use in subsequent steps.</p>
</li>
<li>
<p>Examine the placeholder values to classify them as one of the following types:</p>
<ul>
<li>Creation of user-defined macro variables with the <code>@DEF</code> operator (see more about <a href="#user-defined-variables">user-defined macro variables</a>)</li>
<li>Macro variables: <a href="../macro_variables/">Vulcan pre-defined</a>, <a href="#local-variables">user-defined local</a>, and <a href="#global-variables">user-defined global</a></li>
<li>Macro functions, both <a href="#macro-operators">Vulcan's</a> and <a href="#user-defined-macro-functions">user-defined</a></li>
</ul>
</li>
<li>
<p>Substitute macro variable values where they are detected. In most cases, this is direct string substitution as with a templating system.</p>
</li>
<li>
<p>Execute any macro functions and substitute the returned values.</p>
</li>
<li>
<p>Modify the semantic representation of the SQL query with the substituted variable values from (3) and functions from (4).</p>
</li>
</ol>
<h3 id="embedding-variables-in-strings">Embedding variables in strings<a class="headerlink" href="#embedding-variables-in-strings" title="Link to this section">¶</a></h3>
<p>Vulcan always incorporates macro variable values into the semantic representation of a SQL query (step 5 above). To do that, it infers the role each macro variable value plays in the query.</p>
<p>For context, two commonly used types of string in SQL are:</p>
<ul>
<li>String literals, which represent text values and are surrounded by single quotes, such as <code>'the_string'</code></li>
<li>Identifiers, which reference database objects like column, table, alias, and function names<ul>
<li>They may be unquoted or quoted with double quotes, backticks, or brackets, depending on the SQL dialect</li>
</ul>
</li>
</ul>
<p>In a normal query, Vulcan can easily determine which role a given string is playing. However, it is more difficult if a macro variable is embedded directly into a string - especially if the string is in the <code>MODEL</code> block (and not the query itself).</p>
<p>For example, consider a project that defines a <a href="#gateway-variables">gateway variable</a> named <code>gateway_var</code>. The project includes a model that references <code>@gateway_var</code> as part of the schema in the model's <code>name</code>, which is a SQL <em>identifier</em>.</p>
<p>This is how we might try to write the model:</p>
<div class="language-sql highlight"><span class="filename">Incorrectly rendered to string literal</span><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">the_</span><span class="o">@</span><span class="n">gateway_var_schema</span><span class="p">.</span><span class="k">table</span>
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">);</span>
</span></code></pre></div>
<p>From Vulcan's perspective, the model schema is the combination of three sub-strings: <code>the_</code>, the value of <code>@gateway_var</code>, and <code>_schema</code>.</p>
<p>Vulcan will concatenate those strings, but it does not have the context to know that it is building a SQL identifier and will return a string literal.</p>
<p>To provide the context Vulcan needs, you must add curly braces to the macro variable reference: <code>@{gateway_var}</code> instead of <code>@gateway_var</code>:</p>
<div class="language-sql highlight"><span class="filename">Correctly rendered to identifier</span><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">the_</span><span class="o">@</span><span class="err">{</span><span class="n">gateway_var</span><span class="err">}</span><span class="n">_schema</span><span class="p">.</span><span class="k">table</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="p">);</span>
</span></code></pre></div>
<p>The curly braces let Vulcan know that it should treat the string as a SQL identifier, which it will then quote based on the SQL dialect's quoting rules.</p>
<p>The most common use of the curly brace syntax is embedding macro variables into strings, it can also be used to differentiate string literals and identifiers in SQL queries. For example, consider a macro variable <code>my_variable</code> whose value is <code>col</code>.</p>
<p>If we <code>SELECT</code> this value with regular macro syntax, it will render to a string literal:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">my_variable</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">the_column</span><span class="p">;</span><span class="w"> </span><span class="c1">-- renders to SELECT 'col' AS the_column</span>
</span></code></pre></div>
<p><code>'col'</code> is surrounded with single quotes, and the SQL engine will use that string as the column's data value.</p>
<p>If we use curly braces, Vulcan will know that we want to use the rendered string as an identifier:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="err">{</span><span class="n">my_variable</span><span class="err">}</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">the_column</span><span class="p">;</span><span class="w"> </span><span class="c1">-- renders to SELECT col AS the_column</span>
</span></code></pre></div>
<p><code>col</code> is not surrounded with single quotes, and the SQL engine will determine that the query is referencing a column or other object named <code>col</code>.</p>
<h2 id="user-defined-variables">User-defined variables<a class="headerlink" href="#user-defined-variables" title="Link to this section">¶</a></h2>
<p>Vulcan supports four kinds of user-defined macro variables: <a href="#global-variables">global</a>, <a href="#gateway-variables">gateway</a>, <a href="#blueprint-variables">blueprint</a> and <a href="#local-variables">local</a>.</p>
<p>Global and gateway macro variables are defined in the project configuration file and can be accessed in any project model. Blueprint and macro variables are defined in a model definition and can only be accessed in that model.</p>
<p>Macro variables with the same name may be specified at any or all of the global, gateway, blueprint and local levels. When variables are specified at multiple levels, the value of the most specific level takes precedence. For example, the value of a local variable takes precedence over the value of a blueprint or gateway variable with the same name, and the value of a gateway variable takes precedence over the value of a global variable.</p>
<h3 id="global-variables">Global variables<a class="headerlink" href="#global-variables" title="Link to this section">¶</a></h3>
<p>Global variables are defined in the project configuration file <a href="../../reference/configuration.md#variables"><code>variables</code> key</a>.</p>
<p>Global variable values may be any of the following data types or lists or dictionaries containing these types: <code>int</code>, <code>float</code>, <code>bool</code>, <code>str</code>.</p>
<p>Access global variable values in a model definition using the <code>@&lt;VAR_NAME&gt;</code> macro or the <code>@VAR()</code> macro function. The latter function requires the name of the variable <em>in single quotes</em> as the first argument and an optional default value as the second argument. The default value is a safety mechanism used if the variable name is not found in the project configuration file.</p>
<p>For example, this Vulcan configuration key defines six variables of different data types:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio"/><input id="__tabbed_1_2" name="__tabbed_1" type="radio"/><div class="tabbed-labels"><label for="__tabbed_1_1">YAML</label><label for="__tabbed_1_2">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span>
<span class="normal"><a href="#__codelineno-4-7">7</a></span>
<span class="normal"><a href="#__codelineno-4-8">8</a></span>
<span class="normal"><a href="#__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">variables</span><span class="p">:</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">int_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">  </span><span class="nt">float_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.0</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">bool_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">str_var</span><span class="p">:</span><span class="w"> </span><span class="s">"cat"</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="nt">list_var</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3</span><span class="p p-Indicator">]</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">  </span><span class="nt">dict_var</span><span class="p">:</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nt">key1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nt">key2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span></code></pre></div></td></tr></tbody></table></div>
</div>
<div class="tabbed-block">
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="s2">"int_var"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="s2">"float_var"</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="s2">"bool_var"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="s2">"str_var"</span><span class="p">:</span> <span class="s2">"cat"</span><span class="p">,</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="s2">"list_var"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="s2">"dict_var"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"key1"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"key2"</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">}</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a>    <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a>    <span class="o">...</span> <span class="c1"># other Config arguments</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>A model definition could access the <code>int_var</code> value in a <code>WHERE</code> clause like this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">int_variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">INT_VAR</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Alternatively, the same variable can be accessed by passing the variable name into the <code>@VAR()</code> macro function. Note that the variable name is in single quotes in the call <code>@VAR('int_var')</code>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">int_variable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">VAR</span><span class="p">(</span><span class="s1">'int_var'</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>A default value can be passed as a second argument to the <code>@VAR()</code> macro function, which will be used as a fallback value if the variable is missing from the configuration file.</p>
<p>In this example, the <code>WHERE</code> clause would render to <code>WHERE some_value = 0</code> because no variable named <code>missing_var</code> was defined in the project configuration file:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">some_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">VAR</span><span class="p">(</span><span class="s1">'missing_var'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>A similar API is available for <a href="#accessing-global-variable-values">Python macro functions</a> via the <code>evaluator.var</code> method and <a href="../models/python_models.md#user-defined-variables">Python models</a> via the <code>context.var</code> method.</p>
<h3 id="gateway-variables">Gateway variables<a class="headerlink" href="#gateway-variables" title="Link to this section">¶</a></h3>
<p>Like global variables, gateway variables are defined in the project configuration file. However, they are specified in a specific gateway's <code>variables</code> key:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio"/><input id="__tabbed_2_2" name="__tabbed_2" type="radio"/><div class="tabbed-labels"><label for="__tabbed_2_1">YAML</label><label for="__tabbed_2_2">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-yaml highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nt">gateways</span><span class="p">:</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="nt">my_gateway</span><span class="p">:</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="nt">variables</span><span class="p">:</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">      </span><span class="nt">int_var</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</span></code></pre></div></td></tr></tbody></table></div>
</div>
<div class="tabbed-block">
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">gateway_variables</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>  <span class="s2">"int_var"</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="p">}</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="n">gateways</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a>      <span class="s2">"my_gateway"</span><span class="p">:</span> <span class="n">GatewayConfig</span><span class="p">(</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="n">variables</span><span class="o">=</span><span class="n">gateway_variables</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="o">...</span> <span class="c1"># other GatewayConfig arguments</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="p">),</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a>      <span class="p">}</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
</div>
</div>
</div>
<p>Access them in models using the same methods as <a href="#global-variables">global variables</a>.</p>
<p>Gateway-specific variable values take precedence over variables with the same name specified in the root <code>variables</code> key.</p>
<h3 id="blueprint-variables">Blueprint variables<a class="headerlink" href="#blueprint-variables" title="Link to this section">¶</a></h3>
<p>Blueprint macro variables are defined in a model. Blueprint variable values take precedence over <a href="#global-variables">global</a> or <a href="#gateway-variables">gateway-specific</a> variables with the same name.</p>
<p>Blueprint variables are defined as a property of the <code>MODEL</code> statement, and serve as a mechanism for <a href="../models/sql_models.md">creating model templates</a>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="o">@</span><span class="n">customer</span><span class="p">.</span><span class="n">some_table</span><span class="p">,</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="n">blueprints</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="p">(</span><span class="n">customer</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">customer1</span><span class="p">,</span><span class="w"> </span><span class="n">field_a</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">field_b</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">field_c</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">'foo'</span><span class="p">),</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="p">(</span><span class="n">customer</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">customer2</span><span class="p">,</span><span class="w"> </span><span class="n">field_a</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">field_b</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">field_c</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">'bar'</span><span class="p">)</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="p">);</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="k">SELECT</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">  </span><span class="o">@</span><span class="n">field_a</span><span class="p">,</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">  </span><span class="o">@</span><span class="err">{</span><span class="n">field_b</span><span class="err">}</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">field_b</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">  </span><span class="o">@</span><span class="n">field_c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">@</span><span class="err">{</span><span class="n">field_c</span><span class="err">}</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">customer</span><span class="p">.</span><span class="n">some_source</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="cm">/*</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="cm">When rendered for customer1.some_table:</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="cm">SELECT</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="cm">  x,</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="cm">  y AS field_b,</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="cm">  'foo' AS foo</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="cm">FROM customer1.some_source</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="cm">When rendered for customer2.some_table:</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="cm">SELECT</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="cm">  z,</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="cm">  w AS field_b,</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="cm">  'bar' AS bar</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="cm">FROM customer2.some_source</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="cm">*/</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note the use of both regular <code>@field_a</code> and curly brace syntax <code>@{field_b}</code> macro variable references in the model query. Both of these will be rendered as identifiers. In the case of <code>field_c</code>, which in the blueprints is a string, it would be rendered as a string literal when used with the regular macro syntax <code>@field_c</code> and if we want to use the string as an identifier then we use the curly braces <code>@{field_c}</code>. Learn more <a href="#embedding-variables-in-strings">above</a></p>
<p>Blueprint variables can be accessed using the syntax shown above, or through the <code>@BLUEPRINT_VAR()</code> macro function, which also supports specifying default values in case the variable is undefined (similar to <code>@VAR()</code>).</p>
<h3 id="local-variables">Local variables<a class="headerlink" href="#local-variables" title="Link to this section">¶</a></h3>
<p>Local macro variables are defined in a model. Local variable values take precedence over <a href="#global-variables">global</a>, <a href="#blueprint-variables">blueprint</a>, or <a href="#gateway-variables">gateway-specific</a> variables with the same name.</p>
<p>Define your own local macro variables with the <code>@DEF</code> macro operator. For example, you could set the macro variable <code>macro_var</code> to the value <code>1</code> with:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">macro_var</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Vulcan has three basic requirements for using the <code>@DEF</code> operator:</p>
<ol>
<li>The <code>MODEL</code> statement must end with a semi-colon <code>;</code></li>
<li>All <code>@DEF</code> uses must come after the <code>MODEL</code> statement and before the SQL query</li>
<li>Each <code>@DEF</code> use must end with a semi-colon <code>;</code></li>
</ol>
<p>For example, consider the following model <code>vulcan_example.full_model</code> from the <a href="../../getting_started/docker.md">Vulcan quickstart guide</a>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="p">,</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="n">cron</span><span class="w"> </span><span class="s1">'@daily'</span><span class="p">,</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span><span class="n">audits</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_order_ids</span><span class="p">),</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="p">);</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="k">SELECT</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="k">FROM</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This model could be extended with a user-defined macro variable to filter the query results based on <code>item_size</code> like this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="p">,</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="n">cron</span><span class="w"> </span><span class="s1">'@daily'</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="n">audits</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_order_ids</span><span class="p">),</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="p">);</span><span class="w"> </span><span class="c1">-- NOTE: semi-colon at end of MODEL statement</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- NOTE: semi-colon at end of @DEF operator</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="k">SELECT</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="k">FROM</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="k">WHERE</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">  </span><span class="n">item_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">size</span><span class="w"> </span><span class="c1">-- Reference to macro variable `@size` defined above with `@DEF()`</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This example defines the macro variable <code>size</code> with <code>@DEF(size, 1)</code>. When the model is run, Vulcan will substitute in the number <code>1</code> where <code>@size</code> appears in the <code>WHERE</code> clause.</p>
<h3 id="macro-functions">Macro functions<a class="headerlink" href="#macro-functions" title="Link to this section">¶</a></h3>
<p>In addition to inline user-defined variables, Vulcan also supports inline macro functions. These functions can be used to express more readable and reusable logic than is possible with variables alone. Lets look at an example:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">MODEL</span><span class="p">(...);</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">  </span><span class="n">rank_to_int</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">left</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'A'</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">left</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'B'</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="k">left</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'C'</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">end</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="p">);</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="k">SELECT</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">  </span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">  </span><span class="n">cust_rank_1</span><span class="p">,</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">  </span><span class="n">cust_rank_2</span><span class="p">,</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">  </span><span class="n">cust_rank_3</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">  </span><span class="o">@</span><span class="n">rank_to_int</span><span class="p">(</span><span class="n">cust_rank_1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cust_rank_1_int</span><span class="p">,</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">  </span><span class="o">@</span><span class="n">rank_to_int</span><span class="p">(</span><span class="n">cust_rank_2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cust_rank_2_int</span><span class="p">,</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">  </span><span class="o">@</span><span class="n">rank_to_int</span><span class="p">(</span><span class="n">cust_rank_3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cust_rank_3_int</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="k">FROM</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">  </span><span class="k">some</span><span class="p">.</span><span class="n">model</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Multiple arguments can be expressed in a macro function as well:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span>
<span class="normal"><a href="#__codelineno-16-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">pythag</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)));</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="k">SELECT</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="n">sideA</span><span class="p">,</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="n">sideB</span><span class="p">,</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">  </span><span class="o">@</span><span class="n">pythag</span><span class="p">(</span><span class="n">sideA</span><span class="p">,</span><span class="w"> </span><span class="n">sideB</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sideC</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="k">FROM</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">  </span><span class="k">some</span><span class="p">.</span><span class="n">triangle</span>
</span></code></pre></div></td></tr></tbody></table></div>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span>
<span class="normal"><a href="#__codelineno-17-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">nrr</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">starting_mrr</span><span class="p">,</span><span class="w"> </span><span class="n">expansion_mrr</span><span class="p">,</span><span class="w"> </span><span class="n">churned_mrr</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">starting_mrr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">expansion_mrr</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">churned_mrr</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">starting_mrr</span><span class="p">);</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="k">SELECT</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">  </span><span class="o">@</span><span class="n">nrr</span><span class="p">(</span><span class="n">fy21_mrr</span><span class="p">,</span><span class="w"> </span><span class="n">fy21_expansions</span><span class="p">,</span><span class="w"> </span><span class="n">fy21_churns</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fy21_net_retention_rate</span><span class="p">,</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">  </span><span class="o">@</span><span class="n">nrr</span><span class="p">(</span><span class="n">fy22_mrr</span><span class="p">,</span><span class="w"> </span><span class="n">fy22_expansions</span><span class="p">,</span><span class="w"> </span><span class="n">fy22_churns</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fy22_net_retention_rate</span><span class="p">,</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">  </span><span class="o">@</span><span class="n">nrr</span><span class="p">(</span><span class="n">fy23_mrr</span><span class="p">,</span><span class="w"> </span><span class="n">fy23_expansions</span><span class="p">,</span><span class="w"> </span><span class="n">fy23_churns</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fy23_net_retention_rate</span><span class="p">,</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="k">FROM</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">  </span><span class="k">some</span><span class="p">.</span><span class="n">revenue</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>You can nest macro functions like so:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span>
<span class="normal"><a href="#__codelineno-18-8">8</a></span>
<span class="normal"><a href="#__codelineno-18-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dummy</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="p">);</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">pi</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">container_volume</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">area</span><span class="p">(</span><span class="o">@</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h</span><span class="p">);</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">container_id</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">container_volume</span><span class="p">((</span><span class="n">cont_di</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">cont_hi</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">volume</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h2 id="macro-operators">Macro operators<a class="headerlink" href="#macro-operators" title="Link to this section">¶</a></h2>
<p>Vulcan's macro system has multiple operators that allow different forms of dynamic behavior in models.</p>
<h3 id="each"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/EACH" title="GitHub User: EACH">@EACH</a><a class="headerlink" href="#each" title="Link to this section">¶</a></h3>
<p><code>@EACH</code> is used to transform a list of items by applying a function to each of them, analogous to a <code>for</code> loop.</p>
<details class="info">
<summary>Learn more about <code>for</code> loops and <code>@EACH</code></summary>
<p>Before diving into the <code>@EACH</code> operator, let's dissect a <code>for</code> loop to understand its components.</p>
<p><code>for</code> loops have two primary parts: a collection of items and an action that should be taken for each item. For example, here is a <code>for</code> loop in Python:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This for loop prints each number present in the brackets:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="mi">4</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="mi">5</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="mi">6</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The first line of the example sets up the loop, doing two things:</p>
<ol>
<li>Telling Python that code inside the loop will refer to each item as <code>number</code></li>
<li>Telling Python to step through the list of items in brackets</li>
</ol>
<p>The second line tells Python what action should be taken for each item. In this case, it prints the item.</p>
<p>The loop executes one time for each item in the list, substituting in the item for the word <code>number</code> in the code. For example, the first time through the loop the code would execute as <code>print(4)</code> and the second time as <code>print(5)</code>.</p>
<p>The Vulcan <code>@EACH</code> operator is used to implement the equivalent of a <code>for</code> loop in Vulcan macros.</p>
<p><code>@EACH</code> gets its name from the fact that a loop performs the action "for each" item in the collection. It is fundamentally equivalent to the Python loop above, but you specify the two loop components differently.</p>
</details>
<p><code>@EACH</code> takes two arguments: a list of items and a function definition.</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="o">@</span><span class="k">EACH</span><span class="p">([</span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">items</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">function</span><span class="w"> </span><span class="n">definition</span><span class="p">])</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The function definition is specified inline. This example specifies the identity function, returning the input unmodified:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">SELECT</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">  </span><span class="o">@</span><span class="k">EACH</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="nb">number</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nb">number</span><span class="p">)</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The loop is set up by the first argument: <code>@EACH([4, 5, 6]</code> tells Vulcan to step through the list of items in brackets.</p>
<p>The second argument <code>number -&gt; number</code> tells Vulcan what action should be taken for each item using an "anonymous" function (aka "lambda" function). The left side of the arrow states what name the code on the right side will refer to each item as (like <code>name</code> in <code>for [name] in [items]</code> in a Python <code>for</code> loop).</p>
<p>The right side of the arrow specifies what should be done to each item in the list. <code>number -&gt; number</code> tells <code>@EACH</code> that for each item <code>number</code> it should return that item (e.g., <code>1</code>).</p>
<p>Vulcan macros use their semantic understanding of SQL code to take automatic actions based on where in a SQL query macro variables are used. If <code>@EACH</code> is used in the <code>SELECT</code> clause of a SQL statement:</p>
<ol>
<li>It prints the item</li>
<li>It knows fields are separated by commas in <code>SELECT</code>, so it automatically separates the printed items with commas</li>
</ol>
<p>Because of the automatic print and comma-separation, the anonymous function <code>number -&gt; number</code> tells <code>@EACH</code> that for each item <code>number</code> it should print the item and separate the items with commas. Therefore, the complete output from the example is:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span>
<span class="normal"><a href="#__codelineno-23-3">3</a></span>
<span class="normal"><a href="#__codelineno-23-4">4</a></span>
<span class="normal"><a href="#__codelineno-23-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="k">SELECT</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">  </span><span class="mi">4</span><span class="p">,</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">  </span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">  </span><span class="mi">6</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This basic example is too simple to be useful. Many uses of <code>@EACH</code> will involve using the values as one or both of a literal value and an identifier.</p>
<p>For example, a column <code>favorite_number</code> in our data might contain values <code>4</code>, <code>5</code>, and <code>6</code>, and we want to unpack that column into three indicator (i.e., binary, dummy, one-hot encoded) columns. We could write that by hand as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">SELECT</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">favorite_4</span><span class="p">,</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">favorite_5</span><span class="p">,</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">favorite_6</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>In that SQL query each number is being used in two distinct ways. For example, <code>4</code> is being used:</p>
<ol>
<li>As a literal numeric value in <code>favorite_number = 4</code></li>
<li>As part of a column name in <code>favorite_4</code></li>
</ol>
<p>We describe each of these uses separately.</p>
<p>For the literal numeric value, <code>@EACH</code> substitutes in the exact value that is passed in the brackets, <em>including quotes</em>. For example, consider this query similar to the <code>CASE WHEN</code> example above:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="k">SELECT</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">  </span><span class="o">@</span><span class="k">EACH</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">column</span><span class="p">)</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>It renders to this SQL:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span>
<span class="normal"><a href="#__codelineno-26-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="k">SELECT</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column</span><span class="p">,</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column</span><span class="p">,</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note that the number <code>4</code>, <code>5</code>, and <code>6</code> are unquoted in <em>both</em> the input <code>@EACH</code> array in brackets and the resulting SQL query.</p>
<p>We can instead quote them in the input <code>@EACH</code> array:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="k">SELECT</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">  </span><span class="o">@</span><span class="k">EACH</span><span class="p">([</span><span class="s1">'4'</span><span class="p">,</span><span class="s1">'5'</span><span class="p">,</span><span class="s1">'6'</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">column</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>And they will be quoted in the resulting SQL query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span>
<span class="normal"><a href="#__codelineno-28-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="k">SELECT</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'4'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column</span><span class="p">,</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'5'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'6'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>We can place the array values at the end of a column name by using the Vulcan macro operator <code>@</code> inside the <code>@EACH</code> function definition:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="k">SELECT</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">  </span><span class="o">@</span><span class="k">EACH</span><span class="p">([</span><span class="s1">'4'</span><span class="p">,</span><span class="s1">'5'</span><span class="p">,</span><span class="s1">'6'</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">column_</span><span class="o">@</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This query will render to:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="k">SELECT</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'4'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">column_4</span><span class="p">,</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'5'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">column_5</span><span class="p">,</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">favorite_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'6'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">column_6</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This syntax works regardless of whether the array values are quoted or not.</p>
<div class="admonition note">
<p class="admonition-title">Embedding macros in strings</p>
<p>Vulcan macros support placing macro values at the end of a column name using <code>column_@x</code>.</p>
<p>However, if you wish to substitute the variable anywhere else in the identifier, you need to use the more explicit curly brace syntax <code>@{}</code> to avoid ambiguity. For example, these are valid uses: <code>@{x}_column</code> or <code>my_@{x}_column</code>.</p>
<p>Learn more about embedding macros in strings <a href="#embedding-variables-in-strings">above</a></p>
</div>
<h3 id="if"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/IF" title="GitHub User: IF">@IF</a><a class="headerlink" href="#if" title="Link to this section">¶</a></h3>
<p>Vulcan's <code>@IF</code> macro allows components of a SQL query to change based on the result of a logical condition.</p>
<p>It includes three elements:</p>
<ol>
<li>A logical condition that evaluates to <code>TRUE</code> or <code>FALSE</code></li>
<li>A value to return if the condition is <code>TRUE</code></li>
<li>A value to return if the condition is <code>FALSE</code> [optional]</li>
</ol>
<p>These elements are specified as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="o">@</span><span class="k">IF</span><span class="p">([</span><span class="n">logical</span><span class="w"> </span><span class="n">condition</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">TRUE</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">FALSE</span><span class="p">])</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The value to return if the condition is <code>FALSE</code> is optional - if it is not provided and the condition is <code>FALSE</code>, then the macro has no effect on the resulting query.</p>
<p>The logical condition should be written <em>in SQL</em> and is evaluated with <a href="https://github.com/tobymao/sqlglot">SQLGlot's</a> SQL executor. It supports the following operators:</p>
<ul>
<li>Equality: <code>=</code> for equals, <code>!=</code> or <code>&lt;&gt;</code> for not equals</li>
<li>Comparison: <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>,</li>
<li>Between: <code>[number] BETWEEN [low number] AND [high number]</code></li>
<li>Membership: <code>[item] IN ([comma-separated list of items])</code></li>
</ul>
<p>For example, the following simple conditions are all valid SQL and evaluate to <code>TRUE</code>:</p>
<ul>
<li><code>'a' = 'a'</code></li>
<li><code>'a' != 'b'</code></li>
<li><code>0 &lt; 1</code></li>
<li><code>1 &gt;= 1</code></li>
<li><code>2 BETWEEN 1 AND 3</code></li>
<li><code>'a' IN ('a', 'b')</code></li>
</ul>
<p><code>@IF</code> can be used to modify any part of a SQL query. For example, this query conditionally includes <code>sensitive_col</code> in the query results:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span>
<span class="normal"><a href="#__codelineno-32-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="k">SELECT</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">  </span><span class="n">col1</span><span class="p">,</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">  </span><span class="o">@</span><span class="k">IF</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sensitive_col</span><span class="p">)</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Because <code>1 &gt; 0</code> evaluates to <code>TRUE</code>, the query is rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="k">SELECT</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">  </span><span class="n">col1</span><span class="p">,</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">  </span><span class="n">sensitive_col</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note that <code>@IF(1 &gt; 0, sensitive_col)</code> does not include the third argument specifying a value if <code>FALSE</code>. Had the condition evaluated to <code>FALSE</code>, <code>@IF</code> would return nothing and only <code>col1</code> would be selected.</p>
<p>Alternatively, we could specify that <code>nonsensitive_col</code> be returned if the condition evaluates to <code>FALSE</code>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="k">SELECT</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w">  </span><span class="n">col1</span><span class="p">,</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">  </span><span class="o">@</span><span class="k">IF</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">sensitive_col</span><span class="p">,</span><span class="w"> </span><span class="n">nonsensitive_col</span><span class="p">)</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Because <code>1 &gt; 2</code> evaluates to <code>FALSE</code>, the query is rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span>
<span class="normal"><a href="#__codelineno-35-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="k">SELECT</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">  </span><span class="n">col1</span><span class="p">,</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">  </span><span class="n">nonsensitive_col</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p><a href="#vulcan-macro-approach">Macro rendering</a> occurs before the <code>@IF</code> condition is evaluated. For example, Vulcan doesn't evaluate the condition <code>my_column &gt; @my_value</code> until it has first substituted the number <code>@my_value</code> represents.</p>
<p>Your macro might do things besides returning a value, such as printing a message or executing a statement (i.e., the macro "has side effects"). The side effect code will always run during the rendering step. To prevent this, modify the macro code to condition the side effects on the evaluation stage.</p>
<h4 id="prepost-statements">Pre/post-statements<a class="headerlink" href="#prepost-statements" title="Link to this section">¶</a></h4>
<p><code>@IF</code> may be used to conditionally execute pre/post-statements:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="o">@</span><span class="k">IF</span><span class="p">([</span><span class="n">logical</span><span class="w"> </span><span class="n">condition</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">statement</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">execute</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">TRUE</span><span class="p">]);</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The <code>@IF</code> statement itself must end with a semi-colon, but the inner statement argument must not.</p>
<p>This example conditionally executes a pre/post-statement depending on the model's <a href="../macro_variables/#predefined-variables">runtime stage</a>, accessed via the pre-defined macro variable <code>@runtime_stage</code>. The <code>@IF</code> post-statement will only be executed at model evaluation time:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="p">,</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">  </span><span class="n">cron</span><span class="w"> </span><span class="s1">'@daily'</span><span class="p">,</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">  </span><span class="n">audits</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_order_ids</span><span class="p">),</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="p">);</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="k">SELECT</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="k">FROM</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span><span class="p">;</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16"></a>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17"></a><span class="hll"><span class="o">@</span><span class="k">IF</span><span class="p">(</span>
</span></span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18"></a><span class="hll"><span class="w">  </span><span class="o">@</span><span class="n">runtime_stage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'evaluating'</span><span class="p">,</span>
</span></span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19"></a><span class="hll"><span class="w">  </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="n">item_id</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="nb">VARCHAR</span>
</span></span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20"></a><span class="hll"><span class="p">);</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<p>NOTE: alternatively, we could alter a column's type if the <code>@runtime_stage = 'creating'</code>, but that would only be useful if the model is incremental and the alteration would persist. <code>FULL</code> models are rebuilt on each evaluation, so changes made at their creation stage will be overwritten each time the model is evaluated.</p>
<h3 id="eval"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/EVAL" title="GitHub User: EVAL">@EVAL</a><a class="headerlink" href="#eval" title="Link to this section">¶</a></h3>
<p><code>@EVAL</code> evaluates its arguments with SQLGlot's SQL executor.</p>
<p>It allows you to execute mathematical or other calculations in SQL code. It behaves similarly to the first argument of the <a href="#if"><code>@IF</code> operator</a>, but it is not limited to logical conditions.</p>
<p>For example, consider a query adding 5 to a macro variable:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span>
<span class="normal"><a href="#__codelineno-38-4">4</a></span>
<span class="normal"><a href="#__codelineno-38-5">5</a></span>
<span class="normal"><a href="#__codelineno-38-6">6</a></span>
<span class="normal"><a href="#__codelineno-38-7">7</a></span>
<span class="normal"><a href="#__codelineno-38-8">8</a></span>
<span class="normal"><a href="#__codelineno-38-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="p">);</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="k">SELECT</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">  </span><span class="o">@</span><span class="n">EVAL</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">my_six</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>After macro variable substitution, this would render as <code>@EVAL(5 + 1)</code> and be evaluated to <code>6</code>, resulting in the final rendered query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span>
<span class="normal"><a href="#__codelineno-39-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="k">SELECT</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">my_six</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="filter"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/FILTER" title="GitHub User: FILTER">@FILTER</a><a class="headerlink" href="#filter" title="Link to this section">¶</a></h3>
<p><code>@FILTER</code> is used to subset an input array of items to only those meeting the logical condition specified in the anonymous function. Its output can be consumed by other macro operators such as <a href="#each"><code>@EACH</code></a> or <a href="#reduce"><code>@REDUCE</code></a>.</p>
<p>The user-specified anonymous function must evaluate to <code>TRUE</code> or <code>FALSE</code>. <code>@FILTER</code> applies the function to each item in the array, only including the item in the output array if it meets the condition.</p>
<p>The anonymous function should be written <em>in SQL</em> and is evaluated with <a href="https://github.com/tobymao/sqlglot">SQLGlot's</a> SQL executor. It supports standard SQL equality and comparison operators - see <a href="#if"><code>@IF</code></a> above for more information about supported operators.</p>
<p>For example, consider this <code>@FILTER</code> call:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="o">@</span><span class="n">FILTER</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>It applies the condition <code>x &gt; 1</code> to each item in the input array <code>[1,2,3]</code> and returns <code>[2,3]</code>.</p>
<h3 id="reduce"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/REDUCE" title="GitHub User: REDUCE">@REDUCE</a><a class="headerlink" href="#reduce" title="Link to this section">¶</a></h3>
<p><code>@REDUCE</code> is used to combine the items in an array.</p>
<p>The anonymous function specifies how the items in the input array should be combined. In contrast to <code>@EACH</code> and <code>@FILTER</code>, the anonymous function takes two arguments whose values are named in parentheses.</p>
<p>For example, an anonymous function for <code>@EACH</code> might be specified <code>x -&gt; x + 1</code>. The <code>x</code> to the left of the arrow tells Vulcan that the array items will be referred to as <code>x</code> in the code to the right of the arrow.</p>
<p>Because the <code>@REDUCE</code> anonymous function takes two arguments, the text to the left of the arrow must contain two comma-separated names in parentheses. For example, <code>(x, y) -&gt; x + y</code> tells Vulcan that items will be referred to as <code>x</code> and <code>y</code> in the code to the right of the arrow.</p>
<p>Even though the anonymous function takes only two arguments, the input array can contain as many items as necessary.</p>
<p>Consider the anonymous function <code>(x, y) -&gt; x + y</code>. Conceptually, only the <code>y</code> argument corresponds to items in the array; the <code>x</code> argument is a temporary value created when the function is evaluated.</p>
<p>For the call <code>@REDUCE([1,2,3,4], (x, y) -&gt; x + y)</code>, the anonymous function is applied to the array in the following steps:</p>
<ol>
<li>Take the first two items in the array as <code>x</code> and <code>y</code>. Apply the function to them: <code>1 + 2</code> = <code>3</code>.</li>
<li>Take the output of step (1) as <code>x</code> and the next item in the array <code>3</code> as <code>y</code>. Apply the function to them: <code>3 + 3</code> = <code>6</code>.</li>
<li>Take the output of step (2) as <code>x</code> and the next item in the array <code>4</code> as <code>y</code>. Apply the function to them: <code>6 + 4</code> = <code>10</code>.</li>
<li>No items remain. Return value from step (3): <code>10</code>.</li>
</ol>
<p><code>@REDUCE</code> will almost always be used with another macro operator. For example, we might want to build a <code>WHERE</code> clause from multiple column names:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span>
<span class="normal"><a href="#__codelineno-41-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="k">SELECT</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">  </span><span class="n">my_column</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="k">FROM</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">  </span><span class="k">table</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="k">WHERE</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">  </span><span class="n">col1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">col2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">col3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>We can use <code>@EACH</code> to build each column's predicate (e.g., <code>col1 = 1</code>) and <code>@REDUCE</code> to combine them into a single statement:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span>
<span class="normal"><a href="#__codelineno-42-2">2</a></span>
<span class="normal"><a href="#__codelineno-42-3">3</a></span>
<span class="normal"><a href="#__codelineno-42-4">4</a></span>
<span class="normal"><a href="#__codelineno-42-5">5</a></span>
<span class="normal"><a href="#__codelineno-42-6">6</a></span>
<span class="normal"><a href="#__codelineno-42-7">7</a></span>
<span class="normal"><a href="#__codelineno-42-8">8</a></span>
<span class="normal"><a href="#__codelineno-42-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="k">SELECT</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="w">  </span><span class="n">my_column</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="k">FROM</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">  </span><span class="k">table</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="k">WHERE</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w">  </span><span class="o">@</span><span class="n">REDUCE</span><span class="p">(</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w">    </span><span class="o">@</span><span class="k">EACH</span><span class="p">([</span><span class="n">col1</span><span class="p">,</span><span class="w"> </span><span class="n">col2</span><span class="p">,</span><span class="w"> </span><span class="n">col3</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="c1">-- Builds each individual predicate `col1 = 1`</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="w">    </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="c1">-- Combines individual predicates with `AND`</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="w">  </span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="star"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/STAR" title="GitHub User: STAR">@STAR</a><a class="headerlink" href="#star" title="Link to this section">¶</a></h3>
<p><code>@STAR</code> is used to return a set of column selections in a query.</p>
<p><code>@STAR</code> is named after SQL's star operator <code>*</code>, but it allows you to programmatically generate a set of column selections and aliases instead of just selecting all available columns. A query may use more than one <code>@STAR</code> and may also include explicit column selections.</p>
<p><code>@STAR</code> uses Vulcan's knowledge of each table's columns and data types to generate the appropriate column list.</p>
<p>If the column data types are known, the resulting query <code>CAST</code>s columns to their data type in the source table. Otherwise, the columns will be listed without any casting.</p>
<p><code>@STAR</code> supports the following arguments, in this order:</p>
<ul>
<li><code>relation</code>: The relation/table whose columns are being selected</li>
<li><code>alias</code> (optional): The alias of the relation (if it has one)</li>
<li><code>exclude</code> (optional): A list of columns to exclude</li>
<li><code>prefix</code> (optional): A string to use as a prefix for all selected column names</li>
<li><code>suffix</code> (optional): A string to use as a suffix for all selected column names</li>
<li><code>quote_identifiers</code> (optional): Whether to quote the resulting identifiers, defaults to true</li>
</ul>
<p><strong>NOTE</strong>: the <code>exclude</code> argument used to be named <code>except_</code>. The latter is still supported but we discourage its use because it will be deprecated in the future.</p>
<p>Like all Vulcan macro functions, omitting an argument when calling <code>@STAR</code> requires passing subsequent arguments with their name and the special <code>:=</code> keyword operator. For example, we might omit the <code>alias</code> argument with <code>@STAR(foo, exclude := [c])</code>. Learn more about macro function arguments <a href="#positional-and-keyword-arguments">below</a>.</p>
<p>As a <code>@STAR</code> example, consider the following query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span>
<span class="normal"><a href="#__codelineno-43-2">2</a></span>
<span class="normal"><a href="#__codelineno-43-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="k">SELECT</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="w">  </span><span class="o">@</span><span class="n">STAR</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">c</span><span class="p">],</span><span class="w"> </span><span class="s1">'baz_'</span><span class="p">,</span><span class="w"> </span><span class="s1">'_qux'</span><span class="p">)</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bar</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The arguments to <code>@STAR</code> are:</p>
<ol>
<li>The name of the table <code>foo</code> (from the query's <code>FROM foo</code>)</li>
<li>The table alias <code>bar</code> (from the query's <code>AS bar</code>)</li>
<li>A list of columns to exclude from the selection, containing one column <code>c</code></li>
<li>A string <code>baz_</code> to use as a prefix for all column names</li>
<li>A string <code>_qux</code> to use as a suffix for all column names</li>
</ol>
<p><code>foo</code> is a table that contains four columns: <code>a</code> (<code>TEXT</code>), <code>b</code> (<code>TEXT</code>), <code>c</code> (<code>TEXT</code>) and <code>d</code> (<code>INT</code>). After macro expansion, if the column types are known the query would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span>
<span class="normal"><a href="#__codelineno-44-3">3</a></span>
<span class="normal"><a href="#__codelineno-44-4">4</a></span>
<span class="normal"><a href="#__codelineno-44-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="k">SELECT</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"bar"</span><span class="p">.</span><span class="ss">"a"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"baz_a_qux"</span><span class="p">,</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"bar"</span><span class="p">.</span><span class="ss">"b"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"baz_b_qux"</span><span class="p">,</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"bar"</span><span class="p">.</span><span class="ss">"d"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"baz_d_qux"</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bar</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note these aspects of the rendered query:</p>
<ul>
<li>Each column is <code>CAST</code> to its data type in the table <code>foo</code> (e.g., <code>a</code> to <code>TEXT</code>)</li>
<li>Each column selection uses the alias <code>bar</code> (e.g., <code>"bar"."a"</code>)</li>
<li>Column <code>c</code> is not present because it was passed to <code>@STAR</code>'s <code>exclude</code> argument</li>
<li>Each column alias is prefixed with <code>baz_</code> and suffixed with <code>_qux</code> (e.g., <code>"baz_a_qux"</code>)</li>
</ul>
<p>Now consider a more complex example that provides different prefixes to <code>a</code> and <code>b</code> than to <code>d</code> and includes an explicit column <code>my_column</code>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span>
<span class="normal"><a href="#__codelineno-45-2">2</a></span>
<span class="normal"><a href="#__codelineno-45-3">3</a></span>
<span class="normal"><a href="#__codelineno-45-4">4</a></span>
<span class="normal"><a href="#__codelineno-45-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="k">SELECT</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w">  </span><span class="o">@</span><span class="n">STAR</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="n">exclude</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">],</span><span class="w"> </span><span class="s1">'ab_pre_'</span><span class="p">),</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">  </span><span class="o">@</span><span class="n">STAR</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="n">exclude</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">],</span><span class="w"> </span><span class="s1">'d_pre_'</span><span class="p">),</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">  </span><span class="n">my_column</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bar</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>As before, <code>foo</code> is a table that contains four columns: <code>a</code> (<code>TEXT</code>), <code>b</code> (<code>TEXT</code>), <code>c</code> (<code>TEXT</code>) and <code>d</code> (<code>INT</code>). After macro expansion, the query would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span>
<span class="normal"><a href="#__codelineno-46-2">2</a></span>
<span class="normal"><a href="#__codelineno-46-3">3</a></span>
<span class="normal"><a href="#__codelineno-46-4">4</a></span>
<span class="normal"><a href="#__codelineno-46-5">5</a></span>
<span class="normal"><a href="#__codelineno-46-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="k">SELECT</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"bar"</span><span class="p">.</span><span class="ss">"a"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"ab_pre_a"</span><span class="p">,</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"bar"</span><span class="p">.</span><span class="ss">"b"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"ab_pre_b"</span><span class="p">,</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"bar"</span><span class="p">.</span><span class="ss">"d"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"d_pre_d"</span><span class="p">,</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">  </span><span class="n">my_column</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">bar</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note these aspects of the rendered query:</p>
<ul>
<li>Columns <code>a</code> and <code>b</code> have the prefix <code>"ab_pre_"</code> , while column <code>d</code> has the prefix <code>"d_pre_"</code></li>
<li>Column <code>c</code> is not present because it was passed to the <code>exclude</code> argument in both <code>@STAR</code> calls</li>
<li><code>my_column</code> is present in the query</li>
</ul>
<h3 id="generate_surrogate_key"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/GENERATE_SURROGATE_KEY" title="GitHub User: GENERATE_SURROGATE_KEY">@GENERATE_SURROGATE_KEY</a><a class="headerlink" href="#generate_surrogate_key" title="Link to this section">¶</a></h3>
<p><code>@GENERATE_SURROGATE_KEY</code> generates a surrogate key from a set of columns. The surrogate key is a sequence of alphanumeric digits returned by a hash function, such as <a href="https://en.wikipedia.org/wiki/MD5"><code>MD5</code></a>, on the concatenated column values.</p>
<p>The surrogate key is created by:
1. <code>CAST</code>ing each column's value to <code>TEXT</code> (or the SQL engine's equivalent type)
2. Replacing <code>NULL</code> values with the text <code>'_vulcan_surrogate_key_null_'</code> for each column
3. Concatenating the column values after steps (1) and (2)
4. Applying the <a href="https://en.wikipedia.org/wiki/MD5"><code>MD5()</code> hash function</a> to the concatenated value returned by step (3)</p>
<p>For example, the following query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="k">SELECT</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">  </span><span class="o">@</span><span class="n">GENERATE_SURROGATE_KEY</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">col</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="k">SELECT</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="w">  </span><span class="n">MD5</span><span class="p">(</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">    </span><span class="n">CONCAT</span><span class="p">(</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">      </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="ss">"a"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">),</span><span class="w"> </span><span class="s1">'_vulcan_surrogate_key_null_'</span><span class="p">),</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="w">      </span><span class="s1">'|'</span><span class="p">,</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="w">      </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="ss">"b"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">),</span><span class="w"> </span><span class="s1">'_vulcan_surrogate_key_null_'</span><span class="p">),</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="w">      </span><span class="s1">'|'</span><span class="p">,</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">      </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="ss">"c"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">),</span><span class="w"> </span><span class="s1">'_vulcan_surrogate_key_null_'</span><span class="p">)</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"col"</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">"foo"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"foo"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>By default, the <code>MD5</code> function is used, but this behavior can change by setting the <code>hash_function</code> argument as follows:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span>
<span class="normal"><a href="#__codelineno-49-2">2</a></span>
<span class="normal"><a href="#__codelineno-49-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="k">SELECT</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w">  </span><span class="o">@</span><span class="n">GENERATE_SURROGATE_KEY</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">hash_function</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">'SHA256'</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">col</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This query will similarly be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-50-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-50-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-50-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-50-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-50-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-50-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-50-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-50-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-50-10">10</a></span>
<span class="normal"><a href="#__codelineno-50-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="k">SELECT</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="w">  </span><span class="n">SHA256</span><span class="p">(</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="w">    </span><span class="n">CONCAT</span><span class="p">(</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w">      </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="ss">"a"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">),</span><span class="w"> </span><span class="s1">'_vulcan_surrogate_key_null_'</span><span class="p">),</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="w">      </span><span class="s1">'|'</span><span class="p">,</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="w">      </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="ss">"b"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">),</span><span class="w"> </span><span class="s1">'_vulcan_surrogate_key_null_'</span><span class="p">),</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="w">      </span><span class="s1">'|'</span><span class="p">,</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8"></a><span class="w">      </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="ss">"c"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">),</span><span class="w"> </span><span class="s1">'_vulcan_surrogate_key_null_'</span><span class="p">)</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10"></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"col"</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">"foo"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"foo"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="safe_add"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/SAFE_ADD" title="GitHub User: SAFE_ADD">@SAFE_ADD</a><a class="headerlink" href="#safe_add" title="Link to this section">¶</a></h3>
<p><code>@SAFE_ADD</code> adds two or more operands, substituting <code>NULL</code>s with <code>0</code>s. It returns <code>NULL</code> if all operands are <code>NULL</code>.</p>
<p>For example, the following query:</p>
<p></p><div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span>
<span class="normal"><a href="#__codelineno-51-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="k">SELECT</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="w">  </span><span class="o">@</span><span class="n">SAFE_ADD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">)</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
would be rendered as:<p></p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1">1</a></span>
<span class="normal"><a href="#__codelineno-52-2">2</a></span>
<span class="normal"><a href="#__codelineno-52-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="k">SELECT</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">END</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="safe_sub"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/SAFE_SUB" title="GitHub User: SAFE_SUB">@SAFE_SUB</a><a class="headerlink" href="#safe_sub" title="Link to this section">¶</a></h3>
<p><code>@SAFE_SUB</code> subtracts two or more operands, substituting <code>NULL</code>s with <code>0</code>s. It returns <code>NULL</code> if all operands are <code>NULL</code>.</p>
<p>For example, the following query:</p>
<p></p><div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span>
<span class="normal"><a href="#__codelineno-53-2">2</a></span>
<span class="normal"><a href="#__codelineno-53-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="k">SELECT</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="w">  </span><span class="o">@</span><span class="n">SAFE_SUB</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">)</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
would be rendered as:<p></p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1">1</a></span>
<span class="normal"><a href="#__codelineno-54-2">2</a></span>
<span class="normal"><a href="#__codelineno-54-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="k">SELECT</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">END</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="safe_div"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/SAFE_DIV" title="GitHub User: SAFE_DIV">@SAFE_DIV</a><a class="headerlink" href="#safe_div" title="Link to this section">¶</a></h3>
<p><code>@SAFE_DIV</code> divides two numbers, returning <code>NULL</code> if the denominator is <code>0</code>.</p>
<p>For example, the following query:</p>
<p></p><div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span>
<span class="normal"><a href="#__codelineno-55-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="k">SELECT</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="w">  </span><span class="o">@</span><span class="n">SAFE_DIV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
would be rendered as:<p></p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1">1</a></span>
<span class="normal"><a href="#__codelineno-56-2">2</a></span>
<span class="normal"><a href="#__codelineno-56-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="k">SELECT</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="union"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/UNION" title="GitHub User: UNION">@UNION</a><a class="headerlink" href="#union" title="Link to this section">¶</a></h3>
<p><code>@UNION</code> returns a <code>UNION</code> query that selects all columns with matching names and data types from the tables.</p>
<p>Its first argument can be either a condition or the <code>UNION</code> "type". If the first argument evaluates to a boolean (<code>TRUE</code> or <code>FALSE</code>), it's treated as a condition. If the condition is <code>FALSE</code>, only the first table is returned. If it's <code>TRUE</code>, the union operation is performed.</p>
<p>If the first argument is not a boolean condition, it's treated as the <code>UNION</code> "type": either <code>'DISTINCT'</code> (removing duplicated rows) or <code>'ALL'</code> (returning all rows). Subsequent arguments are the tables to be combined.</p>
<p>Let's assume that:</p>
<ul>
<li><code>foo</code> is a table that contains three columns: <code>a</code> (<code>INT</code>), <code>b</code> (<code>TEXT</code>), <code>c</code> (<code>TEXT</code>)</li>
<li><code>bar</code> is a table that contains three columns: <code>a</code> (<code>INT</code>), <code>b</code> (<code>INT</code>), <code>c</code> (<code>TEXT</code>)</li>
</ul>
<p>Then, the following expression:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="o">@</span><span class="k">UNION</span><span class="p">(</span><span class="s1">'distinct'</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1">1</a></span>
<span class="normal"><a href="#__codelineno-58-2">2</a></span>
<span class="normal"><a href="#__codelineno-58-3">3</a></span>
<span class="normal"><a href="#__codelineno-58-4">4</a></span>
<span class="normal"><a href="#__codelineno-58-5">5</a></span>
<span class="normal"><a href="#__codelineno-58-6">6</a></span>
<span class="normal"><a href="#__codelineno-58-7">7</a></span>
<span class="normal"><a href="#__codelineno-58-8">8</a></span>
<span class="normal"><a href="#__codelineno-58-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="k">SELECT</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a><span class="k">UNION</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="k">SELECT</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="k">FROM</span><span class="w"> </span><span class="n">bar</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>If the union type is omitted, <code>'ALL'</code> is used as the default. So the following expression:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="o">@</span><span class="k">UNION</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1">1</a></span>
<span class="normal"><a href="#__codelineno-60-2">2</a></span>
<span class="normal"><a href="#__codelineno-60-3">3</a></span>
<span class="normal"><a href="#__codelineno-60-4">4</a></span>
<span class="normal"><a href="#__codelineno-60-5">5</a></span>
<span class="normal"><a href="#__codelineno-60-6">6</a></span>
<span class="normal"><a href="#__codelineno-60-7">7</a></span>
<span class="normal"><a href="#__codelineno-60-8">8</a></span>
<span class="normal"><a href="#__codelineno-60-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="k">SELECT</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="k">SELECT</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="k">FROM</span><span class="w"> </span><span class="n">bar</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>You can also use a condition to control whether the union happens:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="o">@</span><span class="k">UNION</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">'all'</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This would render the same as above. However, if the condition is <code>FALSE</code>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="o">@</span><span class="k">UNION</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">'all'</span><span class="p">,</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Only the first table would be selected:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1">1</a></span>
<span class="normal"><a href="#__codelineno-63-2">2</a></span>
<span class="normal"><a href="#__codelineno-63-3">3</a></span>
<span class="normal"><a href="#__codelineno-63-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="k">SELECT</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="p">,</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="w">  </span><span class="k">CAST</span><span class="p">(</span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">foo</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="haversine_distance"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/HAVERSINE_DISTANCE" title="GitHub User: HAVERSINE_DISTANCE">@HAVERSINE_DISTANCE</a><a class="headerlink" href="#haversine_distance" title="Link to this section">¶</a></h3>
<p><code>@HAVERSINE_DISTANCE</code> returns the <a href="https://en.wikipedia.org/wiki/Haversine_formula">haversine distance</a> between two geographic points.</p>
<p>It supports the following arguments, in this order:</p>
<ul>
<li><code>lat1</code>: Latitude of the first point</li>
<li><code>lon1</code>: Longitude of the first point</li>
<li><code>lat2</code>: Latitude of the second point</li>
<li><code>lon2</code>: Longitude of the second point</li>
<li><code>unit</code> (optional): The measurement unit, currently only <code>'mi'</code> (miles, default) and <code>'km'</code> (kilometers) are supported</li>
</ul>
<p>Vulcan macro operators do not accept named arguments. For example, <code>@HAVERSINE_DISTANCE(lat1=lat_column)</code> will error.</p>
<p>For example, the following query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1">1</a></span>
<span class="normal"><a href="#__codelineno-64-2">2</a></span>
<span class="normal"><a href="#__codelineno-64-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="k">SELECT</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="w">  </span><span class="o">@</span><span class="n">HAVERSINE_DISTANCE</span><span class="p">(</span><span class="n">driver_y</span><span class="p">,</span><span class="w"> </span><span class="n">driver_x</span><span class="p">,</span><span class="w"> </span><span class="n">passenger_y</span><span class="p">,</span><span class="w"> </span><span class="n">passenger_x</span><span class="p">,</span><span class="w"> </span><span class="s1">'mi'</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dist</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">rides</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1">1</a></span>
<span class="normal"><a href="#__codelineno-65-2">2</a></span>
<span class="normal"><a href="#__codelineno-65-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="k">SELECT</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="w">  </span><span class="mi">7922</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ASIN</span><span class="p">(</span><span class="n">SQRT</span><span class="p">((</span><span class="n">POWER</span><span class="p">(</span><span class="n">SIN</span><span class="p">(</span><span class="n">RADIANS</span><span class="p">((</span><span class="n">passenger_y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">driver_y</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)),</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">COS</span><span class="p">(</span><span class="n">RADIANS</span><span class="p">(</span><span class="n">driver_y</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">COS</span><span class="p">(</span><span class="n">RADIANS</span><span class="p">(</span><span class="n">passenger_y</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">POWER</span><span class="p">(</span><span class="n">SIN</span><span class="p">(</span><span class="n">RADIANS</span><span class="p">((</span><span class="n">passenger_x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">driver_x</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)),</span><span class="w"> </span><span class="mi">2</span><span class="p">))))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dist</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">rides</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="pivot"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/PIVOT" title="GitHub User: PIVOT">@PIVOT</a><a class="headerlink" href="#pivot" title="Link to this section">¶</a></h3>
<p><code>@PIVOT</code> returns a set of columns as a result of pivoting an input column on the specified values. This operation is sometimes described a pivoting from a "long" format (multiple values in a single column) to a "wide" format (one value in each of multiple columns).</p>
<p>It supports the following arguments, in this order:</p>
<ul>
<li><code>column</code>: The column to pivot</li>
<li><code>values</code>: The values to use for pivoting (one column is created for each value in <code>values</code>)</li>
<li><code>alias</code> (optional): Whether to create aliases for the resulting columns, defaults to true</li>
<li><code>agg</code> (optional): The aggregation function to use, defaults to <code>SUM</code></li>
<li><code>cmp</code> (optional): The comparison operator to use for comparing the column values, defaults to <code>=</code></li>
<li><code>prefix</code> (optional): A prefix to use for all aliases</li>
<li><code>suffix</code> (optional): A suffix to use for all aliases</li>
<li><code>then_value</code> (optional): The value to be used if the comparison succeeds, defaults to <code>1</code></li>
<li><code>else_value</code> (optional): The value to be used if the comparison fails, defaults to <code>0</code></li>
<li><code>quote</code> (optional): Whether to quote the resulting aliases, defaults to true</li>
<li><code>distinct</code> (optional): Whether to apply a <code>DISTINCT</code> clause for the aggregation function, defaults to false</li>
</ul>
<p>Like all Vulcan macro functions, omitting an argument when calling <code>@PIVOT</code> requires passing subsequent arguments with their name and the special <code>:=</code> keyword operator. For example, we might omit the <code>agg</code> argument with <code>@PIVOT(status, ['cancelled', 'completed'], cmp := '&lt;')</code>. Learn more about macro function arguments <a href="#positional-and-keyword-arguments">below</a>.</p>
<p>For example, the following query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1">1</a></span>
<span class="normal"><a href="#__codelineno-66-2">2</a></span>
<span class="normal"><a href="#__codelineno-66-3">3</a></span>
<span class="normal"><a href="#__codelineno-66-4">4</a></span>
<span class="normal"><a href="#__codelineno-66-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="k">SELECT</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="w">  </span><span class="n">date_day</span><span class="p">,</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="w">  </span><span class="o">@</span><span class="n">PIVOT</span><span class="p">(</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">'cancelled'</span><span class="p">,</span><span class="w"> </span><span class="s1">'completed'</span><span class="p">])</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4"></a><span class="k">FROM</span><span class="w"> </span><span class="n">rides</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1">1</a></span>
<span class="normal"><a href="#__codelineno-67-2">2</a></span>
<span class="normal"><a href="#__codelineno-67-3">3</a></span>
<span class="normal"><a href="#__codelineno-67-4">4</a></span>
<span class="normal"><a href="#__codelineno-67-5">5</a></span>
<span class="normal"><a href="#__codelineno-67-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="k">SELECT</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="w">  </span><span class="n">date_day</span><span class="p">,</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'cancelled'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"'cancelled'"</span><span class="p">,</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'completed'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"'completed'"</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">rides</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="deduplicate"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/DEDUPLICATE" title="GitHub User: DEDUPLICATE">@DEDUPLICATE</a><a class="headerlink" href="#deduplicate" title="Link to this section">¶</a></h3>
<p><code>@DEDUPLICATE</code> is used to deduplicate rows in a table based on the specified partition and order columns with a window function.</p>
<p>It supports the following arguments, in this order:</p>
<ul>
<li><code>relation</code>: The table or CTE name to deduplicate</li>
<li><code>partition_by</code>: column names, or expressions to use to identify a window of rows out of which to select one as the deduplicated row</li>
<li><code>order_by</code>: A list of strings representing the ORDER BY clause, optional - you can add nulls ordering like this: ['<column_name> desc nulls last']</column_name></li>
</ul>
<p>For example, the following query:
</p><div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1">1</a></span>
<span class="normal"><a href="#__codelineno-68-2">2</a></span>
<span class="normal"><a href="#__codelineno-68-3">3</a></span>
<span class="normal"><a href="#__codelineno-68-4">4</a></span>
<span class="normal"><a href="#__codelineno-68-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="k">with</span><span class="w"> </span><span class="n">raw_data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="o">@</span><span class="n">deduplicate</span><span class="p">(</span><span class="n">my_table</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="n">event_date</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span><span class="p">)],</span><span class="w"> </span><span class="p">[</span><span class="s1">'event_date DESC'</span><span class="p">,</span><span class="w"> </span><span class="s1">'status ASC'</span><span class="p">])</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="p">)</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4"></a>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">raw_data</span>
</span></code></pre></div></td></tr></tbody></table></div><p></p>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-69-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-69-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-69-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-69-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-69-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-69-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-69-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-69-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-69-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="k">WITH</span><span class="w"> </span><span class="ss">"raw_data"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2"></a><span class="w">  </span><span class="k">SELECT</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="w">    </span><span class="o">*</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="ss">"my_table"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"my_table"</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w">  </span><span class="n">QUALIFY</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="w">    </span><span class="n">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="ss">"id"</span><span class="p">,</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="ss">"event_date"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="ss">"event_date"</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="ss">"status"</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7"></a><span class="p">)</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8"></a><span class="k">SELECT</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9"></a><span class="w">  </span><span class="o">*</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">"raw_data"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"raw_data"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="date_spine"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/DATE_SPINE" title="GitHub User: DATE_SPINE">@DATE_SPINE</a><a class="headerlink" href="#date_spine" title="Link to this section">¶</a></h3>
<p><code>@DATE_SPINE</code> returns the SQL required to build a date spine. The spine will include the start_date (if it is aligned to the datepart), AND it will include the end_date. This is different from the <a href="https://github.com/dbt-labs/dbt-utils?tab=readme-ov-file#date_spine-source"><code>date_spine</code></a> macro in <code>dbt-utils</code> which will NOT include the end_date. It's typically used to join in unique, hard-coded, date ranges to with other tables/views, so people don't have to constantly adjust date ranges in <code>where</code> clauses across many SQL models.</p>
<p>It supports the following arguments, in this order:</p>
<ul>
<li><code>datepart</code>: The datepart to use for the date spine - day, week, month, quarter, year</li>
<li><code>start_date</code>: The start date for the date spine in format YYYY-MM-DD</li>
<li><code>end_date</code>: The end date for the date spine in format YYYY-MM-DD</li>
</ul>
<p>For example, the following query:
</p><div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1">1</a></span>
<span class="normal"><a href="#__codelineno-70-2">2</a></span>
<span class="normal"><a href="#__codelineno-70-3">3</a></span>
<span class="normal"><a href="#__codelineno-70-4">4</a></span>
<span class="normal"><a href="#__codelineno-70-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="k">WITH</span><span class="w"> </span><span class="n">discount_promotion_dates</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="w">  </span><span class="o">@</span><span class="n">date_spine</span><span class="p">(</span><span class="s1">'day'</span><span class="p">,</span><span class="w"> </span><span class="s1">'2024-01-01'</span><span class="p">,</span><span class="w"> </span><span class="s1">'2024-01-16'</span><span class="p">)</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="p">)</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4"></a>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">discount_promotion_dates</span>
</span></code></pre></div></td></tr></tbody></table></div><p></p>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1">1</a></span>
<span class="normal"><a href="#__codelineno-71-2">2</a></span>
<span class="normal"><a href="#__codelineno-71-3">3</a></span>
<span class="normal"><a href="#__codelineno-71-4">4</a></span>
<span class="normal"><a href="#__codelineno-71-5">5</a></span>
<span class="normal"><a href="#__codelineno-71-6">6</a></span>
<span class="normal"><a href="#__codelineno-71-7">7</a></span>
<span class="normal"><a href="#__codelineno-71-8">8</a></span>
<span class="normal"><a href="#__codelineno-71-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="k">WITH</span><span class="w"> </span><span class="ss">"discount_promotion_dates"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2"></a><span class="w">  </span><span class="k">SELECT</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3"></a><span class="w">    </span><span class="ss">"_exploded"</span><span class="p">.</span><span class="ss">"date_day"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"date_day"</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="k">UNNEST</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">GENERATE_SERIES</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="s1">'2024-01-01'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'2024-01-16'</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DATE</span><span class="p">),</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="k">DAY</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5"></a><span class="nb">DATE</span><span class="p">[]))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"_exploded"</span><span class="p">(</span><span class="ss">"date_day"</span><span class="p">)</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6"></a><span class="p">)</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7"></a><span class="k">SELECT</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8"></a><span class="w">  </span><span class="ss">"discount_promotion_dates"</span><span class="p">.</span><span class="ss">"date_day"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"date_day"</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">"discount_promotion_dates"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"discount_promotion_dates"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note: This is DuckDB SQL and other dialects will be transpiled accordingly.
- Recursive CTEs (common table expressions) will be used for <code>Redshift / MySQL / MSSQL</code>.
- For <code>MSSQL</code> in particular, there's a recursion limit of approximately 100. If this becomes a problem, you can add an <code>OPTION (MAXRECURSION 0)</code> clause after the date spine macro logic to remove the limit. This applies for long date ranges.</p>
<h3 id="resolve_template"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/RESOLVE_TEMPLATE" title="GitHub User: RESOLVE_TEMPLATE">@RESOLVE_TEMPLATE</a><a class="headerlink" href="#resolve_template" title="Link to this section">¶</a></h3>
<p><code>@resolve_template</code> is a helper macro intended to be used in situations where you need to gain access to the <em>components</em> of the physical object name. It's intended for use in the following situations:</p>
<ul>
<li>Providing explicit control over table locations on a per-model basis for engines that decouple storage and compute (such as Athena, Trino, Spark etc)</li>
<li>Generating references to engine-specific metadata tables that are derived from the physical table name, such as the <a href="https://trino.io/docs/current/connector/iceberg.html#metadata-tables"><code>&lt;table&gt;$properties</code></a> metadata table in Trino.</li>
</ul>
<p>Under the hood, it uses the <code>@this_model</code> variable so it can only be used during the <code>creating</code> and <code>evaluation</code> <a href="../macro_variables/#runtime-variables">runtime stages</a>. Attempting to use it at the <code>loading</code> runtime stage will result in a no-op.</p>
<p>The <code>@resolve_template</code> macro supports the following arguments:</p>
<ul>
<li><code>template</code> - The string template to render into an AST node</li>
<li><code>mode</code> - What type of SQLGlot AST node to return after rendering the template. Valid values are <code>literal</code> or <code>table</code>. Defaults to <code>literal</code>.</li>
</ul>
<p>The <code>template</code> can contain the following placeholders that will be substituted:</p>
<ul>
<li><code>@{catalog_name}</code> - The name of the catalog, eg <code>datalake</code></li>
<li><code>@{schema_name}</code> - The name of the physical schema that Vulcan is using for the model version table, eg <code>vulcan__landing</code></li>
<li><code>@{table_name}</code> - The name of the physical table that Vulcan is using for the model version, eg <code>landing__customers__2517971505</code></li>
</ul>
<p>Note the use of the curly brace syntax <code>@{}</code> in the template placeholders - learn more <a href="#embedding-variables-in-strings">above</a>.</p>
<p>The <code>@resolve_template</code> macro can be used in a <code>MODEL</code> block:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span>
<span class="normal"><a href="#__codelineno-72-2">2</a></span>
<span class="normal"><a href="#__codelineno-72-3">3</a></span>
<span class="normal"><a href="#__codelineno-72-4">4</a></span>
<span class="normal"><a href="#__codelineno-72-5">5</a></span>
<span class="normal"><a href="#__codelineno-72-6">6</a></span>
<span class="normal"><a href="#__codelineno-72-7">7</a></span>
<span class="normal"><a href="#__codelineno-72-8">8</a></span>
<span class="normal"><a href="#__codelineno-72-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">datalake</span><span class="p">.</span><span class="n">landing</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4"></a><span class="w">  </span><span class="n">physical_properties</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5"></a><span class="hll"><span class="w">    </span><span class="k">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">resolve_template</span><span class="p">(</span><span class="s1">'s3://warehouse-data/@{catalog_name}/prod/@{schema_name}/@{table_name}'</span><span class="p">)</span>
</span></span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7"></a><span class="p">);</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8"></a><span class="c1">-- CREATE TABLE "datalake"."vulcan__landing"."landing__customers__2517971505" ...</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9"></a><span class="c1">-- WITH (location = 's3://warehouse-data/datalake/prod/vulcan__landing/landing__customers__2517971505')</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>And also within a query, using <code>mode := 'table'</code>:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1">1</a></span>
<span class="normal"><a href="#__codelineno-73-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">resolve_template</span><span class="p">(</span><span class="s1">'@{catalog_name}.@{schema_name}.@{table_name}$properties'</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">'table'</span><span class="p">)</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2"></a><span class="c1">-- SELECT * FROM "datalake"."vulcan__landing"."landing__customers__2517971505$properties"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="and"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/AND" title="GitHub User: AND">@AND</a><a class="headerlink" href="#and" title="Link to this section">¶</a></h3>
<p><code>@AND</code> combines a sequence of operands using the <code>AND</code> operator, filtering out any NULL expressions.</p>
<p>For example, the following expression:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="o">@</span><span class="k">AND</span><span class="p">(</span><span class="k">TRUE</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="k">TRUE</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="or"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/OR" title="GitHub User: OR">@OR</a><a class="headerlink" href="#or" title="Link to this section">¶</a></h3>
<p><code>@OR</code> combines a sequence of operands using the <code>OR</code> operator, filtering out any NULL expressions.</p>
<p>For example, the following expression:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1"></a><span class="o">@</span><span class="k">OR</span><span class="p">(</span><span class="k">TRUE</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>would be rendered as:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="k">TRUE</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="sql-clause-operators">SQL clause operators<a class="headerlink" href="#sql-clause-operators" title="Link to this section">¶</a></h3>
<p>Vulcan's macro system has six operators that correspond to different clauses in SQL syntax. They are:</p>
<ul>
<li><code>@WITH</code>: common table expression <code>WITH</code> clause</li>
<li><code>@JOIN</code>: table <code>JOIN</code> clause(s)</li>
<li><code>@WHERE</code>: filtering <code>WHERE</code> clause</li>
<li><code>@GROUP_BY</code>: grouping <code>GROUP BY</code> clause</li>
<li><code>@HAVING</code>: group by filtering <code>HAVING</code> clause</li>
<li><code>@ORDER_BY</code>: ordering <code>ORDER BY</code> clause</li>
<li><code>@LIMIT</code>: limiting <code>LIMIT</code> clause</li>
</ul>
<p>Each of these operators is used to dynamically add the code for its corresponding clause to a model's SQL query.</p>
<h4 id="how-sql-clause-operators-work">How SQL clause operators work<a class="headerlink" href="#how-sql-clause-operators-work" title="Link to this section">¶</a></h4>
<p>The SQL clause operators take a single argument that determines whether the clause is generated.</p>
<p>If the argument is <code>TRUE</code> the clause code is generated, if <code>FALSE</code> the code is not. The argument should be written <em>in SQL</em> and its value is evaluated with <a href="https://github.com/tobymao/sqlglot">SQLGlot's</a> SQL engine.</p>
<p>Each SQL clause operator may only be used once in a query, but any common table expressions or subqueries may contain their own single use of the operator as well.</p>
<p>As an example of SQL clause operators, let's revisit the example model from the <a href="#user-defined-variables">User-defined Variables</a> section above.</p>
<p>As written, the model will always include the <code>WHERE</code> clause. We could make its presence dynamic by using the <code>@WHERE</code> macro operator:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span>
<span class="normal"><a href="#__codelineno-78-14">14</a></span>
<span class="normal"><a href="#__codelineno-78-15">15</a></span>
<span class="normal"><a href="#__codelineno-78-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="p">,</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4"></a><span class="w">  </span><span class="n">cron</span><span class="w"> </span><span class="s1">'@daily'</span><span class="p">,</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5"></a><span class="w">  </span><span class="n">audits</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_order_ids</span><span class="p">),</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6"></a><span class="p">);</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7"></a>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9"></a>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10"></a><span class="k">SELECT</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13"></a><span class="k">FROM</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15"></a><span class="o">@</span><span class="k">WHERE</span><span class="p">(</span><span class="k">TRUE</span><span class="p">)</span><span class="w"> </span><span class="n">item_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">size</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The <code>@WHERE</code> argument is set to <code>TRUE</code>, so the WHERE code is included in the rendered model:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1">1</a></span>
<span class="normal"><a href="#__codelineno-79-2">2</a></span>
<span class="normal"><a href="#__codelineno-79-3">3</a></span>
<span class="normal"><a href="#__codelineno-79-4">4</a></span>
<span class="normal"><a href="#__codelineno-79-5">5</a></span>
<span class="normal"><a href="#__codelineno-79-6">6</a></span>
<span class="normal"><a href="#__codelineno-79-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="k">SELECT</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4"></a><span class="k">FROM</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">item_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>If the <code>@WHERE</code> argument were instead set to <code>FALSE</code> the <code>WHERE</code> clause would be omitted from the query.</p>
<p>These operators aren't too useful if the argument's value is hard-coded. Instead, the argument can consist of code executable by the SQLGlot SQL executor.</p>
<p>For example, the <code>WHERE</code> clause will be included in this query because 1 less than 2:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="p">,</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="w">  </span><span class="n">cron</span><span class="w"> </span><span class="s1">'@daily'</span><span class="p">,</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5"></a><span class="w">  </span><span class="n">audits</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_order_ids</span><span class="p">),</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="p">);</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7"></a>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9"></a>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="k">SELECT</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="k">FROM</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="o">@</span><span class="k">WHERE</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">item_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">size</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The operator's argument code can include macro variables.</p>
<p>In this example, the two numbers being compared are defined as macro variables instead of being hard-coded:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span>
<span class="normal"><a href="#__codelineno-81-13">13</a></span>
<span class="normal"><a href="#__codelineno-81-14">14</a></span>
<span class="normal"><a href="#__codelineno-81-15">15</a></span>
<span class="normal"><a href="#__codelineno-81-16">16</a></span>
<span class="normal"><a href="#__codelineno-81-17">17</a></span>
<span class="normal"><a href="#__codelineno-81-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">full_model</span><span class="p">,</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4"></a><span class="w">  </span><span class="n">cron</span><span class="w"> </span><span class="s1">'@daily'</span><span class="p">,</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5"></a><span class="w">  </span><span class="n">audits</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_order_ids</span><span class="p">),</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6"></a><span class="p">);</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7"></a>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">left_number</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">right_number</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="k">size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11"></a>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12"></a><span class="k">SELECT</span>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13"></a><span class="w">  </span><span class="n">item_id</span><span class="p">,</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14"></a><span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_orders</span><span class="p">,</span>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15"></a><span class="k">FROM</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16"></a><span class="w">  </span><span class="n">vulcan_example</span><span class="p">.</span><span class="n">incremental_model</span>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17"></a><span class="o">@</span><span class="k">WHERE</span><span class="p">(</span><span class="o">@</span><span class="n">left_number</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">right_number</span><span class="p">)</span><span class="w"> </span><span class="n">item_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">size</span>
</span><span id="__span-81-18"><a id="__codelineno-81-18" name="__codelineno-81-18"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The argument to <code>@WHERE</code> will be "1 &lt; 2" as in the previous hard-coded example after the macro variables <code>left_number</code> and <code>right_number</code> are substituted in.</p>
<h3 id="sql-clause-operator-examples">SQL clause operator examples<a class="headerlink" href="#sql-clause-operator-examples" title="Link to this section">¶</a></h3>
<p>This section provides brief examples of each SQL clause operator's usage.</p>
<p>The examples use variants of this simple select statement:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1">1</a></span>
<span class="normal"><a href="#__codelineno-82-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="with-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/WITH" title="GitHub User: WITH">@WITH</a> operator<a class="headerlink" href="#with-operator" title="Link to this section">¶</a></h4>
<p>The <code>@WITH</code> operator is used to create <a href="https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL#Common_table_expression">common table expressions</a>, or "CTEs."</p>
<p>CTEs are typically used in place of derived tables (subqueries in the <code>FROM</code> clause) to make SQL code easier to read. Less commonly, recursive CTEs support analysis of hierarchical data with SQL.</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1">1</a></span>
<span class="normal"><a href="#__codelineno-83-2">2</a></span>
<span class="normal"><a href="#__codelineno-83-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="o">@</span><span class="k">WITH</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="n">all_cities</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">city</span><span class="p">)</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1">1</a></span>
<span class="normal"><a href="#__codelineno-84-2">2</a></span>
<span class="normal"><a href="#__codelineno-84-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="k">WITH</span><span class="w"> </span><span class="n">all_cities</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">city</span><span class="p">)</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="join-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/JOIN" title="GitHub User: JOIN">@JOIN</a> operator<a class="headerlink" href="#join-operator" title="Link to this section">¶</a></h4>
<p>The <code>@JOIN</code> operator specifies joins between tables or other SQL objects; it supports different join types (e.g., INNER, OUTER, CROSS, etc.).</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1">1</a></span>
<span class="normal"><a href="#__codelineno-85-2">2</a></span>
<span class="normal"><a href="#__codelineno-85-3">3</a></span>
<span class="normal"><a href="#__codelineno-85-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="o">@</span><span class="k">JOIN</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="n">country</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">city</span><span class="p">.</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country</span><span class="p">.</span><span class="n">name</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1">1</a></span>
<span class="normal"><a href="#__codelineno-86-2">2</a></span>
<span class="normal"><a href="#__codelineno-86-3">3</a></span>
<span class="normal"><a href="#__codelineno-86-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">country</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">city</span><span class="p">.</span><span class="n">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country</span><span class="p">.</span><span class="n">name</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The <code>@JOIN</code> operator recognizes that <code>LEFT OUTER</code> is a component of the <code>JOIN</code> specification and will omit it if the <code>@JOIN</code> argument evaluates to False.</p>
<h4 id="where-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/WHERE" title="GitHub User: WHERE">@WHERE</a> operator<a class="headerlink" href="#where-operator" title="Link to this section">¶</a></h4>
<p>The <code>@WHERE</code> operator adds a filtering <code>WHERE</code> clause(s) to the query when its argument evaluates to True.</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1">1</a></span>
<span class="normal"><a href="#__codelineno-87-2">2</a></span>
<span class="normal"><a href="#__codelineno-87-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3"></a><span class="o">@</span><span class="k">WHERE</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="n">city_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Toronto'</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1">1</a></span>
<span class="normal"><a href="#__codelineno-88-2">2</a></span>
<span class="normal"><a href="#__codelineno-88-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">city_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Toronto'</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="group_by-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/GROUP_BY" title="GitHub User: GROUP_BY">@GROUP_BY</a> operator<a class="headerlink" href="#group_by-operator" title="Link to this section">¶</a></h4>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1">1</a></span>
<span class="normal"><a href="#__codelineno-89-2">2</a></span>
<span class="normal"><a href="#__codelineno-89-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3"></a><span class="o">@</span><span class="n">GROUP_BY</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="n">city_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1">1</a></span>
<span class="normal"><a href="#__codelineno-90-2">2</a></span>
<span class="normal"><a href="#__codelineno-90-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">city_id</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="having-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/HAVING" title="GitHub User: HAVING">@HAVING</a> operator<a class="headerlink" href="#having-operator" title="Link to this section">¶</a></h4>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1">1</a></span>
<span class="normal"><a href="#__codelineno-91-2">2</a></span>
<span class="normal"><a href="#__codelineno-91-3">3</a></span>
<span class="normal"><a href="#__codelineno-91-4">4</a></span>
<span class="normal"><a href="#__codelineno-91-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1"></a><span class="k">SELECT</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2"></a><span class="k">count</span><span class="p">(</span><span class="n">city_pop</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">population</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">city_id</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5"></a><span class="o">@</span><span class="k">HAVING</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="n">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1">1</a></span>
<span class="normal"><a href="#__codelineno-92-2">2</a></span>
<span class="normal"><a href="#__codelineno-92-3">3</a></span>
<span class="normal"><a href="#__codelineno-92-4">4</a></span>
<span class="normal"><a href="#__codelineno-92-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1"></a><span class="k">SELECT</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2"></a><span class="k">count</span><span class="p">(</span><span class="n">city_pop</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">population</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">city_id</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5"></a><span class="k">HAVING</span><span class="w"> </span><span class="n">population</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="order_by-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/ORDER_BY" title="GitHub User: ORDER_BY">@ORDER_BY</a> operator<a class="headerlink" href="#order_by-operator" title="Link to this section">¶</a></h4>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1">1</a></span>
<span class="normal"><a href="#__codelineno-93-2">2</a></span>
<span class="normal"><a href="#__codelineno-93-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3"></a><span class="o">@</span><span class="n">ORDER_BY</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="n">city_pop</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-94-1">1</a></span>
<span class="normal"><a href="#__codelineno-94-2">2</a></span>
<span class="normal"><a href="#__codelineno-94-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3"></a><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">city_pop</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="limit-operator"><a class="magiclink magiclink-github magiclink-mention" href="https://github.com/LIMIT" title="GitHub User: LIMIT">@LIMIT</a> operator<a class="headerlink" href="#limit-operator" title="Link to this section">¶</a></h4>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-95-1">1</a></span>
<span class="normal"><a href="#__codelineno-95-2">2</a></span>
<span class="normal"><a href="#__codelineno-95-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3"></a><span class="o">@</span><span class="k">LIMIT</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="mi">10</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>renders to</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-96-1">1</a></span>
<span class="normal"><a href="#__codelineno-96-2">2</a></span>
<span class="normal"><a href="#__codelineno-96-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">all_cities</span>
</span><span id="__span-96-3"><a id="__codelineno-96-3" name="__codelineno-96-3"></a><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h2 id="user-defined-macro-functions">User-defined macro functions<a class="headerlink" href="#user-defined-macro-functions" title="Link to this section">¶</a></h2>
<p>User-defined macro functions allow the same macro code to be used in multiple models.</p>
<p>Vulcan supports user-defined macro functions written in two languages - SQL and Python:</p>
<ul>
<li>SQL macro functions must use the <a href="../jinja_macros/#user-defined-macro-functions">Jinja templating system</a>.</li>
<li>Python macro functions use the SQLGlot library to allow more complex operations than macro variables and operators provide alone.</li>
</ul>
<h3 id="python-macro-functions">Python macro functions<a class="headerlink" href="#python-macro-functions" title="Link to this section">¶</a></h3>
<h4 id="setup">Setup<a class="headerlink" href="#setup" title="Link to this section">¶</a></h4>
<p>Python macro functions should be placed in <code>.py</code> files in the Vulcan project's <code>macros</code> directory. Multiple functions can be defined in one <code>.py</code> file, or they can be distributed across multiple files.</p>
<p>An empty <code>__init__.py</code> file must be present in the Vulcan project's <code>macros</code> directory. It will be created automatically when the project scaffold is created with <code>vulcan init</code>.</p>
<p>Each <code>.py</code> file containing a macro definition must import Vulcan's <code>macro</code> decorator with <code>from vulcan import macro</code>.</p>
<p>Python macros are defined as regular python functions adorned with the Vulcan <code>@macro()</code> decorator. The first argument to the function must be <code>evaluator</code>, which provides the macro evaluation context in which the macro function will run.</p>
<h4 id="inputs-and-outputs">Inputs and outputs<a class="headerlink" href="#inputs-and-outputs" title="Link to this section">¶</a></h4>
<p>Python macros parse all arguments passed to the macro call with SQLGlot before they are used in the function body. Therefore, unless <a href="#argument-data-types">argument type annotations are provided</a> in the function definition, the macro function code must process SQLGlot expressions and may need to extract the expression's attributes/contents for use.</p>
<p>Python macro functions may return values of either <code>string</code> or SQLGlot <code>expression</code> types. Vulcan will automatically parse returned strings into a SQLGlot expression after the function is executed so they can be incorporated into the model query's semantic representation.</p>
<p>Macro functions may <a href="#returning-more-than-one-value">return a list of strings or expressions</a> that all play the same role in the query (e.g., specifying column definitions). For example, a list containing multiple <code>CASE WHEN</code> statements would be incorporated into the query properly, but a list containing both <code>CASE WHEN</code> statements and a <code>WHERE</code> clause would not.</p>
<h4 id="macro-function-basics">Macro function basics<a class="headerlink" href="#macro-function-basics" title="Link to this section">¶</a></h4>
<p>This example demonstrates the core requirements for defining a python macro - it takes no user-supplied arguments and returns the string <code>text</code>.</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-97-1">1</a></span>
<span class="normal"><a href="#__codelineno-97-2">2</a></span>
<span class="normal"><a href="#__codelineno-97-3">3</a></span>
<span class="normal"><a href="#__codelineno-97-4">4</a></span>
<span class="normal"><a href="#__codelineno-97-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2"></a>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3"></a><span class="nd">@macro</span><span class="p">()</span> <span class="c1"># Note parentheses at end of `@macro()` decorator</span>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_text</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5"></a>  <span class="k">return</span> <span class="s1">'text'</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>We could use this in a Vulcan SQL model like this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-98-1">1</a></span>
<span class="normal"><a href="#__codelineno-98-2">2</a></span>
<span class="normal"><a href="#__codelineno-98-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1"></a><span class="k">SELECT</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2"></a><span class="w">  </span><span class="o">@</span><span class="n">print_text</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">my_text</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>After processing, it will render to this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-99-1">1</a></span>
<span class="normal"><a href="#__codelineno-99-2">2</a></span>
<span class="normal"><a href="#__codelineno-99-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1"></a><span class="k">SELECT</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2"></a><span class="w">  </span><span class="nb">text</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">my_text</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note that the python function returned a string <code>'text'</code>, but the rendered query uses <code>text</code> as a column name. That is due to the function's returned text being parsed as SQL code by SQLGlot and integrated into the query's semantic representation.</p>
<p>The rendered query will treat <code>text</code> as a string if we double-quote the single-quoted value in the function definition as <code>"'text'"</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-100-1">1</a></span>
<span class="normal"><a href="#__codelineno-100-2">2</a></span>
<span class="normal"><a href="#__codelineno-100-3">3</a></span>
<span class="normal"><a href="#__codelineno-100-4">4</a></span>
<span class="normal"><a href="#__codelineno-100-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2"></a>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_text</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5"></a>    <span class="k">return</span> <span class="s2">"'text'"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>When run in the same model query as before, this will render to:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-101-1">1</a></span>
<span class="normal"><a href="#__codelineno-101-2">2</a></span>
<span class="normal"><a href="#__codelineno-101-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1"></a><span class="k">SELECT</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2"></a><span class="w">  </span><span class="s1">'text'</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">my_text</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="argument-data-types">Argument data types<a class="headerlink" href="#argument-data-types" title="Link to this section">¶</a></h4>
<p>Most macro functions provide arguments so users can supply custom values when the function is called. The data type of the argument plays a key role in how the macro code processes its value, and providing type annotations in the macro definition ensures that the macro code receives the data type it expects. This section provides a brief description of Vulcan macro type annotation - find additional information <a href="#typed-macros">below</a>.</p>
<p>As <a href="#inputs-and-outputs">mentioned above</a>, argument values passed to the macro call are parsed by SQLGlot before they become available to the function code. If an argument does not have a type annotation in the macro function definition, its value will always be a SQLGlot expression in the function body. Therefore, the macro function code must operate directly on the expression (and may need to extract information from it before usage).</p>
<p>If an argument does have a type annotation in the macro function definition, the value passed to the macro call will be coerced to that type after parsing by SQLGlot and before the values are used in the function body. Essentially, Vulcan will extract the relevant information of the annotated data type from the expression for you (if possible).</p>
<p>For example, this macro function determines whether an argument's value is any of the integers 1, 2, or 3:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-102-1">1</a></span>
<span class="normal"><a href="#__codelineno-102-2">2</a></span>
<span class="normal"><a href="#__codelineno-102-3">3</a></span>
<span class="normal"><a href="#__codelineno-102-4">4</a></span>
<span class="normal"><a href="#__codelineno-102-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2"></a>
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">arg_in_123</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">my_arg</span><span class="p">):</span>
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5"></a>    <span class="k">return</span> <span class="n">my_arg</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>When this macro is called, it will return <code>FALSE</code> even if an integer was passed in the call. Consider this macro call:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-103-1">1</a></span>
<span class="normal"><a href="#__codelineno-103-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1"></a><span class="k">SELECT</span>
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2"></a><span class="w">  </span><span class="o">@</span><span class="n">arg_in_123</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>It returns <code>SELECT FALSE</code> because:</p>
<ol>
<li>The passed value <code>1</code> is parsed by SQLGlot into a SQLGlot expression before the function code executes and</li>
<li>There is no matching SQLGlot expression in <code>[1,2,3]</code></li>
</ol>
<p>However, the macro will treat the argument like a normal Python function does if we annotate <code>my_arg</code> with the integer <code>int</code> type in the function definition:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-104-1">1</a></span>
<span class="normal"><a href="#__codelineno-104-2">2</a></span>
<span class="normal"><a href="#__codelineno-104-3">3</a></span>
<span class="normal"><a href="#__codelineno-104-4">4</a></span>
<span class="normal"><a href="#__codelineno-104-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2"></a>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">arg_in_123</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">my_arg</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># Type annotation `my_arg: int`</span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5"></a>    <span class="k">return</span> <span class="n">my_arg</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Now the macro call will return <code>SELECT TRUE</code> because the value is coerced to a Python integer before the function code executes and <code>1</code> is in <code>[1,2,3]</code>.</p>
<p>If an argument has a default value, the value is not parsed by SQLGlot before the function code executes. Therefore, take care to ensure that the default's data type matches that of a user-supplied argument by adding a type annotation, making the default value a SQLGlot expression, or making the default value <code>None</code>.</p>
<h4 id="positional-and-keyword-arguments">Positional and keyword arguments<a class="headerlink" href="#positional-and-keyword-arguments" title="Link to this section">¶</a></h4>
<p>In a macro call, the arguments may be provided by position if none are skipped.</p>
<p>For example, consider the <code>add_args()</code> function - it has three arguments with default values provided in the function definition:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-105-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-105-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-105-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-105-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-105-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-105-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-105-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-105-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-105-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-105-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2"></a>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">add_args</span><span class="p">(</span>
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5"></a>    <span class="n">evaluator</span><span class="p">,</span>
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6"></a>    <span class="n">argument_1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-105-7"><a id="__codelineno-105-7" name="__codelineno-105-7"></a>    <span class="n">argument_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="__span-105-8"><a id="__codelineno-105-8" name="__codelineno-105-8"></a>    <span class="n">argument_3</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-105-9"><a id="__codelineno-105-9" name="__codelineno-105-9"></a><span class="p">):</span>
</span><span id="__span-105-10"><a id="__codelineno-105-10" name="__codelineno-105-10"></a>    <span class="k">return</span> <span class="n">argument_1</span> <span class="o">+</span> <span class="n">argument_2</span> <span class="o">+</span> <span class="n">argument_3</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>An <code>@add_args</code> call providing values for all arguments accepts positional arguments like this: <code>@add_args(5, 6, 7)</code> (which returns 5 + 6 + 7 = <code>18</code>). A call omitting and using the default value for the the final <code>argument_3</code> can also use positional arguments: <code>@add_args(5, 6)</code> (which returns 5 + 6 + 3 = <code>14</code>).</p>
<p>However, skipping an argument requires specifying the names of subsequent arguments (i.e., using "keyword arguments"). For example, skipping the second argument above by just omitting it - <code>@add_args(5, , 7)</code> - results in an error.</p>
<p>Unlike Python, Vulcan keyword arguments must use the special operator <code>:=</code>. To skip and use the default value for the second argument above, the call must name the third argument: <code>@add_args(5, argument_3 := 8)</code> (which returns 5 + 2 + 8 = <code>15</code>).</p>
<h4 id="variable-length-arguments">Variable-length arguments<a class="headerlink" href="#variable-length-arguments" title="Link to this section">¶</a></h4>
<p>The <code>add_args()</code> macro defined in the <a href="#positional-and-keyword-arguments">previous section</a> accepts only three arguments and requires that all three have a value. This greatly limits the macro's flexibility because users may want to add any number of values together.</p>
<p>The macro can be improved by allowing users to provide any number of arguments at call time. We use Python's "variable-length arguments" to accomplish this:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-106-1">1</a></span>
<span class="normal"><a href="#__codelineno-106-2">2</a></span>
<span class="normal"><a href="#__codelineno-106-3">3</a></span>
<span class="normal"><a href="#__codelineno-106-4">4</a></span>
<span class="normal"><a href="#__codelineno-106-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2"></a>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">add_args</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># Variable-length arguments of integer type `*args: int`</span>
</span><span id="__span-106-5"><a id="__codelineno-106-5" name="__codelineno-106-5"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This macro can be called with one or more arguments. For example:</p>
<ul>
<li><code>@add_args(1)</code> returns 1</li>
<li><code>@add_args(1, 2)</code> returns 3</li>
<li><code>@add_args(1, 2, 3)</code> returns 6</li>
</ul>
<h4 id="returning-more-than-one-value">Returning more than one value<a class="headerlink" href="#returning-more-than-one-value" title="Link to this section">¶</a></h4>
<p>Macro functions are a convenient way to tidy model code by creating multiple outputs from one function call. Python macro functions do this by returning a list of strings or SQLGlot expressions.</p>
<p>For example, we might want to create indicator variables from the values in a string column. We can do that by passing in the name of column and a list of values for which it should create indicators, which we then interpolate into <code>CASE WHEN</code> statements.</p>
<p>Because Vulcan parses the input objects, they become SQLGLot expressions in the function body. Therefore, the function code <strong>cannot</strong> treat the input list as a regular Python list.</p>
<p>Two things will happen to the input Python list before the function code is executed:</p>
<ol>
<li>
<p>Each of its entries will be parsed by SQLGlot. Different inputs are parsed into different SQLGlot expressions:</p>
<ul>
<li>Numbers are parsed into <a href="https://sqlglot.com/sqlglot/expressions.html#Literal"><code>Literal</code> expressions</a></li>
<li>Quoted strings are parsed into <a href="https://sqlglot.com/sqlglot/expressions.html#Literal"><code>Literal</code> expressions</a></li>
<li>Unquoted strings are parsed into <a href="https://sqlglot.com/sqlglot/expressions.html#Column"><code>Column</code> expressions</a></li>
</ul>
</li>
<li>
<p>The parsed entries will be contained in a SQLGlot <a href="https://sqlglot.com/sqlglot/expressions.html#Array"><code>Array</code> expression</a>, the SQL entity analogous to a Python list</p>
</li>
</ol>
<p>Because the input  <code>Array</code> expression named <code>values</code> is not a Python list, we cannot iterate over it directly - instead, we iterate over its <code>expressions</code> attribute with <code>values.expressions</code>:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-107-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-107-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-107-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-107-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-107-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-107-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-107-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-107-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-107-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-107-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2"></a>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_indicators</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">string_column</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5"></a>    <span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-107-6"><a id="__codelineno-107-6" name="__codelineno-107-6"></a>
</span><span id="__span-107-7"><a id="__codelineno-107-7" name="__codelineno-107-7"></a>    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">expressions</span><span class="p">:</span> <span class="c1"># Iterate over `values.expressions`</span>
</span><span id="__span-107-8"><a id="__codelineno-107-8" name="__codelineno-107-8"></a>        <span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CASE WHEN </span><span class="si">{</span><span class="n">string_column</span><span class="si">}</span><span class="s2"> = '</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">' THEN '</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">' ELSE NULL END AS </span><span class="si">{</span><span class="n">string_column</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-107-9"><a id="__codelineno-107-9" name="__codelineno-107-9"></a>
</span><span id="__span-107-10"><a id="__codelineno-107-10" name="__codelineno-107-10"></a>    <span class="k">return</span> <span class="n">cases</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>We call this function in a model query to create <code>CASE WHEN</code> statements for the <code>vehicle</code> column values <code>truck</code> and <code>bus</code> like this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-108-1">1</a></span>
<span class="normal"><a href="#__codelineno-108-2">2</a></span>
<span class="normal"><a href="#__codelineno-108-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1"></a><span class="k">SELECT</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2"></a><span class="w">  </span><span class="o">@</span><span class="n">make_indicators</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">truck</span><span class="p">,</span><span class="w"> </span><span class="n">bus</span><span class="p">])</span>
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Which renders to:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-109-1">1</a></span>
<span class="normal"><a href="#__codelineno-109-2">2</a></span>
<span class="normal"><a href="#__codelineno-109-3">3</a></span>
<span class="normal"><a href="#__codelineno-109-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1"></a><span class="k">SELECT</span>
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">vehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'truck'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">'truck'</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">vehicle_truck</span><span class="p">,</span>
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">vehicle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bus'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">'bus'</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">vehicle_bus</span><span class="p">,</span>
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note that in the call <code>@make_indicators(vehicle, [truck, bus])</code> none of the three values is quoted.</p>
<p>Because they are unquoted, SQLGlot will parse them all as <code>Column</code> expressions. In the places we used single quotes when building the string (<code>'{value}'</code>), they will be single-quoted in the output. In the places we did not quote them (<code>{string_column} =</code> and <code>{string_column}_{value}</code>), they will not.</p>
<h4 id="accessing-predefined-and-local-variable-values">Accessing predefined and local variable values<a class="headerlink" href="#accessing-predefined-and-local-variable-values" title="Link to this section">¶</a></h4>
<p><a href="../macro_variables/#predefined-variables">Pre-defined variables</a> and <a href="#local-variables">user-defined local variables</a> can be accessed within the macro's body via the <code>evaluator.locals</code> attribute.</p>
<p>The first argument to every macro function, the macro evaluation context <code>evaluator</code>, contains macro variable values in its <code>locals</code> attribute. <code>evaluator.locals</code> is a dictionary whose key:value pairs are macro variables names and the associated values.</p>
<p>For example, a function could access the predefined <code>execution_epoch</code> variable containing the epoch timestamp of when the execution started.</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-110-1">1</a></span>
<span class="normal"><a href="#__codelineno-110-2">2</a></span>
<span class="normal"><a href="#__codelineno-110-3">3</a></span>
<span class="normal"><a href="#__codelineno-110-4">4</a></span>
<span class="normal"><a href="#__codelineno-110-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2"></a>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_execution_epoch</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5"></a>    <span class="k">return</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">locals</span><span class="p">[</span><span class="s1">'execution_epoch'</span><span class="p">]</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The function would return the <code>execution_epoch</code> value when called in a model query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-111-1">1</a></span>
<span class="normal"><a href="#__codelineno-111-2">2</a></span>
<span class="normal"><a href="#__codelineno-111-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1"></a><span class="k">SELECT</span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2"></a><span class="w">  </span><span class="o">@</span><span class="n">get_execution_epoch</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">execution_epoch</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The same approach works for user-defined local macro variables, where the key <code>"execution_epoch"</code> would be replaced with the name of the user-defined variable to be accessed.</p>
<p>One downside of that approach to accessing user-defined local variables is that the name of the variable is hard-coded into the function. A more flexible approach is to pass the name of the local macro variable as a function argument:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-112-1">1</a></span>
<span class="normal"><a href="#__codelineno-112-2">2</a></span>
<span class="normal"><a href="#__codelineno-112-3">3</a></span>
<span class="normal"><a href="#__codelineno-112-4">4</a></span>
<span class="normal"><a href="#__codelineno-112-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2"></a>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-112-4"><a id="__codelineno-112-4" name="__codelineno-112-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_macro_var</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">macro_var</span><span class="p">):</span>
</span><span id="__span-112-5"><a id="__codelineno-112-5" name="__codelineno-112-5"></a>    <span class="k">return</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">locals</span><span class="p">[</span><span class="n">macro_var</span><span class="p">]</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>We could define a local macro variable <code>my_macro_var</code> with a value of 1 and pass it to the <code>get_macro_var</code> function like this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-113-1">1</a></span>
<span class="normal"><a href="#__codelineno-113-2">2</a></span>
<span class="normal"><a href="#__codelineno-113-3">3</a></span>
<span class="normal"><a href="#__codelineno-113-4">4</a></span>
<span class="normal"><a href="#__codelineno-113-5">5</a></span>
<span class="normal"><a href="#__codelineno-113-6">6</a></span>
<span class="normal"><a href="#__codelineno-113-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(...);</span>
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2"></a>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3"></a><span class="o">@</span><span class="n">DEF</span><span class="p">(</span><span class="n">my_macro_var</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">-- Define local macro variable 'my_macro_var'</span>
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4"></a>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5"></a><span class="k">SELECT</span>
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6"></a><span class="w">  </span><span class="o">@</span><span class="n">get_macro_var</span><span class="p">(</span><span class="s1">'my_macro_var'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">macro_var_value</span><span class="w"> </span><span class="c1">-- Access my_macro_var value from Python macro function</span>
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The model query would render to:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-114-1">1</a></span>
<span class="normal"><a href="#__codelineno-114-2">2</a></span>
<span class="normal"><a href="#__codelineno-114-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1"></a><span class="k">SELECT</span>
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2"></a><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">macro_var_value</span>
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="accessing-global-variable-values">Accessing global variable values<a class="headerlink" href="#accessing-global-variable-values" title="Link to this section">¶</a></h4>
<p><a href="#global-variables">User-defined global variables</a> can be accessed within the macro's body using the <code>evaluator.var</code> method.</p>
<p>If a global variable is not defined, the method will return a Python <code>None</code> value. You may provide a different default value as the method's second argument.</p>
<p>For example:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-115-1">1</a></span>
<span class="normal"><a href="#__codelineno-115-2">2</a></span>
<span class="normal"><a href="#__codelineno-115-3">3</a></span>
<span class="normal"><a href="#__codelineno-115-4">4</a></span>
<span class="normal"><a href="#__codelineno-115-5">5</a></span>
<span class="normal"><a href="#__codelineno-115-6">6</a></span>
<span class="normal"><a href="#__codelineno-115-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan.core.macros</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2"></a>
</span><span id="__span-115-3"><a id="__codelineno-115-3" name="__codelineno-115-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-115-4"><a id="__codelineno-115-4" name="__codelineno-115-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">some_macro</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-115-5"><a id="__codelineno-115-5" name="__codelineno-115-5"></a>    <span class="n">var_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">"&lt;var_name&gt;"</span><span class="p">)</span> <span class="c1"># Default value is `None`</span>
</span><span id="__span-115-6"><a id="__codelineno-115-6" name="__codelineno-115-6"></a>    <span class="n">another_var_value</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">"&lt;another_var_name&gt;"</span><span class="p">,</span> <span class="s2">"default_value"</span><span class="p">)</span> <span class="c1"># Default value is `"default_value"`</span>
</span><span id="__span-115-7"><a id="__codelineno-115-7" name="__codelineno-115-7"></a>    <span class="o">...</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="accessing-model-physical-table-and-virtual-layer-view-names">Accessing model, physical table, and virtual layer view names<a class="headerlink" href="#accessing-model-physical-table-and-virtual-layer-view-names" title="Link to this section">¶</a></h4>
<p>All Vulcan models have a name in their <code>MODEL</code> specification. We refer to that as the model's "unresolved" name because it may not correspond to any specific object in the SQL engine.</p>
<p>When Vulcan renders and executes a model, it converts the model name into three forms at different stages:</p>
<ol>
<li>
<p>The <em>fully qualified</em> name</p>
<ul>
<li>If the model name is of the form <code>schema.table</code>, Vulcan determines the correct catalog and adds it, like <code>catalog.schema.table</code></li>
<li>Vulcan quotes each component of the name using the SQL engine's quoting and case-sensitivity rules, like <code>"catalog"."schema"."table"</code></li>
</ul>
</li>
<li>
<p>The <em>resolved</em> physical table name</p>
<ul>
<li>The qualified name of the model's underlying physical table</li>
</ul>
</li>
<li>
<p>The <em>resolved</em> virtual layer view name</p>
<ul>
<li>The qualified name of the model's virtual layer view in the environment where the model is being executed</li>
</ul>
</li>
</ol>
<p>You can access any of these three forms in a Python macro through properties of the <code>evaluation</code> context object.</p>
<p>Access the unresolved, fully-qualified name through the <code>this_model_fqn</code> property.</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-116-1">1</a></span>
<span class="normal"><a href="#__codelineno-116-2">2</a></span>
<span class="normal"><a href="#__codelineno-116-3">3</a></span>
<span class="normal"><a href="#__codelineno-116-4">4</a></span>
<span class="normal"><a href="#__codelineno-116-5">5</a></span>
<span class="normal"><a href="#__codelineno-116-6">6</a></span>
<span class="normal"><a href="#__codelineno-116-7">7</a></span>
<span class="normal"><a href="#__codelineno-116-8">8</a></span>
<span class="normal"><a href="#__codelineno-116-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan.core.macros</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2"></a>
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-116-4"><a id="__codelineno-116-4" name="__codelineno-116-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">some_macro</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-116-5"><a id="__codelineno-116-5" name="__codelineno-116-5"></a>    <span class="c1"># Example:</span>
</span><span id="__span-116-6"><a id="__codelineno-116-6" name="__codelineno-116-6"></a>    <span class="c1"># Name in model definition: landing.customers</span>
</span><span id="__span-116-7"><a id="__codelineno-116-7" name="__codelineno-116-7"></a>    <span class="c1"># Value returned here: '"datalake"."landing"."customers"'</span>
</span><span id="__span-116-8"><a id="__codelineno-116-8" name="__codelineno-116-8"></a>    <span class="n">unresolved_model_fqn</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">this_model_fqn</span>
</span><span id="__span-116-9"><a id="__codelineno-116-9" name="__codelineno-116-9"></a>    <span class="o">...</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Access the resolved physical table and virtual layer view names through the <code>this_model</code> property.</p>
<p>The <code>this_model</code> property returns different names depending on the runtime stage:</p>
<ul>
<li>
<p><code>promoting</code> runtime stage: <code>this_model</code> resolves to the virtual layer view name</p>
<ul>
<li>Example<ul>
<li>Model name is <code>db.test_model</code></li>
<li><code>plan</code> is running in the <code>dev</code> environment</li>
<li><code>this_model</code> resolves to <code>"catalog"."db__dev"."test_model"</code> (note the <code>__dev</code> suffix in the schema name)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>All other runtime stages: <code>this_model</code> resolves to the physical table name</p>
<ul>
<li>Example<ul>
<li>Model name is <code>db.test_model</code></li>
<li><code>plan</code> is running in any environment</li>
<li><code>this_model</code> resolves to <code>"catalog"."vulcan__project"."project__test_model__684351896"</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-117-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-117-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-117-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-117-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-117-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-117-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-117-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-117-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-117-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-117-10">10</a></span>
<span class="normal"><a href="#__codelineno-117-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan.core.macros</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2"></a>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">some_macro</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5"></a>    <span class="k">if</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">runtime_stage</span> <span class="o">==</span> <span class="s2">"promoting"</span><span class="p">:</span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6"></a>        <span class="c1"># virtual layer view name '"catalog"."db__dev"."test_model"'</span>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7"></a>        <span class="n">resolved_name</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">this_model</span>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9"></a>        <span class="c1"># physical table name '"catalog"."vulcan__project"."project__test_model__684351896"'</span>
</span><span id="__span-117-10"><a id="__codelineno-117-10" name="__codelineno-117-10"></a>        <span class="n">resolved_name</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">this_model</span>
</span><span id="__span-117-11"><a id="__codelineno-117-11" name="__codelineno-117-11"></a>    <span class="o">...</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="accessing-model-schemas">Accessing model schemas<a class="headerlink" href="#accessing-model-schemas" title="Link to this section">¶</a></h4>
<p>Model schemas can be accessed within a Python macro function through its evaluation context's <code>column_to_types()</code> method, if the column types can be statically determined. For instance, a schema of an <a href="../models/external_models.md">external model</a> can be accessed only after the <code>vulcan create_external_models</code> command has been executed.</p>
<p>This macro function renames the columns of an upstream model by adding a prefix to them:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-118-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-118-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-118-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-118-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-118-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-118-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-118-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-118-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-118-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-118-10">10</a></span>
<span class="normal"><a href="#__codelineno-118-11">11</a></span>
<span class="normal"><a href="#__codelineno-118-12">12</a></span>
<span class="normal"><a href="#__codelineno-118-13">13</a></span>
<span class="normal"><a href="#__codelineno-118-14">14</a></span>
<span class="normal"><a href="#__codelineno-118-15">15</a></span>
<span class="normal"><a href="#__codelineno-118-16">16</a></span>
<span class="normal"><a href="#__codelineno-118-17">17</a></span>
<span class="normal"><a href="#__codelineno-118-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlglot</span><span class="w"> </span><span class="kn">import</span> <span class="n">exp</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan.core.macros</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3"></a>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">prefix_columns</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6"></a>    <span class="n">renamed_projections</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-118-7"><a id="__codelineno-118-7" name="__codelineno-118-7"></a>
</span><span id="__span-118-8"><a id="__codelineno-118-8" name="__codelineno-118-8"></a>    <span class="c1"># The following converts `model_name`, which is a SQLGlot expression, into a lookup key,</span>
</span><span id="__span-118-9"><a id="__codelineno-118-9" name="__codelineno-118-9"></a>    <span class="c1"># assuming that it does not contain quotes. If it did, we would have to generate SQL for</span>
</span><span id="__span-118-10"><a id="__codelineno-118-10" name="__codelineno-118-10"></a>    <span class="c1"># each part of `model_name` separately and then concatenate these parts, because in that</span>
</span><span id="__span-118-11"><a id="__codelineno-118-11" name="__codelineno-118-11"></a>    <span class="c1"># case `model_name.sql()` would produce an invalid lookup key.</span>
</span><span id="__span-118-12"><a id="__codelineno-118-12" name="__codelineno-118-12"></a>    <span class="n">model_name_sql</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
</span><span id="__span-118-13"><a id="__codelineno-118-13" name="__codelineno-118-13"></a>
</span><span id="__span-118-14"><a id="__codelineno-118-14" name="__codelineno-118-14"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">columns_to_types</span><span class="p">(</span><span class="n">model_name_sql</span><span class="p">):</span>
</span><span id="__span-118-15"><a id="__codelineno-118-15" name="__codelineno-118-15"></a>        <span class="n">new_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span>
</span><span id="__span-118-16"><a id="__codelineno-118-16" name="__codelineno-118-16"></a>        <span class="n">renamed_projections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span>
</span><span id="__span-118-17"><a id="__codelineno-118-17" name="__codelineno-118-17"></a>
</span><span id="__span-118-18"><a id="__codelineno-118-18" name="__codelineno-118-18"></a>    <span class="k">return</span> <span class="n">renamed_projections</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This can then be used in a SQL model like this:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-119-1">1</a></span>
<span class="normal"><a href="#__codelineno-119-2">2</a></span>
<span class="normal"><a href="#__codelineno-119-3">3</a></span>
<span class="normal"><a href="#__codelineno-119-4">4</a></span>
<span class="normal"><a href="#__codelineno-119-5">5</a></span>
<span class="normal"><a href="#__codelineno-119-6">6</a></span>
<span class="normal"><a href="#__codelineno-119-7">7</a></span>
<span class="normal"><a href="#__codelineno-119-8">8</a></span>
<span class="normal"><a href="#__codelineno-119-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="n">child</span><span class="p">,</span>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4"></a><span class="p">);</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5"></a>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6"></a><span class="k">SELECT</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7"></a><span class="w">  </span><span class="o">@</span><span class="n">prefix_columns</span><span class="p">(</span><span class="k">schema</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="s1">'stg_'</span><span class="p">)</span>
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8"></a><span class="k">FROM</span>
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9"></a><span class="w">  </span><span class="k">schema</span><span class="p">.</span><span class="n">parent</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Note that <code>columns_to_types</code> expects an <em>unquoted model name</em>, such as <code>schema.parent</code>. Since macro arguments without type annotations are SQLGlot expressions, the macro code must extract meaningful information from them. For instance, the lookup key in the above macro definition is extracted by generating the SQL code for <code>model_name</code> using the <code>sql()</code> method.</p>
<p>Accessing the schema of an upstream model can be useful for various reasons. For example:</p>
<ul>
<li>Renaming columns so that downstream consumers are not tightly coupled to external or source tables</li>
<li>Selecting only a subset of columns that satisfy some criteria (e.g. columns whose names start with a specific prefix)</li>
<li>Applying transformations to columns, such as masking PII or computing various statistics based on the column types</li>
</ul>
<p>Thus, leveraging <code>columns_to_types</code> can also enable one to write code according to the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> principle, as a single macro function can implement the transformations instead of creating a different macro for each model of interest.</p>
<p>Note: there may be models whose schema is not available when the project is being loaded, in which case a special placeholder column will be returned, aptly named: <code>__schema_unavailable_at_load__</code>. In some cases, the macro's implementation will need to account for this placeholder in order to avoid issues due to the schema being unavailable.</p>
<h4 id="accessing-snapshots">Accessing snapshots<a class="headerlink" href="#accessing-snapshots" title="Link to this section">¶</a></h4>
<p>After a Vulcan project has been successfully loaded, its snapshots can be accessed in Python macro functions and Python models that generate SQL through the <code>get_snapshot</code> method of <code>MacroEvaluator</code>.</p>
<p>This enables the inspection of physical table names or the processed intervals for certain snapshots at runtime, as shown in the example below:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-120-1">1</a></span>
<span class="normal"><a href="#__codelineno-120-2">2</a></span>
<span class="normal"><a href="#__codelineno-120-3">3</a></span>
<span class="normal"><a href="#__codelineno-120-4">4</a></span>
<span class="normal"><a href="#__codelineno-120-5">5</a></span>
<span class="normal"><a href="#__codelineno-120-6">6</a></span>
<span class="normal"><a href="#__codelineno-120-7">7</a></span>
<span class="normal"><a href="#__codelineno-120-8">8</a></span>
<span class="normal"><a href="#__codelineno-120-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan.core.macros</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2"></a>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">some_macro</span><span class="p">(</span><span class="n">evaluator</span><span class="p">):</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5"></a>    <span class="k">if</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">runtime_stage</span> <span class="o">==</span> <span class="s2">"evaluating"</span><span class="p">:</span>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6"></a>        <span class="c1"># Check the intervals a snapshot has data for and alter the behavior of the macro accordingly</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7"></a>        <span class="n">intervals</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_snapshot</span><span class="p">(</span><span class="s2">"some_model_name"</span><span class="p">)</span><span class="o">.</span><span class="n">intervals</span>
</span><span id="__span-120-8"><a id="__codelineno-120-8" name="__codelineno-120-8"></a>        <span class="o">...</span>
</span><span id="__span-120-9"><a id="__codelineno-120-9" name="__codelineno-120-9"></a>    <span class="o">...</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h4 id="using-sqlglot-expressions">Using SQLGlot expressions<a class="headerlink" href="#using-sqlglot-expressions" title="Link to this section">¶</a></h4>
<p>Vulcan automatically parses strings returned by Python macro functions into <a href="https://github.com/tobymao/sqlglot">SQLGlot</a> expressions so they can be incorporated into the model query's semantic representation. Functions can also return SQLGlot expressions directly.</p>
<p>For example, consider a macro function that uses the <code>BETWEEN</code> operator in the predicate of a <code>WHERE</code> clause. A function returning the predicate as a string might look like this, where the function arguments are substituted into a Python f-string:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-121-1">1</a></span>
<span class="normal"><a href="#__codelineno-121-2">2</a></span>
<span class="normal"><a href="#__codelineno-121-3">3</a></span>
<span class="normal"><a href="#__codelineno-121-4">4</a></span>
<span class="normal"><a href="#__codelineno-121-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span><span class="p">,</span> <span class="n">SQL</span>
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2"></a>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">between_where</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">low_val</span><span class="p">:</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">high_val</span><span class="p">:</span> <span class="n">SQL</span><span class="p">):</span>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2"> BETWEEN </span><span class="si">{</span><span class="n">low_val</span><span class="si">}</span><span class="s2"> AND </span><span class="si">{</span><span class="n">high_val</span><span class="si">}</span><span class="s2">"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The function could then be called in a query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-122-1">1</a></span>
<span class="normal"><a href="#__codelineno-122-2">2</a></span>
<span class="normal"><a href="#__codelineno-122-3">3</a></span>
<span class="normal"><a href="#__codelineno-122-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1"></a><span class="k">SELECT</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2"></a><span class="w">  </span><span class="n">a</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="n">between_where</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>And it would render to:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-123-1">1</a></span>
<span class="normal"><a href="#__codelineno-123-2">2</a></span>
<span class="normal"><a href="#__codelineno-123-3">3</a></span>
<span class="normal"><a href="#__codelineno-123-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1"></a><span class="k">SELECT</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2"></a><span class="w">  </span><span class="n">a</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3"></a><span class="k">FROM</span><span class="w"> </span><span class="k">table</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">3</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Alternatively, the function could return a <a href="https://github.com/tobymao/sqlglot/blob/main/sqlglot/expressions.py">SQLGLot expression</a> equivalent to that string by using SQLGlot's expression methods for building semantic representations:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-124-1">1</a></span>
<span class="normal"><a href="#__codelineno-124-2">2</a></span>
<span class="normal"><a href="#__codelineno-124-3">3</a></span>
<span class="normal"><a href="#__codelineno-124-4">4</a></span>
<span class="normal"><a href="#__codelineno-124-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2"></a>
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-124-4"><a id="__codelineno-124-4" name="__codelineno-124-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">between_where</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">low_val</span><span class="p">,</span> <span class="n">high_val</span><span class="p">):</span>
</span><span id="__span-124-5"><a id="__codelineno-124-5" name="__codelineno-124-5"></a>    <span class="k">return</span> <span class="n">column</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">low_val</span><span class="p">,</span> <span class="n">high_val</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The methods are available because the <code>column</code> argument is parsed as a SQLGlot <a href="https://sqlglot.com/sqlglot/expressions.html#Column">Column expression</a> when the macro function is executed.</p>
<p>Column expressions are sub-classes of the <a href="https://sqlglot.com/sqlglot/expressions.html#Condition">Condition class</a>, so they have builder methods like <a href="https://sqlglot.com/sqlglot/expressions.html#Condition.between"><code>between</code></a> and <a href="https://sqlglot.com/sqlglot/expressions.html#Condition.like"><code>like</code></a>.</p>
<h4 id="macro-prepost-statements">Macro pre/post-statements<a class="headerlink" href="#macro-prepost-statements" title="Link to this section">¶</a></h4>
<p>Macro functions may be used to generate pre/post-statements in a model.</p>
<p>By default, when you first add the pre/post-statement macro functions to a model, Vulcan will treat those models as directly modified and require a backfill in the next plan. Vulcan will also treat edits to or removals of pre/post-statement macros as a breaking change.</p>
<p>If your macro does not affect the data returned by a model and you do not want its addition/editing/removal to trigger a backfill, you can specify in the macro definition that it only affects the model's metadata. Vulcan will still detect changes and create new snapshots for a model when you add/edit/remove the macro, but it will not view the change as breaking and require a backfill.</p>
<p>Specify that a macro only affects a model's metadata by setting the <code>@macro()</code> decorator's <code>metadata_only</code> argument to <code>True</code>. For example:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-125-1">1</a></span>
<span class="normal"><a href="#__codelineno-125-2">2</a></span>
<span class="normal"><a href="#__codelineno-125-3">3</a></span>
<span class="normal"><a href="#__codelineno-125-4">4</a></span>
<span class="normal"><a href="#__codelineno-125-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2"></a>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3"></a><span class="hll"><span class="nd">@macro</span><span class="p">(</span><span class="n">metadata_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">print_message</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5"></a>  <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="typed-macros">Typed Macros<a class="headerlink" href="#typed-macros" title="Link to this section">¶</a></h3>
<p>Typed macros in Vulcan bring the power of type hints from Python, enhancing readability, maintainability, and usability of your SQL macros. These macros enable developers to specify expected types for arguments, making the macros more intuitive and less error-prone.</p>
<h4 id="benefits-of-typed-macros">Benefits of Typed Macros<a class="headerlink" href="#benefits-of-typed-macros" title="Link to this section">¶</a></h4>
<ol>
<li><strong>Improved Readability</strong>: By specifying types, the intent of the macro is clearer to other developers or future you.</li>
<li><strong>Reduced Boilerplate</strong>: No need for manual type conversion within the macro function, allowing you to focus on the core logic.</li>
<li><strong>Enhanced Autocompletion</strong>: IDEs can provide better autocompletion and documentation based on the specified types.</li>
</ol>
<h4 id="defining-a-typed-macro">Defining a Typed Macro<a class="headerlink" href="#defining-a-typed-macro" title="Link to this section">¶</a></h4>
<p>Typed macros in Vulcan use Python's type hints. Here's a simple example of a typed macro that repeats a string a given number of times:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-126-1">1</a></span>
<span class="normal"><a href="#__codelineno-126-2">2</a></span>
<span class="normal"><a href="#__codelineno-126-3">3</a></span>
<span class="normal"><a href="#__codelineno-126-4">4</a></span>
<span class="normal"><a href="#__codelineno-126-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2"></a>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">repeat_string</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5"></a>    <span class="k">return</span> <span class="n">text</span> <span class="o">*</span> <span class="n">count</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>This macro takes two arguments: <code>text</code> of type <code>str</code> and <code>count</code> of type <code>int</code>, and it returns a string.</p>
<p>Without type hints, the inputs are two SQLGlot <code>exp.Literal</code> objects you would need to manually convert to Python <code>str</code> and <code>int</code> types. With type hints, you can work with them as string and integer types directly.</p>
<p>Let's try to use the macro in a Vulcan model:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-127-1">1</a></span>
<span class="normal"><a href="#__codelineno-127-2">2</a></span>
<span class="normal"><a href="#__codelineno-127-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1"></a><span class="k">SELECT</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2"></a><span class="w">  </span><span class="o">@</span><span class="n">repeat_string</span><span class="p">(</span><span class="s1">'Vulcan '</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">repeated_string</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">some_table</span><span class="p">;</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Unfortunately, this model generates an error when rendered:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-128-1"><a href="#__codelineno-128-1" id="__codelineno-128-1" name="__codelineno-128-1"></a>Error: Invalid expression / Unexpected token. Line 1, Col: 23.
</span><span id="__span-128-2"><a href="#__codelineno-128-2" id="__codelineno-128-2" name="__codelineno-128-2"></a>  Vulcan Vulcan Vulcan
</span></code></pre></div>
<p>Why? The macro returned <code>Vulcan Vulcan Vulcan</code> as expected, but that string is not valid SQL in the rendered query:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-129-1">1</a></span>
<span class="normal"><a href="#__codelineno-129-2">2</a></span>
<span class="normal"><a href="#__codelineno-129-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1"></a><span class="k">SELECT</span>
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2"></a><span class="hll"><span class="w">  </span><span class="n">Vulcan</span><span class="w"> </span><span class="n">Vulcan</span><span class="w"> </span><span class="n">Vulcan</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">repeated_string</span><span class="w"> </span><span class="o">###</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="k">SQL</span><span class="w"> </span><span class="n">code</span>
</span></span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">some_table</span><span class="p">;</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>The problem is a mismatch between our macro's Python return type <code>str</code> and the type expected by the parsed SQL query.</p>
<p>Recall that Vulcan macros work by modifying the query's semantic representation. In that representation, a SQLGlot string literal type is expected. Vulcan will do its best to return the type expected by the query's semantic representation, but that is not possible in all scenarios.</p>
<p>Therefore, we must explicitly convert the output with SQLGlot's <code>exp.Literal.string()</code> method:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-130-1">1</a></span>
<span class="normal"><a href="#__codelineno-130-2">2</a></span>
<span class="normal"><a href="#__codelineno-130-3">3</a></span>
<span class="normal"><a href="#__codelineno-130-4">4</a></span>
<span class="normal"><a href="#__codelineno-130-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2"></a>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-130-4"><a id="__codelineno-130-4" name="__codelineno-130-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">repeat_string</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="__span-130-5"><a id="__codelineno-130-5" name="__codelineno-130-5"></a><span class="hll">    <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">text</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span>
</span></span></code></pre></div></td></tr></tbody></table></div>
<p>Now the query will render with a valid single-quoted string literal:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-131-1">1</a></span>
<span class="normal"><a href="#__codelineno-131-2">2</a></span>
<span class="normal"><a href="#__codelineno-131-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1"></a><span class="k">SELECT</span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2"></a><span class="w">  </span><span class="s1">'Vulcan Vulcan Vulcan '</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"repeated_string"</span>
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3"></a><span class="k">FROM</span><span class="w"> </span><span class="ss">"some_table"</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">"some_table"</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Typed macros coerce the <strong>inputs</strong> to a macro function, but the macro code is responsible for coercing the <strong>output</strong> to the type expected by the query's semantic representation.</p>
<h4 id="supported-types">Supported Types<a class="headerlink" href="#supported-types" title="Link to this section">¶</a></h4>
<p>Vulcan supports common Python types for typed macros including:</p>
<ul>
<li><code>str</code> -- This handles string literals and basic identifiers, but won't coerce anything more complicated.</li>
<li><code>int</code></li>
<li><code>float</code></li>
<li><code>bool</code></li>
<li><code>datetime.datetime</code></li>
<li><code>datetime.date</code></li>
<li><code>SQL</code> -- When you want the SQL string representation of the argument that's passed in</li>
<li><code>list[T]</code> - where <code>T</code> is any supported type including sqlglot expressions</li>
<li><code>tuple[T]</code> - where <code>T</code> is any supported type including sqlglot expressions</li>
<li><code>T1 | T2 | ...</code> - where <code>T1</code>, <code>T2</code>, etc. are any supported types including sqlglot expressions</li>
</ul>
<p>We also support SQLGlot expressions as type hints, allowing you to ensure inputs are coerced to the desired SQL AST node your intending on working with. Some useful examples include:</p>
<ul>
<li><code>exp.Table</code></li>
<li><code>exp.Column</code></li>
<li><code>exp.Literal</code></li>
<li><code>exp.Identifier</code></li>
</ul>
<p>While these might be obvious examples, you can effectively coerce an input into <em>any</em> SQLGlot expression type, which can be useful for more complex macros. When coercing to more complex types, you will almost certainly need to pass a string literal since expression to expression coercion is limited. When a string literal is passed to a macro that hints at a SQLGlot expression, the string will be parsed using SQLGlot and coerced to the correct type. Failure to coerce to the correct type will result in the original expression being passed to the macro and a warning being logged for the user to address as-needed.</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-132-1">1</a></span>
<span class="normal"><a href="#__codelineno-132-2">2</a></span>
<span class="normal"><a href="#__codelineno-132-3">3</a></span>
<span class="normal"><a href="#__codelineno-132-4">4</a></span>
<span class="normal"><a href="#__codelineno-132-5">5</a></span>
<span class="normal"><a href="#__codelineno-132-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">stamped</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">exp</span><span class="o">.</span><span class="n">Select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Subquery</span><span class="p">:</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3"></a>    <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="s2">"stamp"</span><span class="p">))</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4"></a>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5"></a><span class="c1"># Coercing to a complex node like `exp.Select` works as expected given a string literal input</span>
</span><span id="__span-132-6"><a id="__codelineno-132-6" name="__codelineno-132-6"></a><span class="c1"># SELECT * FROM @stamped('SELECT a, b, c')</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>When coercion fails, there will always be a warning logged but we will not crash. We believe the macro system should be flexible by default, meaning the default behavior is preserved if we cannot coerce. Given that, the user can express whatever level of additional checks they want. For example, if you would like to raise an error when the coercion fails, you can use an <code>assert</code> statement. For example:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-133-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-133-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-133-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-133-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-133-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-133-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-133-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-133-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-133-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-133-10">10</a></span>
<span class="normal"><a href="#__codelineno-133-11">11</a></span>
<span class="normal"><a href="#__codelineno-133-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">my_macro</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">exp</span><span class="o">.</span><span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Column</span><span class="p">:</span>
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Table</span><span class="p">)</span>
</span><span id="__span-133-4"><a id="__codelineno-133-4" name="__codelineno-133-4"></a>    <span class="n">table</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">"catalog"</span><span class="p">,</span> <span class="s2">"dev"</span><span class="p">)</span>
</span><span id="__span-133-5"><a id="__codelineno-133-5" name="__codelineno-133-5"></a>    <span class="k">return</span> <span class="n">table</span>
</span><span id="__span-133-6"><a id="__codelineno-133-6" name="__codelineno-133-6"></a>
</span><span id="__span-133-7"><a id="__codelineno-133-7" name="__codelineno-133-7"></a><span class="c1"># Works</span>
</span><span id="__span-133-8"><a id="__codelineno-133-8" name="__codelineno-133-8"></a><span class="c1"># SELECT * FROM @my_macro('some.table')</span>
</span><span id="__span-133-9"><a id="__codelineno-133-9" name="__codelineno-133-9"></a><span class="c1"># SELECT * FROM @my_macro(some.table)</span>
</span><span id="__span-133-10"><a id="__codelineno-133-10" name="__codelineno-133-10"></a>
</span><span id="__span-133-11"><a id="__codelineno-133-11" name="__codelineno-133-11"></a><span class="c1"># Raises an error thanks to the users inclusion of the assert, otherwise would pass through the string literal and log a warning</span>
</span><span id="__span-133-12"><a id="__codelineno-133-12" name="__codelineno-133-12"></a><span class="c1"># SELECT * FROM @my_macro('SELECT 1 + 1')</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>In using assert this way, you still get the benefits of reducing/removing the boilerplate needed to coerce types; but you <strong>also</strong> get guarantees about the type of the input. This is a useful pattern and is user-defined, so you can use it as you see fit. It ultimately allows you to keep the macro definition clean and focused on the core business logic.</p>
<h4 id="advanced-typed-macros">Advanced Typed Macros<a class="headerlink" href="#advanced-typed-macros" title="Link to this section">¶</a></h4>
<p>You can create more complex macros using advanced Python features like generics. For example, a macro that accepts a list of integers and returns their sum:</p>
<div class="language-python highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-134-1">1</a></span>
<span class="normal"><a href="#__codelineno-134-2">2</a></span>
<span class="normal"><a href="#__codelineno-134-3">3</a></span>
<span class="normal"><a href="#__codelineno-134-4">4</a></span>
<span class="normal"><a href="#__codelineno-134-5">5</a></span>
<span class="normal"><a href="#__codelineno-134-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vulcan</span><span class="w"> </span><span class="kn">import</span> <span class="n">macro</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3"></a>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4"></a><span class="nd">@macro</span><span class="p">()</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">sum_integers</span><span class="p">(</span><span class="n">evaluator</span><span class="p">,</span> <span class="n">numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-134-6"><a id="__codelineno-134-6" name="__codelineno-134-6"></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Usage in Vulcan:</p>
<div class="language-sql highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-135-1">1</a></span>
<span class="normal"><a href="#__codelineno-135-2">2</a></span>
<span class="normal"><a href="#__codelineno-135-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1"></a><span class="k">SELECT</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2"></a><span class="w">  </span><span class="o">@</span><span class="n">sum_integers</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">])</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">some_table</span><span class="p">;</span>
</span></code></pre></div></td></tr></tbody></table></div>
<p>Generics can be nested and are resolved recursively allowing for fairly robust type hinting.</p>
<p>See examples of the coercion function in action in the test suite <a href="https://github.com/TobikoData/vulcan/blob/main/tests/core/test_macros.py">here</a>.</p>
<h4 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Link to this section">¶</a></h4>
<p>Typed macros in Vulcan not only enhance the development experience by making macros more readable and easier to use but also contribute to more robust and maintainable code. By leveraging Python's type hinting system, developers can create powerful and intuitive macros for their SQL queries, further bridging the gap between SQL and Python.</p>
<h2 id="mixing-macro-systems">Mixing macro systems<a class="headerlink" href="#mixing-macro-systems" title="Link to this section">¶</a></h2>
<p>Vulcan supports both Vulcan and <a href="../jinja_macros/">Jinja</a> macro systems. We strongly recommend using only one system in a model - if both are present, they may fail or behave in unintuitive ways.</p>
</article>
</div>
<script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2024 DataOS Vulcan Team<br/>
<small>Complete stack for building data products</small>
</div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/tmdc-io/vulcan-book" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<div class="md-progress" data-md-component="progress" role="progressbar"></div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tracking", "navigation.indexes", "navigation.path", "navigation.top", "navigation.footer", "toc.follow", "search.highlight", "search.suggest", "search.share", "content.tabs.link", "content.code.copy", "content.code.annotate", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
<script src="../../../assets/javascripts/mermaid-zoom.js"></script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>