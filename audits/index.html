
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Complete documentation for Vulcan - SQLMesh wrapper with semantic layer and data validation">
      
      
      
        <link rel="canonical" href="https://tmdc-io.github.io/vulcan-book/audits/">
      
      
        <link rel="prev" href="../semantic-layer/validation/">
      
      
        <link rel="next" href="../quality-checks/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Audits - Vulcan Book</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-04-audits" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Vulcan Book" class="md-header__button md-logo" aria-label="Vulcan Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vulcan Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Audits
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tmdc-io/vulcan-book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tmdc-io/vulcan-book
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Vulcan Book" class="md-nav__button md-logo" aria-label="Vulcan Book" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Vulcan Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tmdc-io/vulcan-book" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tmdc-io/vulcan-book
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/model-properties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Properties
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/model-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/model-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/model-optimization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Model Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Semantic Layer
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Semantic Layer
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-layer/yaml-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    YAML Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-layer/measures/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Measures
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-layer/joins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Joins
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-layer/validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Audits
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Audits
  

    
  </span>
  
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-what-are-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 What are Audits?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#111-terminology-audits-and-assertions" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1.1 Terminology: Audits and Assertions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-how-audits-work" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1.2 How Audits Work
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-why-use-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1.3 Why Use Audits?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-audits-vs-quality-checks-vs-profiles" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Audits vs Quality Checks vs Profiles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-audits-and-oltp-constraints-similar-but-different" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Audits and OLTP Constraints: Similar But Different
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-when-to-use-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 When to Use Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-audit-execution-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.5 Audit Execution Lifecycle
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16-audit-philosophy-query-for-bad-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.6 Audit Philosophy: Query for Bad Data
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Quick Start
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-your-first-audit" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Your First Audit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-common-patterns-5-most-used-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Common Patterns (5 Most-Used Audits)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-multiple-audits-on-one-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 Multiple Audits on One Model
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-built-in-audits-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Built-in Audits Reference
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Built-in Audits Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#audit-categories" class="md-nav__link">
    <span class="md-ellipsis">
      
        Audit Categories
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#31-data-completeness-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Data Completeness Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-data-uniqueness-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Data Uniqueness Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-data-validity-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Data Validity Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-string-validation-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 String Validation Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-pattern-matching-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 Pattern Matching Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-statistical-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6 Statistical Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37-generic-assertion-audit" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.7 Generic Assertion Audit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-creating-custom-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Creating Custom Audits
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Creating Custom Audits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-basic-custom-audit" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Basic Custom Audit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-parameterized-audits-reusable" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Parameterized Audits (Reusable)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-audit-file-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Audit File Organization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-special-macros" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 Special Macros
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-dialect-specific-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 Dialect-Specific Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-default-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.6 Default Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47-naming-conventions-for-custom-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.7 Naming Conventions for Custom Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#48-documenting-custom-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.8 Documenting Custom Audits
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-inline-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Inline Audits
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Inline Audits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-when-to-use-inline-vs-file-based-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 When to Use Inline vs File-Based Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-inline-audit-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Inline Audit Syntax
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-multiple-inline-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 Multiple Inline Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-combining-inline-and-file-based-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 Combining Inline and File-Based Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-inline-audits-with-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.5 Inline Audits with Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56-organizing-inline-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.6 Organizing Inline Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#57-inline-audit-anti-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.7 Inline Audit Anti-Patterns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-advanced-audit-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Advanced Audit Patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Advanced Audit Patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-referential-integrity-checks" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Referential Integrity Checks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-multi-column-business-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Multi-Column Business Logic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-cross-model-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 Cross-Model Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-time-based-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 Time-Based Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-state-transition-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 State Transition Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66-aggregate-consistency-checks" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.6 Aggregate Consistency Checks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-statistical-outlier-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.7 Statistical Outlier Detection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68-hierarchical-data-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.8 Hierarchical Data Validation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-audit-execution-and-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Audit Execution and Lifecycle
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Audit Execution and Lifecycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-when-audits-run" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 When Audits Run
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-plan-vs-run-where-bad-data-lives" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Plan vs Run: Where Bad Data Lives
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-audit-execution-order" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 Audit Execution Order
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74-incremental-models-and-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 Incremental Models and Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75-full-refresh-and-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.5 Full Refresh and Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76-temporarily-skipping-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.6 Temporarily Skipping Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#77-audit-failure-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.7 Audit Failure Handling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#78-audit-performance-impact" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.8 Audit Performance Impact
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-troubleshooting-and-debugging" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Troubleshooting and Debugging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Troubleshooting and Debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-reading-audit-failure-messages" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 Reading Audit Failure Messages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-debugging-failed-audits-step-by-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 Debugging Failed Audits (Step-by-Step)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-common-audit-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.3 Common Audit Issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-fixing-failed-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.4 Fixing Failed Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85-testing-audits-before-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.5 Testing Audits Before Deployment
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-audit-logic-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 Audit Logic Patterns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-audit-granularity-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 Audit Granularity Strategy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93-performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.3 Performance Optimization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94-naming-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.4 Naming Conventions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95-audit-coverage-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.5 Audit Coverage Strategy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96-organizing-audits-by-domain" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.6 Organizing Audits by Domain
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-real-world-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Real-World Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Real-World Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-e-commerce-order-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 E-commerce Order Validation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-financial-transaction-audits" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Financial Transaction Audits
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103-user-registration-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 User Registration Validation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-quick-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Quick Reference
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Quick Reference">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-most-common-audits-cheat-sheet" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 Most Common Audits (Cheat Sheet)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-syntax-quick-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 Syntax Quick Reference
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-decision-tree" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 Decision Tree
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114-complete-audit-index-alphabetical" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.4 Complete Audit Index (Alphabetical)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-summary-and-next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Summary and Next Steps
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Summary and Next Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Takeaways
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#related-topics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Related Topics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-thoughts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Thoughts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix-audit-catalog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Appendix: Audit Catalog
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quality-checks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quality Checks
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../apis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    APIs
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deployment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/07-isolated-environments-ANALYSIS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Isolated Environments Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/07-isolated-environments-SUMMARY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Isolated Environments Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chapter-04-audits">Chapter 04: Audits<a class="headerlink" href="#chapter-04-audits" title="Permanent link">&para;</a></h1>
<blockquote>
<p><strong>Audits are SQL queries that validate your model's data after execution</strong> - they act as automatic gatekeepers, ensuring only valid data flows downstream to dependent models and consumers.</p>
</blockquote>
<hr />
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#1-introduction">Introduction</a></li>
<li><a href="#2-quick-start">Quick Start</a></li>
<li><a href="#3-built-in-audits-reference">Built-in Audits Reference</a></li>
<li><a href="#4-creating-custom-audits">Creating Custom Audits</a></li>
<li><a href="#5-inline-audits">Inline Audits</a></li>
<li><a href="#6-advanced-audit-patterns">Advanced Audit Patterns</a></li>
<li><a href="#7-audit-execution-and-lifecycle">Audit Execution and Lifecycle</a></li>
<li><a href="#8-troubleshooting-and-debugging">Troubleshooting and Debugging</a></li>
<li><a href="#9-best-practices">Best Practices</a></li>
<li><a href="#10-real-world-examples">Real-World Examples</a></li>
<li><a href="#11-quick-reference">Quick Reference</a></li>
<li><a href="#12-summary-and-next-steps">Summary and Next Steps</a></li>
</ol>
<hr />
<h2 id="1-introduction">1. Introduction<a class="headerlink" href="#1-introduction" title="Permanent link">&para;</a></h2>
<h3 id="11-what-are-audits">1.1 What are Audits?<a class="headerlink" href="#11-what-are-audits" title="Permanent link">&para;</a></h3>
<p><strong>Audits are SQL queries that run automatically after model execution to validate data quality.</strong> They search for invalid data, and if any is found, they halt the flow of data to prevent bad data from propagating downstream.</p>
<hr />
<h3 id="111-terminology-audits-and-assertions">1.1.1 Terminology: Audits and Assertions<a class="headerlink" href="#111-terminology-audits-and-assertions" title="Permanent link">&para;</a></h3>
<p><strong>Two related concepts:</strong>
- <strong>AUDIT</strong> - The validation rule (the SQL query that checks for problems)
- <strong>ASSERTION</strong> - Attaching an audit to a model (claiming it should pass)</p>
<p><strong>In MODEL definitions:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">-- Define the AUDIT (the rule)</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_positive_price</span><span class="p">);</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1">-- Make ASSERTIONS about your model (attach the audit)</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">products</span><span class="p">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">check_positive_price</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Declaring this audit should pass</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">);</span>
</span></code></pre></div></p>
<blockquote>
<p><strong>Note:</strong> You may encounter older code that attaches audits using <code>audits</code> instead of <code>assertions</code> in MODEL definitions. While both work identically, please update to use <code>assertions</code> for clearer semantics. This chapter uses <code>assertions</code> throughout.</p>
</blockquote>
<hr />
<h3 id="112-how-audits-work">1.1.2 How Audits Work<a class="headerlink" href="#112-how-audits-work" title="Permanent link">&para;</a></h3>
<p><strong>Core Principles:</strong></p>
<p><strong>Audits are:</strong>
- <strong>Automatic</strong> - Run after every model execution without manual intervention
- <strong>Blocking</strong> - Always halt execution when they fail (no "warning-only" mode in Vulcan)
- <strong>Scoped</strong> - For incremental models, validate only the newly processed intervals
- <strong>SQL-based</strong> - Written as SQL queries that search for invalid data</p>
<p><strong>How audits work:</strong>
1. Model executes and generates/updates table
2. Audits run automatically against the result
3. Each audit query:
   - Returns NO rows → Audit passes
   - Returns ANY rows → Audit fails → Execution halts
4. If all audits pass → Data flows downstream
5. If any audit fails → Execution stops, bad data is contained</p>
<h3 id="113-why-use-audits">1.1.3 Why Use Audits?<a class="headerlink" href="#113-why-use-audits" title="Permanent link">&para;</a></h3>
<p>Audits provide <strong>immediate feedback</strong> during transformation:</p>
<table>
<thead>
<tr>
<th>Without Audits</th>
<th>With Audits</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bad data propagates silently</td>
<td>Bad data is caught immediately</td>
</tr>
<tr>
<td>Downstream models consume invalid data</td>
<td>Downstream models never see invalid data</td>
</tr>
<tr>
<td>Data quality issues discovered by users</td>
<td>Data quality issues discovered by system</td>
</tr>
<tr>
<td>Manual validation required</td>
<td>Automatic validation built-in</td>
</tr>
<tr>
<td>Root cause is hard to trace</td>
<td>Failure points to exact model</td>
</tr>
</tbody>
</table>
<p><strong>Real-world impact:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1">-- Without audit: $0 revenue records propagate to finance dashboard</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1">-- Finance team discovers it 2 days later, traces through 5 models</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1">-- With audit: Caught immediately at source</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">10000000</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="p">);</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1">-- Audit fails → Execution halts → Alert sent → Fixed within 30 minutes</span>
</span></code></pre></div></p>
<hr />
<h3 id="12-audits-vs-quality-checks-vs-profiles">1.2 Audits vs Quality Checks vs Profiles<a class="headerlink" href="#12-audits-vs-quality-checks-vs-profiles" title="Permanent link">&para;</a></h3>
<p>Vulcan provides three complementary data quality mechanisms. Understanding when to use each is critical:</p>
<h4 id="comparison-table">Comparison Table<a class="headerlink" href="#comparison-table" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Feature</th>
<th><strong>Audits</strong></th>
<th><strong>Quality Checks</strong></th>
<th><strong>Profiles</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Purpose</strong></td>
<td>Validate &amp; block invalid data</td>
<td>Monitor &amp; track quality over time</td>
<td>Observe &amp; track statistical trends</td>
</tr>
<tr>
<td><strong>Definition</strong></td>
<td>SQL queries (inline or <code>audits/</code>)</td>
<td>YAML configurations (<code>checks.yml</code>)</td>
<td>Column list in model metadata</td>
</tr>
<tr>
<td><strong>Execution</strong></td>
<td>After model execution (automatic)</td>
<td>Scheduled/triggered (flexible)</td>
<td>After model execution (automatic)</td>
</tr>
<tr>
<td><strong>Behavior</strong></td>
<td><strong>Always blocking</strong></td>
<td>Configurable (blocking or warning)</td>
<td><strong>Always non-blocking</strong></td>
</tr>
<tr>
<td><strong>Output</strong></td>
<td>Pass/Fail → Halts on failure</td>
<td>Pass/Fail + historical tracking</td>
<td>Metrics stored in <code>_check_profiles</code></td>
</tr>
<tr>
<td><strong>Scope</strong></td>
<td>Model-level (coupled to model)</td>
<td>Project-level (centralized)</td>
<td>Model-level (observability)</td>
</tr>
<tr>
<td><strong>Use Case</strong></td>
<td>Critical validations</td>
<td>Comprehensive monitoring</td>
<td>Baseline tracking, anomaly detection</td>
</tr>
<tr>
<td><strong>Example</strong></td>
<td><code>not_null(columns := (id))</code></td>
<td><code>row_count &gt; 1000</code></td>
<td>Track null % trend over 30 days</td>
</tr>
</tbody>
</table>
<h4 id="when-to-use-each">When to Use Each<a class="headerlink" href="#when-to-use-each" title="Permanent link">&para;</a></h4>
<p><strong>Use Audits When:</strong>
- Data quality is <strong>critical</strong> - invalid data must not pass through
- Validation must be <strong>tightly coupled</strong> to model transformation logic
- You need <strong>immediate feedback</strong> during execution
- The rule is a <strong>hard constraint</strong> (similar to database constraints)
- Failure should <strong>halt the flow of data</strong></p>
<p><strong>Examples:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">-- Primary key must be unique and not null</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">))</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1">-- Revenue must be positive</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">  </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">revenue</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="p">)</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1">-- Status must be in valid set</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">  </span><span class="n">accepted_values</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">))</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Use Quality Checks When:</strong>
- Monitoring data quality <strong>trends over time</strong>
- Need <strong>flexible scheduling</strong> independent of model runs
- Want <strong>centralized configuration</strong> across all models
- Require <strong>detailed reporting</strong> and alerting
- Some checks should be <strong>warnings</strong> rather than blocking</p>
<p><strong>Examples (YAML):</strong>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># checks/orders.yml</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nt">checks</span><span class="p">:</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="nt">sales.orders</span><span class="p">:</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="nt">completeness</span><span class="p">:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">row_count &gt; 1000</span><span class="p">:</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sufficient_daily_orders</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">          </span><span class="nt">attributes</span><span class="p">:</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;At</span><span class="nv"> </span><span class="s">least</span><span class="nv"> </span><span class="s">1000</span><span class="nv"> </span><span class="s">orders</span><span class="nv"> </span><span class="s">expected</span><span class="nv"> </span><span class="s">daily&quot;</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="nt">validity</span><span class="p">:</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">failed rows</span><span class="p">:</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">invalid_status_values</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">          </span><span class="nt">fail query</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">            </span><span class="no">SELECT order_id, status</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">            </span><span class="no">FROM sales.orders</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">            </span><span class="no">WHERE status NOT IN (&#39;pending&#39;, &#39;completed&#39;, &#39;cancelled&#39;)</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">          </span><span class="nt">samples limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span></code></pre></div></p>
<p><strong>Use Profiles When:</strong>
- Tracking <strong>statistical trends</strong> (mean, stddev, null %, distinct count)
- Understanding <strong>data distribution</strong> changes over time
- Building <strong>baseline metrics</strong> for anomaly detection
- Data <strong>observability</strong> without enforcing rules
- Planning future audits based on observed patterns</p>
<p><strong>Examples:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">  </span><span class="n">profiles</span><span class="w"> </span><span class="p">(</span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">discount</span><span class="p">)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">);</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="c1">-- Profiles automatically track:</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1">-- • Null count/percentage</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1">-- • Distinct value count</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1">-- • Min/max/mean/stddev (numeric columns)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="c1">-- • Date ranges (date columns)</span>
</span></code></pre></div></p>
<h4 id="decision-flow">Decision Flow<a class="headerlink" href="#decision-flow" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Need data quality control?
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>│
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>├─ Must BLOCK bad data?
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>│  └─ YES → Use AUDIT
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>│     ├─ Reusable across models? → File-based audit in audits/
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>│     └─ Model-specific? → Inline audit in MODEL()
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>│
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>├─ Need historical tracking?
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>│  └─ YES → Use QUALITY CHECK
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>│     ├─ Should block? → Set blocking: true
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>│     └─ Just monitor? → Set blocking: false
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>│
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>└─ Just observing patterns?
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>   └─ YES → Use PROFILE
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>      └─ View trends in _check_profiles table
</span></code></pre></div>
<hr />
<h3 id="13-audits-and-oltp-constraints-similar-but-different">1.3 Audits and OLTP Constraints: Similar But Different<a class="headerlink" href="#13-audits-and-oltp-constraints-similar-but-different" title="Permanent link">&para;</a></h3>
<p>If you're familiar with relational databases, audits serve a similar purpose to table constraints (like <code>NOT NULL</code>, <code>CHECK</code>, <code>UNIQUE</code>, <code>FOREIGN KEY</code>) - but with a critical difference in <strong>where</strong> the blocking happens.</p>
<h4 id="the-key-difference-where-blocking-happens">The Key Difference: WHERE Blocking Happens<a class="headerlink" href="#the-key-difference-where-blocking-happens" title="Permanent link">&para;</a></h4>
<p><strong>OLTP Constraints: Block at INSERT/UPDATE</strong></p>
<p>In traditional OLTP databases, constraints are enforced at the <strong>row-insert level</strong>:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">-- Traditional OLTP database</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="n">customer_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="n">email</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="n">customer_tier</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">customer_tier</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;free&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pro&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;enterprise&#39;</span><span class="p">)),</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="n">lifetime_value</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">lifetime_value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">);</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="c1">-- What happens during INSERT:</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user@example.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;invalid_tier&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="c1">-- ❌ ERROR: Check constraint violation</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="c1">-- ❌ Transaction ABORTED</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1">-- ❌ Data never written to table</span>
</span></code></pre></div>
<p><strong>Key characteristics:</strong>
- Blocking happens <strong>during the write operation</strong>
- Individual bad rows are <strong>rejected immediately</strong>
- Good rows can still be inserted (if constraints pass)
- Bad data <strong>never enters the table</strong></p>
<p><strong>Audits: Block Downstream Data Flow</strong></p>
<p>In Vulcan, audits are enforced <strong>after transformation completes</strong>:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">-- Vulcan model</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">)),</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="n">accepted_values</span><span class="p">(</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">customer_tier</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;free&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pro&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;enterprise&#39;</span><span class="p">)</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lifetime_value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="p">);</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="k">SELECT</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">  </span><span class="n">email</span><span class="p">,</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">  </span><span class="n">customer_tier</span><span class="p">,</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">  </span><span class="n">lifetime_value</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">customers</span><span class="p">;</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="c1">-- What happens during execution:</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="c1">-- 1. Model executes → Table is written/updated</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="c1">-- 2. Audits run against the complete result</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="c1">-- 3. If audit finds violations:</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="c1">--    ❌ Execution halts</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="c1">--    ❌ Downstream models DO NOT run</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="c1">--    ❌ Bad data is CONTAINED in this model (doesn&#39;t propagate)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="c1">-- 4. Note: The table itself contains the bad data, </span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="c1">--    but it&#39;s isolated - downstream flow is blocked</span>
</span></code></pre></div>
<p><strong>Key characteristics:</strong>
- Blocking happens <strong>after transformation completes</strong>
- Entire result set is validated (batch-level)
- Bad data may be written to the table, but is <strong>contained</strong>
- Downstream models never see the bad data</p>
<h4 id="visualizing-the-difference">Visualizing the Difference<a class="headerlink" href="#visualizing-the-difference" title="Permanent link">&para;</a></h4>
<p><strong>OLTP Constraints:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Source Data → INSERT → [Constraint Check] → ❌ REJECTED → Table unchanged
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>                                          → ✅ PASS → Data in table
</span></code></pre></div></p>
<p><strong>Audits/Assertions:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>Source Data → Model Execution → Data written to table → [Audit Check] 
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>                                                       → ❌ FAIL → Stop here; Downstream blocked
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>                                                       → ✅ PASS → Flow downstream
</span></code></pre></div></p>
<h4 id="why-this-difference-matters">Why This Difference Matters<a class="headerlink" href="#why-this-difference-matters" title="Permanent link">&para;</a></h4>
<p><strong>Scenario: Bad data appears in source system</strong></p>
<p><strong>With OLTP Constraints:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1">-- Bad rows are rejected at INSERT time</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">100</span><span class="p">);</span><span class="w">  </span><span class="c1">-- ❌ Rejected</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">);</span><span class="w">    </span><span class="c1">-- ✅ Accepted</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1">-- Result: Partial data load, some rows missing</span>
</span></code></pre></div></p>
<p><strong>With Audits:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">-- All data is transformed, then validated</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">orders</span><span class="p">,</span><span class="w"> </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))));</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Includes order_id=1 with amount=-100</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="c1">-- Result: </span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1">-- • Entire batch is validated</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="c1">-- • If ANY row violates audit, ALL data is flagged</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="c1">-- • Downstream models are protected from seeing ANY of this batch</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1">-- • You fix the source, then reprocess the entire batch</span>
</span></code></pre></div></p>
<p><strong>CORRECT: Use audits when:</strong>
- You're transforming batch data (not transactional inserts)
- You want to validate entire result sets
- You want to protect downstream consumers
- You can reprocess data after fixing source issues</p>
<p><strong>INCORRECT: Don't expect audits to:</strong>
- Reject individual rows and accept others
- Prevent bad data from being written to the model's own table
- Work like row-level INSERT constraints</p>
<hr />
<h4 id="mapping-oltp-constraints-to-audits">Mapping OLTP Constraints to Audits<a class="headerlink" href="#mapping-oltp-constraints-to-audits" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>OLTP Constraint</th>
<th>Audit Equivalent</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>NOT NULL</code></td>
<td><code>not_null(columns := (col))</code></td>
<td>Ensure required fields exist</td>
</tr>
<tr>
<td><code>UNIQUE</code></td>
<td><code>unique_values(columns := (col))</code></td>
<td>Prevent duplicate values</td>
</tr>
<tr>
<td><code>PRIMARY KEY</code></td>
<td><code>not_null(...)</code> + <code>unique_values(...)</code></td>
<td>Enforce primary key integrity</td>
</tr>
<tr>
<td><code>CHECK (price &gt; 0)</code></td>
<td><code>forall(criteria := (price &gt; 0))</code></td>
<td>Business rule validation</td>
</tr>
<tr>
<td><code>CHECK (status IN (...))</code></td>
<td><code>accepted_values(column := status, is_in := (...))</code></td>
<td>Enum/domain validation</td>
</tr>
<tr>
<td><code>CHECK (start &lt; end)</code></td>
<td><code>forall(criteria := (start_date &lt; end_date))</code></td>
<td>Multi-column validation</td>
</tr>
<tr>
<td><code>FOREIGN KEY</code></td>
<td>Custom audit with <code>LEFT JOIN</code></td>
<td>Referential integrity</td>
</tr>
</tbody>
</table>
<p><strong>Example: Complete constraint mapping</strong></p>
<p><strong>OLTP Table:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="n">order_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span><span class="n">customer_id</span><span class="w"> </span><span class="nb">INT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span><span class="n">order_date</span><span class="w"> </span><span class="nb">DATE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span><span class="n">shipped_date</span><span class="w"> </span><span class="nb">DATE</span><span class="p">,</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="n">amount</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">)),</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="k">CHECK</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span><span class="p">),</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">  </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">customers</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Vulcan Model with Equivalent Audits:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span><span class="k">references</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">),</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="c1">-- PRIMARY KEY: NOT NULL + UNIQUE</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="c1">-- NOT NULL columns</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)),</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="c1">-- CHECK (amount &gt;= 0)</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)),</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="c1">-- CHECK (status IN (...))</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="n">accepted_values</span><span class="p">(</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">,</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">)</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">    </span><span class="c1">-- CHECK (shipped_date &gt;= order_date)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">      </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">    </span><span class="p">))</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">    </span><span class="c1">-- FOREIGN KEY - requires custom audit (see Section 6.1)</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="p">);</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="k">SELECT</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">  </span><span class="n">order_id</span><span class="p">::</span><span class="nb">INT</span><span class="p">,</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">::</span><span class="nb">INT</span><span class="p">,</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="w">  </span><span class="n">order_date</span><span class="p">::</span><span class="nb">DATE</span><span class="p">,</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="w">  </span><span class="n">shipped_date</span><span class="p">::</span><span class="nb">DATE</span><span class="p">,</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="w">  </span><span class="n">amount</span><span class="p">::</span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="w">  </span><span class="n">status</span><span class="p">::</span><span class="nb">VARCHAR</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h4 id="audits-go-beyond-row-level-constraints">Audits Go Beyond Row-Level Constraints<a class="headerlink" href="#audits-go-beyond-row-level-constraints" title="Permanent link">&para;</a></h4>
<p>While OLTP constraints work at the row level, audits can validate much more:</p>
<p><strong>1. Aggregate Validations</strong> (impossible with row-level constraints)
<div class="language-sql highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1">-- Ensure table has minimum number of rows</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span><span class="n">number_of_rows</span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="p">)</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="c1">-- Ensure we have data for all expected dates</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">complete_date_range</span><span class="p">);</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">expected_date</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">GENERATE_SERIES</span><span class="p">(</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">    </span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">::</span><span class="nb">DATE</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">    </span><span class="k">CURRENT_DATE</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span><span class="s1">&#39;1 day&#39;</span><span class="p">::</span><span class="nb">INTERVAL</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">expected_date</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">)</span><span class="w"> </span><span class="n">expected</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">expected</span><span class="p">.</span><span class="n">expected_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual</span><span class="p">.</span><span class="n">order_date</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">actual</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>2. Statistical Validations</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1">-- Ensure revenue mean is within expected range</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">  </span><span class="n">mean_in_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">)</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">)</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="c1">-- Detect outliers</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">  </span><span class="n">z_score</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">transaction_amount</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="p">)</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="c1">-- Ensure distributions are similar</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">  </span><span class="n">kl_divergence</span><span class="p">(</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">    </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">current_month_revenue</span><span class="p">,</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">    </span><span class="n">target_column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">last_month_revenue</span><span class="p">,</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">    </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>3. Cross-Table Referential Integrity</strong> (more flexible than FK constraints)
<div class="language-sql highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">-- Validate foreign key relationship</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_customer_reference</span><span class="p">);</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="w"> </span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="c1">-- Exclude nulls (separate audit)</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">      </span><span class="c1">-- Customer doesn&#39;t exist</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="c1">-- Validate multi-column foreign key</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_product_location_reference</span><span class="p">);</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">ol</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">product_locations</span><span class="w"> </span><span class="n">pl</span><span class="w"> </span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="n">warehouse_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl</span><span class="p">.</span><span class="n">warehouse_id</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">pl</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>4. Complex Business Logic</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">-- Validate discount rules</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">  </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="c1">-- Discount amount can&#39;t exceed order amount</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">order_amount</span><span class="p">,</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">    </span><span class="c1">-- Discount percentage can&#39;t exceed 100%</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="n">discount_percent</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="c1">-- Can&#39;t have both dollar discount AND percentage discount</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="p">(</span><span class="n">discount_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">discount_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">    </span><span class="c1">-- Premium customers get discounts, others don&#39;t</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="p">(</span><span class="n">customer_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;premium&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">discount_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">discount_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">  </span><span class="p">))</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>5. Time-Series Consistency</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">-- Ensure no gaps in time series data</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">no_gaps_in_daily_data</span><span class="p">);</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">WITH</span><span class="w"> </span><span class="n">expected_dates</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">GENERATE_SERIES</span><span class="p">(</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="p">),</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="p">),</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="s1">&#39;1 day&#39;</span><span class="p">::</span><span class="nb">INTERVAL</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">expected_date</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="p">)</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">ed</span><span class="p">.</span><span class="n">expected_date</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="k">FROM</span><span class="w"> </span><span class="n">expected_dates</span><span class="w"> </span><span class="n">ed</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="p">)</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ed</span><span class="p">.</span><span class="n">expected_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual</span><span class="p">.</span><span class="n">order_date</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">actual</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="c1">-- Ensure monotonic increase</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">cumulative_revenue_increases</span><span class="p">);</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="p">,</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">previous_cumulative_revenue</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">t1</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="k">JOIN</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 day&#39;</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Summary: Constraints vs Audits</strong></p>
<table>
<thead>
<tr>
<th>Capability</th>
<th>OLTP Constraints</th>
<th>Audits</th>
</tr>
</thead>
<tbody>
<tr>
<td>Row-level validation</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Aggregate validation</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Statistical validation</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Cross-table validation</td>
<td>Limited (FK only)</td>
<td>Full SQL flexibility</td>
</tr>
<tr>
<td>Complex business logic</td>
<td>Limited</td>
<td>Full SQL flexibility</td>
</tr>
<tr>
<td>Time-series validation</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Blocking location</td>
<td>At INSERT/UPDATE</td>
<td>After transformation, before downstream</td>
</tr>
<tr>
<td>Granularity</td>
<td>Individual rows</td>
<td>Entire batch</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="14-when-to-use-audits">1.4 When to Use Audits<a class="headerlink" href="#14-when-to-use-audits" title="Permanent link">&para;</a></h3>
<h4 id="audit-coverage-strategy">Audit Coverage Strategy<a class="headerlink" href="#audit-coverage-strategy" title="Permanent link">&para;</a></h4>
<p>Layer your audits by <strong>criticality</strong> and <strong>impact</strong>:</p>
<p><strong>CRITICAL (Always Audit)</strong></p>
<p>These validations are non-negotiable - failure indicates severe data corruption:</p>
<table>
<thead>
<tr>
<th>Validation Type</th>
<th>Why Critical</th>
<th>Audit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Primary Key Integrity</strong></td>
<td>Breaks joins, violates uniqueness</td>
<td><code>not_null</code> + <code>unique_values</code></td>
</tr>
<tr>
<td><strong>Foreign Key Integrity</strong></td>
<td>Orphaned records, broken relationships</td>
<td>Custom JOIN audit</td>
</tr>
<tr>
<td><strong>Non-negative Amounts</strong></td>
<td>Business logic violation</td>
<td><code>forall(criteria := (amount &gt;= 0))</code></td>
</tr>
<tr>
<td><strong>Required Fields</strong></td>
<td>Downstream models expect them</td>
<td><code>not_null(columns := (...))</code></td>
</tr>
<tr>
<td><strong>Date Ordering</strong></td>
<td>Illogical sequences</td>
<td><code>forall(criteria := (start &lt;= end))</code></td>
</tr>
</tbody>
</table>
<p><strong>Example: Orders table (critical audits only)</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="k">references</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">),</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="c1">-- Critical validations only</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)),</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>IMPORTANT (Audit Frequently)</strong></p>
<p>Should catch these, but rare edge cases may exist:</p>
<table>
<thead>
<tr>
<th>Validation Type</th>
<th>Why Important</th>
<th>Audit</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Enum Validation</strong></td>
<td>Protects downstream case statements</td>
<td><code>accepted_values</code></td>
</tr>
<tr>
<td><strong>Range Validation</strong></td>
<td>Business constraints</td>
<td><code>accepted_range</code></td>
</tr>
<tr>
<td><strong>Format Validation</strong></td>
<td>Ensures parsability</td>
<td><code>valid_email</code>, <code>valid_url</code></td>
</tr>
<tr>
<td><strong>Calculated Field Logic</strong></td>
<td>Derived values must be consistent</td>
<td>Custom audit</td>
</tr>
<tr>
<td><strong>Row Count Thresholds</strong></td>
<td>Catches upstream failures</td>
<td><code>number_of_rows</code></td>
</tr>
</tbody>
</table>
<p><strong>Example: Adding important audits</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="c1">-- Critical (from above)</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)),</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)),</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">    </span><span class="c1">-- Important (added)</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">    </span><span class="n">accepted_values</span><span class="p">(</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">)</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">),</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="n">number_of_rows</span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Expect at least 100 orders</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>NICE-TO-HAVE (Audit Selectively)</strong></p>
<p>These improve data quality but don't justify blocking:</p>
<table>
<thead>
<tr>
<th>Validation Type</th>
<th>Consideration</th>
<th>Audit or Profile?</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>String Length</strong></td>
<td>Rarely breaks downstream</td>
<td>Profile first, audit if issues found</td>
</tr>
<tr>
<td><strong>Statistical Bounds</strong></td>
<td>Natural variation exists</td>
<td>Profile first, audit for outliers</td>
</tr>
<tr>
<td><strong>Format Patterns</strong></td>
<td>Best-effort validation</td>
<td>Audit if format is critical</td>
</tr>
<tr>
<td><strong>Data Consistency</strong></td>
<td>Soft business rules</td>
<td>Check (warning) first, audit if critical</td>
</tr>
</tbody>
</table>
<p><strong>Recommendation:</strong> Start with <strong>profiles</strong> to understand patterns, then promote to <strong>audits</strong> if you find recurring issues.</p>
<h4 id="anti-patterns-when-not-to-use-audits">Anti-Patterns: When NOT to Use Audits<a class="headerlink" href="#anti-patterns-when-not-to-use-audits" title="Permanent link">&para;</a></h4>
<p><strong>INCORRECT: Don't audit just because you can</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">-- TOO MANY AUDITS (over-engineering)</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">)),</span><span class="w">           </span><span class="c1">-- CORRECT</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span><span class="w">                    </span><span class="c1">-- CORRECT</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="n">string_length_equal</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">36</span><span class="p">),</span><span class="w">        </span><span class="c1">-- Overkill</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">    </span><span class="n">valid_uuid</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_id</span><span class="p">),</span><span class="w">                           </span><span class="c1">-- Overkill</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">    </span><span class="n">not_constant</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_id</span><span class="p">),</span><span class="w">                         </span><span class="c1">-- Redundant</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="n">at_least_one</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_id</span><span class="p">),</span><span class="w">                         </span><span class="c1">-- Redundant</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">    </span><span class="n">z_score</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w">              </span><span class="c1">-- Nonsensical</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">    </span><span class="n">mean_in_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">9999</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Nonsensical</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>INCORRECT: Don't use audits for exploratory validation</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1">-- INCORRECT: Blocking on unknown thresholds</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">session_duration</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="p">)</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="c1">-- CORRECT: Use profiles to understand distribution first</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="n">profiles</span><span class="w"> </span><span class="p">(</span><span class="n">session_duration</span><span class="p">)</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="c1">-- After seeing the distribution, add audit with appropriate threshold</span>
</span></code></pre></div></p>
<p><strong>INCORRECT: Don't use audits when the business rule is unclear</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">-- INCORRECT: What if legitimate orders exceed $1M?</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">  </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="p">)</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="c1">-- CORRECT: Clarify business rules first, or use profiles</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="c1">-- Option 1: Clarify with stakeholders</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">  </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">10000000</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Confirmed max</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="p">)</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="c1">-- Option 2: Profile and monitor instead</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="n">profiles</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span></code></pre></div></p>
<hr />
<h3 id="15-audit-execution-lifecycle">1.5 Audit Execution Lifecycle<a class="headerlink" href="#15-audit-execution-lifecycle" title="Permanent link">&para;</a></h3>
<h4 id="when-audits-run">When Audits Run<a class="headerlink" href="#when-audits-run" title="Permanent link">&para;</a></h4>
<p>Audits execute automatically in this sequence:</p>
<p><strong>1. Model Execution</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>Model SQL executes → Data written to table
</span></code></pre></div></p>
<p><strong>2. Audit Execution (Automatic)</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>For each audit defined in MODEL():
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>  → Run audit SQL query
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>  → Check if any rows returned
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>  → If rows returned: FAIL
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>  → If no rows returned: PASS
</span></code></pre></div></p>
<p><strong>3. Result Handling</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>All audits pass → Continue to next model in execution graph
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>Any audit fails → Halt execution, log failure, send alerts
</span></code></pre></div></p>
<h4 id="incremental-models-audit-scope">Incremental Models: Audit Scope<a class="headerlink" href="#incremental-models-audit-scope" title="Permanent link">&para;</a></h4>
<p>For <strong>incremental models</strong>, audits only validate <strong>newly processed intervals</strong>:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_revenue</span><span class="p">,</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="n">INCREMENTAL_BY_TIME_RANGE</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">time_column</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">  </span><span class="p">),</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">revenue</span><span class="p">))</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="p">);</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c1">-- If processing 2024-01-15:</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c1">-- Audit runs: SELECT * FROM daily_revenue </span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="c1">--             WHERE order_date = &#39;2024-01-15&#39; </span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="c1">--             AND revenue IS NULL</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="c1">--</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="c1">-- Historical data (2024-01-01 to 2024-01-14) is NOT re-audited</span>
</span></code></pre></div>
<p><strong>Why?</strong> Efficiency. Re-auditing the entire table on every run would be expensive and unnecessary.</p>
<p><strong>Special macro:</strong> <code>@this_model</code> automatically handles interval filtering for incremental models.</p>
<h4 id="full-refresh-models-audit-scope">Full Refresh Models: Audit Scope<a class="headerlink" href="#full-refresh-models-audit-scope" title="Permanent link">&para;</a></h4>
<p>For <strong>full refresh models</strong>, audits validate the <strong>entire table</strong>:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="p">);</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="c1">-- Every execution: SELECT customer_id, COUNT(*) </span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="c1">--                  FROM dim.customers </span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="c1">--                  GROUP BY customer_id </span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="c1">--                  HAVING COUNT(*) &gt; 1</span>
</span></code></pre></div>
<hr />
<h3 id="16-audit-philosophy-query-for-bad-data">1.6 Audit Philosophy: Query for Bad Data<a class="headerlink" href="#16-audit-philosophy-query-for-bad-data" title="Permanent link">&para;</a></h3>
<h4 id="the-inverted-logic-pattern">The Inverted Logic Pattern<a class="headerlink" href="#the-inverted-logic-pattern" title="Permanent link">&para;</a></h4>
<p>Audits use <strong>inverted logic</strong> - they query for violations, not compliance:</p>
<p><strong>CORRECT: Find Bad Data</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="c1">-- Audit succeeds if NO rows are returned</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">assert_positive_revenue</span><span class="p">);</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">revenue</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Find violations</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="c1">-- Returns 0 rows → All revenue is positive → Audit passes</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="c1">-- Returns N rows → Found negative revenue → Audit fails</span>
</span></code></pre></div></p>
<p><strong>INCORRECT: Find Good Data</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">-- DON&#39;T DO THIS - Logic is backwards!</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">assert_positive_revenue</span><span class="p">);</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">revenue</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Find compliant rows</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="c1">-- Returns N rows → Audit fails (found data!)</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="c1">-- This is backwards - you want to find PROBLEMS, not successes</span>
</span></code></pre></div></p>
<h4 id="why-this-pattern">Why This Pattern?<a class="headerlink" href="#why-this-pattern" title="Permanent link">&para;</a></h4>
<p>This pattern aligns with how constraints work:</p>
<table>
<thead>
<tr>
<th>System</th>
<th>Pattern</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SQL Constraints</strong></td>
<td>Define what's NOT allowed: <code>CHECK (price &gt; 0)</code></td>
</tr>
<tr>
<td><strong>Unit Tests</strong></td>
<td>Assert what should NOT happen: <code>assert x != null</code></td>
</tr>
<tr>
<td><strong>Audits</strong></td>
<td>Query for what should NOT exist: <code>SELECT ... WHERE bad_condition</code></td>
</tr>
</tbody>
</table>
<h4 id="common-audit-patterns">Common Audit Patterns<a class="headerlink" href="#common-audit-patterns" title="Permanent link">&para;</a></h4>
<p><strong>Pattern 1: Null Check</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">-- CORRECT: Find rows with nulls</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Pattern 2: Range Validation</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1">-- CORRECT: Find rows outside valid range</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">120</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Pattern 3: Enum Validation</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1">-- CORRECT: Find rows with invalid status</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Pattern 4: Uniqueness</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1">-- CORRECT: Find duplicate keys</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">duplicate_count</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_id</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Pattern 5: Referential Integrity</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1">-- CORRECT: Find orphaned records (customer_id doesn&#39;t exist)</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="c1">-- Exclude nulls (separate audit)</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">      </span><span class="c1">-- Customer doesn&#39;t exist</span>
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="2-quick-start">2. Quick Start<a class="headerlink" href="#2-quick-start" title="Permanent link">&para;</a></h2>
<h3 id="21-your-first-audit">2.1 Your First Audit<a class="headerlink" href="#21-your-first-audit" title="Permanent link">&para;</a></h3>
<p>Let's start with the most common use case: ensuring required fields have no NULL values.</p>
<p><strong>Model without audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="p">);</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">SELECT</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="w">  </span><span class="n">amount</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Add your first audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">))</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="p">);</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="k">SELECT</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">  </span><span class="n">amount</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>What happens:</strong>
1. Model executes and populates <code>sales.orders</code> table
2. Audit runs automatically: <code>SELECT * FROM sales.orders WHERE order_id IS NULL OR customer_id IS NULL OR order_date IS NULL OR amount IS NULL</code>
3. If query returns 0 rows → Audit passes → Downstream models can run
4. If query returns any rows → Audit fails → Execution halts</p>
<p><strong>Example failure output:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>Failure in audit &#39;not_null&#39; for model &#39;sales.orders&#39;.
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>Got 3 results, expected 0.
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>Query: SELECT * FROM sales.orders WHERE ... IS NULL
</span></code></pre></div></p>
<hr />
<h3 id="22-common-patterns-5-most-used-audits">2.2 Common Patterns (5 Most-Used Audits)<a class="headerlink" href="#22-common-patterns-5-most-used-audits" title="Permanent link">&para;</a></h3>
<p>Here are the five audits you'll use most frequently:</p>
<h4 id="1-not-null-required-fields">1. Not Null - Required Fields<a class="headerlink" href="#1-not-null-required-fields" title="Permanent link">&para;</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">))</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>Use when:</strong> Fields are required for downstream processing.</p>
<hr />
<h4 id="2-unique-values-primary-keys">2. Unique Values - Primary Keys<a class="headerlink" href="#2-unique-values-primary-keys" title="Permanent link">&para;</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>Use when:</strong> Column must be unique (typically primary keys).</p>
<hr />
<h4 id="3-accepted-values-enum-validation">3. Accepted Values - Enum Validation<a class="headerlink" href="#3-accepted-values-enum-validation" title="Permanent link">&para;</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="n">accepted_values</span><span class="p">(</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">,</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">)</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>Use when:</strong> Column has a fixed set of valid values.</p>
<hr />
<h4 id="4-accepted-range-numeric-bounds">4. Accepted Range - Numeric Bounds<a class="headerlink" href="#4-accepted-range-numeric-bounds" title="Permanent link">&para;</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">10000000</span><span class="p">)</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>Use when:</strong> Numeric columns must fall within business-defined bounds.</p>
<hr />
<h4 id="5-forall-custom-business-logic">5. Forall - Custom Business Logic<a class="headerlink" href="#5-forall-custom-business-logic" title="Permanent link">&para;</a></h4>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">      </span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">      </span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">,</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">      </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">    </span><span class="p">))</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>Use when:</strong> You need custom SQL logic that built-in audits don't cover.</p>
<hr />
<h3 id="23-multiple-audits-on-one-model">2.3 Multiple Audits on One Model<a class="headerlink" href="#23-multiple-audits-on-one-model" title="Permanent link">&para;</a></h3>
<p>You can (and should) apply multiple audits to the same model:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">  </span><span class="k">references</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">),</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="c1">-- Completeness: Required fields</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)),</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="c1">-- Uniqueness: Primary key</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="c1">-- Validity: Status enum</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="n">accepted_values</span><span class="p">(</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">,</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">)</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="c1">-- Validity: Amount range</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">10000000</span><span class="p">),</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">    </span><span class="c1">-- Business logic: Date ordering</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="w">      </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a><span class="w">    </span><span class="p">)),</span>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a><span class="w">    </span><span class="c1">-- Data quality: Minimum row count</span>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a><span class="w">    </span><span class="n">number_of_rows</span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a><span class="p">);</span>
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a><span class="k">SELECT</span>
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a><span class="w">  </span><span class="n">shipped_date</span><span class="p">,</span>
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a><span class="w">  </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-44-37"><a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a><span class="w">  </span><span class="n">status</span>
</span><span id="__span-44-38"><a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span></code></pre></div>
<p><strong>Execution order:</strong>
- Audits run in the order they're defined
- If any audit fails, execution halts immediately
- Subsequent audits don't run after a failure</p>
<p><strong>TIP:</strong> Order audits from fastest to slowest (cheap checks first, expensive checks last).</p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="3-built-in-audits-reference">3. Built-in Audits Reference<a class="headerlink" href="#3-built-in-audits-reference" title="Permanent link">&para;</a></h2>
<p>Vulcan provides 29 built-in audits covering common validation scenarios. All audits are <strong>blocking by default</strong> (and only blocking in Vulcan - there is no non-blocking mode).</p>
<h3 id="audit-categories">Audit Categories<a class="headerlink" href="#audit-categories" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="#31-data-completeness-audits">3.1 Data Completeness Audits</a> - NULL values, row counts</li>
<li><a href="#32-data-uniqueness-audits">3.2 Data Uniqueness Audits</a> - Duplicates, distinct values</li>
<li><a href="#33-data-validity-audits">3.3 Data Validity Audits</a> - Enums, ranges, sequences</li>
<li><a href="#34-string-validation-audits">3.4 String Validation Audits</a> - Length, format, patterns</li>
<li><a href="#35-pattern-matching-audits">3.5 Pattern Matching Audits</a> - Regex, LIKE patterns</li>
<li><a href="#36-statistical-audits">3.6 Statistical Audits</a> - Mean, stddev, outliers</li>
<li><a href="#37-generic-assertion-audit">3.7 Generic Assertion Audit</a> - Custom boolean logic</li>
</ul>
<hr />
<h3 id="31-data-completeness-audits">3.1 Data Completeness Audits<a class="headerlink" href="#31-data-completeness-audits" title="Permanent link">&para;</a></h3>
<p>These audits validate that required data is present.</p>
<h4 id="not_null"><code>not_null</code><a class="headerlink" href="#not_null" title="Permanent link">&para;</a></h4>
<p>Ensures specified columns contain no NULL values.</p>
<p><strong>Parameters:</strong>
- <code>columns</code> - List of column names to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">))</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Columns are required for downstream processing
- Missing values would break joins or calculations
- Implementing NOT NULL constraint equivalent</p>
<p><strong>TIP:</strong> Group related required fields together for clarity.</p>
<hr />
<h4 id="at_least_one"><code>at_least_one</code><a class="headerlink" href="#at_least_one" title="Permanent link">&para;</a></h4>
<p>Ensures a column contains at least one non-NULL value.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="n">at_least_one</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">)</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;No rows in table&#39;</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">  </span><span class="k">WHEN</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;All emails are NULL&#39;</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">violation</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Optional column should have at least some data
- Detecting complete data loss in a column
- Ensuring a table isn't completely empty</p>
<p><strong>WARNING:</strong> This audit fails if the table is empty OR if all values are NULL.</p>
<hr />
<h4 id="not_null_proportion"><code>not_null_proportion</code><a class="headerlink" href="#not_null_proportion" title="Permanent link">&para;</a></h4>
<p>Ensures the proportion of NULL values doesn't exceed a threshold.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>threshold</code> - Maximum proportion of NULLs allowed, as decimal 0-1 (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="n">not_null_proportion</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">zip_code</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Max 20% NULLs</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_rows</span><span class="p">,</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="n">zip_code</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">non_null_count</span><span class="p">,</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">  </span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">zip_code</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)::</span><span class="nb">FLOAT</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">null_proportion</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="k">HAVING</span><span class="w"> </span><span class="p">(</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">zip_code</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)::</span><span class="nb">FLOAT</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Column is optional but should be mostly populated
- Monitoring data quality degradation over time
- Soft requirement (not completely required, but expected)</p>
<p><strong>Example thresholds:</strong>
- <code>threshold := 0.1</code> - Max 10% NULLs (mostly required)
- <code>threshold := 0.5</code> - Max 50% NULLs (nice to have)
- <code>threshold := 0.9</code> - Max 90% NULLs (rarely populated)</p>
<hr />
<h4 id="number_of_rows"><code>number_of_rows</code><a class="headerlink" href="#number_of_rows" title="Permanent link">&para;</a></h4>
<p>Ensures the table contains at least a minimum number of rows.</p>
<p><strong>Parameters:</strong>
- <code>threshold</code> - Minimum number of rows required (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_orders</span><span class="p">,</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="n">number_of_rows</span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Expect at least 100 orders</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">row_count</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_orders</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Detecting upstream data source failures
- Ensuring minimum data volume for analytics
- Catching incomplete data loads</p>
<p><strong>TIP:</strong> Set threshold based on historical patterns. If you typically have 10,000 rows, a threshold of 1,000 catches major issues without false positives.</p>
<hr />
<h3 id="32-data-uniqueness-audits">3.2 Data Uniqueness Audits<a class="headerlink" href="#32-data-uniqueness-audits" title="Permanent link">&para;</a></h3>
<p>These audits validate that values or combinations are unique.</p>
<h4 id="unique_values"><code>unique_values</code><a class="headerlink" href="#unique_values" title="Permanent link">&para;</a></h4>
<p>Ensures specified columns contain no duplicate values.</p>
<p><strong>Parameters:</strong>
- <code>columns</code> - List of column names to check for uniqueness (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duplicate_count</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Multiple columns (each must be individually unique):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">))</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="p">)</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="c1">-- Both customer_id must be unique AND email must be unique</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Enforcing primary key uniqueness
- Ensuring no duplicate records
- Validating unique constraint equivalent</p>
<p><strong>WARNING:</strong> <code>unique_values(columns := (col1, col2))</code> checks that BOTH are unique individually, NOT that the combination is unique. For combination uniqueness, use <code>unique_combination_of_columns</code>.</p>
<hr />
<h4 id="unique_combination_of_columns"><code>unique_combination_of_columns</code><a class="headerlink" href="#unique_combination_of_columns" title="Permanent link">&para;</a></h4>
<p>Ensures each row has a unique combination of values across specified columns.</p>
<p><strong>Parameters:</strong>
- <code>columns</code> - List of column names that form composite key (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_customer_revenue</span><span class="p">,</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">  </span><span class="n">grains</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">),</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">    </span><span class="n">unique_combination_of_columns</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">))</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">duplicate_count</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_customer_revenue</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Composite primary keys (multi-column grain)
- Ensuring no duplicate rows for customer + date
- Fact tables with compound keys</p>
<p><strong>Example use cases:</strong>
- <code>(user_id, date)</code> - One row per user per day
- <code>(order_id, line_item)</code> - One row per line item
- <code>(product_id, warehouse_id)</code> - One row per product-warehouse combination</p>
<hr />
<h4 id="not_constant"><code>not_constant</code><a class="headerlink" href="#not_constant" title="Permanent link">&para;</a></h4>
<p>Ensures a column has at least two distinct non-NULL values.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">customer_segmentation</span><span class="p">,</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">    </span><span class="n">not_constant</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">customer_segment</span><span class="p">)</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_segment</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">distinct_count</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">customer_segmentation</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_segment</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">customer_segment</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Ensuring variation in a column (not all same value)
- Catching upstream filter mistakes (e.g., WHERE country = 'US' applied incorrectly)
- Validating segmentation columns have multiple segments</p>
<p><strong>WARNING:</strong> This audit ignores NULL values. A column with all NULLs will fail <code>at_least_one</code>, not <code>not_constant</code>.</p>
<hr />
<h3 id="33-data-validity-audits">3.3 Data Validity Audits<a class="headerlink" href="#33-data-validity-audits" title="Permanent link">&para;</a></h3>
<p>These audits validate that values fall within expected sets or ranges.</p>
<h4 id="accepted_values"><code>accepted_values</code><a class="headerlink" href="#accepted_values" title="Permanent link">&para;</a></h4>
<p>Ensures all values in a column are in an allowed list.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>is_in</code> - List of accepted values (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">    </span><span class="n">accepted_values</span><span class="p">(</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">,</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">)</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;refunded&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Enum columns (status, type, category)
- Fixed set of valid values
- Protecting downstream CASE statements</p>
<p><strong>NOTE:</strong> NULL values pass this audit. If you want to ensure no NULLs, add a separate <code>not_null</code> audit.</p>
<hr />
<h4 id="not_accepted_values"><code>not_accepted_values</code><a class="headerlink" href="#not_accepted_values" title="Permanent link">&para;</a></h4>
<p>Ensures no values in a column are in a rejected list.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>is_in</code> - List of rejected values (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span><span class="p">,</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="n">not_accepted_values</span><span class="p">(</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">product_name</span><span class="p">,</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">      </span><span class="n">is_in</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;placeholder&#39;</span><span class="p">)</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">product_name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;placeholder&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Ensuring test data doesn't reach production
- Blocking known invalid values
- Catching placeholder values</p>
<p><strong>NOTE:</strong> This audit does not reject NULL values. Use <code>not_null</code> for that.</p>
<hr />
<h4 id="accepted_range"><code>accepted_range</code><a class="headerlink" href="#accepted_range" title="Permanent link">&para;</a></h4>
<p>Ensures numeric values fall within a specified range.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>min_v</code> - Minimum value (required)
- <code>max_v</code> - Maximum value (required)
- <code>inclusive</code> - Whether range boundaries are included (optional, default: true)</p>
<p><strong>Example (inclusive):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">    </span><span class="c1">-- Allows amount &gt;= 0 AND amount &lt;= 1000000</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Example (exclusive):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">metrics</span><span class="p">,</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">percentage</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inclusive</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="k">false</span><span class="p">)</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">    </span><span class="c1">-- Allows percentage &gt; 0 AND percentage &lt; 1 (excludes 0 and 1)</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL (inclusive):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL (exclusive):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">metrics</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">percentage</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">percentage</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Enforcing business rules (revenue &gt; 0, age between 0-120)
- Catching outliers or data entry errors
- Implementing CHECK constraint equivalent</p>
<hr />
<h4 id="mutually_exclusive_ranges"><code>mutually_exclusive_ranges</code><a class="headerlink" href="#mutually_exclusive_ranges" title="Permanent link">&para;</a></h4>
<p>Ensures numeric ranges in different rows don't overlap.</p>
<p><strong>Parameters:</strong>
- <code>lower_bound_column</code> - Column containing range start (required)
- <code>upper_bound_column</code> - Column containing range end (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="n">tier_ranges</span><span class="p">,</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="w">    </span><span class="n">mutually_exclusive_ranges</span><span class="p">(</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">      </span><span class="n">lower_bound_column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">min_revenue</span><span class="p">,</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">      </span><span class="n">upper_bound_column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">max_revenue</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="n">tier_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">tier1</span><span class="p">,</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">tier_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">tier2</span><span class="p">,</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="n">min_revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t1_min</span><span class="p">,</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="n">max_revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t1_max</span><span class="p">,</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">min_revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t2_min</span><span class="p">,</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">max_revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t2_max</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="k">FROM</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="n">tier_ranges</span><span class="w"> </span><span class="n">t1</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">pricing</span><span class="p">.</span><span class="n">tier_ranges</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">tier_id</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">min_revenue</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">max_revenue</span><span class="w"> </span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">max_revenue</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">min_revenue</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Pricing tiers with revenue ranges
- Date ranges that shouldn't overlap
- Territory assignments (zip code ranges)</p>
<p><strong>Example data:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>Tier      | Min Revenue | Max Revenue
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>----------|-------------|-------------
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>Bronze    | 0           | 10000       ✓ Valid
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>Silver    | 10001       | 50000       ✓ Valid  
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>Gold      | 50001       | 100000      ✓ Valid
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>Platinum  | 40000       | 200000      ✗ Overlaps with Silver &amp; Gold
</span></code></pre></div></p>
<hr />
<h4 id="sequential_values"><code>sequential_values</code><a class="headerlink" href="#sequential_values" title="Permanent link">&para;</a></h4>
<p>Ensures ordered numeric column values are sequential with consistent interval.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>interval</code> - Expected difference between consecutive values (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">date_spine</span><span class="p">,</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="w">    </span><span class="n">sequential_values</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">date_key</span><span class="p">,</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="w">    </span><span class="c1">-- date_key should be 20240101, 20240102, 20240103, ... (no gaps)</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">WITH</span><span class="w"> </span><span class="n">ordered_values</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="w">    </span><span class="n">date_key</span><span class="p">,</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="w">    </span><span class="n">LAG</span><span class="p">(</span><span class="n">date_key</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">date_key</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">prev_date_key</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">date_spine</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="p">)</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">ordered_values</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">prev_date_key</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">date_key</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">prev_date_key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Date dimensions with no gaps
- Sequential ID columns
- Time series with regular intervals</p>
<p><strong>WARNING:</strong> This audit assumes values are naturally ordered. It fails if there are gaps in the sequence.</p>
<hr />
<h3 id="34-string-validation-audits">3.4 String Validation Audits<a class="headerlink" href="#34-string-validation-audits" title="Permanent link">&para;</a></h3>
<p>These audits validate string/character data characteristics.</p>
<h4 id="not_empty_string"><code>not_empty_string</code><a class="headerlink" href="#not_empty_string" title="Permanent link">&para;</a></h4>
<p>Ensures no rows contain empty strings ('').</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span><span class="p">,</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="w">    </span><span class="n">not_empty_string</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">product_name</span><span class="p">)</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Catching empty strings vs NULL (they're different!)
- Ensuring string columns have meaningful content
- Validating user input</p>
<p><strong>NOTE:</strong> Empty string ('') and NULL are different. This audit checks for '', not NULL.</p>
<hr />
<h4 id="string_length_equal"><code>string_length_equal</code><a class="headerlink" href="#string_length_equal" title="Permanent link">&para;</a></h4>
<p>Ensures all string values have exactly the specified length.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>v</code> - Expected string length (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">locations</span><span class="p">,</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="w">    </span><span class="n">string_length_equal</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">zip_code</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">    </span><span class="c1">-- All zip codes must be exactly 5 characters</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">locations</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">LENGTH</span><span class="p">(</span><span class="n">zip_code</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Fixed-length codes (zip codes, country codes, SKUs)
- Standardized identifiers
- Validating data format</p>
<hr />
<h4 id="string_length_between"><code>string_length_between</code><a class="headerlink" href="#string_length_between" title="Permanent link">&para;</a></h4>
<p>Ensures string values have length within a specified range.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>min_v</code> - Minimum length (required)
- <code>max_v</code> - Maximum length (required)
- <code>inclusive</code> - Whether boundaries are included (optional, default: true)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="w">    </span><span class="n">string_length_between</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="w">    </span><span class="c1">-- Names between 2 and 100 characters (inclusive)</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL (inclusive):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">LENGTH</span><span class="p">(</span><span class="n">customer_name</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">LENGTH</span><span class="p">(</span><span class="n">customer_name</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Validating reasonable name lengths
- Ensuring text fields aren't too long
- Catching truncated data</p>
<hr />
<h4 id="valid_email"><code>valid_email</code><a class="headerlink" href="#valid_email" title="Permanent link">&para;</a></h4>
<p>Ensures strings match email address format.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">users</span><span class="p">,</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="w">    </span><span class="n">valid_email</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">)</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1">-- Uses regex: ^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">users</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">REGEXP_MATCHES</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Validating email addresses
- Ensuring parseable contact information
- Catching malformed data</p>
<p><strong>NOTE:</strong> NULL values pass this audit. Use <code>not_null</code> separately if required.</p>
<hr />
<h4 id="valid_url"><code>valid_url</code><a class="headerlink" href="#valid_url" title="Permanent link">&para;</a></h4>
<p>Ensures strings match URL format.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span><span class="p">,</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">    </span><span class="n">valid_url</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">product_url</span><span class="p">)</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1">-- Uses regex: ^(https?|ftp)://[^\s/$.?#].[^\s]*$</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">product_url</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">REGEXP_MATCHES</span><span class="p">(</span><span class="n">product_url</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^(https?|ftp)://[^\s/$.?#].[^\s]*$&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Validating website URLs
- Ensuring clickable links
- API endpoint validation</p>
<hr />
<h4 id="valid_uuid"><code>valid_uuid</code><a class="headerlink" href="#valid_uuid" title="Permanent link">&para;</a></h4>
<p>Ensures strings match UUID format.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">events</span><span class="p">.</span><span class="n">user_sessions</span><span class="p">,</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="w">    </span><span class="n">valid_uuid</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">session_id</span><span class="p">)</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1">-- UUID format: 8-4-4-4-12 hexadecimal digits</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="c1">-- Example: 550e8400-e29b-41d4-a716-446655440000</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">events</span><span class="p">.</span><span class="n">user_sessions</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">REGEXP_MATCHES</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="w">    </span><span class="s1">&#39;^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Validating UUID identifiers
- Ensuring proper format from UUID generators
- Catching malformed IDs</p>
<hr />
<h4 id="valid_http_method"><code>valid_http_method</code><a class="headerlink" href="#valid_http_method" title="Permanent link">&para;</a></h4>
<p>Ensures values are valid HTTP methods.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="n">api_requests</span><span class="p">,</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">    </span><span class="n">valid_http_method</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">http_method</span><span class="p">)</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Valid HTTP methods:</strong>
- GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS, TRACE, CONNECT</p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="n">api_requests</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">http_method</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PATCH&#39;</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="w">                          </span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;TRACE&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CONNECT&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Validating API logs
- Ensuring standardized HTTP methods
- Catching typos or malformed requests</p>
<hr />
<h3 id="35-pattern-matching-audits">3.5 Pattern Matching Audits<a class="headerlink" href="#35-pattern-matching-audits" title="Permanent link">&para;</a></h3>
<p>These audits validate strings against patterns.</p>
<h4 id="match_regex_pattern_list"><code>match_regex_pattern_list</code><a class="headerlink" href="#match_regex_pattern_list" title="Permanent link">&para;</a></h4>
<p>Ensures all non-NULL values match at least one regex pattern.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>patterns</code> - List of regex patterns (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">products</span><span class="p">.</span><span class="n">inventory</span><span class="p">,</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="w">    </span><span class="n">match_regex_pattern_list</span><span class="p">(</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">sku</span><span class="p">,</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="w">      </span><span class="n">patterns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;^[A-Z]{3}-[0-9]{6}$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^LEGACY-.*&#39;</span><span class="p">)</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="w">      </span><span class="c1">-- Matches: ABC-123456 OR LEGACY-anything</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="p">.</span><span class="n">inventory</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">sku</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="w">    </span><span class="n">REGEXP_MATCHES</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^[A-Z]{3}-[0-9]{6}$&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">    </span><span class="n">REGEXP_MATCHES</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^LEGACY-.*&#39;</span><span class="p">)</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w">  </span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Multiple valid format patterns
- Complex validation rules
- Migrating between formats</p>
<hr />
<h4 id="not_match_regex_pattern_list"><code>not_match_regex_pattern_list</code><a class="headerlink" href="#not_match_regex_pattern_list" title="Permanent link">&para;</a></h4>
<p>Ensures no non-NULL values match any regex pattern.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>patterns</code> - List of regex patterns to reject (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">products</span><span class="p">.</span><span class="n">inventory</span><span class="p">,</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="w">    </span><span class="n">not_match_regex_pattern_list</span><span class="p">(</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">sku</span><span class="p">,</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="w">      </span><span class="n">patterns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;^TEST-.*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^TEMP-.*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;^DEBUG-.*&#39;</span><span class="p">)</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="w">      </span><span class="c1">-- Reject: TEST-*, TEMP-*, DEBUG-*</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Blocking test data patterns
- Ensuring production-only data
- Catching debug/temporary records</p>
<hr />
<h4 id="match_like_pattern_list"><code>match_like_pattern_list</code><a class="headerlink" href="#match_like_pattern_list" title="Permanent link">&para;</a></h4>
<p>Ensures all non-NULL values match at least one LIKE pattern.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>patterns</code> - List of LIKE patterns (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a><span class="w">    </span><span class="n">match_like_pattern_list</span><span class="p">(</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">,</span>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a><span class="w">      </span><span class="n">patterns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;%@company.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%@subsidiary.com&#39;</span><span class="p">)</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a><span class="w">      </span><span class="c1">-- Only company or subsidiary emails</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">customers</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%@company.com&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%@subsidiary.com&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Simple wildcard patterns
- Domain validation
- Simpler than regex</p>
<hr />
<h4 id="not_match_like_pattern_list"><code>not_match_like_pattern_list</code><a class="headerlink" href="#not_match_like_pattern_list" title="Permanent link">&para;</a></h4>
<p>Ensures no non-NULL values match any LIKE pattern.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>patterns</code> - List of LIKE patterns to reject (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">products</span><span class="p">.</span><span class="k">catalog</span><span class="p">,</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="w">    </span><span class="n">not_match_like_pattern_list</span><span class="p">(</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">product_name</span><span class="p">,</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a><span class="w">      </span><span class="n">patterns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;%test%&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%dummy%&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;%placeholder%&#39;</span><span class="p">)</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Blocking keywords (test, dummy, etc.)
- Ensuring clean data
- Catching placeholders</p>
<hr />
<h3 id="36-statistical-audits">3.6 Statistical Audits<a class="headerlink" href="#36-statistical-audits" title="Permanent link">&para;</a></h3>
<p>These audits validate statistical properties of numeric columns.</p>
<p><strong>WARNING:</strong> Thresholds for statistical audits typically require tuning based on your data distribution. Start with profiles to understand baseline statistics before setting audit thresholds.</p>
<h4 id="mean_in_range"><code>mean_in_range</code><a class="headerlink" href="#mean_in_range" title="Permanent link">&para;</a></h4>
<p>Ensures column mean falls within specified range.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>min_v</code> - Minimum mean (required)
- <code>max_v</code> - Maximum mean (required)
- <code>inclusive</code> - Whether boundaries are included (optional, default: true)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_revenue</span><span class="p">,</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="w">    </span><span class="n">mean_in_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">order_amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="w">    </span><span class="c1">-- Average order should be between $50-$200</span>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Detecting shifts in average behavior
- Ensuring expected data distribution
- Catching data quality issues affecting aggregates</p>
<hr />
<h4 id="stddev_in_range"><code>stddev_in_range</code><a class="headerlink" href="#stddev_in_range" title="Permanent link">&para;</a></h4>
<p>Ensures column standard deviation falls within specified range.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>min_v</code> - Minimum standard deviation (required)
- <code>max_v</code> - Maximum standard deviation (required)
- <code>inclusive</code> - Whether boundaries are included (optional, default: true)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">customer_metrics</span><span class="p">,</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="w">    </span><span class="n">stddev_in_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">purchase_frequency</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Monitoring data variability
- Detecting unusual distribution changes
- Ensuring consistent spread</p>
<hr />
<h4 id="z_score"><code>z_score</code><a class="headerlink" href="#z_score" title="Permanent link">&para;</a></h4>
<p>Ensures no values have absolute z-score exceeding threshold (outlier detection).</p>
<p><strong>Parameters:</strong>
- <code>column</code> - Column name to check (required)
- <code>threshold</code> - Maximum absolute z-score (required, typically 3 or 4)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">transactions</span><span class="p">,</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a><span class="w">    </span><span class="n">z_score</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">transaction_amount</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a><span class="w">    </span><span class="c1">-- Flag values &gt;3 standard deviations from mean</span>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Z-score calculation:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>z = |value - mean| / stddev
</span></code></pre></div></p>
<p><strong>Common thresholds:</strong>
- <code>threshold := 2</code> - Strict (catches values &gt;2σ from mean, ~5% of normal distribution)
- <code>threshold := 3</code> - Standard (catches values &gt;3σ from mean, ~0.3% of normal distribution)
- <code>threshold := 4</code> - Lenient (catches extreme outliers only)</p>
<p><strong>Use when:</strong>
- Detecting extreme outliers
- Catching data entry errors
- Ensuring realistic value ranges</p>
<hr />
<h4 id="kl_divergence"><code>kl_divergence</code><a class="headerlink" href="#kl_divergence" title="Permanent link">&para;</a></h4>
<p>Ensures symmetrized KL divergence between two columns doesn't exceed threshold.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - First column to compare (required)
- <code>target_column</code> - Second column to compare (required)
- <code>threshold</code> - Maximum KL divergence (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">cohort_comparison</span><span class="p">,</span>
</span><span id="__span-97-3"><a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-97-4"><a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="w">    </span><span class="n">kl_divergence</span><span class="p">(</span>
</span><span id="__span-97-5"><a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">current_month_revenue_distribution</span><span class="p">,</span>
</span><span id="__span-97-6"><a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="w">      </span><span class="n">target_column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">last_month_revenue_distribution</span><span class="p">,</span>
</span><span id="__span-97-7"><a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="w">      </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>
</span><span id="__span-97-8"><a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-97-9"><a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-97-10"><a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Comparing distributions across time periods
- Detecting distribution shifts
- A/B test validation</p>
<p><strong>NOTE:</strong> This is an advanced statistical audit. Most use cases are better served by profiles or quality checks with trending.</p>
<hr />
<h4 id="chi_square"><code>chi_square</code><a class="headerlink" href="#chi_square" title="Permanent link">&para;</a></h4>
<p>Ensures chi-square statistic for two categorical columns doesn't exceed critical value.</p>
<p><strong>Parameters:</strong>
- <code>column</code> - First categorical column (required)
- <code>target_column</code> - Second categorical column (required)
- <code>critical_value</code> - Chi-square critical value (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">analytics</span><span class="p">.</span><span class="n">user_segments</span><span class="p">,</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="w">    </span><span class="n">chi_square</span><span class="p">(</span>
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="w">      </span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">user_region</span><span class="p">,</span>
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="w">      </span><span class="n">target_column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">subscription_tier</span><span class="p">,</span>
</span><span id="__span-98-7"><a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="w">      </span><span class="n">critical_value</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">.</span><span class="mi">635</span><span class="w">  </span><span class="c1">-- p-value 0.95, df=1</span>
</span><span id="__span-98-8"><a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-98-9"><a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-98-10"><a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Finding critical values:</strong>
<div class="language-python highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">chi2</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="c1"># critical_value for p=0.95, degrees_of_freedom=1</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Returns 3.841</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Testing independence of categorical variables
- Validating expected relationships
- Advanced statistical validation</p>
<p><strong>NOTE:</strong> This is an advanced statistical audit requiring knowledge of chi-square testing.</p>
<hr />
<h3 id="37-generic-assertion-audit">3.7 Generic Assertion Audit<a class="headerlink" href="#37-generic-assertion-audit" title="Permanent link">&para;</a></h3>
<h4 id="forall"><code>forall</code><a class="headerlink" href="#forall" title="Permanent link">&para;</a></h4>
<p>Ensures arbitrary boolean expressions evaluate to TRUE for all rows.</p>
<p><strong>Parameters:</strong>
- <code>criteria</code> - List of boolean SQL expressions (required)</p>
<p><strong>Example:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a><span class="w">      </span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a><span class="w">      </span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">,</span>
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a><span class="w">      </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a><span class="w">      </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-100-9"><a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a><span class="w">      </span><span class="p">(</span><span class="n">customer_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;premium&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">discount_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-100-10"><a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a><span class="w">    </span><span class="p">))</span>
</span><span id="__span-100-11"><a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-100-12"><a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Equivalent SQL:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="w">  </span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span>
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">amount</span>
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="p">((</span><span class="n">customer_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;premium&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">discount_percent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Use when:</strong>
- Multiple related conditions
- Complex business logic
- Custom validation not covered by built-in audits</p>
<p><strong>TIP:</strong> This is the most flexible audit - use it when built-in audits don't fit your needs.</p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="4-creating-custom-audits">4. Creating Custom Audits<a class="headerlink" href="#4-creating-custom-audits" title="Permanent link">&para;</a></h2>
<p>When built-in audits don't cover your specific validation needs, create custom audits.</p>
<h3 id="41-basic-custom-audit">4.1 Basic Custom Audit<a class="headerlink" href="#41-basic-custom-audit" title="Permanent link">&para;</a></h3>
<p>Custom audits are defined in <code>.sql</code> files within an <code>audits/</code> directory in your project.</p>
<p><strong>Project structure:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>my_project/
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a>├── models/
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>│   ├── staging/
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>│   └── marts/
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>├── audits/           ← Create this directory
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a>│   └── business_rules.sql
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>└── config.yaml
</span></code></pre></div></p>
<p><strong>Example: audits/business_rules.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">assert_positive_price</span><span class="p">,</span>
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a><span class="w">  </span><span class="n">dialect</span><span class="w"> </span><span class="n">postgres</span>
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a><span class="p">);</span>
</span><span id="__span-103-5"><a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>
</span><span id="__span-103-6"><a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-103-7"><a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
</span><span id="__span-103-8"><a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Apply to model:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="c1">-- models/staging/products.sql</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">staging</span><span class="p">.</span><span class="n">products</span><span class="p">,</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">assert_positive_price</span><span class="p">)</span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="p">);</span>
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="k">SELECT</span>
</span><span id="__span-104-8"><a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a><span class="w">  </span><span class="n">product_id</span><span class="p">,</span>
</span><span id="__span-104-9"><a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a><span class="w">  </span><span class="n">product_name</span><span class="p">,</span>
</span><span id="__span-104-10"><a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="w">  </span><span class="n">price</span><span class="p">,</span>
</span><span id="__span-104-11"><a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a><span class="w">  </span><span class="n">cost</span>
</span><span id="__span-104-12"><a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">products</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Key components:</strong>
1. <code>AUDIT (name ...)</code> - Defines the audit name
2. <code>dialect</code> - Optional, specifies SQL dialect if different from project default
3. <code>SELECT * FROM @this_model WHERE ...</code> - Query for bad data</p>
<hr />
<h3 id="42-parameterized-audits-reusable">4.2 Parameterized Audits (Reusable)<a class="headerlink" href="#42-parameterized-audits-reusable" title="Permanent link">&para;</a></h3>
<p>Make audits reusable by adding parameters:</p>
<p><strong>audits/generic_checks.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">threshold_check</span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="p">);</span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">threshold</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Apply with different parameters:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-106-4"><a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="w">    </span><span class="n">threshold_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">),</span>
</span><span id="__span-106-5"><a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a><span class="w">    </span><span class="n">threshold_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-106-6"><a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-106-7"><a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>How it works:</strong>
- <code>@column</code> and <code>@threshold</code> are macro variables
- Values are substituted when audit runs
- Same audit definition, multiple uses</p>
<p><strong>Example: Range check audit</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">value_in_range</span>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="p">);</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-107-6"><a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">min_value</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">max_value</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Usage:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="w">  </span><span class="n">value_in_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">min_value</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_value</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">120</span><span class="p">),</span>
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a><span class="w">  </span><span class="n">value_in_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">discount_percent</span><span class="p">,</span><span class="w"> </span><span class="n">min_value</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_value</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a><span class="p">)</span>
</span></code></pre></div></p>
<hr />
<h3 id="43-audit-file-organization">4.3 Audit File Organization<a class="headerlink" href="#43-audit-file-organization" title="Permanent link">&para;</a></h3>
<p>Organize audits by domain or function:</p>
<p><strong>Recommended structure:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>audits/
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a>├── common/                    # Reusable generic audits
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a>│   ├── nulls.sql             # Null-related checks
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a>│   ├── ranges.sql            # Range validations
</span><span id="__span-109-5"><a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a>│   └── formats.sql           # Format validations
</span><span id="__span-109-6"><a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a>├── sales/                     # Domain-specific audits
</span><span id="__span-109-7"><a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a>│   ├── orders.sql
</span><span id="__span-109-8"><a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a>│   └── revenue.sql
</span><span id="__span-109-9"><a id="__codelineno-109-9" name="__codelineno-109-9" href="#__codelineno-109-9"></a>├── finance/
</span><span id="__span-109-10"><a id="__codelineno-109-10" name="__codelineno-109-10" href="#__codelineno-109-10"></a>│   └── transactions.sql
</span><span id="__span-109-11"><a id="__codelineno-109-11" name="__codelineno-109-11" href="#__codelineno-109-11"></a>└── data_quality/
</span><span id="__span-109-12"><a id="__codelineno-109-12" name="__codelineno-109-12" href="#__codelineno-109-12"></a>    └── referential.sql       # Referential integrity checks
</span></code></pre></div></p>
<p><strong>Example: audits/common/ranges.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="c1">-- Generic positive value check</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">assert_positive</span><span class="p">);</span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a>
</span><span id="__span-110-6"><a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="c1">-- Generic non-negative check</span>
</span><span id="__span-110-7"><a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">assert_non_negative</span><span class="p">);</span>
</span><span id="__span-110-8"><a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-110-9"><a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-110-10"><a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a>
</span><span id="__span-110-11"><a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a><span class="c1">-- Generic percentage check (0-1)</span>
</span><span id="__span-110-12"><a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">assert_valid_percentage</span><span class="p">);</span>
</span><span id="__span-110-13"><a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-110-14"><a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-110-15"><a id="__codelineno-110-15" name="__codelineno-110-15" href="#__codelineno-110-15"></a>
</span><span id="__span-110-16"><a id="__codelineno-110-16" name="__codelineno-110-16" href="#__codelineno-110-16"></a><span class="c1">-- Generic percentage check (0-100)</span>
</span><span id="__span-110-17"><a id="__codelineno-110-17" name="__codelineno-110-17" href="#__codelineno-110-17"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">assert_valid_percentage_100</span><span class="p">);</span>
</span><span id="__span-110-18"><a id="__codelineno-110-18" name="__codelineno-110-18" href="#__codelineno-110-18"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-110-19"><a id="__codelineno-110-19" name="__codelineno-110-19" href="#__codelineno-110-19"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Example: audits/sales/orders.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="c1">-- Order-specific business rules</span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_order_dates</span><span class="p">);</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span>
</span><span id="__span-111-5"><a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span>
</span><span id="__span-111-6"><a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">shipped_date</span><span class="p">);</span>
</span><span id="__span-111-7"><a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a>
</span><span id="__span-111-8"><a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="c1">-- Order amount validation</span>
</span><span id="__span-111-9"><a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_order_amounts</span><span class="p">);</span>
</span><span id="__span-111-10"><a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-111-11"><a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-111-12"><a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">amount</span>
</span><span id="__span-111-13"><a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-111-14"><a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">total_amount</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>TIP:</strong> Multiple audits can be defined in a single file. Group related audits together.</p>
<hr />
<h3 id="44-special-macros">4.4 Special Macros<a class="headerlink" href="#44-special-macros" title="Permanent link">&para;</a></h3>
<p>Vulcan provides special macros for audit queries:</p>
<h4 id="this_model"><code>@this_model</code><a class="headerlink" href="#this_model" title="Permanent link">&para;</a></h4>
<p>References the model being audited. For incremental models, automatically filters to processed intervals.</p>
<p><strong>Usage:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_values</span><span class="p">);</span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">invalid_condition</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>For incremental models:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="c1">-- If model is INCREMENTAL_BY_TIME_RANGE with time_column = order_date</span>
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="c1">-- And processing interval 2024-01-15</span>
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a><span class="c1">-- @this_model expands to:</span>
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a><span class="c1">-- (SELECT * FROM sales.orders WHERE order_date = &#39;2024-01-15&#39;)</span>
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_today_orders</span><span class="p">);</span>
</span><span id="__span-113-8"><a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-113-9"><a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-113-10"><a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a><span class="c1">-- Only checks orders from 2024-01-15</span>
</span></code></pre></div></p>
<h4 id="start_ds-and-end_ds"><code>@start_ds</code> and <code>@end_ds</code><a class="headerlink" href="#start_ds-and-end_ds" title="Permanent link">&para;</a></h4>
<p>For incremental models, these provide the date/timestamp boundaries of the processed interval.</p>
<p><strong>Usage:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_date_range</span><span class="p">);</span>
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-114-3"><a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">start_ds</span>
</span><span id="__span-114-4"><a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">end_ds</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Example: Ensure all data is within expected interval</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">data_within_interval</span><span class="p">);</span>
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-115-3"><a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-115-4"><a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="w">  </span><span class="s1">&#39;@start_ds&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">expected_start</span><span class="p">,</span>
</span><span id="__span-115-5"><a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a><span class="w">  </span><span class="s1">&#39;@end_ds&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">expected_end</span>
</span><span id="__span-115-6"><a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-115-7"><a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">@</span><span class="n">start_ds</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">end_ds</span><span class="p">;</span>
</span></code></pre></div></p>
<h4 id="custom-parameters">Custom Parameters<a class="headerlink" href="#custom-parameters" title="Permanent link">&para;</a></h4>
<p>Any parameter passed to the audit becomes a macro variable:</p>
<p><strong>Audit definition:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">multi_param_check</span><span class="p">);</span>
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="n">column1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">threshold1</span>
</span><span id="__span-116-4"><a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="n">column2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">threshold2</span>
</span><span id="__span-116-5"><a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="o">@</span><span class="n">valid_statuses</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Usage:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="w">  </span><span class="n">multi_param_check</span><span class="p">(</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="w">    </span><span class="n">column1</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="w">    </span><span class="n">threshold1</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a><span class="w">    </span><span class="n">column2</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">margin</span><span class="p">,</span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a><span class="w">    </span><span class="n">threshold2</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a><span class="w">    </span><span class="n">valid_statuses</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">)</span>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a><span class="p">)</span>
</span></code></pre></div></p>
<hr />
<h3 id="45-dialect-specific-audits">4.5 Dialect-Specific Audits<a class="headerlink" href="#45-dialect-specific-audits" title="Permanent link">&para;</a></h3>
<p>Specify SQL dialect if different from project default:</p>
<p><strong>audits/spark_specific.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">check_array_length</span><span class="p">,</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="w">  </span><span class="n">dialect</span><span class="w"> </span><span class="n">spark</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="p">);</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-118-7"><a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">SIZE</span><span class="p">(</span><span class="o">@</span><span class="n">array_column</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">min_size</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Common use cases:</strong>
- Using database-specific functions
- Warehouse-specific syntax
- Multi-warehouse projects</p>
<p><strong>Example: BigQuery specific</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">check_json_field</span><span class="p">,</span>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="w">  </span><span class="n">dialect</span><span class="w"> </span><span class="n">bigquery</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="p">);</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">JSON_EXTRACT_SCALAR</span><span class="p">(</span><span class="o">@</span><span class="n">json_column</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;$.field&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Example: Snowflake specific</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">check_variant_field</span><span class="p">,</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="w">  </span><span class="n">dialect</span><span class="w"> </span><span class="n">snowflake</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="p">);</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="n">variant_column</span><span class="p">:</span><span class="n">field</span><span class="p">::</span><span class="n">STRING</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="46-default-parameters">4.6 Default Parameters<a class="headerlink" href="#46-default-parameters" title="Permanent link">&para;</a></h3>
<p>Provide default values for parameters:</p>
<p><strong>audits/defaults_example.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">threshold_check</span><span class="p">,</span>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a><span class="w">  </span><span class="k">defaults</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a><span class="w">    </span><span class="n">threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a><span class="w">    </span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span>
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a><span class="p">);</span>
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>
</span><span id="__span-121-9"><a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-121-10"><a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">threshold</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Usage with defaults:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="c1">-- Use default threshold (100) and default column (value)</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a><span class="w">  </span><span class="n">threshold_check</span><span class="p">()</span>
</span><span id="__span-122-4"><a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a><span class="p">)</span>
</span><span id="__span-122-5"><a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>
</span><span id="__span-122-6"><a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a><span class="c1">-- Override threshold, use default column</span>
</span><span id="__span-122-7"><a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-122-8"><a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a><span class="w">  </span><span class="n">threshold_check</span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-122-9"><a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a><span class="p">)</span>
</span><span id="__span-122-10"><a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a>
</span><span id="__span-122-11"><a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a><span class="c1">-- Override both</span>
</span><span id="__span-122-12"><a id="__codelineno-122-12" name="__codelineno-122-12" href="#__codelineno-122-12"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-122-13"><a id="__codelineno-122-13" name="__codelineno-122-13" href="#__codelineno-122-13"></a><span class="w">  </span><span class="n">threshold_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">)</span>
</span><span id="__span-122-14"><a id="__codelineno-122-14" name="__codelineno-122-14" href="#__codelineno-122-14"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Example: Flexible range check</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">range_check</span><span class="p">,</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="w">  </span><span class="k">defaults</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="w">    </span><span class="n">min_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="w">    </span><span class="n">max_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">999999</span><span class="p">,</span>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a><span class="w">    </span><span class="k">column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a><span class="w">    </span><span class="n">inclusive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-123-9"><a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a><span class="p">);</span>
</span><span id="__span-123-10"><a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a>
</span><span id="__span-123-11"><a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-123-12"><a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-123-13"><a id="__codelineno-123-13" name="__codelineno-123-13" href="#__codelineno-123-13"></a><span class="w">  </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="o">@</span><span class="n">inclusive</span><span class="w"> </span><span class="k">THEN</span>
</span><span id="__span-123-14"><a id="__codelineno-123-14" name="__codelineno-123-14" href="#__codelineno-123-14"></a><span class="w">    </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">min_value</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">max_value</span>
</span><span id="__span-123-15"><a id="__codelineno-123-15" name="__codelineno-123-15" href="#__codelineno-123-15"></a><span class="w">  </span><span class="k">ELSE</span>
</span><span id="__span-123-16"><a id="__codelineno-123-16" name="__codelineno-123-16" href="#__codelineno-123-16"></a><span class="w">    </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">@</span><span class="n">min_value</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">@</span><span class="n">max_value</span>
</span><span id="__span-123-17"><a id="__codelineno-123-17" name="__codelineno-123-17" href="#__codelineno-123-17"></a><span class="w">  </span><span class="k">END</span>
</span><span id="__span-123-18"><a id="__codelineno-123-18" name="__codelineno-123-18" href="#__codelineno-123-18"></a><span class="p">);</span>
</span></code></pre></div></p>
<hr />
<h3 id="47-naming-conventions-for-custom-audits">4.7 Naming Conventions for Custom Audits<a class="headerlink" href="#47-naming-conventions-for-custom-audits" title="Permanent link">&para;</a></h3>
<p><strong>CORRECT naming:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="c1">-- Descriptive, action-oriented names</span>
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="n">assert_positive_revenue</span>
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="n">validate_customer_exists</span>
</span><span id="__span-124-4"><a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a><span class="n">check_order_date_before_shipped_date</span>
</span><span id="__span-124-5"><a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a><span class="n">ensure_email_format_valid</span>
</span><span id="__span-124-6"><a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a><span class="n">verify_no_duplicate_transactions</span>
</span></code></pre></div></p>
<p><strong>INCORRECT naming:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="c1">-- Too vague</span>
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="n">audit1</span>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="n">check_data</span>
</span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a><span class="n">validation</span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a><span class="n">my_audit</span>
</span><span id="__span-125-6"><a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a>
</span><span id="__span-125-7"><a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a><span class="c1">-- Too generic</span>
</span><span id="__span-125-8"><a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a><span class="k">check</span>
</span><span id="__span-125-9"><a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a><span class="n">validate</span>
</span><span id="__span-125-10"><a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a><span class="n">ensure</span>
</span></code></pre></div></p>
<p><strong>Naming patterns:</strong>
- <code>assert_*</code> - For simple assertions (assert_positive_price)
- <code>validate_*</code> - For complex validations (validate_referential_integrity)
- <code>check_*</code> - For conditional checks (check_date_ordering)
- <code>ensure_*</code> - For guarantee checks (ensure_completeness)
- <code>verify_*</code> - For verification logic (verify_calculations)</p>
<hr />
<h3 id="48-documenting-custom-audits">4.8 Documenting Custom Audits<a class="headerlink" href="#48-documenting-custom-audits" title="Permanent link">&para;</a></h3>
<p>Add comments to explain complex audits:</p>
<p><strong>audits/documented_example.sql</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="c1">-- Audit: validate_revenue_calculation</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a><span class="c1">-- Description: Ensures revenue calculation is correct</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a><span class="c1">-- Business Rule: Revenue = Quantity * Unit Price - Discounts + Taxes</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a><span class="c1">-- Tolerance: Allow $0.01 rounding difference</span>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">validate_revenue_calculation</span><span class="p">);</span>
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a>
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-126-11"><a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a><span class="w">  </span><span class="n">revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">recorded_revenue</span><span class="p">,</span>
</span><span id="__span-126-12"><a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a><span class="w">  </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">calculated_revenue</span><span class="p">,</span>
</span><span id="__span-126-13"><a id="__codelineno-126-13" name="__codelineno-126-13" href="#__codelineno-126-13"></a><span class="w">  </span><span class="k">ABS</span><span class="p">(</span><span class="n">revenue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">difference</span>
</span><span id="__span-126-14"><a id="__codelineno-126-14" name="__codelineno-126-14" href="#__codelineno-126-14"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-126-15"><a id="__codelineno-126-15" name="__codelineno-126-15" href="#__codelineno-126-15"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">revenue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Complex business logic audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="c1">-- Audit: validate_subscription_lifecycle</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="c1">-- Description: Ensures subscription dates follow valid lifecycle</span>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="c1">-- Business Rules:</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a><span class="c1">--   1. start_date &lt;= current_date</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="c1">--   2. end_date &gt; start_date (if not NULL)</span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a><span class="c1">--   3. cancelled_date between start_date and end_date</span>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a><span class="c1">--   4. renewal_date &gt; end_date (for auto-renew subscriptions)</span>
</span><span id="__span-127-9"><a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-127-10"><a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">validate_subscription_lifecycle</span><span class="p">);</span>
</span><span id="__span-127-11"><a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a>
</span><span id="__span-127-12"><a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-127-13"><a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a><span class="w">  </span><span class="n">subscription_id</span><span class="p">,</span>
</span><span id="__span-127-14"><a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a><span class="w">  </span><span class="n">start_date</span><span class="p">,</span>
</span><span id="__span-127-15"><a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a><span class="w">  </span><span class="n">end_date</span><span class="p">,</span>
</span><span id="__span-127-16"><a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a><span class="w">  </span><span class="n">cancelled_date</span><span class="p">,</span>
</span><span id="__span-127-17"><a id="__codelineno-127-17" name="__codelineno-127-17" href="#__codelineno-127-17"></a><span class="w">  </span><span class="n">renewal_date</span><span class="p">,</span>
</span><span id="__span-127-18"><a id="__codelineno-127-18" name="__codelineno-127-18" href="#__codelineno-127-18"></a><span class="w">  </span><span class="k">CASE</span>
</span><span id="__span-127-19"><a id="__codelineno-127-19" name="__codelineno-127-19" href="#__codelineno-127-19"></a><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">start_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Future start date&#39;</span>
</span><span id="__span-127-20"><a id="__codelineno-127-20" name="__codelineno-127-20" href="#__codelineno-127-20"></a><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">start_date</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;End before start&#39;</span>
</span><span id="__span-127-21"><a id="__codelineno-127-21" name="__codelineno-127-21" href="#__codelineno-127-21"></a><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">start_date</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Cancelled before start&#39;</span>
</span><span id="__span-127-22"><a id="__codelineno-127-22" name="__codelineno-127-22" href="#__codelineno-127-22"></a><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Cancelled after end&#39;</span>
</span><span id="__span-127-23"><a id="__codelineno-127-23" name="__codelineno-127-23" href="#__codelineno-127-23"></a><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">renewal_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">renewal_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Renewal before end&#39;</span>
</span><span id="__span-127-24"><a id="__codelineno-127-24" name="__codelineno-127-24" href="#__codelineno-127-24"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Unknown violation&#39;</span>
</span><span id="__span-127-25"><a id="__codelineno-127-25" name="__codelineno-127-25" href="#__codelineno-127-25"></a><span class="w">  </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">violation_type</span>
</span><span id="__span-127-26"><a id="__codelineno-127-26" name="__codelineno-127-26" href="#__codelineno-127-26"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-127-27"><a id="__codelineno-127-27" name="__codelineno-127-27" href="#__codelineno-127-27"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">start_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span>
</span><span id="__span-127-28"><a id="__codelineno-127-28" name="__codelineno-127-28" href="#__codelineno-127-28"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">end_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">start_date</span><span class="p">)</span>
</span><span id="__span-127-29"><a id="__codelineno-127-29" name="__codelineno-127-29" href="#__codelineno-127-29"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">cancelled_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">start_date</span><span class="p">)</span>
</span><span id="__span-127-30"><a id="__codelineno-127-30" name="__codelineno-127-30" href="#__codelineno-127-30"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">cancelled_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">end_date</span><span class="p">)</span>
</span><span id="__span-127-31"><a id="__codelineno-127-31" name="__codelineno-127-31" href="#__codelineno-127-31"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">renewal_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">renewal_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">end_date</span><span class="p">);</span>
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="5-inline-audits">5. Inline Audits<a class="headerlink" href="#5-inline-audits" title="Permanent link">&para;</a></h2>
<p>Inline audits are defined directly within model files, keeping audit logic close to the model it validates.</p>
<h3 id="51-when-to-use-inline-vs-file-based-audits">5.1 When to Use Inline vs File-Based Audits<a class="headerlink" href="#51-when-to-use-inline-vs-file-based-audits" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Use Inline Audits</th>
<th>Use File-Based Audits</th>
</tr>
</thead>
<tbody>
<tr>
<td>Model-specific validation</td>
<td>Reusable across models</td>
</tr>
<tr>
<td>Simple, one-off checks</td>
<td>Complex parameterized logic</td>
</tr>
<tr>
<td>Keep audit close to model logic</td>
<td>Shared team standards</td>
</tr>
<tr>
<td>Quick prototyping</td>
<td>Organized by domain</td>
</tr>
<tr>
<td>Few audits (1-3)</td>
<td>Many audits (4+)</td>
</tr>
</tbody>
</table>
<p><strong>CORRECT: Use inline for model-specific logic</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="c1">-- models/sales/daily_metrics.sql</span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_metrics</span><span class="p">,</span>
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">revenue_matches_orders</span><span class="p">,</span><span class="w"> </span><span class="n">no_future_dates</span><span class="p">)</span>
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="p">);</span>
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a>
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a><span class="k">SELECT</span>
</span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span>
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span>
</span><span id="__span-128-11"><a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-128-12"><a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">order_date</span><span class="p">;</span>
</span><span id="__span-128-13"><a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a>
</span><span id="__span-128-14"><a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a><span class="c1">-- Inline audit 1: Model-specific calculation check</span>
</span><span id="__span-128-15"><a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">revenue_matches_orders</span><span class="p">);</span>
</span><span id="__span-128-16"><a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">actual_revenue</span>
</span><span id="__span-128-17"><a id="__codelineno-128-17" name="__codelineno-128-17" href="#__codelineno-128-17"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">dm</span>
</span><span id="__span-128-18"><a id="__codelineno-128-18" name="__codelineno-128-18" href="#__codelineno-128-18"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span>
</span><span id="__span-128-19"><a id="__codelineno-128-19" name="__codelineno-128-19" href="#__codelineno-128-19"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">revenue</span>
</span><span id="__span-128-20"><a id="__codelineno-128-20" name="__codelineno-128-20" href="#__codelineno-128-20"></a><span class="k">HAVING</span><span class="w"> </span><span class="n">dm</span><span class="p">.</span><span class="n">revenue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">amount</span><span class="p">);</span>
</span><span id="__span-128-21"><a id="__codelineno-128-21" name="__codelineno-128-21" href="#__codelineno-128-21"></a>
</span><span id="__span-128-22"><a id="__codelineno-128-22" name="__codelineno-128-22" href="#__codelineno-128-22"></a><span class="c1">-- Inline audit 2: Model-specific date check</span>
</span><span id="__span-128-23"><a id="__codelineno-128-23" name="__codelineno-128-23" href="#__codelineno-128-23"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">no_future_dates</span><span class="p">);</span>
</span><span id="__span-128-24"><a id="__codelineno-128-24" name="__codelineno-128-24" href="#__codelineno-128-24"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-128-25"><a id="__codelineno-128-25" name="__codelineno-128-25" href="#__codelineno-128-25"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>INCORRECT: Don't inline generic reusable audits</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="c1">-- DON&#39;T DO THIS - This should be in audits/common/</span>
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">not_null_check</span><span class="p">,</span><span class="w"> </span><span class="n">positive_amount_check</span><span class="p">)</span>
</span><span id="__span-129-5"><a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a><span class="p">);</span>
</span><span id="__span-129-6"><a id="__codelineno-129-6" name="__codelineno-129-6" href="#__codelineno-129-6"></a>
</span><span id="__span-129-7"><a id="__codelineno-129-7" name="__codelineno-129-7" href="#__codelineno-129-7"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span><span id="__span-129-8"><a id="__codelineno-129-8" name="__codelineno-129-8" href="#__codelineno-129-8"></a>
</span><span id="__span-129-9"><a id="__codelineno-129-9" name="__codelineno-129-9" href="#__codelineno-129-9"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">not_null_check</span><span class="p">);</span><span class="w">  </span><span class="c1">-- Generic! Should be in audits/</span>
</span><span id="__span-129-10"><a id="__codelineno-129-10" name="__codelineno-129-10" href="#__codelineno-129-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">order_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span><span id="__span-129-11"><a id="__codelineno-129-11" name="__codelineno-129-11" href="#__codelineno-129-11"></a>
</span><span id="__span-129-12"><a id="__codelineno-129-12" name="__codelineno-129-12" href="#__codelineno-129-12"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">positive_amount_check</span><span class="p">);</span><span class="w">  </span><span class="c1">-- Generic! Should be in audits/</span>
</span><span id="__span-129-13"><a id="__codelineno-129-13" name="__codelineno-129-13" href="#__codelineno-129-13"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="52-inline-audit-syntax">5.2 Inline Audit Syntax<a class="headerlink" href="#52-inline-audit-syntax" title="Permanent link">&para;</a></h3>
<p><strong>Basic syntax:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="k">table_name</span><span class="p">,</span>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3" href="#__codelineno-130-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">audit1</span><span class="p">,</span><span class="w"> </span><span class="n">audit2</span><span class="p">,</span><span class="w"> </span><span class="n">audit3</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Reference inline audits</span>
</span><span id="__span-130-4"><a id="__codelineno-130-4" name="__codelineno-130-4" href="#__codelineno-130-4"></a><span class="p">);</span>
</span><span id="__span-130-5"><a id="__codelineno-130-5" name="__codelineno-130-5" href="#__codelineno-130-5"></a>
</span><span id="__span-130-6"><a id="__codelineno-130-6" name="__codelineno-130-6" href="#__codelineno-130-6"></a><span class="c1">-- Model query</span>
</span><span id="__span-130-7"><a id="__codelineno-130-7" name="__codelineno-130-7" href="#__codelineno-130-7"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-130-8"><a id="__codelineno-130-8" name="__codelineno-130-8" href="#__codelineno-130-8"></a>
</span><span id="__span-130-9"><a id="__codelineno-130-9" name="__codelineno-130-9" href="#__codelineno-130-9"></a><span class="c1">-- Inline audit definitions</span>
</span><span id="__span-130-10"><a id="__codelineno-130-10" name="__codelineno-130-10" href="#__codelineno-130-10"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">audit1</span><span class="p">);</span>
</span><span id="__span-130-11"><a id="__codelineno-130-11" name="__codelineno-130-11" href="#__codelineno-130-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-130-12"><a id="__codelineno-130-12" name="__codelineno-130-12" href="#__codelineno-130-12"></a>
</span><span id="__span-130-13"><a id="__codelineno-130-13" name="__codelineno-130-13" href="#__codelineno-130-13"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">audit2</span><span class="p">);</span>
</span><span id="__span-130-14"><a id="__codelineno-130-14" name="__codelineno-130-14" href="#__codelineno-130-14"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-130-15"><a id="__codelineno-130-15" name="__codelineno-130-15" href="#__codelineno-130-15"></a>
</span><span id="__span-130-16"><a id="__codelineno-130-16" name="__codelineno-130-16" href="#__codelineno-130-16"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">audit3</span><span class="p">);</span>
</span><span id="__span-130-17"><a id="__codelineno-130-17" name="__codelineno-130-17" href="#__codelineno-130-17"></a><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span></code></pre></div></p>
<p><strong>Example: Product inventory</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">inventory</span><span class="p">.</span><span class="n">product_stock</span><span class="p">,</span>
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">warehouse_id</span><span class="p">),</span>
</span><span id="__span-131-4"><a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-131-5"><a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a><span class="w">    </span><span class="n">valid_stock_levels</span><span class="p">,</span>
</span><span id="__span-131-6"><a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a><span class="w">    </span><span class="n">consistent_totals</span>
</span><span id="__span-131-7"><a id="__codelineno-131-7" name="__codelineno-131-7" href="#__codelineno-131-7"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-131-8"><a id="__codelineno-131-8" name="__codelineno-131-8" href="#__codelineno-131-8"></a><span class="p">);</span>
</span><span id="__span-131-9"><a id="__codelineno-131-9" name="__codelineno-131-9" href="#__codelineno-131-9"></a>
</span><span id="__span-131-10"><a id="__codelineno-131-10" name="__codelineno-131-10" href="#__codelineno-131-10"></a><span class="k">SELECT</span>
</span><span id="__span-131-11"><a id="__codelineno-131-11" name="__codelineno-131-11" href="#__codelineno-131-11"></a><span class="w">  </span><span class="n">product_id</span><span class="p">,</span>
</span><span id="__span-131-12"><a id="__codelineno-131-12" name="__codelineno-131-12" href="#__codelineno-131-12"></a><span class="w">  </span><span class="n">warehouse_id</span><span class="p">,</span>
</span><span id="__span-131-13"><a id="__codelineno-131-13" name="__codelineno-131-13" href="#__codelineno-131-13"></a><span class="w">  </span><span class="n">on_hand_qty</span><span class="p">,</span>
</span><span id="__span-131-14"><a id="__codelineno-131-14" name="__codelineno-131-14" href="#__codelineno-131-14"></a><span class="w">  </span><span class="n">reserved_qty</span><span class="p">,</span>
</span><span id="__span-131-15"><a id="__codelineno-131-15" name="__codelineno-131-15" href="#__codelineno-131-15"></a><span class="w">  </span><span class="n">available_qty</span>
</span><span id="__span-131-16"><a id="__codelineno-131-16" name="__codelineno-131-16" href="#__codelineno-131-16"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">inventory</span><span class="p">;</span>
</span><span id="__span-131-17"><a id="__codelineno-131-17" name="__codelineno-131-17" href="#__codelineno-131-17"></a>
</span><span id="__span-131-18"><a id="__codelineno-131-18" name="__codelineno-131-18" href="#__codelineno-131-18"></a><span class="c1">-- Audit 1: Stock quantities make sense</span>
</span><span id="__span-131-19"><a id="__codelineno-131-19" name="__codelineno-131-19" href="#__codelineno-131-19"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_stock_levels</span><span class="p">);</span>
</span><span id="__span-131-20"><a id="__codelineno-131-20" name="__codelineno-131-20" href="#__codelineno-131-20"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-131-21"><a id="__codelineno-131-21" name="__codelineno-131-21" href="#__codelineno-131-21"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">on_hand_qty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-131-22"><a id="__codelineno-131-22" name="__codelineno-131-22" href="#__codelineno-131-22"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">reserved_qty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-131-23"><a id="__codelineno-131-23" name="__codelineno-131-23" href="#__codelineno-131-23"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">available_qty</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-131-24"><a id="__codelineno-131-24" name="__codelineno-131-24" href="#__codelineno-131-24"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">reserved_qty</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">on_hand_qty</span>
</span><span id="__span-131-25"><a id="__codelineno-131-25" name="__codelineno-131-25" href="#__codelineno-131-25"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">available_qty</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">on_hand_qty</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">reserved_qty</span><span class="p">);</span>
</span><span id="__span-131-26"><a id="__codelineno-131-26" name="__codelineno-131-26" href="#__codelineno-131-26"></a>
</span><span id="__span-131-27"><a id="__codelineno-131-27" name="__codelineno-131-27" href="#__codelineno-131-27"></a><span class="c1">-- Audit 2: Totals match warehouse aggregates</span>
</span><span id="__span-131-28"><a id="__codelineno-131-28" name="__codelineno-131-28" href="#__codelineno-131-28"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">consistent_totals</span><span class="p">);</span>
</span><span id="__span-131-29"><a id="__codelineno-131-29" name="__codelineno-131-29" href="#__codelineno-131-29"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-131-30"><a id="__codelineno-131-30" name="__codelineno-131-30" href="#__codelineno-131-30"></a><span class="w">  </span><span class="n">product_id</span><span class="p">,</span>
</span><span id="__span-131-31"><a id="__codelineno-131-31" name="__codelineno-131-31" href="#__codelineno-131-31"></a><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">warehouse_count</span><span class="p">,</span>
</span><span id="__span-131-32"><a id="__codelineno-131-32" name="__codelineno-131-32" href="#__codelineno-131-32"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">on_hand_qty</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_on_hand</span>
</span><span id="__span-131-33"><a id="__codelineno-131-33" name="__codelineno-131-33" href="#__codelineno-131-33"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-131-34"><a id="__codelineno-131-34" name="__codelineno-131-34" href="#__codelineno-131-34"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span>
</span><span id="__span-131-35"><a id="__codelineno-131-35" name="__codelineno-131-35" href="#__codelineno-131-35"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">on_hand_qty</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Shouldn&#39;t be possible if audit 1 passes</span>
</span></code></pre></div></p>
<hr />
<h3 id="53-multiple-inline-audits">5.3 Multiple Inline Audits<a class="headerlink" href="#53-multiple-inline-audits" title="Permanent link">&para;</a></h3>
<p>You can define many inline audits in a single model file:</p>
<p><strong>Example: Comprehensive order validation</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a><span class="w">    </span><span class="n">valid_amounts</span><span class="p">,</span>
</span><span id="__span-132-6"><a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a><span class="w">    </span><span class="n">valid_dates</span><span class="p">,</span>
</span><span id="__span-132-7"><a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a><span class="w">    </span><span class="n">valid_status_transitions</span><span class="p">,</span>
</span><span id="__span-132-8"><a id="__codelineno-132-8" name="__codelineno-132-8" href="#__codelineno-132-8"></a><span class="w">    </span><span class="n">valid_customer_references</span><span class="p">,</span>
</span><span id="__span-132-9"><a id="__codelineno-132-9" name="__codelineno-132-9" href="#__codelineno-132-9"></a><span class="w">    </span><span class="n">valid_calculations</span>
</span><span id="__span-132-10"><a id="__codelineno-132-10" name="__codelineno-132-10" href="#__codelineno-132-10"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-132-11"><a id="__codelineno-132-11" name="__codelineno-132-11" href="#__codelineno-132-11"></a><span class="p">);</span>
</span><span id="__span-132-12"><a id="__codelineno-132-12" name="__codelineno-132-12" href="#__codelineno-132-12"></a>
</span><span id="__span-132-13"><a id="__codelineno-132-13" name="__codelineno-132-13" href="#__codelineno-132-13"></a><span class="k">SELECT</span>
</span><span id="__span-132-14"><a id="__codelineno-132-14" name="__codelineno-132-14" href="#__codelineno-132-14"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-132-15"><a id="__codelineno-132-15" name="__codelineno-132-15" href="#__codelineno-132-15"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-132-16"><a id="__codelineno-132-16" name="__codelineno-132-16" href="#__codelineno-132-16"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-132-17"><a id="__codelineno-132-17" name="__codelineno-132-17" href="#__codelineno-132-17"></a><span class="w">  </span><span class="n">shipped_date</span><span class="p">,</span>
</span><span id="__span-132-18"><a id="__codelineno-132-18" name="__codelineno-132-18" href="#__codelineno-132-18"></a><span class="w">  </span><span class="n">delivered_date</span><span class="p">,</span>
</span><span id="__span-132-19"><a id="__codelineno-132-19" name="__codelineno-132-19" href="#__codelineno-132-19"></a><span class="w">  </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-132-20"><a id="__codelineno-132-20" name="__codelineno-132-20" href="#__codelineno-132-20"></a><span class="w">  </span><span class="n">discount_amount</span><span class="p">,</span>
</span><span id="__span-132-21"><a id="__codelineno-132-21" name="__codelineno-132-21" href="#__codelineno-132-21"></a><span class="w">  </span><span class="n">tax_amount</span><span class="p">,</span>
</span><span id="__span-132-22"><a id="__codelineno-132-22" name="__codelineno-132-22" href="#__codelineno-132-22"></a><span class="w">  </span><span class="n">total_amount</span><span class="p">,</span>
</span><span id="__span-132-23"><a id="__codelineno-132-23" name="__codelineno-132-23" href="#__codelineno-132-23"></a><span class="w">  </span><span class="n">status</span>
</span><span id="__span-132-24"><a id="__codelineno-132-24" name="__codelineno-132-24" href="#__codelineno-132-24"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span><span id="__span-132-25"><a id="__codelineno-132-25" name="__codelineno-132-25" href="#__codelineno-132-25"></a>
</span><span id="__span-132-26"><a id="__codelineno-132-26" name="__codelineno-132-26" href="#__codelineno-132-26"></a><span class="c1">-- Audit 1: Amount validations</span>
</span><span id="__span-132-27"><a id="__codelineno-132-27" name="__codelineno-132-27" href="#__codelineno-132-27"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_amounts</span><span class="p">);</span>
</span><span id="__span-132-28"><a id="__codelineno-132-28" name="__codelineno-132-28" href="#__codelineno-132-28"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-132-29"><a id="__codelineno-132-29" name="__codelineno-132-29" href="#__codelineno-132-29"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-132-30"><a id="__codelineno-132-30" name="__codelineno-132-30" href="#__codelineno-132-30"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-132-31"><a id="__codelineno-132-31" name="__codelineno-132-31" href="#__codelineno-132-31"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-132-32"><a id="__codelineno-132-32" name="__codelineno-132-32" href="#__codelineno-132-32"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">total_amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-132-33"><a id="__codelineno-132-33" name="__codelineno-132-33" href="#__codelineno-132-33"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span>
</span><span id="__span-132-34"><a id="__codelineno-132-34" name="__codelineno-132-34" href="#__codelineno-132-34"></a>
</span><span id="__span-132-35"><a id="__codelineno-132-35" name="__codelineno-132-35" href="#__codelineno-132-35"></a><span class="c1">-- Audit 2: Date validations</span>
</span><span id="__span-132-36"><a id="__codelineno-132-36" name="__codelineno-132-36" href="#__codelineno-132-36"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_dates</span><span class="p">);</span>
</span><span id="__span-132-37"><a id="__codelineno-132-37" name="__codelineno-132-37" href="#__codelineno-132-37"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-132-38"><a id="__codelineno-132-38" name="__codelineno-132-38" href="#__codelineno-132-38"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span>
</span><span id="__span-132-39"><a id="__codelineno-132-39" name="__codelineno-132-39" href="#__codelineno-132-39"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span>
</span><span id="__span-132-40"><a id="__codelineno-132-40" name="__codelineno-132-40" href="#__codelineno-132-40"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">shipped_date</span><span class="p">);</span>
</span><span id="__span-132-41"><a id="__codelineno-132-41" name="__codelineno-132-41" href="#__codelineno-132-41"></a>
</span><span id="__span-132-42"><a id="__codelineno-132-42" name="__codelineno-132-42" href="#__codelineno-132-42"></a><span class="c1">-- Audit 3: Status logic</span>
</span><span id="__span-132-43"><a id="__codelineno-132-43" name="__codelineno-132-43" href="#__codelineno-132-43"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_status_transitions</span><span class="p">);</span>
</span><span id="__span-132-44"><a id="__codelineno-132-44" name="__codelineno-132-44" href="#__codelineno-132-44"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-132-45"><a id="__codelineno-132-45" name="__codelineno-132-45" href="#__codelineno-132-45"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span><span id="__span-132-46"><a id="__codelineno-132-46" name="__codelineno-132-46" href="#__codelineno-132-46"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;delivered&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span><span id="__span-132-47"><a id="__codelineno-132-47" name="__codelineno-132-47" href="#__codelineno-132-47"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">);</span>
</span><span id="__span-132-48"><a id="__codelineno-132-48" name="__codelineno-132-48" href="#__codelineno-132-48"></a>
</span><span id="__span-132-49"><a id="__codelineno-132-49" name="__codelineno-132-49" href="#__codelineno-132-49"></a><span class="c1">-- Audit 4: Referential integrity</span>
</span><span id="__span-132-50"><a id="__codelineno-132-50" name="__codelineno-132-50" href="#__codelineno-132-50"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_customer_references</span><span class="p">);</span>
</span><span id="__span-132-51"><a id="__codelineno-132-51" name="__codelineno-132-51" href="#__codelineno-132-51"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-132-52"><a id="__codelineno-132-52" name="__codelineno-132-52" href="#__codelineno-132-52"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-132-53"><a id="__codelineno-132-53" name="__codelineno-132-53" href="#__codelineno-132-53"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-132-54"><a id="__codelineno-132-54" name="__codelineno-132-54" href="#__codelineno-132-54"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span><span id="__span-132-55"><a id="__codelineno-132-55" name="__codelineno-132-55" href="#__codelineno-132-55"></a>
</span><span id="__span-132-56"><a id="__codelineno-132-56" name="__codelineno-132-56" href="#__codelineno-132-56"></a><span class="c1">-- Audit 5: Calculation validation</span>
</span><span id="__span-132-57"><a id="__codelineno-132-57" name="__codelineno-132-57" href="#__codelineno-132-57"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_calculations</span><span class="p">);</span>
</span><span id="__span-132-58"><a id="__codelineno-132-58" name="__codelineno-132-58" href="#__codelineno-132-58"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-132-59"><a id="__codelineno-132-59" name="__codelineno-132-59" href="#__codelineno-132-59"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">total_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>TIP:</strong> Inline audits run in the order defined. Put fast audits first, expensive audits last.</p>
<hr />
<h3 id="54-combining-inline-and-file-based-audits">5.4 Combining Inline and File-Based Audits<a class="headerlink" href="#54-combining-inline-and-file-based-audits" title="Permanent link">&para;</a></h3>
<p>You can use both inline and file-based audits together:</p>
<p><strong>Example: Mix generic and specific audits</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-133-4"><a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-133-5"><a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a><span class="w">    </span><span class="c1">-- File-based generic audits</span>
</span><span id="__span-133-6"><a id="__codelineno-133-6" name="__codelineno-133-6" href="#__codelineno-133-6"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">)),</span>
</span><span id="__span-133-7"><a id="__codelineno-133-7" name="__codelineno-133-7" href="#__codelineno-133-7"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-133-8"><a id="__codelineno-133-8" name="__codelineno-133-8" href="#__codelineno-133-8"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">),</span>
</span><span id="__span-133-9"><a id="__codelineno-133-9" name="__codelineno-133-9" href="#__codelineno-133-9"></a>
</span><span id="__span-133-10"><a id="__codelineno-133-10" name="__codelineno-133-10" href="#__codelineno-133-10"></a><span class="w">    </span><span class="c1">-- Inline model-specific audits</span>
</span><span id="__span-133-11"><a id="__codelineno-133-11" name="__codelineno-133-11" href="#__codelineno-133-11"></a><span class="w">    </span><span class="n">valid_order_lifecycle</span><span class="p">,</span>
</span><span id="__span-133-12"><a id="__codelineno-133-12" name="__codelineno-133-12" href="#__codelineno-133-12"></a><span class="w">    </span><span class="n">revenue_matches_line_items</span>
</span><span id="__span-133-13"><a id="__codelineno-133-13" name="__codelineno-133-13" href="#__codelineno-133-13"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-133-14"><a id="__codelineno-133-14" name="__codelineno-133-14" href="#__codelineno-133-14"></a><span class="p">);</span>
</span><span id="__span-133-15"><a id="__codelineno-133-15" name="__codelineno-133-15" href="#__codelineno-133-15"></a>
</span><span id="__span-133-16"><a id="__codelineno-133-16" name="__codelineno-133-16" href="#__codelineno-133-16"></a><span class="k">SELECT</span>
</span><span id="__span-133-17"><a id="__codelineno-133-17" name="__codelineno-133-17" href="#__codelineno-133-17"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-133-18"><a id="__codelineno-133-18" name="__codelineno-133-18" href="#__codelineno-133-18"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-133-19"><a id="__codelineno-133-19" name="__codelineno-133-19" href="#__codelineno-133-19"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-133-20"><a id="__codelineno-133-20" name="__codelineno-133-20" href="#__codelineno-133-20"></a><span class="w">  </span><span class="n">shipped_date</span><span class="p">,</span>
</span><span id="__span-133-21"><a id="__codelineno-133-21" name="__codelineno-133-21" href="#__codelineno-133-21"></a><span class="w">  </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-133-22"><a id="__codelineno-133-22" name="__codelineno-133-22" href="#__codelineno-133-22"></a><span class="w">  </span><span class="n">discount_amount</span>
</span><span id="__span-133-23"><a id="__codelineno-133-23" name="__codelineno-133-23" href="#__codelineno-133-23"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span><span id="__span-133-24"><a id="__codelineno-133-24" name="__codelineno-133-24" href="#__codelineno-133-24"></a>
</span><span id="__span-133-25"><a id="__codelineno-133-25" name="__codelineno-133-25" href="#__codelineno-133-25"></a><span class="c1">-- Inline audit 1: Order-specific lifecycle</span>
</span><span id="__span-133-26"><a id="__codelineno-133-26" name="__codelineno-133-26" href="#__codelineno-133-26"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_order_lifecycle</span><span class="p">);</span>
</span><span id="__span-133-27"><a id="__codelineno-133-27" name="__codelineno-133-27" href="#__codelineno-133-27"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-133-28"><a id="__codelineno-133-28" name="__codelineno-133-28" href="#__codelineno-133-28"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span>
</span><span id="__span-133-29"><a id="__codelineno-133-29" name="__codelineno-133-29" href="#__codelineno-133-29"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">order_date</span><span class="p">;</span>
</span><span id="__span-133-30"><a id="__codelineno-133-30" name="__codelineno-133-30" href="#__codelineno-133-30"></a>
</span><span id="__span-133-31"><a id="__codelineno-133-31" name="__codelineno-133-31" href="#__codelineno-133-31"></a><span class="c1">-- Inline audit 2: Order-specific calculation</span>
</span><span id="__span-133-32"><a id="__codelineno-133-32" name="__codelineno-133-32" href="#__codelineno-133-32"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">revenue_matches_line_items</span><span class="p">);</span>
</span><span id="__span-133-33"><a id="__codelineno-133-33" name="__codelineno-133-33" href="#__codelineno-133-33"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-133-34"><a id="__codelineno-133-34" name="__codelineno-133-34" href="#__codelineno-133-34"></a><span class="w">  </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-133-35"><a id="__codelineno-133-35" name="__codelineno-133-35" href="#__codelineno-133-35"></a><span class="w">  </span><span class="n">o</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_amount</span><span class="p">,</span>
</span><span id="__span-133-36"><a id="__codelineno-133-36" name="__codelineno-133-36" href="#__codelineno-133-36"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">line_items_total</span>
</span><span id="__span-133-37"><a id="__codelineno-133-37" name="__codelineno-133-37" href="#__codelineno-133-37"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-133-38"><a id="__codelineno-133-38" name="__codelineno-133-38" href="#__codelineno-133-38"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">order_line_items</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">order_id</span>
</span><span id="__span-133-39"><a id="__codelineno-133-39" name="__codelineno-133-39" href="#__codelineno-133-39"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">amount</span>
</span><span id="__span-133-40"><a id="__codelineno-133-40" name="__codelineno-133-40" href="#__codelineno-133-40"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">unit_price</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>When to combine:</strong>
- Use file-based audits for standard validations (nulls, uniqueness, ranges)
- Use inline audits for model-specific business logic
- This gives you both reusability and specificity</p>
<hr />
<h3 id="55-inline-audits-with-parameters">5.5 Inline Audits with Parameters<a class="headerlink" href="#55-inline-audits-with-parameters" title="Permanent link">&para;</a></h3>
<p>Inline audits can be parameterized too:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a><span class="w">    </span><span class="n">threshold_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">),</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a><span class="w">    </span><span class="n">threshold_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-134-6"><a id="__codelineno-134-6" name="__codelineno-134-6" href="#__codelineno-134-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-134-7"><a id="__codelineno-134-7" name="__codelineno-134-7" href="#__codelineno-134-7"></a><span class="p">);</span>
</span><span id="__span-134-8"><a id="__codelineno-134-8" name="__codelineno-134-8" href="#__codelineno-134-8"></a>
</span><span id="__span-134-9"><a id="__codelineno-134-9" name="__codelineno-134-9" href="#__codelineno-134-9"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span><span id="__span-134-10"><a id="__codelineno-134-10" name="__codelineno-134-10" href="#__codelineno-134-10"></a>
</span><span id="__span-134-11"><a id="__codelineno-134-11" name="__codelineno-134-11" href="#__codelineno-134-11"></a><span class="c1">-- Parameterized inline audit</span>
</span><span id="__span-134-12"><a id="__codelineno-134-12" name="__codelineno-134-12" href="#__codelineno-134-12"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">threshold_check</span><span class="p">);</span>
</span><span id="__span-134-13"><a id="__codelineno-134-13" name="__codelineno-134-13" href="#__codelineno-134-13"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-134-14"><a id="__codelineno-134-14" name="__codelineno-134-14" href="#__codelineno-134-14"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">threshold</span><span class="p">;</span>
</span></code></pre></div>
<p><strong>Reusing inline audits within the same model:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">metrics</span><span class="p">,</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a><span class="w">    </span><span class="n">range_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="n">min_val</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_val</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">),</span>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a><span class="w">    </span><span class="n">range_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">profit</span><span class="p">,</span><span class="w"> </span><span class="n">min_val</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">100000</span><span class="p">,</span><span class="w"> </span><span class="n">max_val</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">500000</span><span class="p">),</span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a><span class="w">    </span><span class="n">range_check</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">margin</span><span class="p">,</span><span class="w"> </span><span class="n">min_val</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_val</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a><span class="p">);</span>
</span><span id="__span-135-9"><a id="__codelineno-135-9" name="__codelineno-135-9" href="#__codelineno-135-9"></a>
</span><span id="__span-135-10"><a id="__codelineno-135-10" name="__codelineno-135-10" href="#__codelineno-135-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">metrics</span><span class="p">;</span>
</span><span id="__span-135-11"><a id="__codelineno-135-11" name="__codelineno-135-11" href="#__codelineno-135-11"></a>
</span><span id="__span-135-12"><a id="__codelineno-135-12" name="__codelineno-135-12" href="#__codelineno-135-12"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">range_check</span><span class="p">);</span>
</span><span id="__span-135-13"><a id="__codelineno-135-13" name="__codelineno-135-13" href="#__codelineno-135-13"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-135-14"><a id="__codelineno-135-14" name="__codelineno-135-14" href="#__codelineno-135-14"></a><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">min_val</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">max_val</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="56-organizing-inline-audits">5.6 Organizing Inline Audits<a class="headerlink" href="#56-organizing-inline-audits" title="Permanent link">&para;</a></h3>
<p><strong>For clarity, add comments:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">complex_metrics</span><span class="p">,</span>
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="w">    </span><span class="n">completeness_checks</span><span class="p">,</span>
</span><span id="__span-136-5"><a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a><span class="w">    </span><span class="n">business_rule_validations</span><span class="p">,</span>
</span><span id="__span-136-6"><a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a><span class="w">    </span><span class="n">calculation_validations</span>
</span><span id="__span-136-7"><a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-136-8"><a id="__codelineno-136-8" name="__codelineno-136-8" href="#__codelineno-136-8"></a><span class="p">);</span>
</span><span id="__span-136-9"><a id="__codelineno-136-9" name="__codelineno-136-9" href="#__codelineno-136-9"></a>
</span><span id="__span-136-10"><a id="__codelineno-136-10" name="__codelineno-136-10" href="#__codelineno-136-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-136-11"><a id="__codelineno-136-11" name="__codelineno-136-11" href="#__codelineno-136-11"></a>
</span><span id="__span-136-12"><a id="__codelineno-136-12" name="__codelineno-136-12" href="#__codelineno-136-12"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-136-13"><a id="__codelineno-136-13" name="__codelineno-136-13" href="#__codelineno-136-13"></a><span class="c1">-- COMPLETENESS CHECKS</span>
</span><span id="__span-136-14"><a id="__codelineno-136-14" name="__codelineno-136-14" href="#__codelineno-136-14"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-136-15"><a id="__codelineno-136-15" name="__codelineno-136-15" href="#__codelineno-136-15"></a>
</span><span id="__span-136-16"><a id="__codelineno-136-16" name="__codelineno-136-16" href="#__codelineno-136-16"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">completeness_checks</span><span class="p">);</span>
</span><span id="__span-136-17"><a id="__codelineno-136-17" name="__codelineno-136-17" href="#__codelineno-136-17"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-136-18"><a id="__codelineno-136-18" name="__codelineno-136-18" href="#__codelineno-136-18"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-136-19"><a id="__codelineno-136-19" name="__codelineno-136-19" href="#__codelineno-136-19"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">revenue</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-136-20"><a id="__codelineno-136-20" name="__codelineno-136-20" href="#__codelineno-136-20"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">order_count</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span><span id="__span-136-21"><a id="__codelineno-136-21" name="__codelineno-136-21" href="#__codelineno-136-21"></a>
</span><span id="__span-136-22"><a id="__codelineno-136-22" name="__codelineno-136-22" href="#__codelineno-136-22"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-136-23"><a id="__codelineno-136-23" name="__codelineno-136-23" href="#__codelineno-136-23"></a><span class="c1">-- BUSINESS RULE VALIDATIONS</span>
</span><span id="__span-136-24"><a id="__codelineno-136-24" name="__codelineno-136-24" href="#__codelineno-136-24"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-136-25"><a id="__codelineno-136-25" name="__codelineno-136-25" href="#__codelineno-136-25"></a>
</span><span id="__span-136-26"><a id="__codelineno-136-26" name="__codelineno-136-26" href="#__codelineno-136-26"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">business_rule_validations</span><span class="p">);</span>
</span><span id="__span-136-27"><a id="__codelineno-136-27" name="__codelineno-136-27" href="#__codelineno-136-27"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-136-28"><a id="__codelineno-136-28" name="__codelineno-136-28" href="#__codelineno-136-28"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">revenue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-136-29"><a id="__codelineno-136-29" name="__codelineno-136-29" href="#__codelineno-136-29"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">order_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-136-30"><a id="__codelineno-136-30" name="__codelineno-136-30" href="#__codelineno-136-30"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">order_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">revenue</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">  </span><span class="c1">-- Revenue without orders</span>
</span><span id="__span-136-31"><a id="__codelineno-136-31" name="__codelineno-136-31" href="#__codelineno-136-31"></a>
</span><span id="__span-136-32"><a id="__codelineno-136-32" name="__codelineno-136-32" href="#__codelineno-136-32"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-136-33"><a id="__codelineno-136-33" name="__codelineno-136-33" href="#__codelineno-136-33"></a><span class="c1">-- CALCULATION VALIDATIONS</span>
</span><span id="__span-136-34"><a id="__codelineno-136-34" name="__codelineno-136-34" href="#__codelineno-136-34"></a><span class="c1">-- =============================================================================</span>
</span><span id="__span-136-35"><a id="__codelineno-136-35" name="__codelineno-136-35" href="#__codelineno-136-35"></a>
</span><span id="__span-136-36"><a id="__codelineno-136-36" name="__codelineno-136-36" href="#__codelineno-136-36"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">calculation_validations</span><span class="p">);</span>
</span><span id="__span-136-37"><a id="__codelineno-136-37" name="__codelineno-136-37" href="#__codelineno-136-37"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-136-38"><a id="__codelineno-136-38" name="__codelineno-136-38" href="#__codelineno-136-38"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">average_order_value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">revenue</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">order_count</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="57-inline-audit-anti-patterns">5.7 Inline Audit Anti-Patterns<a class="headerlink" href="#57-inline-audit-anti-patterns" title="Permanent link">&para;</a></h3>
<p><strong>INCORRECT: Too many inline audits</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="c1">-- DON&#39;T DO THIS - Too many inline audits (10+)</span>
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-137-4"><a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">audit1</span><span class="p">,</span><span class="w"> </span><span class="n">audit2</span><span class="p">,</span><span class="w"> </span><span class="n">audit3</span><span class="p">,</span><span class="w"> </span><span class="n">audit4</span><span class="p">,</span><span class="w"> </span><span class="n">audit5</span><span class="p">,</span><span class="w"> </span><span class="n">audit6</span><span class="p">,</span><span class="w"> </span><span class="n">audit7</span><span class="p">,</span><span class="w"> </span><span class="n">audit8</span><span class="p">,</span><span class="w"> </span><span class="n">audit9</span><span class="p">,</span><span class="w"> </span><span class="n">audit10</span><span class="p">,</span><span class="w"> </span><span class="n">audit11</span><span class="p">,</span><span class="w"> </span><span class="n">audit12</span><span class="p">)</span>
</span><span id="__span-137-5"><a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a><span class="p">);</span>
</span><span id="__span-137-6"><a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a>
</span><span id="__span-137-7"><a id="__codelineno-137-7" name="__codelineno-137-7" href="#__codelineno-137-7"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-137-8"><a id="__codelineno-137-8" name="__codelineno-137-8" href="#__codelineno-137-8"></a>
</span><span id="__span-137-9"><a id="__codelineno-137-9" name="__codelineno-137-9" href="#__codelineno-137-9"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">audit1</span><span class="p">);</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-137-10"><a id="__codelineno-137-10" name="__codelineno-137-10" href="#__codelineno-137-10"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">audit2</span><span class="p">);</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-137-11"><a id="__codelineno-137-11" name="__codelineno-137-11" href="#__codelineno-137-11"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">audit3</span><span class="p">);</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-137-12"><a id="__codelineno-137-12" name="__codelineno-137-12" href="#__codelineno-137-12"></a><span class="c1">-- ... 12 total audits ...</span>
</span><span id="__span-137-13"><a id="__codelineno-137-13" name="__codelineno-137-13" href="#__codelineno-137-13"></a>
</span><span id="__span-137-14"><a id="__codelineno-137-14" name="__codelineno-137-14" href="#__codelineno-137-14"></a><span class="c1">-- RESULT: Model file is 500+ lines, hard to navigate</span>
</span></code></pre></div></p>
<p><strong>CORRECT: Move to file-based</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a><span class="c1">-- Create audits/sales/orders.sql with the 12 audits</span>
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a><span class="c1">-- Keep model file clean</span>
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a>
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a><span class="w">    </span><span class="n">orders_completeness</span><span class="p">,</span>
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a><span class="w">    </span><span class="n">orders_validity</span><span class="p">,</span>
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a><span class="w">    </span><span class="n">orders_calculations</span><span class="p">,</span>
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a><span class="w">    </span><span class="n">orders_referential_integrity</span>
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a><span class="w">    </span><span class="c1">-- Only 4 references, but 12+ actual audits in audits/sales/orders.sql</span>
</span><span id="__span-138-12"><a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-138-13"><a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a><span class="p">);</span>
</span><span id="__span-138-14"><a id="__codelineno-138-14" name="__codelineno-138-14" href="#__codelineno-138-14"></a>
</span><span id="__span-138-15"><a id="__codelineno-138-15" name="__codelineno-138-15" href="#__codelineno-138-15"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">...;</span>
</span></code></pre></div></p>
<p><strong>INCORRECT: Generic inline audits</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="c1">-- DON&#39;T DO THIS - These should be in audits/common/</span>
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span><span class="p">,</span><span class="w"> </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">check_not_null</span><span class="p">));</span>
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a>
</span><span id="__span-139-5"><a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_not_null</span><span class="p">);</span>
</span><span id="__span-139-6"><a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>CORRECT: Use built-in or file-based</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">products</span><span class="p">,</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">product_id</span><span class="p">)))</span><span class="w">  </span><span class="c1">-- Built-in</span>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a><span class="p">);</span>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">...;</span>
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="6-advanced-audit-patterns">6. Advanced Audit Patterns<a class="headerlink" href="#6-advanced-audit-patterns" title="Permanent link">&para;</a></h2>
<p>This section covers complex audit patterns for sophisticated data validation scenarios.</p>
<h3 id="61-referential-integrity-checks">6.1 Referential Integrity Checks<a class="headerlink" href="#61-referential-integrity-checks" title="Permanent link">&para;</a></h3>
<p>Validate foreign key relationships using JOINs:</p>
<p><strong>Basic referential integrity:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="c1">-- audits/referential/customer_orders.sql</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_customer_references</span><span class="p">);</span>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a>
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-141-6"><a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-141-7"><a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="c1">-- Separate null check</span>
</span><span id="__span-141-8"><a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">      </span><span class="c1">-- Customer doesn&#39;t exist</span>
</span></code></pre></div></p>
<p><strong>Multi-column foreign keys:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_product_location_references</span><span class="p">);</span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">ol</span>
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">product_locations</span><span class="w"> </span><span class="n">pl</span><span class="w"> </span>
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span>
</span><span id="__span-142-7"><a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="n">warehouse_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pl</span><span class="p">.</span><span class="n">warehouse_id</span>
</span><span id="__span-142-8"><a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-142-9"><a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">ol</span><span class="p">.</span><span class="n">warehouse_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-142-10"><a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">pl</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Conditional referential integrity:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="c1">-- Only certain statuses require customer reference</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">conditional_customer_reference</span><span class="p">);</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a>
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#__codelineno-143-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Only these statuses</span>
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#__codelineno-143-8"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#__codelineno-143-9"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Temporal referential integrity:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="c1">-- Order date must be within customer&#39;s active period</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">temporal_customer_reference</span><span class="p">);</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a>
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-144-5"><a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-144-6"><a id="__codelineno-144-6" name="__codelineno-144-6" href="#__codelineno-144-6"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-144-7"><a id="__codelineno-144-7" name="__codelineno-144-7" href="#__codelineno-144-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">first_purchase_date</span>
</span><span id="__span-144-8"><a id="__codelineno-144-8" name="__codelineno-144-8" href="#__codelineno-144-8"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">last_purchase_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">last_purchase_date</span><span class="p">);</span>
</span></code></pre></div></p>
<hr />
<h3 id="62-multi-column-business-logic">6.2 Multi-Column Business Logic<a class="headerlink" href="#62-multi-column-business-logic" title="Permanent link">&para;</a></h3>
<p>Validate complex relationships between multiple columns:</p>
<p><strong>Date ordering:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_date_sequence</span><span class="p">);</span>
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a>
</span><span id="__span-145-3"><a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-145-4"><a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_DATE</span>
</span><span id="__span-145-5"><a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span>
</span><span id="__span-145-6"><a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">shipped_date</span><span class="p">)</span>
</span><span id="__span-145-7"><a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">cancelled_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">order_date</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Calculated fields validation:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">revenue_calculation_valid</span><span class="p">);</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a>
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="w">  </span><span class="n">subtotal</span><span class="p">,</span>
</span><span id="__span-146-6"><a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a><span class="w">  </span><span class="n">discount_amount</span><span class="p">,</span>
</span><span id="__span-146-7"><a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a><span class="w">  </span><span class="n">tax_amount</span><span class="p">,</span>
</span><span id="__span-146-8"><a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a><span class="w">  </span><span class="n">shipping_cost</span><span class="p">,</span>
</span><span id="__span-146-9"><a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a><span class="w">  </span><span class="n">total_amount</span><span class="p">,</span>
</span><span id="__span-146-10"><a id="__codelineno-146-10" name="__codelineno-146-10" href="#__codelineno-146-10"></a><span class="w">  </span><span class="p">(</span><span class="n">subtotal</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shipping_cost</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">calculated_total</span><span class="p">,</span>
</span><span id="__span-146-11"><a id="__codelineno-146-11" name="__codelineno-146-11" href="#__codelineno-146-11"></a><span class="w">  </span><span class="k">ABS</span><span class="p">(</span><span class="n">total_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">subtotal</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shipping_cost</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">difference</span>
</span><span id="__span-146-12"><a id="__codelineno-146-12" name="__codelineno-146-12" href="#__codelineno-146-12"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-146-13"><a id="__codelineno-146-13" name="__codelineno-146-13" href="#__codelineno-146-13"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">total_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">subtotal</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tax_amount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shipping_cost</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Conditional logic:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">conditional_business_rules</span><span class="p">);</span>
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a>
</span><span id="__span-147-3"><a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-147-4"><a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a><span class="k">WHERE</span><span class="w"> </span>
</span><span id="__span-147-5"><a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a><span class="w">  </span><span class="c1">-- Premium customers get free shipping</span>
</span><span id="__span-147-6"><a id="__codelineno-147-6" name="__codelineno-147-6" href="#__codelineno-147-6"></a><span class="w">  </span><span class="p">(</span><span class="n">customer_tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;premium&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipping_cost</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-147-7"><a id="__codelineno-147-7" name="__codelineno-147-7" href="#__codelineno-147-7"></a>
</span><span id="__span-147-8"><a id="__codelineno-147-8" name="__codelineno-147-8" href="#__codelineno-147-8"></a><span class="w">  </span><span class="c1">-- Orders over $100 get discount</span>
</span><span id="__span-147-9"><a id="__codelineno-147-9" name="__codelineno-147-9" href="#__codelineno-147-9"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">subtotal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-147-10"><a id="__codelineno-147-10" name="__codelineno-147-10" href="#__codelineno-147-10"></a>
</span><span id="__span-147-11"><a id="__codelineno-147-11" name="__codelineno-147-11" href="#__codelineno-147-11"></a><span class="w">  </span><span class="c1">-- Cancelled orders shouldn&#39;t have shipped/delivered dates</span>
</span><span id="__span-147-12"><a id="__codelineno-147-12" name="__codelineno-147-12" href="#__codelineno-147-12"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">))</span>
</span><span id="__span-147-13"><a id="__codelineno-147-13" name="__codelineno-147-13" href="#__codelineno-147-13"></a>
</span><span id="__span-147-14"><a id="__codelineno-147-14" name="__codelineno-147-14" href="#__codelineno-147-14"></a><span class="w">  </span><span class="c1">-- Delivered orders must have both shipped and delivered dates</span>
</span><span id="__span-147-15"><a id="__codelineno-147-15" name="__codelineno-147-15" href="#__codelineno-147-15"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;delivered&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">));</span>
</span></code></pre></div></p>
<p><strong>Percentage validations:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">percentage_consistency</span><span class="p">);</span>
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a>
</span><span id="__span-148-3"><a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-148-4"><a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a><span class="k">WHERE</span><span class="w"> </span>
</span><span id="__span-148-5"><a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a><span class="w">  </span><span class="c1">-- Discount percentage should match discount amount</span>
</span><span id="__span-148-6"><a id="__codelineno-148-6" name="__codelineno-148-6" href="#__codelineno-148-6"></a><span class="w">  </span><span class="k">ABS</span><span class="p">(</span><span class="n">discount_percent</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">discount_amount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">subtotal</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span>
</span><span id="__span-148-7"><a id="__codelineno-148-7" name="__codelineno-148-7" href="#__codelineno-148-7"></a>
</span><span id="__span-148-8"><a id="__codelineno-148-8" name="__codelineno-148-8" href="#__codelineno-148-8"></a><span class="w">  </span><span class="c1">-- Tax percentage should match tax amount</span>
</span><span id="__span-148-9"><a id="__codelineno-148-9" name="__codelineno-148-9" href="#__codelineno-148-9"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">tax_percent</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">tax_amount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">subtotal</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span>
</span><span id="__span-148-10"><a id="__codelineno-148-10" name="__codelineno-148-10" href="#__codelineno-148-10"></a>
</span><span id="__span-148-11"><a id="__codelineno-148-11" name="__codelineno-148-11" href="#__codelineno-148-11"></a><span class="w">  </span><span class="c1">-- Margin percentage should match margin amount</span>
</span><span id="__span-148-12"><a id="__codelineno-148-12" name="__codelineno-148-12" href="#__codelineno-148-12"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">margin_percent</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="n">revenue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cost</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="n">revenue</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="63-cross-model-validation">6.3 Cross-Model Validation<a class="headerlink" href="#63-cross-model-validation" title="Permanent link">&para;</a></h3>
<p>Validate data consistency across multiple models:</p>
<p><strong>Aggregate consistency:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">orders_match_line_items</span><span class="p">);</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a>
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-149-4"><a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="w">  </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-149-5"><a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a><span class="w">  </span><span class="n">o</span><span class="p">.</span><span class="n">total_amount</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_total</span><span class="p">,</span>
</span><span id="__span-149-6"><a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">line_items_total</span><span class="p">,</span>
</span><span id="__span-149-7"><a id="__codelineno-149-7" name="__codelineno-149-7" href="#__codelineno-149-7"></a><span class="w">  </span><span class="k">ABS</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">total_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">unit_price</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">difference</span>
</span><span id="__span-149-8"><a id="__codelineno-149-8" name="__codelineno-149-8" href="#__codelineno-149-8"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-149-9"><a id="__codelineno-149-9" name="__codelineno-149-9" href="#__codelineno-149-9"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">order_line_items</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">order_id</span>
</span><span id="__span-149-10"><a id="__codelineno-149-10" name="__codelineno-149-10" href="#__codelineno-149-10"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">total_amount</span>
</span><span id="__span-149-11"><a id="__codelineno-149-11" name="__codelineno-149-11" href="#__codelineno-149-11"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">total_amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">li</span><span class="p">.</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">unit_price</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Count consistency:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">customer_order_count_matches</span><span class="p">);</span>
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a>
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-150-4"><a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-150-5"><a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">total_orders</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">recorded_count</span><span class="p">,</span>
</span><span id="__span-150-6"><a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a><span class="w">  </span><span class="k">COUNT</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">actual_count</span>
</span><span id="__span-150-7"><a id="__codelineno-150-7" name="__codelineno-150-7" href="#__codelineno-150-7"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-150-8"><a id="__codelineno-150-8" name="__codelineno-150-8" href="#__codelineno-150-8"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-150-9"><a id="__codelineno-150-9" name="__codelineno-150-9" href="#__codelineno-150-9"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">total_orders</span>
</span><span id="__span-150-10"><a id="__codelineno-150-10" name="__codelineno-150-10" href="#__codelineno-150-10"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">total_orders</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Date range consistency:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">date_ranges_match_detail_data</span><span class="p">);</span>
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a>
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a><span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-151-5"><a id="__codelineno-151-5" name="__codelineno-151-5" href="#__codelineno-151-5"></a><span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">first_order_date</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">summary_first_date</span><span class="p">,</span>
</span><span id="__span-151-6"><a id="__codelineno-151-6" name="__codelineno-151-6" href="#__codelineno-151-6"></a><span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">last_order_date</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">summary_last_date</span><span class="p">,</span>
</span><span id="__span-151-7"><a id="__codelineno-151-7" name="__codelineno-151-7" href="#__codelineno-151-7"></a><span class="w">  </span><span class="k">MIN</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">actual_first_date</span><span class="p">,</span>
</span><span id="__span-151-8"><a id="__codelineno-151-8" name="__codelineno-151-8" href="#__codelineno-151-8"></a><span class="w">  </span><span class="k">MAX</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">actual_last_date</span>
</span><span id="__span-151-9"><a id="__codelineno-151-9" name="__codelineno-151-9" href="#__codelineno-151-9"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">s</span>
</span><span id="__span-151-10"><a id="__codelineno-151-10" name="__codelineno-151-10" href="#__codelineno-151-10"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-151-11"><a id="__codelineno-151-11" name="__codelineno-151-11" href="#__codelineno-151-11"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">first_order_date</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">last_order_date</span>
</span><span id="__span-151-12"><a id="__codelineno-151-12" name="__codelineno-151-12" href="#__codelineno-151-12"></a><span class="k">HAVING</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">first_order_date</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">)</span>
</span><span id="__span-151-13"><a id="__codelineno-151-13" name="__codelineno-151-13" href="#__codelineno-151-13"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">last_order_date</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">);</span>
</span></code></pre></div></p>
<hr />
<h3 id="64-time-based-audits">6.4 Time-Based Audits<a class="headerlink" href="#64-time-based-audits" title="Permanent link">&para;</a></h3>
<p>Special considerations for incremental and time-series data:</p>
<p><strong>No gaps in time series:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">no_date_gaps</span><span class="p">);</span>
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a>
</span><span id="__span-152-3"><a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a><span class="k">WITH</span><span class="w"> </span><span class="n">expected_dates</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-152-4"><a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">GENERATE_SERIES</span><span class="p">(</span>
</span><span id="__span-152-5"><a id="__codelineno-152-5" name="__codelineno-152-5" href="#__codelineno-152-5"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MIN</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="p">),</span>
</span><span id="__span-152-6"><a id="__codelineno-152-6" name="__codelineno-152-6" href="#__codelineno-152-6"></a><span class="w">    </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="p">),</span>
</span><span id="__span-152-7"><a id="__codelineno-152-7" name="__codelineno-152-7" href="#__codelineno-152-7"></a><span class="w">    </span><span class="s1">&#39;1 day&#39;</span><span class="p">::</span><span class="nb">INTERVAL</span>
</span><span id="__span-152-8"><a id="__codelineno-152-8" name="__codelineno-152-8" href="#__codelineno-152-8"></a><span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">expected_date</span>
</span><span id="__span-152-9"><a id="__codelineno-152-9" name="__codelineno-152-9" href="#__codelineno-152-9"></a><span class="p">)</span>
</span><span id="__span-152-10"><a id="__codelineno-152-10" name="__codelineno-152-10" href="#__codelineno-152-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">ed</span><span class="p">.</span><span class="n">expected_date</span>
</span><span id="__span-152-11"><a id="__codelineno-152-11" name="__codelineno-152-11" href="#__codelineno-152-11"></a><span class="k">FROM</span><span class="w"> </span><span class="n">expected_dates</span><span class="w"> </span><span class="n">ed</span>
</span><span id="__span-152-12"><a id="__codelineno-152-12" name="__codelineno-152-12" href="#__codelineno-152-12"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-152-13"><a id="__codelineno-152-13" name="__codelineno-152-13" href="#__codelineno-152-13"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-152-14"><a id="__codelineno-152-14" name="__codelineno-152-14" href="#__codelineno-152-14"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-152-15"><a id="__codelineno-152-15" name="__codelineno-152-15" href="#__codelineno-152-15"></a><span class="p">)</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ed</span><span class="p">.</span><span class="n">expected_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">actual</span><span class="p">.</span><span class="n">order_date</span>
</span><span id="__span-152-16"><a id="__codelineno-152-16" name="__codelineno-152-16" href="#__codelineno-152-16"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">actual</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Monotonic increase validation:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">cumulative_values_increase</span><span class="p">);</span>
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a>
</span><span id="__span-153-3"><a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-153-4"><a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
</span><span id="__span-153-5"><a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a><span class="w">  </span><span class="n">t1</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="p">,</span>
</span><span id="__span-153-6"><a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a><span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">previous_cumulative_revenue</span>
</span><span id="__span-153-7"><a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">t1</span>
</span><span id="__span-153-8"><a id="__codelineno-153-8" name="__codelineno-153-8" href="#__codelineno-153-8"></a><span class="k">JOIN</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span>
</span><span id="__span-153-9"><a id="__codelineno-153-9" name="__codelineno-153-9" href="#__codelineno-153-9"></a><span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 day&#39;</span>
</span><span id="__span-153-10"><a id="__codelineno-153-10" name="__codelineno-153-10" href="#__codelineno-153-10"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">cumulative_revenue</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Late arrival data detection:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">no_late_arriving_data</span><span class="p">);</span>
</span><span id="__span-154-2"><a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a>
</span><span id="__span-154-3"><a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a><span class="c1">-- For incremental models: ensure no data before current interval</span>
</span><span id="__span-154-4"><a id="__codelineno-154-4" name="__codelineno-154-4" href="#__codelineno-154-4"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-154-5"><a id="__codelineno-154-5" name="__codelineno-154-5" href="#__codelineno-154-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">@</span><span class="n">start_ds</span>
</span><span id="__span-154-6"><a id="__codelineno-154-6" name="__codelineno-154-6" href="#__codelineno-154-6"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">end_ds</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Rolling window consistency:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">rolling_average_consistency</span><span class="p">);</span>
</span><span id="__span-155-2"><a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a>
</span><span id="__span-155-3"><a id="__codelineno-155-3" name="__codelineno-155-3" href="#__codelineno-155-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-155-4"><a id="__codelineno-155-4" name="__codelineno-155-4" href="#__codelineno-155-4"></a><span class="w">  </span><span class="nb">date</span><span class="p">,</span>
</span><span id="__span-155-5"><a id="__codelineno-155-5" name="__codelineno-155-5" href="#__codelineno-155-5"></a><span class="w">  </span><span class="n">rolling_7day_avg</span><span class="p">,</span>
</span><span id="__span-155-6"><a id="__codelineno-155-6" name="__codelineno-155-6" href="#__codelineno-155-6"></a><span class="w">  </span><span class="n">daily_value</span>
</span><span id="__span-155-7"><a id="__codelineno-155-7" name="__codelineno-155-7" href="#__codelineno-155-7"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-155-8"><a id="__codelineno-155-8" name="__codelineno-155-8" href="#__codelineno-155-8"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span>
</span><span id="__span-155-9"><a id="__codelineno-155-9" name="__codelineno-155-9" href="#__codelineno-155-9"></a><span class="w">  </span><span class="n">rolling_7day_avg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>
</span><span id="__span-155-10"><a id="__codelineno-155-10" name="__codelineno-155-10" href="#__codelineno-155-10"></a><span class="w">  </span><span class="k">AVG</span><span class="p">(</span><span class="n">daily_value</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-155-11"><a id="__codelineno-155-11" name="__codelineno-155-11" href="#__codelineno-155-11"></a><span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span>
</span><span id="__span-155-12"><a id="__codelineno-155-12" name="__codelineno-155-12" href="#__codelineno-155-12"></a><span class="w">    </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span>
</span><span id="__span-155-13"><a id="__codelineno-155-13" name="__codelineno-155-13" href="#__codelineno-155-13"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-155-14"><a id="__codelineno-155-14" name="__codelineno-155-14" href="#__codelineno-155-14"></a><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="65-state-transition-validation">6.5 State Transition Validation<a class="headerlink" href="#65-state-transition-validation" title="Permanent link">&para;</a></h3>
<p>Validate that status/state changes follow valid paths:</p>
<p><strong>Valid status transitions:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_status_lifecycle</span><span class="p">);</span>
</span><span id="__span-156-2"><a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a>
</span><span id="__span-156-3"><a id="__codelineno-156-3" name="__codelineno-156-3" href="#__codelineno-156-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-156-4"><a id="__codelineno-156-4" name="__codelineno-156-4" href="#__codelineno-156-4"></a><span class="k">WHERE</span><span class="w"> </span>
</span><span id="__span-156-5"><a id="__codelineno-156-5" name="__codelineno-156-5" href="#__codelineno-156-5"></a><span class="w">  </span><span class="c1">-- Pending can only transition to processing or cancelled</span>
</span><span id="__span-156-6"><a id="__codelineno-156-6" name="__codelineno-156-6" href="#__codelineno-156-6"></a><span class="w">  </span><span class="p">(</span><span class="n">previous_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">))</span>
</span><span id="__span-156-7"><a id="__codelineno-156-7" name="__codelineno-156-7" href="#__codelineno-156-7"></a>
</span><span id="__span-156-8"><a id="__codelineno-156-8" name="__codelineno-156-8" href="#__codelineno-156-8"></a><span class="w">  </span><span class="c1">-- Processing can only transition to completed, failed, or cancelled</span>
</span><span id="__span-156-9"><a id="__codelineno-156-9" name="__codelineno-156-9" href="#__codelineno-156-9"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">previous_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="p">))</span>
</span><span id="__span-156-10"><a id="__codelineno-156-10" name="__codelineno-156-10" href="#__codelineno-156-10"></a>
</span><span id="__span-156-11"><a id="__codelineno-156-11" name="__codelineno-156-11" href="#__codelineno-156-11"></a><span class="w">  </span><span class="c1">-- Completed is terminal (no transitions)</span>
</span><span id="__span-156-12"><a id="__codelineno-156-12" name="__codelineno-156-12" href="#__codelineno-156-12"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">previous_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</span><span id="__span-156-13"><a id="__codelineno-156-13" name="__codelineno-156-13" href="#__codelineno-156-13"></a>
</span><span id="__span-156-14"><a id="__codelineno-156-14" name="__codelineno-156-14" href="#__codelineno-156-14"></a><span class="w">  </span><span class="c1">-- Failed can transition to processing (retry)</span>
</span><span id="__span-156-15"><a id="__codelineno-156-15" name="__codelineno-156-15" href="#__codelineno-156-15"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">previous_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">))</span>
</span><span id="__span-156-16"><a id="__codelineno-156-16" name="__codelineno-156-16" href="#__codelineno-156-16"></a>
</span><span id="__span-156-17"><a id="__codelineno-156-17" name="__codelineno-156-17" href="#__codelineno-156-17"></a><span class="w">  </span><span class="c1">-- Cancelled is terminal</span>
</span><span id="__span-156-18"><a id="__codelineno-156-18" name="__codelineno-156-18" href="#__codelineno-156-18"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">previous_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Status-date consistency:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">status_date_consistency</span><span class="p">);</span>
</span><span id="__span-157-2"><a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a>
</span><span id="__span-157-3"><a id="__codelineno-157-3" name="__codelineno-157-3" href="#__codelineno-157-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-157-4"><a id="__codelineno-157-4" name="__codelineno-157-4" href="#__codelineno-157-4"></a><span class="k">WHERE</span><span class="w"> </span>
</span><span id="__span-157-5"><a id="__codelineno-157-5" name="__codelineno-157-5" href="#__codelineno-157-5"></a><span class="w">  </span><span class="c1">-- Shipped status requires shipped_date</span>
</span><span id="__span-157-6"><a id="__codelineno-157-6" name="__codelineno-157-6" href="#__codelineno-157-6"></a><span class="w">  </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span><span id="__span-157-7"><a id="__codelineno-157-7" name="__codelineno-157-7" href="#__codelineno-157-7"></a>
</span><span id="__span-157-8"><a id="__codelineno-157-8" name="__codelineno-157-8" href="#__codelineno-157-8"></a><span class="w">  </span><span class="c1">-- Delivered status requires both shipped_date and delivered_date</span>
</span><span id="__span-157-9"><a id="__codelineno-157-9" name="__codelineno-157-9" href="#__codelineno-157-9"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;delivered&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">))</span>
</span><span id="__span-157-10"><a id="__codelineno-157-10" name="__codelineno-157-10" href="#__codelineno-157-10"></a>
</span><span id="__span-157-11"><a id="__codelineno-157-11" name="__codelineno-157-11" href="#__codelineno-157-11"></a><span class="w">  </span><span class="c1">-- Cancelled status requires cancelled_date</span>
</span><span id="__span-157-12"><a id="__codelineno-157-12" name="__codelineno-157-12" href="#__codelineno-157-12"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">cancelled_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span><span id="__span-157-13"><a id="__codelineno-157-13" name="__codelineno-157-13" href="#__codelineno-157-13"></a>
</span><span id="__span-157-14"><a id="__codelineno-157-14" name="__codelineno-157-14" href="#__codelineno-157-14"></a><span class="w">  </span><span class="c1">-- Pending/processing shouldn&#39;t have these dates</span>
</span><span id="__span-157-15"><a id="__codelineno-157-15" name="__codelineno-157-15" href="#__codelineno-157-15"></a><span class="w">  </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">));</span>
</span></code></pre></div></p>
<p><strong>One-way transitions:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">subscription_no_reactivation</span><span class="p">);</span>
</span><span id="__span-158-2"><a id="__codelineno-158-2" name="__codelineno-158-2" href="#__codelineno-158-2"></a>
</span><span id="__span-158-3"><a id="__codelineno-158-3" name="__codelineno-158-3" href="#__codelineno-158-3"></a><span class="c1">-- Once cancelled, subscription shouldn&#39;t reactivate</span>
</span><span id="__span-158-4"><a id="__codelineno-158-4" name="__codelineno-158-4" href="#__codelineno-158-4"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-158-5"><a id="__codelineno-158-5" name="__codelineno-158-5" href="#__codelineno-158-5"></a><span class="w">  </span><span class="n">subscription_id</span><span class="p">,</span>
</span><span id="__span-158-6"><a id="__codelineno-158-6" name="__codelineno-158-6" href="#__codelineno-158-6"></a><span class="w">  </span><span class="n">status</span><span class="p">,</span>
</span><span id="__span-158-7"><a id="__codelineno-158-7" name="__codelineno-158-7" href="#__codelineno-158-7"></a><span class="w">  </span><span class="n">LAG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">subscription_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">updated_at</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">previous_status</span>
</span><span id="__span-158-8"><a id="__codelineno-158-8" name="__codelineno-158-8" href="#__codelineno-158-8"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-158-9"><a id="__codelineno-158-9" name="__codelineno-158-9" href="#__codelineno-158-9"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">LAG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">subscription_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">updated_at</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span>
</span><span id="__span-158-10"><a id="__codelineno-158-10" name="__codelineno-158-10" href="#__codelineno-158-10"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="66-aggregate-consistency-checks">6.6 Aggregate Consistency Checks<a class="headerlink" href="#66-aggregate-consistency-checks" title="Permanent link">&para;</a></h3>
<p>Validate that aggregates match their detail data:</p>
<p><strong>Sum of parts equals whole:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">revenue_components_sum_to_total</span><span class="p">);</span>
</span><span id="__span-159-2"><a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a>
</span><span id="__span-159-3"><a id="__codelineno-159-3" name="__codelineno-159-3" href="#__codelineno-159-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-159-4"><a id="__codelineno-159-4" name="__codelineno-159-4" href="#__codelineno-159-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span>
</span><span id="__span-159-5"><a id="__codelineno-159-5" name="__codelineno-159-5" href="#__codelineno-159-5"></a><span class="w">  </span><span class="n">total_revenue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-159-6"><a id="__codelineno-159-6" name="__codelineno-159-6" href="#__codelineno-159-6"></a><span class="w">    </span><span class="n">product_revenue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
</span><span id="__span-159-7"><a id="__codelineno-159-7" name="__codelineno-159-7" href="#__codelineno-159-7"></a><span class="w">    </span><span class="n">shipping_revenue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
</span><span id="__span-159-8"><a id="__codelineno-159-8" name="__codelineno-159-8" href="#__codelineno-159-8"></a><span class="w">    </span><span class="n">tax_revenue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
</span><span id="__span-159-9"><a id="__codelineno-159-9" name="__codelineno-159-9" href="#__codelineno-159-9"></a><span class="w">    </span><span class="n">other_revenue</span>
</span><span id="__span-159-10"><a id="__codelineno-159-10" name="__codelineno-159-10" href="#__codelineno-159-10"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-159-11"><a id="__codelineno-159-11" name="__codelineno-159-11" href="#__codelineno-159-11"></a><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Percentage parts sum to 100%:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">category_percentages_sum_to_one</span><span class="p">);</span>
</span><span id="__span-160-2"><a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a>
</span><span id="__span-160-3"><a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-160-4"><a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a><span class="w">  </span><span class="n">product_id</span><span class="p">,</span>
</span><span id="__span-160-5"><a id="__codelineno-160-5" name="__codelineno-160-5" href="#__codelineno-160-5"></a><span class="w">  </span><span class="n">category_a_percent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">category_b_percent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">category_c_percent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other_percent</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_percent</span>
</span><span id="__span-160-6"><a id="__codelineno-160-6" name="__codelineno-160-6" href="#__codelineno-160-6"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-160-7"><a id="__codelineno-160-7" name="__codelineno-160-7" href="#__codelineno-160-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">((</span><span class="n">category_a_percent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">category_b_percent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">category_c_percent</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">other_percent</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Count aggregates match:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">aggregate_counts_consistent</span><span class="p">);</span>
</span><span id="__span-161-2"><a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a>
</span><span id="__span-161-3"><a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-161-4"><a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">total_customers</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">active_customers</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inactive_customers</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cancelled_customers</span><span class="p">)</span>
</span><span id="__span-161-5"><a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">total_orders</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="n">completed_orders</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pending_orders</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cancelled_orders</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Weighted averages:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">weighted_average_valid</span><span class="p">);</span>
</span><span id="__span-162-2"><a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a>
</span><span id="__span-162-3"><a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-162-4"><a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a><span class="w">  </span><span class="n">product_id</span><span class="p">,</span>
</span><span id="__span-162-5"><a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a><span class="w">  </span><span class="n">weighted_average_price</span><span class="p">,</span>
</span><span id="__span-162-6"><a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">calculated_weighted_avg</span>
</span><span id="__span-162-7"><a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-162-8"><a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">order_line_items</span><span class="w"> </span><span class="n">li</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">li</span><span class="p">.</span><span class="n">product_id</span>
</span><span id="__span-162-9"><a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">weighted_average_price</span>
</span><span id="__span-162-10"><a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">weighted_average_price</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">unit_price</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="67-statistical-outlier-detection">6.7 Statistical Outlier Detection<a class="headerlink" href="#67-statistical-outlier-detection" title="Permanent link">&para;</a></h3>
<p>Beyond simple z-score, detect complex outliers:</p>
<p><strong>Inter-quartile range (IQR) method:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">iqr_outlier_detection</span><span class="p">);</span>
</span><span id="__span-163-2"><a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a>
</span><span id="__span-163-3"><a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a><span class="k">WITH</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-163-4"><a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-163-5"><a id="__codelineno-163-5" name="__codelineno-163-5" href="#__codelineno-163-5"></a><span class="w">    </span><span class="n">PERCENTILE_CONT</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="n">WITHIN</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">q1</span><span class="p">,</span>
</span><span id="__span-163-6"><a id="__codelineno-163-6" name="__codelineno-163-6" href="#__codelineno-163-6"></a><span class="w">    </span><span class="n">PERCENTILE_CONT</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">75</span><span class="p">)</span><span class="w"> </span><span class="n">WITHIN</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">q3</span>
</span><span id="__span-163-7"><a id="__codelineno-163-7" name="__codelineno-163-7" href="#__codelineno-163-7"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-163-8"><a id="__codelineno-163-8" name="__codelineno-163-8" href="#__codelineno-163-8"></a><span class="p">),</span>
</span><span id="__span-163-9"><a id="__codelineno-163-9" name="__codelineno-163-9" href="#__codelineno-163-9"></a><span class="n">bounds</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-163-10"><a id="__codelineno-163-10" name="__codelineno-163-10" href="#__codelineno-163-10"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-163-11"><a id="__codelineno-163-11" name="__codelineno-163-11" href="#__codelineno-163-11"></a><span class="w">    </span><span class="n">q1</span><span class="p">,</span>
</span><span id="__span-163-12"><a id="__codelineno-163-12" name="__codelineno-163-12" href="#__codelineno-163-12"></a><span class="w">    </span><span class="n">q3</span><span class="p">,</span>
</span><span id="__span-163-13"><a id="__codelineno-163-13" name="__codelineno-163-13" href="#__codelineno-163-13"></a><span class="w">    </span><span class="n">q3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">iqr</span><span class="p">,</span>
</span><span id="__span-163-14"><a id="__codelineno-163-14" name="__codelineno-163-14" href="#__codelineno-163-14"></a><span class="w">    </span><span class="n">q1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">q3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">lower_bound</span><span class="p">,</span>
</span><span id="__span-163-15"><a id="__codelineno-163-15" name="__codelineno-163-15" href="#__codelineno-163-15"></a><span class="w">    </span><span class="n">q3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">q3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">upper_bound</span>
</span><span id="__span-163-16"><a id="__codelineno-163-16" name="__codelineno-163-16" href="#__codelineno-163-16"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">stats</span>
</span><span id="__span-163-17"><a id="__codelineno-163-17" name="__codelineno-163-17" href="#__codelineno-163-17"></a><span class="p">)</span>
</span><span id="__span-163-18"><a id="__codelineno-163-18" name="__codelineno-163-18" href="#__codelineno-163-18"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-163-19"><a id="__codelineno-163-19" name="__codelineno-163-19" href="#__codelineno-163-19"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">bounds</span>
</span><span id="__span-163-20"><a id="__codelineno-163-20" name="__codelineno-163-20" href="#__codelineno-163-20"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bounds</span><span class="p">.</span><span class="n">lower_bound</span>
</span><span id="__span-163-21"><a id="__codelineno-163-21" name="__codelineno-163-21" href="#__codelineno-163-21"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">bounds</span><span class="p">.</span><span class="n">upper_bound</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Moving average deviation:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">moving_average_deviation</span><span class="p">);</span>
</span><span id="__span-164-2"><a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a>
</span><span id="__span-164-3"><a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a><span class="k">WITH</span><span class="w"> </span><span class="n">moving_stats</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-164-4"><a id="__codelineno-164-4" name="__codelineno-164-4" href="#__codelineno-164-4"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-164-5"><a id="__codelineno-164-5" name="__codelineno-164-5" href="#__codelineno-164-5"></a><span class="w">    </span><span class="nb">date</span><span class="p">,</span>
</span><span id="__span-164-6"><a id="__codelineno-164-6" name="__codelineno-164-6" href="#__codelineno-164-6"></a><span class="w">    </span><span class="n">daily_value</span><span class="p">,</span>
</span><span id="__span-164-7"><a id="__codelineno-164-7" name="__codelineno-164-7" href="#__codelineno-164-7"></a><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">daily_value</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">moving_avg_30d</span><span class="p">,</span>
</span><span id="__span-164-8"><a id="__codelineno-164-8" name="__codelineno-164-8" href="#__codelineno-164-8"></a><span class="w">    </span><span class="n">STDDEV</span><span class="p">(</span><span class="n">daily_value</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">moving_stddev_30d</span>
</span><span id="__span-164-9"><a id="__codelineno-164-9" name="__codelineno-164-9" href="#__codelineno-164-9"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-164-10"><a id="__codelineno-164-10" name="__codelineno-164-10" href="#__codelineno-164-10"></a><span class="p">)</span>
</span><span id="__span-164-11"><a id="__codelineno-164-11" name="__codelineno-164-11" href="#__codelineno-164-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-164-12"><a id="__codelineno-164-12" name="__codelineno-164-12" href="#__codelineno-164-12"></a><span class="k">FROM</span><span class="w"> </span><span class="n">moving_stats</span>
</span><span id="__span-164-13"><a id="__codelineno-164-13" name="__codelineno-164-13" href="#__codelineno-164-13"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">daily_value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">moving_avg_30d</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">moving_stddev_30d</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Comparing to historical baseline:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">deviation_from_historical_baseline</span><span class="p">);</span>
</span><span id="__span-165-2"><a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a>
</span><span id="__span-165-3"><a id="__codelineno-165-3" name="__codelineno-165-3" href="#__codelineno-165-3"></a><span class="k">WITH</span><span class="w"> </span><span class="n">historical_stats</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-165-4"><a id="__codelineno-165-4" name="__codelineno-165-4" href="#__codelineno-165-4"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-165-5"><a id="__codelineno-165-5" name="__codelineno-165-5" href="#__codelineno-165-5"></a><span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">daily_revenue</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">baseline_avg</span><span class="p">,</span>
</span><span id="__span-165-6"><a id="__codelineno-165-6" name="__codelineno-165-6" href="#__codelineno-165-6"></a><span class="w">    </span><span class="n">STDDEV</span><span class="p">(</span><span class="n">daily_revenue</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">baseline_stddev</span>
</span><span id="__span-165-7"><a id="__codelineno-165-7" name="__codelineno-165-7" href="#__codelineno-165-7"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-165-8"><a id="__codelineno-165-8" name="__codelineno-165-8" href="#__codelineno-165-8"></a><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">@</span><span class="n">start_ds</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;90 days&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">start_ds</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 day&#39;</span>
</span><span id="__span-165-9"><a id="__codelineno-165-9" name="__codelineno-165-9" href="#__codelineno-165-9"></a><span class="p">)</span>
</span><span id="__span-165-10"><a id="__codelineno-165-10" name="__codelineno-165-10" href="#__codelineno-165-10"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-165-11"><a id="__codelineno-165-11" name="__codelineno-165-11" href="#__codelineno-165-11"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">historical_stats</span>
</span><span id="__span-165-12"><a id="__codelineno-165-12" name="__codelineno-165-12" href="#__codelineno-165-12"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">daily_revenue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">historical_stats</span><span class="p">.</span><span class="n">baseline_avg</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">historical_stats</span><span class="p">.</span><span class="n">baseline_stddev</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="68-hierarchical-data-validation">6.8 Hierarchical Data Validation<a class="headerlink" href="#68-hierarchical-data-validation" title="Permanent link">&para;</a></h3>
<p>Validate parent-child relationships:</p>
<p><strong>Parent exists:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">category_parent_exists</span><span class="p">);</span>
</span><span id="__span-166-2"><a id="__codelineno-166-2" name="__codelineno-166-2" href="#__codelineno-166-2"></a>
</span><span id="__span-166-3"><a id="__codelineno-166-3" name="__codelineno-166-3" href="#__codelineno-166-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-166-4"><a id="__codelineno-166-4" name="__codelineno-166-4" href="#__codelineno-166-4"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-166-5"><a id="__codelineno-166-5" name="__codelineno-166-5" href="#__codelineno-166-5"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">parent_category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">category_id</span>
</span><span id="__span-166-6"><a id="__codelineno-166-6" name="__codelineno-166-6" href="#__codelineno-166-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">parent_category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-166-7"><a id="__codelineno-166-7" name="__codelineno-166-7" href="#__codelineno-166-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>No circular references:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">no_circular_category_references</span><span class="p">);</span>
</span><span id="__span-167-2"><a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a>
</span><span id="__span-167-3"><a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">category_path</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-167-4"><a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a><span class="w">  </span><span class="c1">-- Base case: start with leaf categories</span>
</span><span id="__span-167-5"><a id="__codelineno-167-5" name="__codelineno-167-5" href="#__codelineno-167-5"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-167-6"><a id="__codelineno-167-6" name="__codelineno-167-6" href="#__codelineno-167-6"></a><span class="w">    </span><span class="n">category_id</span><span class="p">,</span>
</span><span id="__span-167-7"><a id="__codelineno-167-7" name="__codelineno-167-7" href="#__codelineno-167-7"></a><span class="w">    </span><span class="n">parent_category_id</span><span class="p">,</span>
</span><span id="__span-167-8"><a id="__codelineno-167-8" name="__codelineno-167-8" href="#__codelineno-167-8"></a><span class="w">    </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">category_id</span><span class="p">]</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">path</span><span class="p">,</span>
</span><span id="__span-167-9"><a id="__codelineno-167-9" name="__codelineno-167-9" href="#__codelineno-167-9"></a><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">depth</span>
</span><span id="__span-167-10"><a id="__codelineno-167-10" name="__codelineno-167-10" href="#__codelineno-167-10"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-167-11"><a id="__codelineno-167-11" name="__codelineno-167-11" href="#__codelineno-167-11"></a><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">parent_category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-167-12"><a id="__codelineno-167-12" name="__codelineno-167-12" href="#__codelineno-167-12"></a>
</span><span id="__span-167-13"><a id="__codelineno-167-13" name="__codelineno-167-13" href="#__codelineno-167-13"></a><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-167-14"><a id="__codelineno-167-14" name="__codelineno-167-14" href="#__codelineno-167-14"></a>
</span><span id="__span-167-15"><a id="__codelineno-167-15" name="__codelineno-167-15" href="#__codelineno-167-15"></a><span class="w">  </span><span class="c1">-- Recursive case: walk up the hierarchy</span>
</span><span id="__span-167-16"><a id="__codelineno-167-16" name="__codelineno-167-16" href="#__codelineno-167-16"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-167-17"><a id="__codelineno-167-17" name="__codelineno-167-17" href="#__codelineno-167-17"></a><span class="w">    </span><span class="n">cp</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span>
</span><span id="__span-167-18"><a id="__codelineno-167-18" name="__codelineno-167-18" href="#__codelineno-167-18"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">parent_category_id</span><span class="p">,</span>
</span><span id="__span-167-19"><a id="__codelineno-167-19" name="__codelineno-167-19" href="#__codelineno-167-19"></a><span class="w">    </span><span class="n">cp</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span>
</span><span id="__span-167-20"><a id="__codelineno-167-20" name="__codelineno-167-20" href="#__codelineno-167-20"></a><span class="w">    </span><span class="n">cp</span><span class="p">.</span><span class="n">depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-167-21"><a id="__codelineno-167-21" name="__codelineno-167-21" href="#__codelineno-167-21"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">category_path</span><span class="w"> </span><span class="n">cp</span>
</span><span id="__span-167-22"><a id="__codelineno-167-22" name="__codelineno-167-22" href="#__codelineno-167-22"></a><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cp</span><span class="p">.</span><span class="n">parent_category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">category_id</span>
</span><span id="__span-167-23"><a id="__codelineno-167-23" name="__codelineno-167-23" href="#__codelineno-167-23"></a><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">parent_category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-167-24"><a id="__codelineno-167-24" name="__codelineno-167-24" href="#__codelineno-167-24"></a><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="p">(</span><span class="n">cp</span><span class="p">.</span><span class="n">path</span><span class="p">))</span><span class="w">  </span><span class="c1">-- Stop if we see a cycle</span>
</span><span id="__span-167-25"><a id="__codelineno-167-25" name="__codelineno-167-25" href="#__codelineno-167-25"></a><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">cp</span><span class="p">.</span><span class="n">depth</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w">  </span><span class="c1">-- Prevent infinite recursion</span>
</span><span id="__span-167-26"><a id="__codelineno-167-26" name="__codelineno-167-26" href="#__codelineno-167-26"></a><span class="p">)</span>
</span><span id="__span-167-27"><a id="__codelineno-167-27" name="__codelineno-167-27" href="#__codelineno-167-27"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-167-28"><a id="__codelineno-167-28" name="__codelineno-167-28" href="#__codelineno-167-28"></a><span class="k">FROM</span><span class="w"> </span><span class="n">category_path</span>
</span><span id="__span-167-29"><a id="__codelineno-167-29" name="__codelineno-167-29" href="#__codelineno-167-29"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">parent_category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ANY</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w">  </span><span class="c1">-- Found a cycle</span>
</span></code></pre></div></p>
<p><strong>Hierarchy consistency:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">hierarchy_level_consistency</span><span class="p">);</span>
</span><span id="__span-168-2"><a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a>
</span><span id="__span-168-3"><a id="__codelineno-168-3" name="__codelineno-168-3" href="#__codelineno-168-3"></a><span class="c1">-- Ensure level matches actual depth in hierarchy</span>
</span><span id="__span-168-4"><a id="__codelineno-168-4" name="__codelineno-168-4" href="#__codelineno-168-4"></a><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">hierarchy_depth</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-168-5"><a id="__codelineno-168-5" name="__codelineno-168-5" href="#__codelineno-168-5"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-168-6"><a id="__codelineno-168-6" name="__codelineno-168-6" href="#__codelineno-168-6"></a><span class="w">    </span><span class="n">category_id</span><span class="p">,</span>
</span><span id="__span-168-7"><a id="__codelineno-168-7" name="__codelineno-168-7" href="#__codelineno-168-7"></a><span class="w">    </span><span class="n">parent_category_id</span><span class="p">,</span>
</span><span id="__span-168-8"><a id="__codelineno-168-8" name="__codelineno-168-8" href="#__codelineno-168-8"></a><span class="w">    </span><span class="k">level</span><span class="p">,</span>
</span><span id="__span-168-9"><a id="__codelineno-168-9" name="__codelineno-168-9" href="#__codelineno-168-9"></a><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">actual_depth</span>
</span><span id="__span-168-10"><a id="__codelineno-168-10" name="__codelineno-168-10" href="#__codelineno-168-10"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-168-11"><a id="__codelineno-168-11" name="__codelineno-168-11" href="#__codelineno-168-11"></a><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">parent_category_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-168-12"><a id="__codelineno-168-12" name="__codelineno-168-12" href="#__codelineno-168-12"></a>
</span><span id="__span-168-13"><a id="__codelineno-168-13" name="__codelineno-168-13" href="#__codelineno-168-13"></a><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-168-14"><a id="__codelineno-168-14" name="__codelineno-168-14" href="#__codelineno-168-14"></a>
</span><span id="__span-168-15"><a id="__codelineno-168-15" name="__codelineno-168-15" href="#__codelineno-168-15"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-168-16"><a id="__codelineno-168-16" name="__codelineno-168-16" href="#__codelineno-168-16"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">category_id</span><span class="p">,</span>
</span><span id="__span-168-17"><a id="__codelineno-168-17" name="__codelineno-168-17" href="#__codelineno-168-17"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="n">parent_category_id</span><span class="p">,</span>
</span><span id="__span-168-18"><a id="__codelineno-168-18" name="__codelineno-168-18" href="#__codelineno-168-18"></a><span class="w">    </span><span class="k">c</span><span class="p">.</span><span class="k">level</span><span class="p">,</span>
</span><span id="__span-168-19"><a id="__codelineno-168-19" name="__codelineno-168-19" href="#__codelineno-168-19"></a><span class="w">    </span><span class="n">hd</span><span class="p">.</span><span class="n">actual_depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-168-20"><a id="__codelineno-168-20" name="__codelineno-168-20" href="#__codelineno-168-20"></a><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">c</span>
</span><span id="__span-168-21"><a id="__codelineno-168-21" name="__codelineno-168-21" href="#__codelineno-168-21"></a><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">hierarchy_depth</span><span class="w"> </span><span class="n">hd</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">parent_category_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hd</span><span class="p">.</span><span class="n">category_id</span>
</span><span id="__span-168-22"><a id="__codelineno-168-22" name="__codelineno-168-22" href="#__codelineno-168-22"></a><span class="p">)</span>
</span><span id="__span-168-23"><a id="__codelineno-168-23" name="__codelineno-168-23" href="#__codelineno-168-23"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-168-24"><a id="__codelineno-168-24" name="__codelineno-168-24" href="#__codelineno-168-24"></a><span class="k">FROM</span><span class="w"> </span><span class="n">hierarchy_depth</span>
</span><span id="__span-168-25"><a id="__codelineno-168-25" name="__codelineno-168-25" href="#__codelineno-168-25"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">actual_depth</span><span class="p">;</span>
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="7-audit-execution-and-lifecycle">7. Audit Execution and Lifecycle<a class="headerlink" href="#7-audit-execution-and-lifecycle" title="Permanent link">&para;</a></h2>
<h3 id="71-when-audits-run">7.1 When Audits Run<a class="headerlink" href="#71-when-audits-run" title="Permanent link">&para;</a></h3>
<p>Audits execute automatically at specific points:</p>
<p><strong>1. After model execution completes</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a>Model SQL runs → Data written → Audits run immediately
</span></code></pre></div></p>
<p><strong>2. During <code>vulcan plan</code> and <code>vulcan run</code></strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-170-1"><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a>vulcan plan → Models execute in virtual environments → Audits run → Apply promotes clean data
</span><span id="__span-170-2"><a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a>vulcan run → Models execute in target environments → Audits run → Blocks downstream on failure
</span></code></pre></div></p>
<p><strong>3. Not during schema changes</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-171-1"><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a>ALTER TABLE statements → No audits run
</span></code></pre></div></p>
<hr />
<h3 id="72-plan-vs-run-where-bad-data-lives">7.2 Plan vs Run: Where Bad Data Lives<a class="headerlink" href="#72-plan-vs-run-where-bad-data-lives" title="Permanent link">&para;</a></h3>
<p><strong>This is a critical distinction that affects how you recover from audit failures.</strong></p>
<h4 id="during-vulcan-plan-developmentstaging-workflow">During <code>vulcan plan</code> (Development/Staging Workflow)<a class="headerlink" href="#during-vulcan-plan-developmentstaging-workflow" title="Permanent link">&para;</a></h4>
<p><strong>Virtual Environments:</strong>
- SQLMesh creates <strong>isolated schemas/databases</strong> (virtual environments)
- Models execute and write to <strong>isolated tables</strong>, NOT production
- Audits run against the isolated tables
- Only models that <strong>pass audits</strong> get promoted to production when you apply the plan</p>
<p><strong>Execution flow:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-172-1"><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a>vulcan plan
</span><span id="__span-172-2"><a id="__codelineno-172-2" name="__codelineno-172-2" href="#__codelineno-172-2"></a>  → Creates virtual environment (e.g., schema: myproject__dev_123)
</span><span id="__span-172-3"><a id="__codelineno-172-3" name="__codelineno-172-3" href="#__codelineno-172-3"></a>  → Model writes to: myproject__dev_123.sales.orders
</span><span id="__span-172-4"><a id="__codelineno-172-4" name="__codelineno-172-4" href="#__codelineno-172-4"></a>  → Audit runs on: myproject__dev_123.sales.orders
</span><span id="__span-172-5"><a id="__codelineno-172-5" name="__codelineno-172-5" href="#__codelineno-172-5"></a>  → ❌ Audit fails
</span><span id="__span-172-6"><a id="__codelineno-172-6" name="__codelineno-172-6" href="#__codelineno-172-6"></a>      → Bad data stays in virtual environment
</span><span id="__span-172-7"><a id="__codelineno-172-7" name="__codelineno-172-7" href="#__codelineno-172-7"></a>      → Production tables remain untouched ✅
</span><span id="__span-172-8"><a id="__codelineno-172-8" name="__codelineno-172-8" href="#__codelineno-172-8"></a>      → Fix and re-plan (virtual env is disposable)
</span><span id="__span-172-9"><a id="__codelineno-172-9" name="__codelineno-172-9" href="#__codelineno-172-9"></a>  → ✅ Audit passes
</span><span id="__span-172-10"><a id="__codelineno-172-10" name="__codelineno-172-10" href="#__codelineno-172-10"></a>      → vulcan plan apply
</span><span id="__span-172-11"><a id="__codelineno-172-11" name="__codelineno-172-11" href="#__codelineno-172-11"></a>      → Promotes clean data to production ✅
</span></code></pre></div></p>
<p><strong>Key benefits:</strong>
- <strong>Safe testing</strong> - Production never sees bad data
- <strong>Easy rollback</strong> - Just don't apply the plan
- <strong>Isolated debugging</strong> - Inspect bad data in virtual environment without production impact</p>
<p><strong>Example:</strong>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-173-1"><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="c1"># Plan creates virtual environment and runs audits</span>
</span><span id="__span-173-2"><a id="__codelineno-173-2" name="__codelineno-173-2" href="#__codelineno-173-2"></a>vulcan<span class="w"> </span>plan
</span><span id="__span-173-3"><a id="__codelineno-173-3" name="__codelineno-173-3" href="#__codelineno-173-3"></a>
</span><span id="__span-173-4"><a id="__codelineno-173-4" name="__codelineno-173-4" href="#__codelineno-173-4"></a><span class="c1"># Output:</span>
</span><span id="__span-173-5"><a id="__codelineno-173-5" name="__codelineno-173-5" href="#__codelineno-173-5"></a><span class="c1"># ======================================================================</span>
</span><span id="__span-173-6"><a id="__codelineno-173-6" name="__codelineno-173-6" href="#__codelineno-173-6"></a><span class="c1"># Model: sales.orders (myproject__dev_456.sales.orders)</span>
</span><span id="__span-173-7"><a id="__codelineno-173-7" name="__codelineno-173-7" href="#__codelineno-173-7"></a><span class="c1"># Status: ❌ AUDIT FAILED</span>
</span><span id="__span-173-8"><a id="__codelineno-173-8" name="__codelineno-173-8" href="#__codelineno-173-8"></a><span class="c1"># Audit: not_null</span>
</span><span id="__span-173-9"><a id="__codelineno-173-9" name="__codelineno-173-9" href="#__codelineno-173-9"></a><span class="c1"># Violations: 3 rows</span>
</span><span id="__span-173-10"><a id="__codelineno-173-10" name="__codelineno-173-10" href="#__codelineno-173-10"></a><span class="c1"># ======================================================================</span>
</span><span id="__span-173-11"><a id="__codelineno-173-11" name="__codelineno-173-11" href="#__codelineno-173-11"></a><span class="c1"># </span>
</span><span id="__span-173-12"><a id="__codelineno-173-12" name="__codelineno-173-12" href="#__codelineno-173-12"></a><span class="c1"># Bad data is in: myproject__dev_456.sales.orders</span>
</span><span id="__span-173-13"><a id="__codelineno-173-13" name="__codelineno-173-13" href="#__codelineno-173-13"></a><span class="c1"># Production table: myproject__prod.sales.orders (unchanged ✅)</span>
</span><span id="__span-173-14"><a id="__codelineno-173-14" name="__codelineno-173-14" href="#__codelineno-173-14"></a>
</span><span id="__span-173-15"><a id="__codelineno-173-15" name="__codelineno-173-15" href="#__codelineno-173-15"></a><span class="c1"># Investigate bad data in virtual environment</span>
</span><span id="__span-173-16"><a id="__codelineno-173-16" name="__codelineno-173-16" href="#__codelineno-173-16"></a>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>myproject__dev_456.sales.orders<span class="w"> </span>WHERE<span class="w"> </span>order_id<span class="w"> </span>IS<span class="w"> </span>NULL<span class="p">;</span>
</span><span id="__span-173-17"><a id="__codelineno-173-17" name="__codelineno-173-17" href="#__codelineno-173-17"></a>
</span><span id="__span-173-18"><a id="__codelineno-173-18" name="__codelineno-173-18" href="#__codelineno-173-18"></a><span class="c1"># Fix source issue, then re-plan (creates new virtual env)</span>
</span><span id="__span-173-19"><a id="__codelineno-173-19" name="__codelineno-173-19" href="#__codelineno-173-19"></a>vulcan<span class="w"> </span>plan
</span><span id="__span-173-20"><a id="__codelineno-173-20" name="__codelineno-173-20" href="#__codelineno-173-20"></a>
</span><span id="__span-173-21"><a id="__codelineno-173-21" name="__codelineno-173-21" href="#__codelineno-173-21"></a><span class="c1"># All audits pass ✅</span>
</span><span id="__span-173-22"><a id="__codelineno-173-22" name="__codelineno-173-22" href="#__codelineno-173-22"></a>vulcan<span class="w"> </span>plan<span class="w"> </span>apply<span class="w">  </span><span class="c1"># Now promote to production</span>
</span></code></pre></div></p>
<hr />
<h4 id="during-vulcan-run-direct-execution">During <code>vulcan run</code> (Direct Execution)<a class="headerlink" href="#during-vulcan-run-direct-execution" title="Permanent link">&para;</a></h4>
<p><strong>Direct Writes:</strong>
- Models execute and write <strong>directly to target tables</strong> (often production)
- Audits run <strong>after</strong> the model has already written data
- If audit fails, bad data is <strong>already committed</strong> to the table</p>
<p><strong>Execution flow:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-174-1"><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a>vulcan run
</span><span id="__span-174-2"><a id="__codelineno-174-2" name="__codelineno-174-2" href="#__codelineno-174-2"></a>  → Model writes directly to: myproject__prod.sales.orders
</span><span id="__span-174-3"><a id="__codelineno-174-3" name="__codelineno-174-3" href="#__codelineno-174-3"></a>  → Data is committed ✅ (already in table)
</span><span id="__span-174-4"><a id="__codelineno-174-4" name="__codelineno-174-4" href="#__codelineno-174-4"></a>  → Audit runs on: myproject__prod.sales.orders
</span><span id="__span-174-5"><a id="__codelineno-174-5" name="__codelineno-174-5" href="#__codelineno-174-5"></a>  → ❌ Audit fails
</span><span id="__span-174-6"><a id="__codelineno-174-6" name="__codelineno-174-6" href="#__codelineno-174-6"></a>      → Bad data is ALREADY in production table ⚠️
</span><span id="__span-174-7"><a id="__codelineno-174-7" name="__codelineno-174-7" href="#__codelineno-174-7"></a>      → Downstream models are blocked ✅ (won&#39;t see bad data)
</span><span id="__span-174-8"><a id="__codelineno-174-8" name="__codelineno-174-8" href="#__codelineno-174-8"></a>      → Must fix source and re-run to overwrite ⚠️
</span><span id="__span-174-9"><a id="__codelineno-174-9" name="__codelineno-174-9" href="#__codelineno-174-9"></a>  → ✅ Audit passes
</span><span id="__span-174-10"><a id="__codelineno-174-10" name="__codelineno-174-10" href="#__codelineno-174-10"></a>      → Downstream models proceed
</span></code></pre></div></p>
<p><strong>Key implications:</strong>
- <strong>Production impact</strong> - Failed model's table contains bad data
- <strong>Downstream protection</strong> - Dependent models don't run (data doesn't propagate further)
- <strong>Recovery required</strong> - Must fix issue and re-run to replace bad data</p>
<p><strong>Example:</strong>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-175-1"><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="c1"># Run directly writes to production</span>
</span><span id="__span-175-2"><a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a>vulcan<span class="w"> </span>run
</span><span id="__span-175-3"><a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a>
</span><span id="__span-175-4"><a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a><span class="c1"># Output:</span>
</span><span id="__span-175-5"><a id="__codelineno-175-5" name="__codelineno-175-5" href="#__codelineno-175-5"></a><span class="c1"># ======================================================================</span>
</span><span id="__span-175-6"><a id="__codelineno-175-6" name="__codelineno-175-6" href="#__codelineno-175-6"></a><span class="c1"># Model: sales.orders</span>
</span><span id="__span-175-7"><a id="__codelineno-175-7" name="__codelineno-175-7" href="#__codelineno-175-7"></a><span class="c1"># Table updated: myproject__prod.sales.orders ✅</span>
</span><span id="__span-175-8"><a id="__codelineno-175-8" name="__codelineno-175-8" href="#__codelineno-175-8"></a><span class="c1"># Auditing...</span>
</span><span id="__span-175-9"><a id="__codelineno-175-9" name="__codelineno-175-9" href="#__codelineno-175-9"></a><span class="c1"># Status: ❌ AUDIT FAILED</span>
</span><span id="__span-175-10"><a id="__codelineno-175-10" name="__codelineno-175-10" href="#__codelineno-175-10"></a><span class="c1"># Audit: not_null</span>
</span><span id="__span-175-11"><a id="__codelineno-175-11" name="__codelineno-175-11" href="#__codelineno-175-11"></a><span class="c1"># Violations: 3 rows</span>
</span><span id="__span-175-12"><a id="__codelineno-175-12" name="__codelineno-175-12" href="#__codelineno-175-12"></a><span class="c1"># ======================================================================</span>
</span><span id="__span-175-13"><a id="__codelineno-175-13" name="__codelineno-175-13" href="#__codelineno-175-13"></a><span class="c1"># </span>
</span><span id="__span-175-14"><a id="__codelineno-175-14" name="__codelineno-175-14" href="#__codelineno-175-14"></a><span class="c1"># ⚠️  Bad data is now in: myproject__prod.sales.orders</span>
</span><span id="__span-175-15"><a id="__codelineno-175-15" name="__codelineno-175-15" href="#__codelineno-175-15"></a><span class="c1"># ✅  Downstream models blocked: sales.daily_metrics, sales.customer_summary</span>
</span><span id="__span-175-16"><a id="__codelineno-175-16" name="__codelineno-175-16" href="#__codelineno-175-16"></a><span class="c1"># </span>
</span><span id="__span-175-17"><a id="__codelineno-175-17" name="__codelineno-175-17" href="#__codelineno-175-17"></a><span class="c1"># Recovery steps:</span>
</span><span id="__span-175-18"><a id="__codelineno-175-18" name="__codelineno-175-18" href="#__codelineno-175-18"></a><span class="c1"># 1. Investigate: SELECT * FROM myproject__prod.sales.orders WHERE order_id IS NULL</span>
</span><span id="__span-175-19"><a id="__codelineno-175-19" name="__codelineno-175-19" href="#__codelineno-175-19"></a><span class="c1"># 2. Fix source data</span>
</span><span id="__span-175-20"><a id="__codelineno-175-20" name="__codelineno-175-20" href="#__codelineno-175-20"></a><span class="c1"># 3. Re-run: vulcan run (overwrites bad data)</span>
</span><span id="__span-175-21"><a id="__codelineno-175-21" name="__codelineno-175-21" href="#__codelineno-175-21"></a>
</span><span id="__span-175-22"><a id="__codelineno-175-22" name="__codelineno-175-22" href="#__codelineno-175-22"></a><span class="c1"># Investigate bad data (already in production)</span>
</span><span id="__span-175-23"><a id="__codelineno-175-23" name="__codelineno-175-23" href="#__codelineno-175-23"></a>SELECT<span class="w"> </span>*<span class="w"> </span>FROM<span class="w"> </span>myproject__prod.sales.orders<span class="w"> </span>WHERE<span class="w"> </span>order_id<span class="w"> </span>IS<span class="w"> </span>NULL<span class="p">;</span>
</span><span id="__span-175-24"><a id="__codelineno-175-24" name="__codelineno-175-24" href="#__codelineno-175-24"></a>
</span><span id="__span-175-25"><a id="__codelineno-175-25" name="__codelineno-175-25" href="#__codelineno-175-25"></a><span class="c1"># After fixing source issue</span>
</span><span id="__span-175-26"><a id="__codelineno-175-26" name="__codelineno-175-26" href="#__codelineno-175-26"></a>vulcan<span class="w"> </span>run<span class="w">  </span><span class="c1"># Overwrites the bad data</span>
</span></code></pre></div></p>
<hr />
<h4 id="comparison-plan-vs-run">Comparison: Plan vs Run<a class="headerlink" href="#comparison-plan-vs-run" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Aspect</th>
<th><code>vulcan plan</code></th>
<th><code>vulcan run</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Write destination</strong></td>
<td>Virtual environment (isolated)</td>
<td>Target environment (often production)</td>
</tr>
<tr>
<td><strong>Audit failure impact</strong></td>
<td>Bad data in isolated schema</td>
<td>Bad data in production table ⚠️</td>
</tr>
<tr>
<td><strong>Production safety</strong></td>
<td>✅ Production never sees bad data</td>
<td>⚠️ Failed model's table has bad data</td>
</tr>
<tr>
<td><strong>Downstream protection</strong></td>
<td>✅ Never promoted</td>
<td>✅ Blocked from running</td>
</tr>
<tr>
<td><strong>Recovery</strong></td>
<td>Easy - don't apply plan</td>
<td>Must fix and re-run to overwrite</td>
</tr>
<tr>
<td><strong>Use case</strong></td>
<td>Development, staging, testing changes</td>
<td>Direct production updates (use cautiously)</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="73-audit-execution-order">7.3 Audit Execution Order<a class="headerlink" href="#73-audit-execution-order" title="Permanent link">&para;</a></h3>
<p>Audits run in the order they're defined:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-176-1"><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-176-2"><a id="__codelineno-176-2" name="__codelineno-176-2" href="#__codelineno-176-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-176-3"><a id="__codelineno-176-3" name="__codelineno-176-3" href="#__codelineno-176-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-176-4"><a id="__codelineno-176-4" name="__codelineno-176-4" href="#__codelineno-176-4"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span><span class="w">      </span><span class="c1">-- Runs 1st</span>
</span><span id="__span-176-5"><a id="__codelineno-176-5" name="__codelineno-176-5" href="#__codelineno-176-5"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span><span class="w"> </span><span class="c1">-- Runs 2nd</span>
</span><span id="__span-176-6"><a id="__codelineno-176-6" name="__codelineno-176-6" href="#__codelineno-176-6"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">),</span><span class="w"> </span><span class="c1">-- Runs 3rd</span>
</span><span id="__span-176-7"><a id="__codelineno-176-7" name="__codelineno-176-7" href="#__codelineno-176-7"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">))</span><span class="w">  </span><span class="c1">-- Runs 4th</span>
</span><span id="__span-176-8"><a id="__codelineno-176-8" name="__codelineno-176-8" href="#__codelineno-176-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-176-9"><a id="__codelineno-176-9" name="__codelineno-176-9" href="#__codelineno-176-9"></a><span class="p">);</span>
</span></code></pre></div>
<p><strong>If any audit fails:</strong>
- Execution halts immediately
- Subsequent audits don't run
- Downstream models don't execute</p>
<p><strong>Optimization tip:</strong> Order audits by execution speed (fast → slow):
<div class="language-sql highlight"><pre><span></span><code><span id="__span-177-1"><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-177-2"><a id="__codelineno-177-2" name="__codelineno-177-2" href="#__codelineno-177-2"></a><span class="w">  </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span><span class="w">           </span><span class="c1">-- Fast: simple null check</span>
</span><span id="__span-177-3"><a id="__codelineno-177-3" name="__codelineno-177-3" href="#__codelineno-177-3"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span><span class="w">       </span><span class="c1">-- Medium: GROUP BY + HAVING</span>
</span><span id="__span-177-4"><a id="__codelineno-177-4" name="__codelineno-177-4" href="#__codelineno-177-4"></a><span class="w">  </span><span class="n">referential_integrity_check</span><span class="p">,</span><span class="w">                 </span><span class="c1">-- Slow: JOIN with large table</span>
</span><span id="__span-177-5"><a id="__codelineno-177-5" name="__codelineno-177-5" href="#__codelineno-177-5"></a><span class="w">  </span><span class="n">complex_statistical_outlier_detection</span><span class="w">        </span><span class="c1">-- Slowest: multiple passes</span>
</span><span id="__span-177-6"><a id="__codelineno-177-6" name="__codelineno-177-6" href="#__codelineno-177-6"></a><span class="p">)</span>
</span></code></pre></div></p>
<hr />
<h3 id="74-incremental-models-and-audits">7.4 Incremental Models and Audits<a class="headerlink" href="#74-incremental-models-and-audits" title="Permanent link">&para;</a></h3>
<p>For incremental models, audits scope automatically to processed intervals:</p>
<p><strong>Example: Incremental model</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-178-1"><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-178-2"><a id="__codelineno-178-2" name="__codelineno-178-2" href="#__codelineno-178-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_orders</span><span class="p">,</span>
</span><span id="__span-178-3"><a id="__codelineno-178-3" name="__codelineno-178-3" href="#__codelineno-178-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="n">INCREMENTAL_BY_TIME_RANGE</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-178-4"><a id="__codelineno-178-4" name="__codelineno-178-4" href="#__codelineno-178-4"></a><span class="w">    </span><span class="n">time_column</span><span class="w"> </span><span class="n">order_date</span>
</span><span id="__span-178-5"><a id="__codelineno-178-5" name="__codelineno-178-5" href="#__codelineno-178-5"></a><span class="w">  </span><span class="p">),</span>
</span><span id="__span-178-6"><a id="__codelineno-178-6" name="__codelineno-178-6" href="#__codelineno-178-6"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-178-7"><a id="__codelineno-178-7" name="__codelineno-178-7" href="#__codelineno-178-7"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">))</span>
</span><span id="__span-178-8"><a id="__codelineno-178-8" name="__codelineno-178-8" href="#__codelineno-178-8"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-178-9"><a id="__codelineno-178-9" name="__codelineno-178-9" href="#__codelineno-178-9"></a><span class="p">);</span>
</span><span id="__span-178-10"><a id="__codelineno-178-10" name="__codelineno-178-10" href="#__codelineno-178-10"></a>
</span><span id="__span-178-11"><a id="__codelineno-178-11" name="__codelineno-178-11" href="#__codelineno-178-11"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-178-12"><a id="__codelineno-178-12" name="__codelineno-178-12" href="#__codelineno-178-12"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">@</span><span class="n">start_ds</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">@</span><span class="n">end_ds</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Execution on 2024-01-15:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-179-1"><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a>1. Model processes: WHERE order_date BETWEEN &#39;2024-01-15&#39; AND &#39;2024-01-15&#39;
</span><span id="__span-179-2"><a id="__codelineno-179-2" name="__codelineno-179-2" href="#__codelineno-179-2"></a>2. Audit runs on: Only rows with order_date = &#39;2024-01-15&#39;
</span><span id="__span-179-3"><a id="__codelineno-179-3" name="__codelineno-179-3" href="#__codelineno-179-3"></a>3. Historical data (2024-01-01 to 2024-01-14) is NOT re-audited
</span></code></pre></div></p>
<p><strong>How <code>@this_model</code> works:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-180-1"><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="c1">-- Your audit definition</span>
</span><span id="__span-180-2"><a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_amounts</span><span class="p">);</span>
</span><span id="__span-180-3"><a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-180-4"><a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a>
</span><span id="__span-180-5"><a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a><span class="c1">-- For incremental model on 2024-01-15, expands to:</span>
</span><span id="__span-180-6"><a id="__codelineno-180-6" name="__codelineno-180-6" href="#__codelineno-180-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-180-7"><a id="__codelineno-180-7" name="__codelineno-180-7" href="#__codelineno-180-7"></a><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">daily_orders</span><span class="w"> </span>
</span><span id="__span-180-8"><a id="__codelineno-180-8" name="__codelineno-180-8" href="#__codelineno-180-8"></a><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="s1">&#39;2024-01-15&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="s1">&#39;2024-01-15&#39;</span>
</span><span id="__span-180-9"><a id="__codelineno-180-9" name="__codelineno-180-9" href="#__codelineno-180-9"></a><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Why this matters:</strong>
- Efficiency: Don't re-audit unchanged historical data
- Correctness: Only validate what you just processed
- Performance: Audits scale with interval size, not total table size</p>
<hr />
<h3 id="75-full-refresh-and-audits">7.5 Full Refresh and Audits<a class="headerlink" href="#75-full-refresh-and-audits" title="Permanent link">&para;</a></h3>
<p>For full refresh models, audits validate the entire table:</p>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-181-1"><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-181-2"><a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="p">,</span>
</span><span id="__span-181-3"><a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a><span class="w">  </span><span class="n">kind</span><span class="w"> </span><span class="k">FULL</span><span class="p">,</span>
</span><span id="__span-181-4"><a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-181-5"><a id="__codelineno-181-5" name="__codelineno-181-5" href="#__codelineno-181-5"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span>
</span><span id="__span-181-6"><a id="__codelineno-181-6" name="__codelineno-181-6" href="#__codelineno-181-6"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-181-7"><a id="__codelineno-181-7" name="__codelineno-181-7" href="#__codelineno-181-7"></a><span class="p">);</span>
</span><span id="__span-181-8"><a id="__codelineno-181-8" name="__codelineno-181-8" href="#__codelineno-181-8"></a>
</span><span id="__span-181-9"><a id="__codelineno-181-9" name="__codelineno-181-9" href="#__codelineno-181-9"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">customers</span><span class="p">;</span>
</span></code></pre></div>
<p><strong>Every execution:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-182-1"><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a>1. Table is completely replaced
</span><span id="__span-182-2"><a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a>2. Audit runs on entire new table contents
</span><span id="__span-182-3"><a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a>3. All rows validated every time
</span></code></pre></div></p>
<p><strong>Performance consideration:</strong>
- Full refresh + expensive audits = slow execution
- Use profiles instead for less critical validations
- Consider incremental models if possible</p>
<hr />
<h3 id="76-temporarily-skipping-audits">7.6 Temporarily Skipping Audits<a class="headerlink" href="#76-temporarily-skipping-audits" title="Permanent link">&para;</a></h3>
<p>Use <code>skip</code> flag to temporarily disable audits:</p>
<p><strong>Skip specific audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-183-1"><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a><span class="c1">-- audits/temp_disabled.sql</span>
</span><span id="__span-183-2"><a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-183-3"><a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">experimental_check</span><span class="p">,</span>
</span><span id="__span-183-4"><a id="__codelineno-183-4" name="__codelineno-183-4" href="#__codelineno-183-4"></a><span class="w">  </span><span class="n">skip</span><span class="w"> </span><span class="k">true</span><span class="w">  </span><span class="c1">-- This audit won&#39;t run</span>
</span><span id="__span-183-5"><a id="__codelineno-183-5" name="__codelineno-183-5" href="#__codelineno-183-5"></a><span class="p">);</span>
</span><span id="__span-183-6"><a id="__codelineno-183-6" name="__codelineno-183-6" href="#__codelineno-183-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">experimental_condition</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>When to skip:</strong>
- Developing/testing a new audit
- Known data quality issue being fixed
- Temporarily expensive audit during investigation</p>
<p><strong>WARNING:</strong> Never skip critical audits in production. Use <code>skip</code> only for development or temporary issues.</p>
<p><strong>Alternative: Comment out instead of skip</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-184-1"><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-184-2"><a id="__codelineno-184-2" name="__codelineno-184-2" href="#__codelineno-184-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-184-3"><a id="__codelineno-184-3" name="__codelineno-184-3" href="#__codelineno-184-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-184-4"><a id="__codelineno-184-4" name="__codelineno-184-4" href="#__codelineno-184-4"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-184-5"><a id="__codelineno-184-5" name="__codelineno-184-5" href="#__codelineno-184-5"></a><span class="w">    </span><span class="c1">-- unique_values(columns := (order_id)),  -- Temporarily disabled</span>
</span><span id="__span-184-6"><a id="__codelineno-184-6" name="__codelineno-184-6" href="#__codelineno-184-6"></a><span class="w">    </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span>
</span><span id="__span-184-7"><a id="__codelineno-184-7" name="__codelineno-184-7" href="#__codelineno-184-7"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-184-8"><a id="__codelineno-184-8" name="__codelineno-184-8" href="#__codelineno-184-8"></a><span class="p">);</span>
</span></code></pre></div></p>
<hr />
<h3 id="77-audit-failure-handling">7.7 Audit Failure Handling<a class="headerlink" href="#77-audit-failure-handling" title="Permanent link">&para;</a></h3>
<p><strong>What happens when an audit fails:</strong></p>
<ol>
<li><strong>Execution halts immediately</strong></li>
<li>Model execution completed</li>
<li>Audit detected violations</li>
<li>
<p>Downstream models blocked</p>
</li>
<li>
<p><strong>Error message includes:</strong></p>
</li>
<li>Audit name</li>
<li>Model name</li>
<li>Number of violating rows</li>
<li>Audit SQL query</li>
</ol>
<p><strong>Example error:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-185-1"><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a>Failure in audit &#39;not_null&#39; for model &#39;sales.orders&#39;.
</span><span id="__span-185-2"><a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a>Got 3 results, expected 0.
</span><span id="__span-185-3"><a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a>Query: SELECT * FROM sales.orders WHERE order_id IS NULL OR customer_id IS NULL
</span></code></pre></div></p>
<ol>
<li><strong>Data state:</strong></li>
<li>Model's own table contains the bad data (already written)</li>
<li>Downstream models don't run (data doesn't propagate)</li>
<li>
<p>Source data unchanged</p>
</li>
<li>
<p><strong>Next steps:</strong></p>
</li>
<li>Investigate root cause</li>
<li>Fix source data or model logic</li>
<li>Re-run execution</li>
</ol>
<hr />
<h3 id="78-audit-performance-impact">7.8 Audit Performance Impact<a class="headerlink" href="#78-audit-performance-impact" title="Permanent link">&para;</a></h3>
<p><strong>Audits add to execution time:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-186-1"><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a>Total execution time = Model execution + All audits execution
</span></code></pre></div></p>
<p><strong>Performance tips:</strong></p>
<p><strong>1. Keep audits simple:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-187-1"><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a><span class="c1">-- Fast audit</span>
</span><span id="__span-187-2"><a id="__codelineno-187-2" name="__codelineno-187-2" href="#__codelineno-187-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-187-3"><a id="__codelineno-187-3" name="__codelineno-187-3" href="#__codelineno-187-3"></a>
</span><span id="__span-187-4"><a id="__codelineno-187-4" name="__codelineno-187-4" href="#__codelineno-187-4"></a><span class="c1">-- Slow audit</span>
</span><span id="__span-187-5"><a id="__codelineno-187-5" name="__codelineno-187-5" href="#__codelineno-187-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">t1</span>
</span><span id="__span-187-6"><a id="__codelineno-187-6" name="__codelineno-187-6" href="#__codelineno-187-6"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">huge_dimension_table</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span>
</span><span id="__span-187-7"><a id="__codelineno-187-7" name="__codelineno-187-7" href="#__codelineno-187-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">complex_function</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="k">column</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invalid_value</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>2. Use indexes on audited columns:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-188-1"><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a><span class="c1">-- If auditing customer_id frequently, add index:</span>
</span><span id="__span-188-2"><a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_customer_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span>
</span><span id="__span-188-3"><a id="__codelineno-188-3" name="__codelineno-188-3" href="#__codelineno-188-3"></a>
</span><span id="__span-188-4"><a id="__codelineno-188-4" name="__codelineno-188-4" href="#__codelineno-188-4"></a><span class="c1">-- Audits will be faster:</span>
</span><span id="__span-188-5"><a id="__codelineno-188-5" name="__codelineno-188-5" href="#__codelineno-188-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>3. Limit cross-model audits:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-189-1"><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a><span class="c1">-- Expensive: JOINs with large tables</span>
</span><span id="__span-189-2"><a id="__codelineno-189-2" name="__codelineno-189-2" href="#__codelineno-189-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">referential_check</span><span class="p">);</span>
</span><span id="__span-189-3"><a id="__codelineno-189-3" name="__codelineno-189-3" href="#__codelineno-189-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-189-4"><a id="__codelineno-189-4" name="__codelineno-189-4" href="#__codelineno-189-4"></a><span class="k">JOIN</span><span class="w"> </span><span class="n">enormous_table</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="k">key</span>
</span><span id="__span-189-5"><a id="__codelineno-189-5" name="__codelineno-189-5" href="#__codelineno-189-5"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">validation_condition</span><span class="p">;</span>
</span><span id="__span-189-6"><a id="__codelineno-189-6" name="__codelineno-189-6" href="#__codelineno-189-6"></a>
</span><span id="__span-189-7"><a id="__codelineno-189-7" name="__codelineno-189-7" href="#__codelineno-189-7"></a><span class="c1">-- Consider: Move to quality check (runs separately) or profile</span>
</span></code></pre></div></p>
<p><strong>4. Avoid function calls in audits:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-190-1"><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a><span class="c1">-- Slow: Function call per row</span>
</span><span id="__span-190-2"><a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-190-3"><a id="__codelineno-190-3" name="__codelineno-190-3" href="#__codelineno-190-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">EXPENSIVE_UDF</span><span class="p">(</span><span class="k">column</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;invalid&#39;</span><span class="p">;</span>
</span><span id="__span-190-4"><a id="__codelineno-190-4" name="__codelineno-190-4" href="#__codelineno-190-4"></a>
</span><span id="__span-190-5"><a id="__codelineno-190-5" name="__codelineno-190-5" href="#__codelineno-190-5"></a><span class="c1">-- Better: Pre-compute if possible</span>
</span><span id="__span-190-6"><a id="__codelineno-190-6" name="__codelineno-190-6" href="#__codelineno-190-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-190-7"><a id="__codelineno-190-7" name="__codelineno-190-7" href="#__codelineno-190-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">computed_column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;invalid&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="8-troubleshooting-and-debugging">8. Troubleshooting and Debugging<a class="headerlink" href="#8-troubleshooting-and-debugging" title="Permanent link">&para;</a></h2>
<h3 id="81-reading-audit-failure-messages">8.1 Reading Audit Failure Messages<a class="headerlink" href="#81-reading-audit-failure-messages" title="Permanent link">&para;</a></h3>
<p>Audit failures provide detailed information:</p>
<p><strong>Example failure:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-191-1"><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a>Failure in audit &#39;not_null&#39; for model &#39;sales.orders&#39;.
</span><span id="__span-191-2"><a id="__codelineno-191-2" name="__codelineno-191-2" href="#__codelineno-191-2"></a>Got 3 results, expected 0.
</span><span id="__span-191-3"><a id="__codelineno-191-3" name="__codelineno-191-3" href="#__codelineno-191-3"></a>Query: SELECT * FROM sales.orders WHERE order_id IS NULL OR customer_id IS NULL
</span></code></pre></div></p>
<p><strong>Message components:</strong>
1. <strong>Audit name:</strong> <code>not_null</code>
2. <strong>Model name:</strong> <code>sales.orders</code>
3. <strong>Row count:</strong> <code>Got 3 results</code> (3 rows violated)
4. <strong>SQL query:</strong> The actual audit query that found violations</p>
<hr />
<h3 id="82-debugging-failed-audits-step-by-step">8.2 Debugging Failed Audits (Step-by-Step)<a class="headerlink" href="#82-debugging-failed-audits-step-by-step" title="Permanent link">&para;</a></h3>
<p><strong>Step 1: Run the audit query manually</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-192-1"><a id="__codelineno-192-1" name="__codelineno-192-1" href="#__codelineno-192-1"></a><span class="c1">-- Copy the query from error message</span>
</span><span id="__span-192-2"><a id="__codelineno-192-2" name="__codelineno-192-2" href="#__codelineno-192-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span>
</span><span id="__span-192-3"><a id="__codelineno-192-3" name="__codelineno-192-3" href="#__codelineno-192-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span><span id="__span-192-4"><a id="__codelineno-192-4" name="__codelineno-192-4" href="#__codelineno-192-4"></a>
</span><span id="__span-192-5"><a id="__codelineno-192-5" name="__codelineno-192-5" href="#__codelineno-192-5"></a><span class="c1">-- Result shows the 3 problematic rows</span>
</span></code></pre></div></p>
<p><strong>Step 2: Add context to understand the issue</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-193-1"><a id="__codelineno-193-1" name="__codelineno-193-1" href="#__codelineno-193-1"></a><span class="c1">-- Expand query to see full row context</span>
</span><span id="__span-193-2"><a id="__codelineno-193-2" name="__codelineno-193-2" href="#__codelineno-193-2"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-193-3"><a id="__codelineno-193-3" name="__codelineno-193-3" href="#__codelineno-193-3"></a><span class="w">  </span><span class="o">*</span><span class="p">,</span>
</span><span id="__span-193-4"><a id="__codelineno-193-4" name="__codelineno-193-4" href="#__codelineno-193-4"></a><span class="w">  </span><span class="s1">&#39;Missing order_id&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">issue_type</span>
</span><span id="__span-193-5"><a id="__codelineno-193-5" name="__codelineno-193-5" href="#__codelineno-193-5"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span>
</span><span id="__span-193-6"><a id="__codelineno-193-6" name="__codelineno-193-6" href="#__codelineno-193-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-193-7"><a id="__codelineno-193-7" name="__codelineno-193-7" href="#__codelineno-193-7"></a>
</span><span id="__span-193-8"><a id="__codelineno-193-8" name="__codelineno-193-8" href="#__codelineno-193-8"></a><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span>
</span><span id="__span-193-9"><a id="__codelineno-193-9" name="__codelineno-193-9" href="#__codelineno-193-9"></a>
</span><span id="__span-193-10"><a id="__codelineno-193-10" name="__codelineno-193-10" href="#__codelineno-193-10"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-193-11"><a id="__codelineno-193-11" name="__codelineno-193-11" href="#__codelineno-193-11"></a><span class="w">  </span><span class="o">*</span><span class="p">,</span>
</span><span id="__span-193-12"><a id="__codelineno-193-12" name="__codelineno-193-12" href="#__codelineno-193-12"></a><span class="w">  </span><span class="s1">&#39;Missing customer_id&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">issue_type</span>
</span><span id="__span-193-13"><a id="__codelineno-193-13" name="__codelineno-193-13" href="#__codelineno-193-13"></a><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span>
</span><span id="__span-193-14"><a id="__codelineno-193-14" name="__codelineno-193-14" href="#__codelineno-193-14"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Step 3: Trace upstream to find root cause</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-194-1"><a id="__codelineno-194-1" name="__codelineno-194-1" href="#__codelineno-194-1"></a><span class="c1">-- Check source data</span>
</span><span id="__span-194-2"><a id="__codelineno-194-2" name="__codelineno-194-2" href="#__codelineno-194-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span>
</span><span id="__span-194-3"><a id="__codelineno-194-3" name="__codelineno-194-3" href="#__codelineno-194-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">order_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span><span id="__span-194-4"><a id="__codelineno-194-4" name="__codelineno-194-4" href="#__codelineno-194-4"></a>
</span><span id="__span-194-5"><a id="__codelineno-194-5" name="__codelineno-194-5" href="#__codelineno-194-5"></a><span class="c1">-- If source is clean, check model logic</span>
</span><span id="__span-194-6"><a id="__codelineno-194-6" name="__codelineno-194-6" href="#__codelineno-194-6"></a><span class="c1">-- Look for JOIN conditions that might create nulls</span>
</span></code></pre></div></p>
<p><strong>Step 4: Determine fix location</strong>
- <strong>Source data issue:</strong> Fix upstream system, re-run extraction
- <strong>Model logic issue:</strong> Update model SQL, re-run transformation
- <strong>Audit logic issue:</strong> Audit is too strict, adjust audit query</p>
<hr />
<h3 id="83-common-audit-issues">8.3 Common Audit Issues<a class="headerlink" href="#83-common-audit-issues" title="Permanent link">&para;</a></h3>
<p><strong>Issue 1: Audit fails intermittently</strong></p>
<p><strong>Cause:</strong> Time-dependent data or race conditions</p>
<p><strong>Solution:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-195-1"><a id="__codelineno-195-1" name="__codelineno-195-1" href="#__codelineno-195-1"></a><span class="c1">-- Bad: Checks against current time (changes every second)</span>
</span><span id="__span-195-2"><a id="__codelineno-195-2" name="__codelineno-195-2" href="#__codelineno-195-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-195-3"><a id="__codelineno-195-3" name="__codelineno-195-3" href="#__codelineno-195-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">;</span>
</span><span id="__span-195-4"><a id="__codelineno-195-4" name="__codelineno-195-4" href="#__codelineno-195-4"></a>
</span><span id="__span-195-5"><a id="__codelineno-195-5" name="__codelineno-195-5" href="#__codelineno-195-5"></a><span class="c1">-- Good: Check against model&#39;s time range</span>
</span><span id="__span-195-6"><a id="__codelineno-195-6" name="__codelineno-195-6" href="#__codelineno-195-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-195-7"><a id="__codelineno-195-7" name="__codelineno-195-7" href="#__codelineno-195-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">end_ds</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;1 hour&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Issue 2: Audit too strict (fails on edge cases)</strong></p>
<p><strong>Cause:</strong> Missing business context</p>
<p><strong>Solution:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-196-1"><a id="__codelineno-196-1" name="__codelineno-196-1" href="#__codelineno-196-1"></a><span class="c1">-- Too strict: Fails on valid $0 free-tier products</span>
</span><span id="__span-196-2"><a id="__codelineno-196-2" name="__codelineno-196-2" href="#__codelineno-196-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-196-3"><a id="__codelineno-196-3" name="__codelineno-196-3" href="#__codelineno-196-3"></a>
</span><span id="__span-196-4"><a id="__codelineno-196-4" name="__codelineno-196-4" href="#__codelineno-196-4"></a><span class="c1">-- Better: Account for free-tier</span>
</span><span id="__span-196-5"><a id="__codelineno-196-5" name="__codelineno-196-5" href="#__codelineno-196-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-196-6"><a id="__codelineno-196-6" name="__codelineno-196-6" href="#__codelineno-196-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
</span><span id="__span-196-7"><a id="__codelineno-196-7" name="__codelineno-196-7" href="#__codelineno-196-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">product_tier</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;free&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Issue 3: Audit passes but data still wrong</strong></p>
<p><strong>Cause:</strong> Inverted logic</p>
<p><strong>Solution:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-197-1"><a id="__codelineno-197-1" name="__codelineno-197-1" href="#__codelineno-197-1"></a><span class="c1">-- Wrong: Returns good data</span>
</span><span id="__span-197-2"><a id="__codelineno-197-2" name="__codelineno-197-2" href="#__codelineno-197-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Audit always fails!</span>
</span><span id="__span-197-3"><a id="__codelineno-197-3" name="__codelineno-197-3" href="#__codelineno-197-3"></a>
</span><span id="__span-197-4"><a id="__codelineno-197-4" name="__codelineno-197-4" href="#__codelineno-197-4"></a><span class="c1">-- Right: Returns bad data</span>
</span><span id="__span-197-5"><a id="__codelineno-197-5" name="__codelineno-197-5" href="#__codelineno-197-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Audit passes if no bad data</span>
</span></code></pre></div></p>
<p><strong>Issue 4: Performance issues</strong></p>
<p><strong>Cause:</strong> Expensive audit queries</p>
<p><strong>Solution:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-198-1"><a id="__codelineno-198-1" name="__codelineno-198-1" href="#__codelineno-198-1"></a><span class="c1">-- Slow: Full table scan with function</span>
</span><span id="__span-198-2"><a id="__codelineno-198-2" name="__codelineno-198-2" href="#__codelineno-198-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-198-3"><a id="__codelineno-198-3" name="__codelineno-198-3" href="#__codelineno-198-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">EXPENSIVE_FUNCTION</span><span class="p">(</span><span class="k">column</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;invalid&#39;</span><span class="p">;</span>
</span><span id="__span-198-4"><a id="__codelineno-198-4" name="__codelineno-198-4" href="#__codelineno-198-4"></a>
</span><span id="__span-198-5"><a id="__codelineno-198-5" name="__codelineno-198-5" href="#__codelineno-198-5"></a><span class="c1">-- Fast: Use indexed column or pre-computed value</span>
</span><span id="__span-198-6"><a id="__codelineno-198-6" name="__codelineno-198-6" href="#__codelineno-198-6"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-198-7"><a id="__codelineno-198-7" name="__codelineno-198-7" href="#__codelineno-198-7"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">computed_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;invalid&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="84-fixing-failed-audits">8.4 Fixing Failed Audits<a class="headerlink" href="#84-fixing-failed-audits" title="Permanent link">&para;</a></h3>
<p><strong>Scenario A: Fix source data</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-199-1"><a id="__codelineno-199-1" name="__codelineno-199-1" href="#__codelineno-199-1"></a>1. Identify bad data in source system
</span><span id="__span-199-2"><a id="__codelineno-199-2" name="__codelineno-199-2" href="#__codelineno-199-2"></a>2. Correct at source
</span><span id="__span-199-3"><a id="__codelineno-199-3" name="__codelineno-199-3" href="#__codelineno-199-3"></a>3. Re-extract data
</span><span id="__span-199-4"><a id="__codelineno-199-4" name="__codelineno-199-4" href="#__codelineno-199-4"></a>4. Re-run Vulcan model
</span><span id="__span-199-5"><a id="__codelineno-199-5" name="__codelineno-199-5" href="#__codelineno-199-5"></a>5. Audit passes
</span></code></pre></div></p>
<p><strong>Scenario B: Fix model logic</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-200-1"><a id="__codelineno-200-1" name="__codelineno-200-1" href="#__codelineno-200-1"></a><span class="c1">-- Before: Model creates nulls via LEFT JOIN</span>
</span><span id="__span-200-2"><a id="__codelineno-200-2" name="__codelineno-200-2" href="#__codelineno-200-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span>
</span><span id="__span-200-3"><a id="__codelineno-200-3" name="__codelineno-200-3" href="#__codelineno-200-3"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-200-4"><a id="__codelineno-200-4" name="__codelineno-200-4" href="#__codelineno-200-4"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-200-5"><a id="__codelineno-200-5" name="__codelineno-200-5" href="#__codelineno-200-5"></a><span class="c1">-- Result: customer_name is NULL for some rows</span>
</span><span id="__span-200-6"><a id="__codelineno-200-6" name="__codelineno-200-6" href="#__codelineno-200-6"></a>
</span><span id="__span-200-7"><a id="__codelineno-200-7" name="__codelineno-200-7" href="#__codelineno-200-7"></a><span class="c1">-- After: Use INNER JOIN or handle nulls</span>
</span><span id="__span-200-8"><a id="__codelineno-200-8" name="__codelineno-200-8" href="#__codelineno-200-8"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">COALESCE</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">customer_name</span>
</span><span id="__span-200-9"><a id="__codelineno-200-9" name="__codelineno-200-9" href="#__codelineno-200-9"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-200-10"><a id="__codelineno-200-10" name="__codelineno-200-10" href="#__codelineno-200-10"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Scenario C: Adjust audit</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-201-1"><a id="__codelineno-201-1" name="__codelineno-201-1" href="#__codelineno-201-1"></a><span class="c1">-- Before: Too strict</span>
</span><span id="__span-201-2"><a id="__codelineno-201-2" name="__codelineno-201-2" href="#__codelineno-201-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-201-3"><a id="__codelineno-201-3" name="__codelineno-201-3" href="#__codelineno-201-3"></a>
</span><span id="__span-201-4"><a id="__codelineno-201-4" name="__codelineno-201-4" href="#__codelineno-201-4"></a><span class="c1">-- After: Account for legitimate discounts</span>
</span><span id="__span-201-5"><a id="__codelineno-201-5" name="__codelineno-201-5" href="#__codelineno-201-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-201-6"><a id="__codelineno-201-6" name="__codelineno-201-6" href="#__codelineno-201-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span>
</span><span id="__span-201-7"><a id="__codelineno-201-7" name="__codelineno-201-7" href="#__codelineno-201-7"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">order_amount</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Only invalid discounts</span>
</span></code></pre></div></p>
<hr />
<h3 id="85-testing-audits-before-deployment">8.5 Testing Audits Before Deployment<a class="headerlink" href="#85-testing-audits-before-deployment" title="Permanent link">&para;</a></h3>
<p><strong>Test with <code>skip</code> flag during development:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-202-1"><a id="__codelineno-202-1" name="__codelineno-202-1" href="#__codelineno-202-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-202-2"><a id="__codelineno-202-2" name="__codelineno-202-2" href="#__codelineno-202-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">new_audit_under_development</span><span class="p">,</span>
</span><span id="__span-202-3"><a id="__codelineno-202-3" name="__codelineno-202-3" href="#__codelineno-202-3"></a><span class="w">  </span><span class="n">skip</span><span class="w"> </span><span class="k">true</span><span class="w">  </span><span class="c1">-- Won&#39;t run yet</span>
</span><span id="__span-202-4"><a id="__codelineno-202-4" name="__codelineno-202-4" href="#__codelineno-202-4"></a><span class="p">);</span>
</span><span id="__span-202-5"><a id="__codelineno-202-5" name="__codelineno-202-5" href="#__codelineno-202-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">new_condition</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Test audit query separately:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-203-1"><a id="__codelineno-203-1" name="__codelineno-203-1" href="#__codelineno-203-1"></a><span class="c1">-- Run audit query manually on existing data</span>
</span><span id="__span-203-2"><a id="__codelineno-203-2" name="__codelineno-203-2" href="#__codelineno-203-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="w">  </span><span class="c1">-- Replace @this_model with actual table</span>
</span><span id="__span-203-3"><a id="__codelineno-203-3" name="__codelineno-203-3" href="#__codelineno-203-3"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">new_condition</span><span class="p">;</span>
</span><span id="__span-203-4"><a id="__codelineno-203-4" name="__codelineno-203-4" href="#__codelineno-203-4"></a>
</span><span id="__span-203-5"><a id="__codelineno-203-5" name="__codelineno-203-5" href="#__codelineno-203-5"></a><span class="c1">-- Verify it finds issues (or doesn&#39;t) as expected</span>
</span></code></pre></div></p>
<p><strong>Test with small dataset:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-204-1"><a id="__codelineno-204-1" name="__codelineno-204-1" href="#__codelineno-204-1"></a><span class="c1">-- Add WHERE clause to limit scope during testing</span>
</span><span id="__span-204-2"><a id="__codelineno-204-2" name="__codelineno-204-2" href="#__codelineno-204-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">test_audit</span><span class="p">);</span>
</span><span id="__span-204-3"><a id="__codelineno-204-3" name="__codelineno-204-3" href="#__codelineno-204-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-204-4"><a id="__codelineno-204-4" name="__codelineno-204-4" href="#__codelineno-204-4"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">condition</span>
</span><span id="__span-204-5"><a id="__codelineno-204-5" name="__codelineno-204-5" href="#__codelineno-204-5"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s1">&#39;2024-01-01&#39;</span><span class="w">  </span><span class="c1">-- Temporary: test on recent data only</span>
</span><span id="__span-204-6"><a id="__codelineno-204-6" name="__codelineno-204-6" href="#__codelineno-204-6"></a><span class="k">LIMIT</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="9-best-practices">9. Best Practices<a class="headerlink" href="#9-best-practices" title="Permanent link">&para;</a></h2>
<h3 id="91-audit-logic-patterns">9.1 Audit Logic Patterns<a class="headerlink" href="#91-audit-logic-patterns" title="Permanent link">&para;</a></h3>
<p><strong>Always query for bad data (inverted logic):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-205-1"><a id="__codelineno-205-1" name="__codelineno-205-1" href="#__codelineno-205-1"></a><span class="c1">-- Correct</span>
</span><span id="__span-205-2"><a id="__codelineno-205-2" name="__codelineno-205-2" href="#__codelineno-205-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Find violations</span>
</span><span id="__span-205-3"><a id="__codelineno-205-3" name="__codelineno-205-3" href="#__codelineno-205-3"></a>
</span><span id="__span-205-4"><a id="__codelineno-205-4" name="__codelineno-205-4" href="#__codelineno-205-4"></a><span class="c1">-- Incorrect</span>
</span><span id="__span-205-5"><a id="__codelineno-205-5" name="__codelineno-205-5" href="#__codelineno-205-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">-- Find good data (backwards!)</span>
</span></code></pre></div></p>
<p><strong>Use clear, explicit conditions:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-206-1"><a id="__codelineno-206-1" name="__codelineno-206-1" href="#__codelineno-206-1"></a><span class="c1">-- Vague</span>
</span><span id="__span-206-2"><a id="__codelineno-206-2" name="__codelineno-206-2" href="#__codelineno-206-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;good&#39;</span><span class="p">;</span>
</span><span id="__span-206-3"><a id="__codelineno-206-3" name="__codelineno-206-3" href="#__codelineno-206-3"></a>
</span><span id="__span-206-4"><a id="__codelineno-206-4" name="__codelineno-206-4" href="#__codelineno-206-4"></a><span class="c1">-- Clear</span>
</span><span id="__span-206-5"><a id="__codelineno-206-5" name="__codelineno-206-5" href="#__codelineno-206-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span>
</span><span id="__span-206-6"><a id="__codelineno-206-6" name="__codelineno-206-6" href="#__codelineno-206-6"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;delivered&#39;</span><span class="p">);</span>
</span></code></pre></div></p>
<hr />
<h3 id="92-audit-granularity-strategy">9.2 Audit Granularity Strategy<a class="headerlink" href="#92-audit-granularity-strategy" title="Permanent link">&para;</a></h3>
<p><strong>Start broad, add specificity over time:</strong></p>
<p><strong>Phase 1: Essential validations</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-207-1"><a id="__codelineno-207-1" name="__codelineno-207-1" href="#__codelineno-207-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-207-2"><a id="__codelineno-207-2" name="__codelineno-207-2" href="#__codelineno-207-2"></a><span class="w">  </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">)),</span>
</span><span id="__span-207-3"><a id="__codelineno-207-3" name="__codelineno-207-3" href="#__codelineno-207-3"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">))</span>
</span><span id="__span-207-4"><a id="__codelineno-207-4" name="__codelineno-207-4" href="#__codelineno-207-4"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Phase 2: Add business rules</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-208-1"><a id="__codelineno-208-1" name="__codelineno-208-1" href="#__codelineno-208-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-208-2"><a id="__codelineno-208-2" name="__codelineno-208-2" href="#__codelineno-208-2"></a><span class="w">  </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">)),</span>
</span><span id="__span-208-3"><a id="__codelineno-208-3" name="__codelineno-208-3" href="#__codelineno-208-3"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-208-4"><a id="__codelineno-208-4" name="__codelineno-208-4" href="#__codelineno-208-4"></a><span class="w">  </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span>
</span><span id="__span-208-5"><a id="__codelineno-208-5" name="__codelineno-208-5" href="#__codelineno-208-5"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>Phase 3: Add complex validations</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-209-1"><a id="__codelineno-209-1" name="__codelineno-209-1" href="#__codelineno-209-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-209-2"><a id="__codelineno-209-2" name="__codelineno-209-2" href="#__codelineno-209-2"></a><span class="w">  </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">)),</span>
</span><span id="__span-209-3"><a id="__codelineno-209-3" name="__codelineno-209-3" href="#__codelineno-209-3"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-209-4"><a id="__codelineno-209-4" name="__codelineno-209-4" href="#__codelineno-209-4"></a><span class="w">  </span><span class="n">accepted_range</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">min_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">max_v</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">),</span>
</span><span id="__span-209-5"><a id="__codelineno-209-5" name="__codelineno-209-5" href="#__codelineno-209-5"></a><span class="w">  </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shipped_date</span><span class="p">))</span>
</span><span id="__span-209-6"><a id="__codelineno-209-6" name="__codelineno-209-6" href="#__codelineno-209-6"></a><span class="p">)</span>
</span></code></pre></div></p>
<hr />
<h3 id="93-performance-optimization">9.3 Performance Optimization<a class="headerlink" href="#93-performance-optimization" title="Permanent link">&para;</a></h3>
<p><strong>1. Order audits by cost (fast first)</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-210-1"><a id="__codelineno-210-1" name="__codelineno-210-1" href="#__codelineno-210-1"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-210-2"><a id="__codelineno-210-2" name="__codelineno-210-2" href="#__codelineno-210-2"></a><span class="w">  </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)),</span><span class="w">           </span><span class="c1">-- Fast</span>
</span><span id="__span-210-3"><a id="__codelineno-210-3" name="__codelineno-210-3" href="#__codelineno-210-3"></a><span class="w">  </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)),</span><span class="w">       </span><span class="c1">-- Medium</span>
</span><span id="__span-210-4"><a id="__codelineno-210-4" name="__codelineno-210-4" href="#__codelineno-210-4"></a><span class="w">  </span><span class="n">referential_integrity_check</span><span class="w">           </span><span class="c1">-- Slow</span>
</span><span id="__span-210-5"><a id="__codelineno-210-5" name="__codelineno-210-5" href="#__codelineno-210-5"></a><span class="p">)</span>
</span></code></pre></div></p>
<p><strong>2. Add indexes on audited columns</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-211-1"><a id="__codelineno-211-1" name="__codelineno-211-1" href="#__codelineno-211-1"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_customer_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">);</span>
</span><span id="__span-211-2"><a id="__codelineno-211-2" name="__codelineno-211-2" href="#__codelineno-211-2"></a><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_order_date</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="p">(</span><span class="n">order_date</span><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>3. Avoid expensive operations</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-212-1"><a id="__codelineno-212-1" name="__codelineno-212-1" href="#__codelineno-212-1"></a><span class="c1">-- Slow</span>
</span><span id="__span-212-2"><a id="__codelineno-212-2" name="__codelineno-212-2" href="#__codelineno-212-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">REGEXP_MATCH</span><span class="p">(</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">complex_pattern</span><span class="p">);</span>
</span><span id="__span-212-3"><a id="__codelineno-212-3" name="__codelineno-212-3" href="#__codelineno-212-3"></a>
</span><span id="__span-212-4"><a id="__codelineno-212-4" name="__codelineno-212-4" href="#__codelineno-212-4"></a><span class="c1">-- Fast</span>
</span><span id="__span-212-5"><a id="__codelineno-212-5" name="__codelineno-212-5" href="#__codelineno-212-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%@%&#39;</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="94-naming-conventions">9.4 Naming Conventions<a class="headerlink" href="#94-naming-conventions" title="Permanent link">&para;</a></h3>
<p><strong>Use descriptive, action-oriented names:</strong>
- <code>assert_positive_revenue</code>
- <code>validate_customer_exists</code>
- <code>check_date_ordering</code>
- <code>ensure_email_format</code>
- <code>verify_calculations</code></p>
<p><strong>Avoid:</strong>
- <code>audit1</code>, <code>check</code>, <code>test</code>, <code>validation</code></p>
<hr />
<h3 id="95-audit-coverage-strategy">9.5 Audit Coverage Strategy<a class="headerlink" href="#95-audit-coverage-strategy" title="Permanent link">&para;</a></h3>
<p><strong>Critical (always audit):</strong>
- Primary keys: <code>not_null</code> + <code>unique_values</code>
- Foreign keys: referential integrity
- Non-negative amounts: <code>forall(criteria := (amount &gt;= 0))</code>
- Required fields: <code>not_null</code></p>
<p><strong>Important (audit frequently):</strong>
- Enums: <code>accepted_values</code>
- Ranges: <code>accepted_range</code>
- Formats: <code>valid_email</code>, <code>valid_url</code></p>
<p><strong>Nice-to-have (use profiles first):</strong>
- String lengths
- Statistical bounds
- Format patterns</p>
<hr />
<h3 id="96-organizing-audits-by-domain">9.6 Organizing Audits by Domain<a class="headerlink" href="#96-organizing-audits-by-domain" title="Permanent link">&para;</a></h3>
<p><strong>Recommended structure:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-213-1"><a id="__codelineno-213-1" name="__codelineno-213-1" href="#__codelineno-213-1"></a>audits/
</span><span id="__span-213-2"><a id="__codelineno-213-2" name="__codelineno-213-2" href="#__codelineno-213-2"></a>├── common/           # Reusable
</span><span id="__span-213-3"><a id="__codelineno-213-3" name="__codelineno-213-3" href="#__codelineno-213-3"></a>│   ├── nulls.sql
</span><span id="__span-213-4"><a id="__codelineno-213-4" name="__codelineno-213-4" href="#__codelineno-213-4"></a>│   ├── ranges.sql
</span><span id="__span-213-5"><a id="__codelineno-213-5" name="__codelineno-213-5" href="#__codelineno-213-5"></a>│   └── formats.sql
</span><span id="__span-213-6"><a id="__codelineno-213-6" name="__codelineno-213-6" href="#__codelineno-213-6"></a>├── sales/            # Domain-specific
</span><span id="__span-213-7"><a id="__codelineno-213-7" name="__codelineno-213-7" href="#__codelineno-213-7"></a>│   ├── orders.sql
</span><span id="__span-213-8"><a id="__codelineno-213-8" name="__codelineno-213-8" href="#__codelineno-213-8"></a>│   └── revenue.sql
</span><span id="__span-213-9"><a id="__codelineno-213-9" name="__codelineno-213-9" href="#__codelineno-213-9"></a>└── finance/
</span><span id="__span-213-10"><a id="__codelineno-213-10" name="__codelineno-213-10" href="#__codelineno-213-10"></a>    └── transactions.sql
</span></code></pre></div></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="10-real-world-examples">10. Real-World Examples<a class="headerlink" href="#10-real-world-examples" title="Permanent link">&para;</a></h2>
<h3 id="101-e-commerce-order-validation">10.1 E-commerce Order Validation<a class="headerlink" href="#101-e-commerce-order-validation" title="Permanent link">&para;</a></h3>
<p><strong>Complete order model with audits:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-214-1"><a id="__codelineno-214-1" name="__codelineno-214-1" href="#__codelineno-214-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-214-2"><a id="__codelineno-214-2" name="__codelineno-214-2" href="#__codelineno-214-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">sales</span><span class="p">.</span><span class="n">orders</span><span class="p">,</span>
</span><span id="__span-214-3"><a id="__codelineno-214-3" name="__codelineno-214-3" href="#__codelineno-214-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-214-4"><a id="__codelineno-214-4" name="__codelineno-214-4" href="#__codelineno-214-4"></a><span class="w">  </span><span class="k">references</span><span class="w"> </span><span class="p">(</span><span class="n">customer_id</span><span class="p">),</span>
</span><span id="__span-214-5"><a id="__codelineno-214-5" name="__codelineno-214-5" href="#__codelineno-214-5"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-214-6"><a id="__codelineno-214-6" name="__codelineno-214-6" href="#__codelineno-214-6"></a><span class="w">    </span><span class="c1">-- Completeness</span>
</span><span id="__span-214-7"><a id="__codelineno-214-7" name="__codelineno-214-7" href="#__codelineno-214-7"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)),</span>
</span><span id="__span-214-8"><a id="__codelineno-214-8" name="__codelineno-214-8" href="#__codelineno-214-8"></a>
</span><span id="__span-214-9"><a id="__codelineno-214-9" name="__codelineno-214-9" href="#__codelineno-214-9"></a><span class="w">    </span><span class="c1">-- Uniqueness</span>
</span><span id="__span-214-10"><a id="__codelineno-214-10" name="__codelineno-214-10" href="#__codelineno-214-10"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">order_id</span><span class="p">)),</span>
</span><span id="__span-214-11"><a id="__codelineno-214-11" name="__codelineno-214-11" href="#__codelineno-214-11"></a>
</span><span id="__span-214-12"><a id="__codelineno-214-12" name="__codelineno-214-12" href="#__codelineno-214-12"></a><span class="w">    </span><span class="c1">-- Business rules</span>
</span><span id="__span-214-13"><a id="__codelineno-214-13" name="__codelineno-214-13" href="#__codelineno-214-13"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-214-14"><a id="__codelineno-214-14" name="__codelineno-214-14" href="#__codelineno-214-14"></a><span class="w">      </span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-214-15"><a id="__codelineno-214-15" name="__codelineno-214-15" href="#__codelineno-214-15"></a><span class="w">      </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-214-16"><a id="__codelineno-214-16" name="__codelineno-214-16" href="#__codelineno-214-16"></a><span class="w">      </span><span class="n">discount_amount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-214-17"><a id="__codelineno-214-17" name="__codelineno-214-17" href="#__codelineno-214-17"></a><span class="w">      </span><span class="n">tax_amount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
</span><span id="__span-214-18"><a id="__codelineno-214-18" name="__codelineno-214-18" href="#__codelineno-214-18"></a><span class="w">      </span><span class="n">order_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">,</span>
</span><span id="__span-214-19"><a id="__codelineno-214-19" name="__codelineno-214-19" href="#__codelineno-214-19"></a><span class="w">      </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-214-20"><a id="__codelineno-214-20" name="__codelineno-214-20" href="#__codelineno-214-20"></a><span class="w">      </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">shipped_date</span>
</span><span id="__span-214-21"><a id="__codelineno-214-21" name="__codelineno-214-21" href="#__codelineno-214-21"></a><span class="w">    </span><span class="p">)),</span>
</span><span id="__span-214-22"><a id="__codelineno-214-22" name="__codelineno-214-22" href="#__codelineno-214-22"></a>
</span><span id="__span-214-23"><a id="__codelineno-214-23" name="__codelineno-214-23" href="#__codelineno-214-23"></a><span class="w">    </span><span class="c1">-- Status logic</span>
</span><span id="__span-214-24"><a id="__codelineno-214-24" name="__codelineno-214-24" href="#__codelineno-214-24"></a><span class="w">    </span><span class="n">valid_order_status</span><span class="p">,</span>
</span><span id="__span-214-25"><a id="__codelineno-214-25" name="__codelineno-214-25" href="#__codelineno-214-25"></a>
</span><span id="__span-214-26"><a id="__codelineno-214-26" name="__codelineno-214-26" href="#__codelineno-214-26"></a><span class="w">    </span><span class="c1">-- Referential integrity</span>
</span><span id="__span-214-27"><a id="__codelineno-214-27" name="__codelineno-214-27" href="#__codelineno-214-27"></a><span class="w">    </span><span class="n">valid_customer_reference</span>
</span><span id="__span-214-28"><a id="__codelineno-214-28" name="__codelineno-214-28" href="#__codelineno-214-28"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-214-29"><a id="__codelineno-214-29" name="__codelineno-214-29" href="#__codelineno-214-29"></a><span class="p">);</span>
</span><span id="__span-214-30"><a id="__codelineno-214-30" name="__codelineno-214-30" href="#__codelineno-214-30"></a>
</span><span id="__span-214-31"><a id="__codelineno-214-31" name="__codelineno-214-31" href="#__codelineno-214-31"></a><span class="k">SELECT</span>
</span><span id="__span-214-32"><a id="__codelineno-214-32" name="__codelineno-214-32" href="#__codelineno-214-32"></a><span class="w">  </span><span class="n">order_id</span><span class="p">,</span>
</span><span id="__span-214-33"><a id="__codelineno-214-33" name="__codelineno-214-33" href="#__codelineno-214-33"></a><span class="w">  </span><span class="n">customer_id</span><span class="p">,</span>
</span><span id="__span-214-34"><a id="__codelineno-214-34" name="__codelineno-214-34" href="#__codelineno-214-34"></a><span class="w">  </span><span class="n">order_date</span><span class="p">,</span>
</span><span id="__span-214-35"><a id="__codelineno-214-35" name="__codelineno-214-35" href="#__codelineno-214-35"></a><span class="w">  </span><span class="n">shipped_date</span><span class="p">,</span>
</span><span id="__span-214-36"><a id="__codelineno-214-36" name="__codelineno-214-36" href="#__codelineno-214-36"></a><span class="w">  </span><span class="n">delivered_date</span><span class="p">,</span>
</span><span id="__span-214-37"><a id="__codelineno-214-37" name="__codelineno-214-37" href="#__codelineno-214-37"></a><span class="w">  </span><span class="n">amount</span><span class="p">,</span>
</span><span id="__span-214-38"><a id="__codelineno-214-38" name="__codelineno-214-38" href="#__codelineno-214-38"></a><span class="w">  </span><span class="n">discount_amount</span><span class="p">,</span>
</span><span id="__span-214-39"><a id="__codelineno-214-39" name="__codelineno-214-39" href="#__codelineno-214-39"></a><span class="w">  </span><span class="n">tax_amount</span><span class="p">,</span>
</span><span id="__span-214-40"><a id="__codelineno-214-40" name="__codelineno-214-40" href="#__codelineno-214-40"></a><span class="w">  </span><span class="n">status</span>
</span><span id="__span-214-41"><a id="__codelineno-214-41" name="__codelineno-214-41" href="#__codelineno-214-41"></a><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>
</span><span id="__span-214-42"><a id="__codelineno-214-42" name="__codelineno-214-42" href="#__codelineno-214-42"></a>
</span><span id="__span-214-43"><a id="__codelineno-214-43" name="__codelineno-214-43" href="#__codelineno-214-43"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_order_status</span><span class="p">);</span>
</span><span id="__span-214-44"><a id="__codelineno-214-44" name="__codelineno-214-44" href="#__codelineno-214-44"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-214-45"><a id="__codelineno-214-45" name="__codelineno-214-45" href="#__codelineno-214-45"></a><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
</span><span id="__span-214-46"><a id="__codelineno-214-46" name="__codelineno-214-46" href="#__codelineno-214-46"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;delivered&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">shipped_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">delivered_date</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">))</span>
</span><span id="__span-214-47"><a id="__codelineno-214-47" name="__codelineno-214-47" href="#__codelineno-214-47"></a><span class="w">   </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;processing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;delivered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cancelled&#39;</span><span class="p">));</span>
</span><span id="__span-214-48"><a id="__codelineno-214-48" name="__codelineno-214-48" href="#__codelineno-214-48"></a>
</span><span id="__span-214-49"><a id="__codelineno-214-49" name="__codelineno-214-49" href="#__codelineno-214-49"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_customer_reference</span><span class="p">);</span>
</span><span id="__span-214-50"><a id="__codelineno-214-50" name="__codelineno-214-50" href="#__codelineno-214-50"></a><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="o">*</span>
</span><span id="__span-214-51"><a id="__codelineno-214-51" name="__codelineno-214-51" href="#__codelineno-214-51"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">o</span>
</span><span id="__span-214-52"><a id="__codelineno-214-52" name="__codelineno-214-52" href="#__codelineno-214-52"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">customers</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span>
</span><span id="__span-214-53"><a id="__codelineno-214-53" name="__codelineno-214-53" href="#__codelineno-214-53"></a><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div></p>
<hr />
<h3 id="102-financial-transaction-audits">10.2 Financial Transaction Audits<a class="headerlink" href="#102-financial-transaction-audits" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-215-1"><a id="__codelineno-215-1" name="__codelineno-215-1" href="#__codelineno-215-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-215-2"><a id="__codelineno-215-2" name="__codelineno-215-2" href="#__codelineno-215-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">finance</span><span class="p">.</span><span class="n">transactions</span><span class="p">,</span>
</span><span id="__span-215-3"><a id="__codelineno-215-3" name="__codelineno-215-3" href="#__codelineno-215-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">transaction_id</span><span class="p">,</span>
</span><span id="__span-215-4"><a id="__codelineno-215-4" name="__codelineno-215-4" href="#__codelineno-215-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-215-5"><a id="__codelineno-215-5" name="__codelineno-215-5" href="#__codelineno-215-5"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">transaction_id</span><span class="p">,</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">transaction_date</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">)),</span>
</span><span id="__span-215-6"><a id="__codelineno-215-6" name="__codelineno-215-6" href="#__codelineno-215-6"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">transaction_id</span><span class="p">)),</span>
</span><span id="__span-215-7"><a id="__codelineno-215-7" name="__codelineno-215-7" href="#__codelineno-215-7"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-215-8"><a id="__codelineno-215-8" name="__codelineno-215-8" href="#__codelineno-215-8"></a><span class="w">      </span><span class="n">transaction_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">,</span>
</span><span id="__span-215-9"><a id="__codelineno-215-9" name="__codelineno-215-9" href="#__codelineno-215-9"></a><span class="w">      </span><span class="k">ABS</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span><span class="c1">-- No zero transactions</span>
</span><span id="__span-215-10"><a id="__codelineno-215-10" name="__codelineno-215-10" href="#__codelineno-215-10"></a><span class="w">      </span><span class="p">(</span><span class="n">transaction_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;debit&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span>
</span><span id="__span-215-11"><a id="__codelineno-215-11" name="__codelineno-215-11" href="#__codelineno-215-11"></a><span class="w">      </span><span class="p">(</span><span class="n">transaction_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;credit&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="c1">-- Sign matches type</span>
</span><span id="__span-215-12"><a id="__codelineno-215-12" name="__codelineno-215-12" href="#__codelineno-215-12"></a><span class="w">    </span><span class="p">)),</span>
</span><span id="__span-215-13"><a id="__codelineno-215-13" name="__codelineno-215-13" href="#__codelineno-215-13"></a><span class="w">    </span><span class="n">balanced_transactions</span><span class="w">  </span><span class="c1">-- Credits = Debits</span>
</span><span id="__span-215-14"><a id="__codelineno-215-14" name="__codelineno-215-14" href="#__codelineno-215-14"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-215-15"><a id="__codelineno-215-15" name="__codelineno-215-15" href="#__codelineno-215-15"></a><span class="p">);</span>
</span><span id="__span-215-16"><a id="__codelineno-215-16" name="__codelineno-215-16" href="#__codelineno-215-16"></a>
</span><span id="__span-215-17"><a id="__codelineno-215-17" name="__codelineno-215-17" href="#__codelineno-215-17"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">transactions</span><span class="p">;</span>
</span><span id="__span-215-18"><a id="__codelineno-215-18" name="__codelineno-215-18" href="#__codelineno-215-18"></a>
</span><span id="__span-215-19"><a id="__codelineno-215-19" name="__codelineno-215-19" href="#__codelineno-215-19"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">balanced_transactions</span><span class="p">);</span>
</span><span id="__span-215-20"><a id="__codelineno-215-20" name="__codelineno-215-20" href="#__codelineno-215-20"></a><span class="c1">-- For each account, ensure sum of transactions = 0 (balanced)</span>
</span><span id="__span-215-21"><a id="__codelineno-215-21" name="__codelineno-215-21" href="#__codelineno-215-21"></a><span class="k">SELECT</span><span class="w"> </span>
</span><span id="__span-215-22"><a id="__codelineno-215-22" name="__codelineno-215-22" href="#__codelineno-215-22"></a><span class="w">  </span><span class="n">account_id</span><span class="p">,</span>
</span><span id="__span-215-23"><a id="__codelineno-215-23" name="__codelineno-215-23" href="#__codelineno-215-23"></a><span class="w">  </span><span class="n">transaction_date</span><span class="p">,</span>
</span><span id="__span-215-24"><a id="__codelineno-215-24" name="__codelineno-215-24" href="#__codelineno-215-24"></a><span class="w">  </span><span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">net_amount</span>
</span><span id="__span-215-25"><a id="__codelineno-215-25" name="__codelineno-215-25" href="#__codelineno-215-25"></a><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span>
</span><span id="__span-215-26"><a id="__codelineno-215-26" name="__codelineno-215-26" href="#__codelineno-215-26"></a><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">account_id</span><span class="p">,</span><span class="w"> </span><span class="n">transaction_date</span>
</span><span id="__span-215-27"><a id="__codelineno-215-27" name="__codelineno-215-27" href="#__codelineno-215-27"></a><span class="k">HAVING</span><span class="w"> </span><span class="k">ABS</span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="p">;</span><span class="w">  </span><span class="c1">-- Allow rounding difference</span>
</span></code></pre></div>
<hr />
<h3 id="103-user-registration-validation">10.3 User Registration Validation<a class="headerlink" href="#103-user-registration-validation" title="Permanent link">&para;</a></h3>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-216-1"><a id="__codelineno-216-1" name="__codelineno-216-1" href="#__codelineno-216-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-216-2"><a id="__codelineno-216-2" name="__codelineno-216-2" href="#__codelineno-216-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">registrations</span><span class="p">,</span>
</span><span id="__span-216-3"><a id="__codelineno-216-3" name="__codelineno-216-3" href="#__codelineno-216-3"></a><span class="w">  </span><span class="n">grain</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span>
</span><span id="__span-216-4"><a id="__codelineno-216-4" name="__codelineno-216-4" href="#__codelineno-216-4"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-216-5"><a id="__codelineno-216-5" name="__codelineno-216-5" href="#__codelineno-216-5"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">signup_date</span><span class="p">)),</span>
</span><span id="__span-216-6"><a id="__codelineno-216-6" name="__codelineno-216-6" href="#__codelineno-216-6"></a><span class="w">    </span><span class="n">unique_values</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">)),</span>
</span><span id="__span-216-7"><a id="__codelineno-216-7" name="__codelineno-216-7" href="#__codelineno-216-7"></a><span class="w">    </span><span class="n">valid_email</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">),</span>
</span><span id="__span-216-8"><a id="__codelineno-216-8" name="__codelineno-216-8" href="#__codelineno-216-8"></a><span class="w">    </span><span class="n">forall</span><span class="p">(</span><span class="n">criteria</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-216-9"><a id="__codelineno-216-9" name="__codelineno-216-9" href="#__codelineno-216-9"></a><span class="w">      </span><span class="n">signup_date</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">,</span>
</span><span id="__span-216-10"><a id="__codelineno-216-10" name="__codelineno-216-10" href="#__codelineno-216-10"></a><span class="w">      </span><span class="n">age</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w">  </span><span class="c1">-- Legal requirement</span>
</span><span id="__span-216-11"><a id="__codelineno-216-11" name="__codelineno-216-11" href="#__codelineno-216-11"></a><span class="w">      </span><span class="n">age</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">120</span><span class="w">  </span><span class="c1">-- Reasonable maximum</span>
</span><span id="__span-216-12"><a id="__codelineno-216-12" name="__codelineno-216-12" href="#__codelineno-216-12"></a><span class="w">    </span><span class="p">)),</span>
</span><span id="__span-216-13"><a id="__codelineno-216-13" name="__codelineno-216-13" href="#__codelineno-216-13"></a><span class="w">    </span><span class="n">valid_country_codes</span>
</span><span id="__span-216-14"><a id="__codelineno-216-14" name="__codelineno-216-14" href="#__codelineno-216-14"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-216-15"><a id="__codelineno-216-15" name="__codelineno-216-15" href="#__codelineno-216-15"></a><span class="p">);</span>
</span><span id="__span-216-16"><a id="__codelineno-216-16" name="__codelineno-216-16" href="#__codelineno-216-16"></a>
</span><span id="__span-216-17"><a id="__codelineno-216-17" name="__codelineno-216-17" href="#__codelineno-216-17"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">raw</span><span class="p">.</span><span class="n">user_registrations</span><span class="p">;</span>
</span><span id="__span-216-18"><a id="__codelineno-216-18" name="__codelineno-216-18" href="#__codelineno-216-18"></a>
</span><span id="__span-216-19"><a id="__codelineno-216-19" name="__codelineno-216-19" href="#__codelineno-216-19"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">valid_country_codes</span><span class="p">);</span>
</span><span id="__span-216-20"><a id="__codelineno-216-20" name="__codelineno-216-20" href="#__codelineno-216-20"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="n">u</span>
</span><span id="__span-216-21"><a id="__codelineno-216-21" name="__codelineno-216-21" href="#__codelineno-216-21"></a><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">dim</span><span class="p">.</span><span class="n">countries</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">country_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">code</span>
</span><span id="__span-216-22"><a id="__codelineno-216-22" name="__codelineno-216-22" href="#__codelineno-216-22"></a><span class="k">WHERE</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">country_code</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
</span><span id="__span-216-23"><a id="__codelineno-216-23" name="__codelineno-216-23" href="#__codelineno-216-23"></a><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">code</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span>
</span></code></pre></div>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="11-quick-reference">11. Quick Reference<a class="headerlink" href="#11-quick-reference" title="Permanent link">&para;</a></h2>
<h3 id="111-most-common-audits-cheat-sheet">11.1 Most Common Audits (Cheat Sheet)<a class="headerlink" href="#111-most-common-audits-cheat-sheet" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Use Case</th>
<th>Audit</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>No NULLs</td>
<td><code>not_null</code></td>
<td><code>not_null(columns := (id, email))</code></td>
</tr>
<tr>
<td>Unique</td>
<td><code>unique_values</code></td>
<td><code>unique_values(columns := (id))</code></td>
</tr>
<tr>
<td>In list</td>
<td><code>accepted_values</code></td>
<td><code>accepted_values(column := status, is_in := ('A', 'B'))</code></td>
</tr>
<tr>
<td>Numeric range</td>
<td><code>accepted_range</code></td>
<td><code>accepted_range(column := age, min_v := 0, max_v := 120)</code></td>
</tr>
<tr>
<td>Positive</td>
<td><code>forall</code></td>
<td><code>forall(criteria := (amount &gt; 0))</code></td>
</tr>
<tr>
<td>Email format</td>
<td><code>valid_email</code></td>
<td><code>valid_email(column := email)</code></td>
</tr>
<tr>
<td>No duplicate combo</td>
<td><code>unique_combination_of_columns</code></td>
<td><code>unique_combination_of_columns(columns := (user, date))</code></td>
</tr>
<tr>
<td>Min rows</td>
<td><code>number_of_rows</code></td>
<td><code>number_of_rows(threshold := 100)</code></td>
</tr>
<tr>
<td>Not empty string</td>
<td><code>not_empty_string</code></td>
<td><code>not_empty_string(column := name)</code></td>
</tr>
<tr>
<td>Custom logic</td>
<td><code>forall</code></td>
<td><code>forall(criteria := (start_date &lt; end_date))</code></td>
</tr>
</tbody>
</table>
<hr />
<h3 id="112-syntax-quick-reference">11.2 Syntax Quick Reference<a class="headerlink" href="#112-syntax-quick-reference" title="Permanent link">&para;</a></h3>
<p><strong>Built-in audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-217-1"><a id="__codelineno-217-1" name="__codelineno-217-1" href="#__codelineno-217-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-217-2"><a id="__codelineno-217-2" name="__codelineno-217-2" href="#__codelineno-217-2"></a><span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="k">table</span><span class="p">,</span>
</span><span id="__span-217-3"><a id="__codelineno-217-3" name="__codelineno-217-3" href="#__codelineno-217-3"></a><span class="w">  </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-217-4"><a id="__codelineno-217-4" name="__codelineno-217-4" href="#__codelineno-217-4"></a><span class="w">    </span><span class="n">not_null</span><span class="p">(</span><span class="n">columns</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="w"> </span><span class="n">col2</span><span class="p">))</span>
</span><span id="__span-217-5"><a id="__codelineno-217-5" name="__codelineno-217-5" href="#__codelineno-217-5"></a><span class="w">  </span><span class="p">)</span>
</span><span id="__span-217-6"><a id="__codelineno-217-6" name="__codelineno-217-6" href="#__codelineno-217-6"></a><span class="p">);</span>
</span></code></pre></div></p>
<p><strong>Custom audit (file-based):</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-218-1"><a id="__codelineno-218-1" name="__codelineno-218-1" href="#__codelineno-218-1"></a><span class="c1">-- audits/my_audit.sql</span>
</span><span id="__span-218-2"><a id="__codelineno-218-2" name="__codelineno-218-2" href="#__codelineno-218-2"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">my_audit</span><span class="p">,</span><span class="w"> </span><span class="n">dialect</span><span class="w"> </span><span class="n">postgres</span><span class="p">);</span>
</span><span id="__span-218-3"><a id="__codelineno-218-3" name="__codelineno-218-3" href="#__codelineno-218-3"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">bad_condition</span><span class="p">;</span>
</span><span id="__span-218-4"><a id="__codelineno-218-4" name="__codelineno-218-4" href="#__codelineno-218-4"></a>
</span><span id="__span-218-5"><a id="__codelineno-218-5" name="__codelineno-218-5" href="#__codelineno-218-5"></a><span class="c1">-- In model</span>
</span><span id="__span-218-6"><a id="__codelineno-218-6" name="__codelineno-218-6" href="#__codelineno-218-6"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="k">table</span><span class="p">,</span><span class="w"> </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">my_audit</span><span class="p">));</span>
</span></code></pre></div></p>
<p><strong>Inline audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-219-1"><a id="__codelineno-219-1" name="__codelineno-219-1" href="#__codelineno-219-1"></a><span class="n">MODEL</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="k">table</span><span class="p">,</span><span class="w"> </span><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">my_audit</span><span class="p">));</span>
</span><span id="__span-219-2"><a id="__codelineno-219-2" name="__codelineno-219-2" href="#__codelineno-219-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">source</span><span class="p">;</span>
</span><span id="__span-219-3"><a id="__codelineno-219-3" name="__codelineno-219-3" href="#__codelineno-219-3"></a>
</span><span id="__span-219-4"><a id="__codelineno-219-4" name="__codelineno-219-4" href="#__codelineno-219-4"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">my_audit</span><span class="p">);</span>
</span><span id="__span-219-5"><a id="__codelineno-219-5" name="__codelineno-219-5" href="#__codelineno-219-5"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">bad_condition</span><span class="p">;</span>
</span></code></pre></div></p>
<p><strong>Parameterized audit:</strong>
<div class="language-sql highlight"><pre><span></span><code><span id="__span-220-1"><a id="__codelineno-220-1" name="__codelineno-220-1" href="#__codelineno-220-1"></a><span class="n">AUDIT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="n">check_threshold</span><span class="p">);</span>
</span><span id="__span-220-2"><a id="__codelineno-220-2" name="__codelineno-220-2" href="#__codelineno-220-2"></a><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">@</span><span class="n">this_model</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">@</span><span class="k">column</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="n">threshold</span><span class="p">;</span>
</span><span id="__span-220-3"><a id="__codelineno-220-3" name="__codelineno-220-3" href="#__codelineno-220-3"></a>
</span><span id="__span-220-4"><a id="__codelineno-220-4" name="__codelineno-220-4" href="#__codelineno-220-4"></a><span class="c1">-- Usage</span>
</span><span id="__span-220-5"><a id="__codelineno-220-5" name="__codelineno-220-5" href="#__codelineno-220-5"></a><span class="n">assertions</span><span class="w"> </span><span class="p">(</span><span class="n">check_threshold</span><span class="p">(</span><span class="k">column</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span>
</span></code></pre></div></p>
<hr />
<h3 id="113-decision-tree">11.3 Decision Tree<a class="headerlink" href="#113-decision-tree" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-221-1"><a id="__codelineno-221-1" name="__codelineno-221-1" href="#__codelineno-221-1"></a>Need data validation?
</span><span id="__span-221-2"><a id="__codelineno-221-2" name="__codelineno-221-2" href="#__codelineno-221-2"></a>│
</span><span id="__span-221-3"><a id="__codelineno-221-3" name="__codelineno-221-3" href="#__codelineno-221-3"></a>├─ Must BLOCK bad data immediately?
</span><span id="__span-221-4"><a id="__codelineno-221-4" name="__codelineno-221-4" href="#__codelineno-221-4"></a>│  └─ YES → Use AUDIT
</span><span id="__span-221-5"><a id="__codelineno-221-5" name="__codelineno-221-5" href="#__codelineno-221-5"></a>│     ├─ Reusable? → audits/common/*.sql
</span><span id="__span-221-6"><a id="__codelineno-221-6" name="__codelineno-221-6" href="#__codelineno-221-6"></a>│     └─ Model-specific? → Inline audit
</span><span id="__span-221-7"><a id="__codelineno-221-7" name="__codelineno-221-7" href="#__codelineno-221-7"></a>│
</span><span id="__span-221-8"><a id="__codelineno-221-8" name="__codelineno-221-8" href="#__codelineno-221-8"></a>├─ Need historical tracking?
</span><span id="__span-221-9"><a id="__codelineno-221-9" name="__codelineno-221-9" href="#__codelineno-221-9"></a>│  └─ Use QUALITY CHECK (YAML)
</span><span id="__span-221-10"><a id="__codelineno-221-10" name="__codelineno-221-10" href="#__codelineno-221-10"></a>│
</span><span id="__span-221-11"><a id="__codelineno-221-11" name="__codelineno-221-11" href="#__codelineno-221-11"></a>└─ Just observing trends?
</span><span id="__span-221-12"><a id="__codelineno-221-12" name="__codelineno-221-12" href="#__codelineno-221-12"></a>   └─ Use PROFILE
</span></code></pre></div>
<hr />
<h3 id="114-complete-audit-index-alphabetical">11.4 Complete Audit Index (Alphabetical)<a class="headerlink" href="#114-complete-audit-index-alphabetical" title="Permanent link">&para;</a></h3>
<p><strong>Built-in audits (29 total):</strong>
- <a href="#accepted_range"><code>accepted_range</code></a>
- <a href="#accepted_values"><code>accepted_values</code></a>
- <a href="#at_least_one"><code>at_least_one</code></a>
- <a href="#chi_square"><code>chi_square</code></a>
- <a href="#forall"><code>forall</code></a>
- <a href="#kl_divergence"><code>kl_divergence</code></a>
- <a href="#match_like_pattern_list"><code>match_like_pattern_list</code></a>
- <a href="#match_regex_pattern_list"><code>match_regex_pattern_list</code></a>
- <a href="#mean_in_range"><code>mean_in_range</code></a>
- <a href="#mutually_exclusive_ranges"><code>mutually_exclusive_ranges</code></a>
- <a href="#not_accepted_values"><code>not_accepted_values</code></a>
- <a href="#not_constant"><code>not_constant</code></a>
- <a href="#not_empty_string"><code>not_empty_string</code></a>
- <a href="#not_match_like_pattern_list"><code>not_match_like_pattern_list</code></a>
- <a href="#not_match_regex_pattern_list"><code>not_match_regex_pattern_list</code></a>
- <a href="#not_null"><code>not_null</code></a>
- <a href="#not_null_proportion"><code>not_null_proportion</code></a>
- <a href="#number_of_rows"><code>number_of_rows</code></a>
- <a href="#sequential_values"><code>sequential_values</code></a>
- <a href="#stddev_in_range"><code>stddev_in_range</code></a>
- <a href="#string_length_between"><code>string_length_between</code></a>
- <a href="#string_length_equal"><code>string_length_equal</code></a>
- <a href="#unique_combination_of_columns"><code>unique_combination_of_columns</code></a>
- <a href="#unique_values"><code>unique_values</code></a>
- <a href="#valid_email"><code>valid_email</code></a>
- <a href="#valid_http_method"><code>valid_http_method</code></a>
- <a href="#valid_url"><code>valid_url</code></a>
- <a href="#valid_uuid"><code>valid_uuid</code></a>
- <a href="#z_score"><code>z_score</code></a></p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />
<h2 id="12-summary-and-next-steps">12. Summary and Next Steps<a class="headerlink" href="#12-summary-and-next-steps" title="Permanent link">&para;</a></h2>
<h3 id="key-takeaways">Key Takeaways<a class="headerlink" href="#key-takeaways" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Audits = Data Warehouse Constraints</strong></li>
<li>Similar to OLTP constraints but block downstream flow instead of INSERT/UPDATE</li>
<li>
<p>Always blocking in Vulcan (no warning-only mode)</p>
</li>
<li>
<p><strong>Three Quality Mechanisms</strong></p>
</li>
<li><strong>Audits</strong>: Critical, blocking validation</li>
<li><strong>Quality Checks</strong>: Monitoring with history</li>
<li>
<p><strong>Profiles</strong>: Trend tracking</p>
</li>
<li>
<p><strong>Query for Bad Data</strong></p>
</li>
<li>Audits use inverted logic: return violations</li>
<li>
<p><code>SELECT * FROM @this_model WHERE bad_condition</code></p>
</li>
<li>
<p><strong>29 Built-in Audits</strong></p>
</li>
<li>Completeness, uniqueness, validity, strings, patterns, statistics</li>
<li>
<p>Use <code>forall</code> for custom logic</p>
</li>
<li>
<p><strong>Custom Audits</strong></p>
</li>
<li>File-based: Reusable in <code>audits/</code> directory</li>
<li>Inline: Model-specific within model file</li>
<li>
<p>Parameterized: Use <code>@column</code>, <code>@threshold</code>, etc.</p>
</li>
<li>
<p><strong>Performance Matters</strong></p>
</li>
<li>Order audits fast → slow</li>
<li>Add indexes on audited columns</li>
<li>
<p>Keep audits simple</p>
</li>
<li>
<p><strong>Layer by Criticality</strong></p>
</li>
<li>Critical: PKs, FKs, non-negative amounts</li>
<li>Important: Enums, ranges, formats</li>
<li>Nice-to-have: Start with profiles</li>
</ol>
<hr />
<h3 id="related-topics">Related Topics<a class="headerlink" href="#related-topics" title="Permanent link">&para;</a></h3>
<p><strong>For deeper learning:</strong></p>
<ol>
<li><strong>Quality Checks</strong> - Scheduled monitoring with historical tracking</li>
<li><strong>Profiles</strong> - Statistical trend analysis</li>
<li><strong>Tests</strong> - Unit tests for model logic (run before audits)</li>
<li><strong>Semantic Layer</strong> - How audits integrate with semantic validations</li>
</ol>
<hr />
<h3 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h3>
<p><strong>Immediate:</strong>
1. Add basic audits to your critical models (<code>not_null</code>, <code>unique_values</code>)
2. Review existing models for audit opportunities
3. Create <code>audits/</code> directory and organize by domain</p>
<p><strong>Short-term:</strong>
4. Implement referential integrity audits
5. Add business rule validations with <code>forall</code>
6. Set up profiles to understand data patterns</p>
<p><strong>Long-term:</strong>
7. Build comprehensive audit coverage across all models
8. Integrate audits into CI/CD
9. Monitor audit performance and optimize</p>
<hr />
<h3 id="final-thoughts">Final Thoughts<a class="headerlink" href="#final-thoughts" title="Permanent link">&para;</a></h3>
<p>Audits are your first line of defense against bad data. They:
- Catch issues immediately during transformation
- Prevent bad data from propagating downstream
- Build confidence in your data products
- Document expected data characteristics</p>
<p>Start simple with critical validations, then expand coverage over time. Your future self (and downstream consumers) will thank you.</p>
<p><strong>Congratulations! You've completed the Audits chapter.</strong></p>
<hr />
<h2 id="appendix-audit-catalog">Appendix: Audit Catalog<a class="headerlink" href="#appendix-audit-catalog" title="Permanent link">&para;</a></h2>
<p>For a complete list of all 29 built-in audits with parameters, see <a href="#3-built-in-audits-reference">Section 3: Built-in Audits Reference</a>.</p>
<p><a href="#chapter-04-audits">↑ Back to Top</a></p>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../semantic-layer/validation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Validation">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Validation
              </div>
            </div>
          </a>
        
        
          
          <a href="../quality-checks/" class="md-footer__link md-footer__link--next" aria-label="Next: Quality Checks">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Quality Checks
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/tmdc-io/vulcan-book" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "navigation.footer", "toc.follow", "toc.integrate", "search.highlight", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>