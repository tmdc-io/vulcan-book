checks:
  vulcan_demo.fct_daily_sales:
    filter: sales_date >= CURRENT_DATE - INTERVAL '30 days'
    completeness:
      - missing_count(sales_date) = 0:
          name: no_missing_sales_dates
          attributes:
            description: "All sales records must have a sales date"
      
      - missing_count(cust_sk) = 0:
          name: no_missing_cust_sk
          attributes:
            description: "All sales records must have a customer surrogate key"
      
      - missing_count(product_sk) = 0:
          name: no_missing_product_sk
          attributes:
            description: "All sales records must have a product surrogate key"
      
      - row_count > 0:
          name: has_sales_data
          filter: "sales_date >= CAST('${run_date}' AS DATE) - INTERVAL '7 days'"
          attributes:
            description: "Sales data exists in the run window (last 7 days)"
    
    validity:
      - failed rows:
          name: negative_revenue
          fail query: |
            SELECT sales_date, cust_sk, product_sk, revenue, units
            FROM vulcan_demo.fct_daily_sales
            WHERE revenue < 0
          samples limit: 10
          attributes:
            description: "Revenue cannot be negative"
      
      - failed rows:
          name: negative_units
          fail query: |
            SELECT sales_date, cust_sk, product_sk, units, revenue
            FROM vulcan_demo.fct_daily_sales
            WHERE units < 0
          samples limit: 10
          attributes:
            description: "Units sold cannot be negative"
      
      - failed rows:
          name: invalid_avg_selling_price
          fail query: |
            SELECT sales_date, cust_sk, product_sk, avg_selling_price, revenue, units
            FROM vulcan_demo.fct_daily_sales
            WHERE avg_selling_price < 0 OR (units > 0 AND revenue > 0 AND ABS(avg_selling_price - (revenue / units)) > 0.01)
          samples limit: 10
          attributes:
            description: "Average selling price must be non-negative and consistent with revenue/units"
      
      - failed rows:
          name: future_sales_dates
          fail query: |
            SELECT sales_date, cust_sk, product_sk, revenue
            FROM vulcan_demo.fct_daily_sales
            WHERE sales_date > CURRENT_DATE
          samples limit: 10
          attributes:
            description: "Sales dates cannot be in the future"
    
    uniqueness:
      - duplicate_count(sales_date, cust_sk, product_sk) = 0:
          name: unique_sales_grain
          attributes:
            description: "Sales records must be unique at the grain level (sales_date, cust_sk, product_sk)"
    
    accuracy:
      - anomaly detection for row_count:
          name: row_count_anomaly
          attributes:
            description: "Detect anomalies in daily sales row count using historic data"
      
      - anomaly detection for sum(revenue):
          name: revenue_anomaly
          attributes:
            description: "Detect anomalies in total daily revenue using historic data"
    
    timeliness:
      - change for row_count >= -50%:
          name: row_count_timeliness_check
          attributes:
            description: "Alert if daily sales row count drops more than 50% from same day last week"

